###############################################################################
#                                                                             #
# IAR C/C++ Compiler V8.20.2.41139 for 8051             13/Jun/2013  14:25:29 #
# Copyright 2004-2013 IAR Systems AB.                                         #
#                                                                             #
#    Core               =  plain                                              #
#    Code model         =  banked                                             #
#    Data model         =  large                                              #
#    Calling convention =  xdata reentrant                                    #
#    Constant location  =  data_rom                                           #
#    Dptr setup         =  1,16                                               #
#                                                                             #
#    Source file        =  C:\Users\PedroZ\Documents\GitHub\TG\Components\sta #
#                          ck\zcl\zcl_key_establish.c                         #
#    Command line       =  -f C:\Users\PedroZ\Documents\GitHub\TG\Projects\St #
#                          ack\SE\SampleApp\CC2530DB\..\..\..\Tools\CC2530DB\ #
#                          f8wEndev.cfg (-DCPU32MHZ -DROOT=__near_func        #
#                          -DMAC_CFG_TX_DATA_MAX=3 -DMAC_CFG_TX_MAX=6         #
#                          -DMAC_CFG_RX_MAX=3) -f C:\Users\PedroZ\Documents\G #
#                          itHub\TG\Projects\Stack\SE\SampleApp\CC2530DB\..\. #
#                          .\..\Tools\CC2530DB\f8wConfig.cfg (-DZIGBEEPRO     #
#                          -DSECURE=0 -DZG_SECURE_DYNAMIC=0 -DREFLECTOR       #
#                          -DDEFAULT_CHANLIST=0x00000800                      #
#                          -DZDAPP_CONFIG_PAN_ID=0xFFFF                       #
#                          -DNWK_START_DELAY=100 -DEXTENDED_JOINING_RANDOM_MA #
#                          SK=0x007F -DBEACON_REQUEST_DELAY=100               #
#                          -DBEACON_REQ_DELAY_MASK=0x00FF                     #
#                          -DLINK_STATUS_JITTER_MASK=0x007F                   #
#                          -DROUTE_EXPIRY_TIME=30 -DAPSC_ACK_WAIT_DURATION_PO #
#                          LLED=3000 -DNWK_INDIRECT_MSG_TIMEOUT=7             #
#                          -DMAX_RREQ_ENTRIES=8 -DAPSC_MAX_FRAME_RETRIES=3    #
#                          -DNWK_MAX_DATA_RETRIES=2                           #
#                          -DMAX_POLL_FAILURE_RETRIES=2 -DMAX_BCAST=9         #
#                          -DAPS_MAX_GROUPS=16 -DMAX_RTG_ENTRIES=40           #
#                          -DNWK_MAX_BINDING_ENTRIES=4                        #
#                          -DMAX_BINDING_CLUSTER_IDS=4 "-DDEFAULT_KEY={0x01,  #
#                          0x03, 0x05, 0x07, 0x09, 0x0B, 0x0D, 0x0F, 0x00,    #
#                          0x02, 0x04, 0x06, 0x08, 0x0A, 0x0C, 0x0D}"         #
#                          -DMAC_MAX_FRAME_SIZE=116                           #
#                          -DZDNWKMGR_MIN_TRANSMISSIONS=20 "-DCONST=const     #
#                          __code" -DGENERIC=__generic                        #
#                          -DRFD_RCVC_ALWAYS_ON=FALSE -DPOLL_RATE=1000        #
#                          -DQUEUED_POLL_RATE=100 -DRESPONSE_POLL_RATE=100    #
#                          -DREJOIN_POLL_RATE=440) -f                         #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\Tools\CC2530DB\f8w #
#                          ZCL.cfg (-DZCL_READ -DZCL_WRITE -DZCL_BASIC        #
#                          -DZCL_IDENTIFY -DZCL_ON_OFF -DZCL_KEY_ESTABLISH    #
#                          -DZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT=4     #
#                          -DZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT=10    #
#                          -DZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT=10   #
#                          -DZCL_LOAD_CONTROL -DZCL_SIMPLE_METERING           #
#                          -DZCL_PRICING -DZCL_MESSAGE -DZCL_TUNNELING        #
#                          -DZCL_TOU) -DZCL_DEVICE_MGMT                       #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Components\sta #
#                          ck\zcl\zcl_key_establish.c -D TC_LINKKEY_JOIN -D   #
#                          ZTOOL_P1 -D MT_TASK -D MT_APP_FUNC -D MT_SYS_FUNC  #
#                          -D LCD_SUPPORTED -D NV_INIT -D xNV_RESTORE -D      #
#                          HOLD_AUTO_START -D NWK_AUTO_POLL -D ZCL_REPORT -D  #
#                          POWER_SAVING -D MAX_POLL_FAILURE_RETRIES=20 -D     #
#                          TEST_CERT_DATA -lC "C:\Users\PedroZ\Documents\GitH #
#                          ub\TG\Projects\Stack\SE\SampleApp\CC2530DB\Simple  #
#                          Metering - EndDevice\List\" -lA                    #
#                          "C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stac #
#                          k\SE\SampleApp\CC2530DB\Simple Metering -          #
#                          EndDevice\List\" --diag_suppress Pe001,Pa010 -o    #
#                          "C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stac #
#                          k\SE\SampleApp\CC2530DB\Simple Metering -          #
#                          EndDevice\Obj\" -e --no_cse --no_unroll            #
#                          --no_inline --no_code_motion --no_tbaa --debug     #
#                          --core=plain --dptr=16,1 --data_model=large        #
#                          --code_model=banked --calling_convention=xdata_ree #
#                          ntrant --place_constants=data_rom                  #
#                          --nr_virtual_regs 16 -I C:\Users\PedroZ\Documents\ #
#                          GitHub\TG\Projects\Stack\SE\SampleApp\CC2530DB\    #
#                          -I C:\Users\PedroZ\Documents\GitHub\TG\Projects\St #
#                          ack\SE\SampleApp\CC2530DB\..\Source\ -I            #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\Source\ -I            #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\ZMain\TI2530DB\    #
#                          -I C:\Users\PedroZ\Documents\GitHub\TG\Projects\St #
#                          ack\SE\SampleApp\CC2530DB\..\..\..\..\..\Component #
#                          s\hal\include\ -I C:\Users\PedroZ\Documents\GitHub #
#                          \TG\Projects\Stack\SE\SampleApp\CC2530DB\..\..\..\ #
#                          ..\..\Components\hal\target\CC2530EB\ -I           #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\m #
#                          ac\include\ -I C:\Users\PedroZ\Documents\GitHub\TG #
#                          \Projects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\ #
#                          ..\Components\mac\high_level\ -I                   #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\m #
#                          ac\low_level\srf04\ -I C:\Users\PedroZ\Documents\G #
#                          itHub\TG\Projects\Stack\SE\SampleApp\CC2530DB\..\. #
#                          .\..\..\..\Components\mac\low_level\srf04\single_c #
#                          hip\ -I C:\Users\PedroZ\Documents\GitHub\TG\Projec #
#                          ts\Stack\SE\SampleApp\CC2530DB\..\..\..\..\..\Comp #
#                          onents\mt\ -I C:\Users\PedroZ\Documents\GitHub\TG\ #
#                          Projects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\. #
#                          .\Components\osal\include\ -I                      #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\s #
#                          ervices\saddr\ -I C:\Users\PedroZ\Documents\GitHub #
#                          \TG\Projects\Stack\SE\SampleApp\CC2530DB\..\..\..\ #
#                          ..\..\Components\services\sdata\ -I                #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\s #
#                          tack\af\ -I C:\Users\PedroZ\Documents\GitHub\TG\Pr #
#                          ojects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\..\ #
#                          Components\stack\nwk\ -I                           #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\s #
#                          tack\sapi\ -I C:\Users\PedroZ\Documents\GitHub\TG\ #
#                          Projects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\. #
#                          .\Components\stack\sec\ -I                         #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\s #
#                          tack\sys\ -I C:\Users\PedroZ\Documents\GitHub\TG\P #
#                          rojects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\.. #
#                          \Components\stack\zcl\ -I                          #
#                          C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\..\..\..\..\..\Components\s #
#                          tack\zdo\ -I C:\Users\PedroZ\Documents\GitHub\TG\P #
#                          rojects\Stack\SE\SampleApp\CC2530DB\..\..\..\..\.. #
#                          \Components\zmac\ -I C:\Users\PedroZ\Documents\Git #
#                          Hub\TG\Projects\Stack\SE\SampleApp\CC2530DB\..\..\ #
#                          ..\..\..\Components\zmac\f8w\ -On                  #
#                          --require_prototypes                               #
#    List file          =  C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\Simple Metering -           #
#                          EndDevice\List\zcl_key_establish.lst               #
#    Object file        =  C:\Users\PedroZ\Documents\GitHub\TG\Projects\Stack #
#                          \SE\SampleApp\CC2530DB\Simple Metering -           #
#                          EndDevice\Obj\zcl_key_establish.r51                #
#                                                                             #
#                                                                             #
###############################################################################

C:\Users\PedroZ\Documents\GitHub\TG\Components\stack\zcl\zcl_key_establish.c
      1          /******************************************************************************
      2            Filename:       zcl_key_establish.c
      3            Revised:        $Date: 2012-04-02 17:02:19 -0700 (Mon, 02 Apr 2012) $
      4            Revision:       $Revision: 29996 $
      5          
      6            Description:    Zigbee Cluster Library - General Function Domain - key
      7                            establishment cluster.
      8                            This application receives ZCL messages and handles them
      9                            within the ZCL layer, without passing to application.
     10          
     11          
     12            Copyright 2007-2012 Texas Instruments Incorporated. All rights reserved.
     13          
     14            IMPORTANT: Your use of this Software is limited to those specific rights
     15            granted under the terms of a software license agreement between the user
     16            who downloaded the software, his/her employer (which must be your employer)
     17            and Texas Instruments Incorporated (the "License"). You may not use this
     18            Software unless you agree to abide by the terms of the License. The License
     19            limits your use, and you acknowledge, that the Software may not be modified,
     20            copied or distributed unless embedded on a Texas Instruments microcontroller
     21            or used solely and exclusively in conjunction with a Texas Instruments radio
     22            frequency transceiver, which is integrated into your product. Other than for
     23            the foregoing purpose, you may not use, reproduce, copy, prepare derivative
     24            works of, modify, distribute, perform, display or sell this Software and/or
     25            its documentation for any purpose.
     26          
     27            YOU FURTHER ACKNOWLEDGE AND AGREE THAT THE SOFTWARE AND DOCUMENTATION ARE
     28            PROVIDED “AS IS” WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESS OR IMPLIED,
     29            INCLUDING WITHOUT LIMITATION, ANY WARRANTY OF MERCHANTABILITY, TITLE,
     30            NON-INFRINGEMENT AND FITNESS FOR A PARTICULAR PURPOSE. IN NO EVENT SHALL
     31            TEXAS INSTRUMENTS OR ITS LICENSORS BE LIABLE OR OBLIGATED UNDER CONTRACT,
     32            NEGLIGENCE, STRICT LIABILITY, CONTRIBUTION, BREACH OF WARRANTY, OR OTHER
     33            LEGAL EQUITABLE THEORY ANY DIRECT OR INDIRECT DAMAGES OR EXPENSES
     34            INCLUDING BUT NOT LIMITED TO ANY INCIDENTAL, SPECIAL, INDIRECT, PUNITIVE
     35            OR CONSEQUENTIAL DAMAGES, LOST PROFITS OR LOST DATA, COST OF PROCUREMENT
     36            OF SUBSTITUTE GOODS, TECHNOLOGY, SERVICES, OR ANY CLAIMS BY THIRD PARTIES
     37            (INCLUDING BUT NOT LIMITED TO ANY DEFENSE THEREOF), OR OTHER SIMILAR COSTS.
     38          
     39            Should you have any questions regarding your right to use this Software,
     40            contact Texas Instruments Incorporated at www.TI.com.
     41          ******************************************************************************/
     42          
     43          /*********************************************************************
     44           * INCLUDES
     45           */
     46          #include "ZComDef.h"
     47          #include "OSAL.h"
     48          #include "OSAL_Nv.h"
     49          #include "zcl.h"
     50          #include "ZDApp.h"
     51          #include "ssp_hash.h"
     52          #include "AddrMgr.h"
     53          #include "ZDSecMgr.h"
     54          #include "APSMEDE.h"
     55          #include "eccapi.h"
     56          #include "zcl_key_establish.h"
     57          #include "DebugTrace.h"
     58          #include "se.h"
     59          
     60          #if defined ( INTER_PAN )
     61            #include "stub_aps.h"
     62          #endif
     63          
     64          /*********************************************************************
     65           * MACROS
     66           */
     67          
     68          /*********************************************************************
     69           * CONSTANTS
     70           */
     71          
     72          #define KEY_ESTABLISHMENT_DEVICE_VERSION      0
     73          #define KEY_ESTABLISHMENT_FLAGS               0
     74          #define KEY_ESTABLISHMENT_SUITE               1  // For CBKE with ECMQV
     75          #define KEY_ESTABLISHMENT_AVG_TIMEOUT         ( 2 * ( ZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT + \
     76                                                            ZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT ) )
     77          
     78          #define ZCL_KEY_ESTABLISH_DEVICE_VERSION      0
     79          #define ZCL_KEY_ESTABLISH_FLAGS               0
     80          
     81          #define INVALID_TASK_ID                       0xFF
     82          
     83          /*********************************************************************
     84           * TYPEDEFS
     85           */
     86          
     87          /*********************************************************************
     88           * GLOBAL VARIABLES
     89           */
     90          
     91          // For debug and testing purpose, use a fixed ephermeral key pair instead
     92          // of the randomly generated one.
     93          #if defined (DEBUG_STATIC_ECC)
     94          uint8 public1[22] = {
     95              0x03, 0x06, 0xAB, 0x52, 0x06, 0x22, 0x01, 0xD9,
     96              0x95, 0xB8, 0xB8, 0x59, 0x1F, 0x3F, 0x08, 0x6A,
     97              0x3A, 0x2E, 0x21, 0x4D, 0x84, 0x5E
     98            };
     99          uint8 private1[21] = {
    100              0x03, 0xD4, 0x8C, 0x72, 0x10, 0xDD, 0xBC, 0xC4,
    101              0xFB, 0x2E, 0x5E, 0x7A, 0x0A, 0xA1, 0x6A, 0x0D,
    102              0xB8, 0x95, 0x40, 0x82, 0x0B
    103            };
    104          uint8 public2[22] = {
    105              0x03, 0x00, 0xE1, 0x17, 0xC8, 0x6D, 0x0E, 0x7C,
    106              0xD1, 0x28, 0xB2, 0xF3, 0x4E, 0x90, 0x76, 0xCF,
    107              0xF2, 0x4A, 0xF4, 0x6D, 0x72, 0x88
    108            };
    109          uint8 private2[21] = {
    110              0x00, 0x13, 0xD3, 0x6D, 0xE4, 0xB1, 0xEA, 0x8E,
    111              0x22, 0x73, 0x9C, 0x38, 0x13, 0x70, 0x82, 0x3F,
    112              0x40, 0x4B, 0xFF, 0x88, 0x62
    113            };
    114          #endif
    115          
    116          

   \                                 In  segment XDATA_I, align 1, keep-with-next
    117          zclOptionRec_t zclKeyEstablish_Options[1] =
   \                     zclKeyEstablish_Options:
   \   000000                DS 3
   \   000003                REQUIRE `?<Initializer for zclKeyEstablish_Options>`
   \   000003                REQUIRE __INIT_XDATA_I
    118          {
    119            {
    120              ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    121              ( AF_ACK_REQUEST ),
    122            },
    123          };
    124          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    125          YieldFunc *zclKeyEstablish_YieldFunc = NULL;
   \                     zclKeyEstablish_YieldFunc:
   \   000000                DS 2
   \   000002                REQUIRE __INIT_XDATA_Z

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    126          uint8 zclKeyEstablish_YieldLevel = 0;
   \                     zclKeyEstablish_YieldLevel:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    127          
    128          #if defined (NWK_AUTO_POLL)

   \                                 In  segment XDATA_I, align 1, keep-with-next
    129          uint16 zclSavedPollRate = POLL_RATE;
   \                     zclSavedPollRate:
   \   000000                DS 2
   \   000002                REQUIRE `?<Initializer for zclSavedPollRate>`
   \   000002                REQUIRE __INIT_XDATA_I
    130          #endif
    131          
    132          /*********************************************************************
    133           * GLOBAL FUNCTIONS
    134           */
    135          extern uint8* SSP_MemCpyReverse( uint8* dst, uint8* src, unsigned int len );
    136          
    137          /*********************************************************************
    138           * LOCAL VARIABLES
    139           */
    140          #if defined(ZCL_KEY_ESTABLISH)

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    141          static uint8 zcl_KeyEstablishment_TaskID;    // Task ID of the key Establishment cluster
   \                     zcl_KeyEstablishment_TaskID:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    142          #endif
    143          
    144          /*********************************************************************
    145           * SIMPLE DESCRIPTOR
    146           */
    147          // This is the Cluster ID List and should be filled with Application
    148          // specific cluster IDs.
    149          #define ZCL_KEY_ESTABLISH_MAX_INCLUSTERS       1

   \                                 In  segment XDATA_ROM_C, align 1
    150          const cId_t zclKeyEstablish_InClusterList[ZCL_KEY_ESTABLISH_MAX_INCLUSTERS] =
   \                     zclKeyEstablish_InClusterList:
   \   000000   0008         DW 2048
    151          {
    152            ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    153          };
    154          
    155          #define ZCL_KEY_ESTABLISH_MAX_OUTCLUSTERS       1

   \                                 In  segment XDATA_ROM_C, align 1
    156          const cId_t zclKeyEstablish_OutClusterList[ZCL_KEY_ESTABLISH_MAX_OUTCLUSTERS] =
   \                     zclKeyEstablish_OutClusterList:
   \   000000   0008         DW 2048
    157          {
    158            ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    159          };
    160          

   \                                 In  segment XDATA_I, align 1, keep-with-next
    161          SimpleDescriptionFormat_t zclKeyEstablish_SimpleDesc =
   \                     zclKeyEstablish_SimpleDesc:
   \   000000                DS 12
   \   00000C                REQUIRE `?<Initializer for zclKeyEstablish_SimpleDesc>`
   \   00000C                REQUIRE __INIT_XDATA_I
    162          {
    163            ZCL_KEY_ESTABLISHMENT_ENDPOINT,          //  int Endpoint;
    164            ZCL_SE_PROFILE_ID,                       //  uint16 AppProfId[2];
    165            ZCL_SE_DEVICEID_PHYSICAL,                //  uint16 AppDeviceId[2];
    166            ZCL_KEY_ESTABLISH_DEVICE_VERSION,        //  int   AppDevVer:4;
    167            ZCL_KEY_ESTABLISH_FLAGS,                 //  int   AppFlags:4;
    168            ZCL_KEY_ESTABLISH_MAX_INCLUSTERS,        //  byte  AppNumInClusters;
    169            (cId_t *)zclKeyEstablish_InClusterList,  //  byte *pAppInClusterList;
    170            ZCL_KEY_ESTABLISH_MAX_OUTCLUSTERS,       //  byte  AppNumInClusters;
    171            (cId_t *)zclKeyEstablish_OutClusterList  //  byte *pAppInClusterList;
    172          };
    173          
    174          #if defined (ZCL_KEY_ESTABLISH)
    175          // Endpoint for Key Establishment Cluster

   \                                 In  segment XDATA_I, align 1, keep-with-next
    176          static endPointDesc_t zclKeyEstablish_Ep =
   \                     zclKeyEstablish_Ep:
   \   000000                DS 6
   \   000006                REQUIRE `?<Initializer for zclKeyEstablish_Ep>`
   \   000006                REQUIRE __INIT_XDATA_I
    177          {
    178            ZCL_KEY_ESTABLISHMENT_ENDPOINT,                               // Test endpoint
    179            &zcl_TaskID,
    180            (SimpleDescriptionFormat_t *)&zclKeyEstablish_SimpleDesc,
    181            (afNetworkLatencyReq_t)0                           // No Network Latency req
    182          };
    183          #endif
    184          
    185          // Pointer to the application sequence number for ZCL commands
    186          #if defined ( ZCL_KEY_ESTABLISH)

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    187          static uint8 zclKeyEstablishPluginRegisted = FALSE;
   \                     zclKeyEstablishPluginRegisted:
   \   000000                DS 1
   \   000001                REQUIRE __INIT_XDATA_Z
    188          

   \                                 In  segment XDATA_Z, align 1, keep-with-next
    189          static zclKeyEstablishRec_t keyEstablishRec[MAX_KEY_ESTABLISHMENT_REC_ENTRY];
   \                     keyEstablishRec:
   \   000000                DS 78
   \   00004E                REQUIRE __INIT_XDATA_Z
    190          
    191          /*********************************************************************
    192           * LOCAL FUNCTIONS
    193           */
    194          static ZStatus_t zclGeneral_KeyEstablish_HdlIncoming( zclIncoming_t *pInMsg );
    195          
    196          static ZStatus_t zclGeneral_KeyEstablish_HdlInSpecificCommands( zclIncoming_t *pInMsg );
    197          
    198          // Key Establish Cluster Command Processing functions
    199          static ZStatus_t zclGeneral_ProcessInCmd_InitiateKeyEstablish( zclIncoming_t *pInMsg );
    200          static ZStatus_t zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp( zclIncoming_t *pInMsg );
    201          static ZStatus_t zclGeneral_ProcessInCmd_EphemeralDataReq( zclIncoming_t *pInMsg );
    202          static ZStatus_t zclGeneral_ProcessInCmd_EphemeralDataRsp( zclIncoming_t *pInMsg );
    203          static ZStatus_t zclGeneral_ProcessInCmd_ConfirmKey( zclIncoming_t *pInMsg );
    204          static ZStatus_t zclGeneral_ProcessInCmd_ConfirmKeyRsp( zclIncoming_t *pInMsg );
    205          static ZStatus_t zclGeneral_ProcessInCmd_TerminateKeyEstablish( zclIncoming_t *pInMsg );
    206          
    207          // Event driven key calculation function
    208          static ZStatus_t zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey(void);
    209          static ZStatus_t zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey(void);
    210          
    211          // Key establishment rec table management function
    212          static void zclGeneral_InitKeyEstablishRecTable( void );
    213          static uint8 zclGeneral_GetKeyEstablishRecIndex( uint16 partnerAddress );
    214          static uint8 zclGeneral_GetKeyEstablishRecIndex_State( KeyEstablishState_t state );
    215          static uint8 zclGeneral_AddKeyEstablishRec( afAddrType_t *addr );
    216          static void zclGeneral_AgeKeyEstablishRec( void );
    217          static void zclGeneral_ResetKeyEstablishRec( uint8 index );
    218          
    219          // Call back function supplying to ECC library
    220          static int zclGeneral_KeyEstablishment_GetRandom(unsigned char *buffer, unsigned long len);
    221          static int zclGeneral_KeyEstablishment_HashFunc(unsigned char *digest, unsigned long len, unsigned char *data);
    222          
    223          // Security related functions
    224          static void zclGeneral_KeyEstablishment_KeyDeriveFunction( uint8 *zData,
    225                                                                     uint8 keyBitLen,
    226                                                                     uint8 *keyBit );
    227          
    228          static ZStatus_t zclGeneral_KeyEstablishment_GenerateMAC(uint8 recIndex,
    229                                                                   uint8 ifMACu,
    230                                                                   uint8 *MAC);
    231          
    232          /*********************************************************************
    233           * @fn      zclGeneral_KeyEstablish_Init
    234           *
    235           * @brief   Call to initialize the Key Establishment Task
    236           *
    237           * @param   task_id
    238           *
    239           * @return  none
    240           */
    241          

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    242          void zclGeneral_KeyEstablish_Init( uint8 task_id )
   \                     zclGeneral_KeyEstablish_Init:
    243          {
   \   000000   74F6         MOV     A,#-0xa
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 10
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
    244            zcl_KeyEstablishment_TaskID = task_id;
   \   000007   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   00000A   F0           MOVX    @DPTR,A
    245          
    246            // Register for the key establishment cluster endpoint
    247            afRegister( &zclKeyEstablish_Ep );
   \   00000B                ; Setup parameters for call to function afRegister
   \   00000B   7A..         MOV     R2,#zclKeyEstablish_Ep & 0xff
   \   00000D   7B..         MOV     R3,#(zclKeyEstablish_Ep >> 8) & 0xff
   \   00000F   12....       LCALL   ??afRegister?relay
   \   000012   E9           MOV     A,R1
    248          
    249            zcl_registerClusterOptionList( ZCL_KEY_ESTABLISHMENT_ENDPOINT, 1,
    250                                           zclKeyEstablish_Options );
   \   000013                ; Setup parameters for call to function zcl_registerClusterOptionList
   \   000013   7C..         MOV     R4,#zclKeyEstablish_Options & 0xff
   \   000015   7D..         MOV     R5,#(zclKeyEstablish_Options >> 8) & 0xff
   \   000017   7A01         MOV     R2,#0x1
   \   000019   790A         MOV     R1,#0xa
   \   00001B   12....       LCALL   ??zcl_registerClusterOptionList?relay
   \   00001E   E9           MOV     A,R1
    251          
    252            // Register as a ZCL Plugin
    253            if ( !zclKeyEstablishPluginRegisted )
   \   00001F   90....       MOV     DPTR,#zclKeyEstablishPluginRegisted
   \   000022   E0           MOVX    A,@DPTR
   \   000023   7022         JNZ     ??zclGeneral_KeyEstablish_Init_0
    254            {
    255              zcl_registerPlugin( ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    256                                  ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    257                                  zclGeneral_KeyEstablish_HdlIncoming );
   \   000025                ; Setup parameters for call to function zcl_registerPlugin
   \   000025   75....       MOV     ?V0 + 0,#??zclGeneral_KeyEstablish_HdlIncoming?relay & 0xff
   \   000028   75....       MOV     ?V0 + 1,#(??zclGeneral_KeyEstablish_HdlIncoming?relay >> 8) & 0xff
   \   00002B   78..         MOV     R0,#?V0 + 0
   \   00002D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000030   7C00         MOV     R4,#0x0
   \   000032   7D08         MOV     R5,#0x8
   \   000034   7A00         MOV     R2,#0x0
   \   000036   7B08         MOV     R3,#0x8
   \   000038   12....       LCALL   ??zcl_registerPlugin?relay
   \   00003B   7402         MOV     A,#0x2
   \   00003D   12....       LCALL   ?DEALLOC_XSTACK8
   \   000040   E9           MOV     A,R1
    258              zclKeyEstablishPluginRegisted = TRUE;
   \   000041   90....       MOV     DPTR,#zclKeyEstablishPluginRegisted
   \   000044   7401         MOV     A,#0x1
   \   000046   F0           MOVX    @DPTR,A
    259            }
    260          
    261            // Initialize the keyEstablishRec table
    262            zclGeneral_InitKeyEstablishRecTable();
   \                     ??zclGeneral_KeyEstablish_Init_0:
   \   000047                ; Setup parameters for call to function zclGeneral_InitKeyEstablishRecTable
   \   000047   12....       LCALL   ??zclGeneral_InitKeyEstablishRecTable?relay
    263          }
   \   00004A   7F02         MOV     R7,#0x2
   \   00004C   02....       LJMP    ?BANKED_LEAVE_XDATA
    264          
    265          /*********************************************************************
    266           * @fn          zclKeyEstablish_event_loop
    267           *
    268           * @brief       Event Loop Processor for Key establish task.
    269           *
    270           * @param       task_id - TaskId
    271           *              events - events
    272           *
    273           * @return      none
    274           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    275          uint16 zclKeyEstablish_event_loop( uint8 task_id, uint16 events )
   \                     zclKeyEstablish_event_loop:
    276          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 2,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
    277            afIncomingMSGPacket_t *MSGpkt;
    278          
    279            if ( events & SYS_EVENT_MSG )
   \   00000B   EE           MOV     A,R6
   \   00000C   5400         ANL     A,#0x0
   \   00000E   F8           MOV     R0,A
   \   00000F   EF           MOV     A,R7
   \   000010   5480         ANL     A,#0x80
   \   000012   F9           MOV     R1,A
   \   000013   E8           MOV     A,R0
   \   000014   49           ORL     A,R1
   \   000015   6029         JZ      ??zclKeyEstablish_event_loop_0
    280            {
    281              while ( (MSGpkt = (afIncomingMSGPacket_t *)osal_msg_receive( task_id )) )
   \                     ??zclKeyEstablish_event_loop_1:
   \   000017                ; Setup parameters for call to function osal_msg_receive
   \   000017   A9..         MOV     R1,?V0 + 2
   \   000019   12....       LCALL   ??osal_msg_receive?relay
   \   00001C   8A..         MOV     ?V0 + 4,R2
   \   00001E   8B..         MOV     ?V0 + 5,R3
   \   000020   A8..         MOV     R0,?V0 + 4
   \   000022   A9..         MOV     R1,?V0 + 5
   \   000024   88..         MOV     ?V0 + 0,R0
   \   000026   89..         MOV     ?V0 + 1,R1
   \   000028   E8           MOV     A,R0
   \   000029   49           ORL     A,R1
   \   00002A   600A         JZ      ??zclKeyEstablish_event_loop_2
    282              {
    283                switch ( MSGpkt->hdr.event )
    284                {
    285                  default:
    286                    break;
    287                }
    288          
    289                // Release the memory
    290                osal_msg_deallocate( (uint8 *)MSGpkt );
   \   00002C                ; Setup parameters for call to function osal_msg_deallocate
   \   00002C   AA..         MOV     R2,?V0 + 0
   \   00002E   AB..         MOV     R3,?V0 + 1
   \   000030   12....       LCALL   ??osal_msg_deallocate?relay
   \   000033   E9           MOV     A,R1
   \   000034   80E1         SJMP    ??zclKeyEstablish_event_loop_1
    291              }
    292          
    293              // return unprocessed events
    294              return (events ^ SYS_EVENT_MSG);
   \                     ??zclKeyEstablish_event_loop_2:
   \   000036   EE           MOV     A,R6
   \   000037   6400         XRL     A,#0x0
   \   000039   FA           MOV     R2,A
   \   00003A   EF           MOV     A,R7
   \   00003B   6480         XRL     A,#0x80
   \   00003D   FB           MOV     R3,A
   \   00003E   803C         SJMP    ??zclKeyEstablish_event_loop_3
    295            }
    296          
    297            if ( events & KEY_ESTABLISHMENT_REC_AGING_EVT )
   \                     ??zclKeyEstablish_event_loop_0:
   \   000040   EE           MOV     A,R6
   \   000041   A2E0         MOV     C,0xE0 /* A   */.0
   \   000043   500D         JNC     ??zclKeyEstablish_event_loop_4
    298            {
    299          
    300              zclGeneral_AgeKeyEstablishRec();
   \   000045                ; Setup parameters for call to function zclGeneral_AgeKeyEstablishRec
   \   000045   12....       LCALL   ??zclGeneral_AgeKeyEstablishRec?relay
    301          
    302              return ( events ^ KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   000048   EE           MOV     A,R6
   \   000049   6401         XRL     A,#0x1
   \   00004B   FA           MOV     R2,A
   \   00004C   EF           MOV     A,R7
   \   00004D   6400         XRL     A,#0x0
   \   00004F   FB           MOV     R3,A
   \   000050   802A         SJMP    ??zclKeyEstablish_event_loop_3
    303            }
    304          
    305            if ( events & KEY_ESTABLISHMENT_CMD_PROCESS_EVT )
   \                     ??zclKeyEstablish_event_loop_4:
   \   000052   EE           MOV     A,R6
   \   000053   5402         ANL     A,#0x2
   \   000055   600E         JZ      ??zclKeyEstablish_event_loop_5
    306            {
    307              zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey();
   \   000057                ; Setup parameters for call to function zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey
   \   000057   12....       LCALL   ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate
   \   00005A   E9           MOV     A,R1
    308          
    309              return ( events ^ KEY_ESTABLISHMENT_CMD_PROCESS_EVT );
   \   00005B   EE           MOV     A,R6
   \   00005C   6402         XRL     A,#0x2
   \   00005E   FA           MOV     R2,A
   \   00005F   EF           MOV     A,R7
   \   000060   6400         XRL     A,#0x0
   \   000062   FB           MOV     R3,A
   \   000063   8017         SJMP    ??zclKeyEstablish_event_loop_3
    310            }
    311          
    312            if ( events & KEY_ESTABLISHMENT_RSP_PROCESS_EVT )
   \                     ??zclKeyEstablish_event_loop_5:
   \   000065   EE           MOV     A,R6
   \   000066   5404         ANL     A,#0x4
   \   000068   600E         JZ      ??zclKeyEstablish_event_loop_6
    313            {
    314              zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey();
   \   00006A                ; Setup parameters for call to function zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey
   \   00006A   12....       LCALL   ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate
   \   00006D   E9           MOV     A,R1
    315              return ( events ^ KEY_ESTABLISHMENT_RSP_PROCESS_EVT );
   \   00006E   EE           MOV     A,R6
   \   00006F   6404         XRL     A,#0x4
   \   000071   FA           MOV     R2,A
   \   000072   EF           MOV     A,R7
   \   000073   6400         XRL     A,#0x0
   \   000075   FB           MOV     R3,A
   \   000076   8004         SJMP    ??zclKeyEstablish_event_loop_3
    316            }
    317            // Discard unknown events
    318            return 0;
   \                     ??zclKeyEstablish_event_loop_6:
   \   000078   7A00         MOV     R2,#0x0
   \   00007A   7B00         MOV     R3,#0x0
   \                     ??zclKeyEstablish_event_loop_3:
   \   00007C   7F06         MOV     R7,#0x6
   \   00007E   02....       LJMP    ?BANKED_LEAVE_XDATA
    319          }
    320          
    321          /*********************************************************************
    322           * @fn      zclGeneral_KeyEstablish_InitiateKeyEstablishment
    323           *
    324           * @brief   Call to initiate key establishment with partner device
    325           *
    326           * @param   appTaskID - task ID of the application that initates the key establish
    327           * @param   partnerAddr - short address and endpoint of the partner to establish key with
    328           * @param   seqNum - pointer to the sequence number of application (ZCL)
    329           *
    330           * @return  ZStatus_t ZSuccess or ZFailure
    331           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    332          ZStatus_t zclGeneral_KeyEstablish_InitiateKeyEstablishment(uint8 appTaskID,
   \                     zclGeneral_KeyEstablish_InitiateKeyEstablishment:
    333                                                                     afAddrType_t *partnerAddr,
    334                                                                     uint8 seqNum)
    335          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 0
   \   000005   E9           MOV     A,R1
   \   000006   FE           MOV     R6,A
   \   000007   8A..         MOV     ?V0 + 2,R2
   \   000009   8B..         MOV     ?V0 + 3,R3
   \   00000B   8C..         MOV     ?V0 + 0,R4
    336            uint8 *implicitCert, index;
    337          
    338            // Assign the app seqnum pointer
    339            zcl_SeqNum = seqNum;
   \   00000D   E5..         MOV     A,?V0 + 0
   \   00000F   90....       MOV     DPTR,#zcl_SeqNum
   \   000012   F0           MOVX    @DPTR,A
    340          
    341            // Start a new key establishment rec entry
    342            index = zclGeneral_AddKeyEstablishRec( partnerAddr );
   \   000013                ; Setup parameters for call to function zclGeneral_AddKeyEstablishRec
   \   000013   AA..         MOV     R2,?V0 + 2
   \   000015   AB..         MOV     R3,?V0 + 3
   \   000017   12....       LCALL   ??zclGeneral_AddKeyEstablishRec?relay
   \   00001A   E9           MOV     A,R1
   \   00001B   FF           MOV     R7,A
    343          
    344            if( index < MAX_KEY_ESTABLISHMENT_REC_ENTRY ) // valid entry
   \   00001C   EF           MOV     A,R7
   \   00001D   C3           CLR     C
   \   00001E   9402         SUBB    A,#0x2
   \   000020   4003         JC      $+5
   \   000022   02....       LJMP    ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_1 & 0xFFFF
    345            {
    346              keyEstablishRec[index].role = KEY_ESTABLISHMENT_INITIATOR;
   \   000025   EF           MOV     A,R7
   \   000026   F8           MOV     R0,A
   \   000027   7900         MOV     R1,#0x0
   \   000029   E8           MOV     A,R0
   \   00002A   75F027       MOV     B,#0x27
   \   00002D   A4           MUL     AB
   \   00002E   C8           XCH     A,R0
   \   00002F   AAF0         MOV     R2,B
   \   000031   75F000       MOV     B,#0x0
   \   000034   A4           MUL     AB
   \   000035   2A           ADD     A,R2
   \   000036   FA           MOV     R2,A
   \   000037   75F027       MOV     B,#0x27
   \   00003A   E9           MOV     A,R1
   \   00003B   A4           MUL     AB
   \   00003C   2A           ADD     A,R2
   \   00003D   F9           MOV     R1,A
   \   00003E   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   000040   28           ADD     A,R0
   \   000041   F582         MOV     DPL,A
   \   000043   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000045   39           ADDC    A,R1
   \   000046   F583         MOV     DPH,A
   \   000048   7400         MOV     A,#0x0
   \   00004A   F0           MOVX    @DPTR,A
    347          
    348              // Assign the application task ID that initiates the key establishment
    349              keyEstablishRec[index].appTaskID = appTaskID;
   \   00004B   EE           MOV     A,R6
   \   00004C   C0E0         PUSH    A
   \   00004E   EF           MOV     A,R7
   \   00004F   F8           MOV     R0,A
   \   000050   7900         MOV     R1,#0x0
   \   000052   E8           MOV     A,R0
   \   000053   75F027       MOV     B,#0x27
   \   000056   A4           MUL     AB
   \   000057   C8           XCH     A,R0
   \   000058   AAF0         MOV     R2,B
   \   00005A   75F000       MOV     B,#0x0
   \   00005D   A4           MUL     AB
   \   00005E   2A           ADD     A,R2
   \   00005F   FA           MOV     R2,A
   \   000060   75F027       MOV     B,#0x27
   \   000063   E9           MOV     A,R1
   \   000064   A4           MUL     AB
   \   000065   2A           ADD     A,R2
   \   000066   F9           MOV     R1,A
   \   000067   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   000069   28           ADD     A,R0
   \   00006A   F582         MOV     DPL,A
   \   00006C   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   00006E   39           ADDC    A,R1
   \   00006F   F583         MOV     DPH,A
   \   000071   D0E0         POP     A
   \   000073   F0           MOVX    @DPTR,A
    350            }
    351            else
    352            {
    353              return ZFailure;
    354            }
    355          
    356            // Generate Ephemeral Public/Private Key Pair
    357            ZSE_ECCGenerateKey( ( unsigned char *)keyEstablishRec[index].pLocalEPrivateKey,
    358                               ( unsigned char *)keyEstablishRec[index].pLocalEPublicKey,
    359                               zclGeneral_KeyEstablishment_GetRandom,
    360                               zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel);
   \   000074                ; Setup parameters for call to function ZSE_ECCGenerateKey
   \   000074   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   000077   E0           MOVX    A,@DPTR
   \   000078   F5..         MOV     ?V0 + 4,A
   \   00007A   E4           CLR     A
   \   00007B   F5..         MOV     ?V0 + 5,A
   \   00007D   F5..         MOV     ?V0 + 6,A
   \   00007F   F5..         MOV     ?V0 + 7,A
   \   000081   78..         MOV     R0,#?V0 + 4
   \   000083   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   000086   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   000089   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00008C   75....       MOV     ?V0 + 4,#??zclGeneral_KeyEstablishment_GetRandom?relay & 0xff
   \   00008F   75....       MOV     ?V0 + 5,#(??zclGeneral_KeyEstablishment_GetRandom?relay >> 8) & 0xff
   \   000092   78..         MOV     R0,#?V0 + 4
   \   000094   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000097   EF           MOV     A,R7
   \   000098   F8           MOV     R0,A
   \   000099   7900         MOV     R1,#0x0
   \   00009B   E8           MOV     A,R0
   \   00009C   75F027       MOV     B,#0x27
   \   00009F   A4           MUL     AB
   \   0000A0   C8           XCH     A,R0
   \   0000A1   AAF0         MOV     R2,B
   \   0000A3   75F000       MOV     B,#0x0
   \   0000A6   A4           MUL     AB
   \   0000A7   2A           ADD     A,R2
   \   0000A8   FA           MOV     R2,A
   \   0000A9   75F027       MOV     B,#0x27
   \   0000AC   E9           MOV     A,R1
   \   0000AD   A4           MUL     AB
   \   0000AE   2A           ADD     A,R2
   \   0000AF   F9           MOV     R1,A
   \   0000B0   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   0000B2   28           ADD     A,R0
   \   0000B3   F582         MOV     DPL,A
   \   0000B5   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   0000B7   39           ADDC    A,R1
   \   0000B8   F583         MOV     DPH,A
   \   0000BA   E0           MOVX    A,@DPTR
   \   0000BB   FC           MOV     R4,A
   \   0000BC   A3           INC     DPTR
   \   0000BD   E0           MOVX    A,@DPTR
   \   0000BE   FD           MOV     R5,A
   \   0000BF   EF           MOV     A,R7
   \   0000C0   F8           MOV     R0,A
   \   0000C1   7900         MOV     R1,#0x0
   \   0000C3   E8           MOV     A,R0
   \   0000C4   75F027       MOV     B,#0x27
   \   0000C7   A4           MUL     AB
   \   0000C8   C8           XCH     A,R0
   \   0000C9   AAF0         MOV     R2,B
   \   0000CB   75F000       MOV     B,#0x0
   \   0000CE   A4           MUL     AB
   \   0000CF   2A           ADD     A,R2
   \   0000D0   FA           MOV     R2,A
   \   0000D1   75F027       MOV     B,#0x27
   \   0000D4   E9           MOV     A,R1
   \   0000D5   A4           MUL     AB
   \   0000D6   2A           ADD     A,R2
   \   0000D7   F9           MOV     R1,A
   \   0000D8   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   0000DA   28           ADD     A,R0
   \   0000DB   F582         MOV     DPL,A
   \   0000DD   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   0000DF   39           ADDC    A,R1
   \   0000E0   F583         MOV     DPH,A
   \   0000E2   E0           MOVX    A,@DPTR
   \   0000E3   FA           MOV     R2,A
   \   0000E4   A3           INC     DPTR
   \   0000E5   E0           MOVX    A,@DPTR
   \   0000E6   FB           MOV     R3,A
   \   0000E7   12....       LCALL   ??ZSE_ECCGenerateKey?relay
   \   0000EA   7408         MOV     A,#0x8
   \   0000EC   12....       LCALL   ?DEALLOC_XSTACK8
    361          
    362          #if defined (DEBUG_STATIC_ECC)
    363            // For debug and testing purpose, use a fixed ephermeral key pair instead
    364            // of the randomly generated one.
    365            osal_memcpy( keyEstablishRec[index].pLocalEPrivateKey, private1, 21 );
    366            osal_memcpy( keyEstablishRec[index].pLocalEPublicKey, public1, 22 );
    367          #endif
    368          
    369            keyEstablishRec[index].state = KeyEstablishState_InitiatePending;
   \   0000EF   EF           MOV     A,R7
   \   0000F0   F8           MOV     R0,A
   \   0000F1   7900         MOV     R1,#0x0
   \   0000F3   E8           MOV     A,R0
   \   0000F4   75F027       MOV     B,#0x27
   \   0000F7   A4           MUL     AB
   \   0000F8   C8           XCH     A,R0
   \   0000F9   AAF0         MOV     R2,B
   \   0000FB   75F000       MOV     B,#0x0
   \   0000FE   A4           MUL     AB
   \   0000FF   2A           ADD     A,R2
   \   000100   FA           MOV     R2,A
   \   000101   75F027       MOV     B,#0x27
   \   000104   E9           MOV     A,R1
   \   000105   A4           MUL     AB
   \   000106   2A           ADD     A,R2
   \   000107   F9           MOV     R1,A
   \   000108   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   00010A   28           ADD     A,R0
   \   00010B   F582         MOV     DPL,A
   \   00010D   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   00010F   39           ADDC    A,R1
   \   000110   F583         MOV     DPH,A
   \   000112   7401         MOV     A,#0x1
   \   000114   F0           MOVX    @DPTR,A
    370          
    371            if ((implicitCert = osal_mem_alloc(ZCL_KE_IMPLICIT_CERTIFICATE_LEN)) == NULL)
   \   000115                ; Setup parameters for call to function osal_mem_alloc
   \   000115   7A30         MOV     R2,#0x30
   \   000117   7B00         MOV     R3,#0x0
   \   000119   12....       LCALL   ??osal_mem_alloc?relay
   \   00011C   8A..         MOV     ?V0 + 4,R2
   \   00011E   8B..         MOV     ?V0 + 5,R3
   \   000120   A8..         MOV     R0,?V0 + 4
   \   000122   A9..         MOV     R1,?V0 + 5
   \   000124   88..         MOV     ?V0 + 8,R0
   \   000126   89..         MOV     ?V0 + 9,R1
   \   000128   E8           MOV     A,R0
   \   000129   49           ORL     A,R1
   \   00012A   700C         JNZ     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_2
   \   00012C   8005         SJMP    ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_3
   \                     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_1:
   \   00012E   7901         MOV     R1,#0x1
   \   000130   02....       LJMP    ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_4 & 0xFFFF
    372            {
    373              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \                     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_3:
   \   000133   79C1         MOV     R1,#-0x3f
   \   000135   02....       LJMP    ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_4 & 0xFFFF
    374            }
    375            osal_nv_read(ZCD_NV_IMPLICIT_CERTIFICATE, 0, ZCL_KE_IMPLICIT_CERTIFICATE_LEN, implicitCert);
   \                     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_2:
   \   000138                ; Setup parameters for call to function osal_nv_read
   \   000138   78..         MOV     R0,#?V0 + 8
   \   00013A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00013D   75..30       MOV     ?V0 + 4,#0x30
   \   000140   75..00       MOV     ?V0 + 5,#0x0
   \   000143   78..         MOV     R0,#?V0 + 4
   \   000145   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000148   7C00         MOV     R4,#0x0
   \   00014A   7D00         MOV     R5,#0x0
   \   00014C   7A69         MOV     R2,#0x69
   \   00014E   7B00         MOV     R3,#0x0
   \   000150   12....       LCALL   ??osal_nv_read?relay
   \   000153   7404         MOV     A,#0x4
   \   000155   12....       LCALL   ?DEALLOC_XSTACK8
   \   000158   E9           MOV     A,R1
    376          
    377            // Send Initiate Key Establishment Command
    378            zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
    379                       partnerAddr,
    380                       KEY_ESTABLISHMENT_SUITE,
    381                       ZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT,
    382                       ZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT + ZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT,
    383                       implicitCert, TRUE, zcl_SeqNum++ );
   \   000159   90....       MOV     DPTR,#zcl_SeqNum
   \   00015C   E0           MOVX    A,@DPTR
   \   00015D   F8           MOV     R0,A
   \   00015E   7401         MOV     A,#0x1
   \   000160   28           ADD     A,R0
   \   000161   90....       MOV     DPTR,#zcl_SeqNum
   \   000164   F0           MOVX    @DPTR,A
   \   000165                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment
   \   000165   E8           MOV     A,R0
   \   000166   F5..         MOV     ?V0 + 1,A
   \   000168   78..         MOV     R0,#?V0 + 1
   \   00016A   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00016D   75..01       MOV     ?V0 + 1,#0x1
   \   000170   78..         MOV     R0,#?V0 + 1
   \   000172   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000175   78..         MOV     R0,#?V0 + 8
   \   000177   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00017A   75..0E       MOV     ?V0 + 1,#0xe
   \   00017D   78..         MOV     R0,#?V0 + 1
   \   00017F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000182   75..0A       MOV     ?V0 + 1,#0xa
   \   000185   78..         MOV     R0,#?V0 + 1
   \   000187   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00018A   7C01         MOV     R4,#0x1
   \   00018C   7D00         MOV     R5,#0x0
   \   00018E   AA..         MOV     R2,?V0 + 2
   \   000190   AB..         MOV     R3,?V0 + 3
   \   000192   790A         MOV     R1,#0xa
   \   000194   12....       LCALL   ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab
   \   000197   7406         MOV     A,#0x6
   \   000199   12....       LCALL   ?DEALLOC_XSTACK8
   \   00019C   E9           MOV     A,R1
    384          
    385            // Start the Key Establishment aging timer, this has to be started to make sure the record
    386            // is going to be deleted in the event that "Key Establishment Response" is not received for
    387            // any reason. This way we do not have hanging records in the table and memory leak issues.
    388            osal_start_reload_timer( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT,
    389                                     KEY_ESTABLISHMENT_REC_AGING_INTERVAL );
   \   00019D                ; Setup parameters for call to function osal_start_reload_timer
   \   00019D   7CE8         MOV     R4,#-0x18
   \   00019F   7D03         MOV     R5,#0x3
   \   0001A1   7A01         MOV     R2,#0x1
   \   0001A3   7B00         MOV     R3,#0x0
   \   0001A5   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   0001A8   E0           MOVX    A,@DPTR
   \   0001A9   F9           MOV     R1,A
   \   0001AA   12....       LCALL   ??osal_start_reload_timer?relay
   \   0001AD   E9           MOV     A,R1
    390          
    391            osal_mem_free(implicitCert);
   \   0001AE                ; Setup parameters for call to function osal_mem_free
   \   0001AE   AA..         MOV     R2,?V0 + 8
   \   0001B0   AB..         MOV     R3,?V0 + 9
   \   0001B2   12....       LCALL   ??osal_mem_free?relay
    392          
    393          #if defined (NWK_AUTO_POLL)
    394            // Start the key establishment process and set the Key Establish poll rate
    395            zclSavedPollRate = zgPollRate;
   \   0001B5   90....       MOV     DPTR,#zgPollRate
   \   0001B8   E0           MOVX    A,@DPTR
   \   0001B9   F8           MOV     R0,A
   \   0001BA   A3           INC     DPTR
   \   0001BB   E0           MOVX    A,@DPTR
   \   0001BC   F9           MOV     R1,A
   \   0001BD   90....       MOV     DPTR,#zclSavedPollRate
   \   0001C0   E8           MOV     A,R0
   \   0001C1   F0           MOVX    @DPTR,A
   \   0001C2   A3           INC     DPTR
   \   0001C3   E9           MOV     A,R1
   \   0001C4   F0           MOVX    @DPTR,A
    396            NLME_SetPollRate(ZCL_KEY_ESTABLISH_POLL_RATE);
   \   0001C5                ; Setup parameters for call to function NLME_SetPollRate
   \   0001C5   7AE8         MOV     R2,#-0x18
   \   0001C7   7B03         MOV     R3,#0x3
   \   0001C9   12....       LCALL   ??NLME_SetPollRate?relay
    397          #endif
    398          
    399            return ZSuccess;
   \   0001CC   7900         MOV     R1,#0x0
   \                     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm_4:
   \   0001CE   7F0A         MOV     R7,#0xa
   \   0001D0   02....       LJMP    ?BANKED_LEAVE_XDATA
    400          }
    401          
    402          /*********************************************************************
    403           * @fn      zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment
    404           *
    405           * @brief   Call to send out a Initiate Key Establishment Command
    406           *
    407           * @param   srcEP - Sending application's endpoint
    408           * @param   dstAddr - where you want the message to go
    409           * @param   keyEstablishmentSuite - key establishment suite bitmap
    410           * @param   keyGenerateTime - how long it takes to generate key
    411           * @param   macGenerateTime - how long it takes to generate mac
    412           * @param   certificate - identity. For CBKE, it's the implicit certificate.
    413           * @param   disableDefaultRsp - disable default response
    414           * @param   seqNum - ZCL sequence number
    415           *
    416           * @return  ZStatus_t
    417           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    418          ZStatus_t zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment:
    419                                                       uint16 keyEstablishmentSuite,
    420                                                       uint8  keyGenerateTime,
    421                                                       uint8  macGenerateTime,
    422                                                       uint8 *certificate,
    423                                                       uint8 disableDefaultRsp, uint8 seqNum )
    424          {
   \   000000   74E8         MOV     A,#-0x18
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 24
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 13,R1
   \   000007   8A..         MOV     ?V0 + 14,R2
   \   000009   8B..         MOV     ?V0 + 15,R3
   \   00000B   8C..         MOV     ?V0 + 0,R4
   \   00000D   8D..         MOV     ?V0 + 1,R5
   \   00000F   7418         MOV     A,#0x18
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 9,A
   \   000017   7419         MOV     A,#0x19
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 8,A
   \   00001F   741C         MOV     A,#0x1c
   \   000021   12....       LCALL   ?XSTACK_DISP0_8
   \   000024   E0           MOVX    A,@DPTR
   \   000025   F5..         MOV     ?V0 + 12,A
   \   000027   741D         MOV     A,#0x1d
   \   000029   12....       LCALL   ?XSTACK_DISP0_8
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   F5..         MOV     ?V0 + 11,A
    425            uint8 *buf;
    426            uint8 *pBuf;
    427            uint8 status;
    428            uint8 bufLen;
    429          
    430            (void)srcEP; // Intentionally unreferenced parameter
    431          
    432            // keyEstablishmentSuite + eDataGenerateTime + macGenerateTime + certificate
    433            bufLen = 2 + 1 + 1 + ZCL_KE_IMPLICIT_CERTIFICATE_LEN;
   \   00002F   75..34       MOV     ?V0 + 7,#0x34
    434          
    435            if ((buf = osal_mem_alloc(bufLen)) == NULL)
   \   000032                ; Setup parameters for call to function osal_mem_alloc
   \   000032   85....       MOV     ?V0 + 4,?V0 + 7
   \   000035   75..00       MOV     ?V0 + 5,#0x0
   \   000038   AA..         MOV     R2,?V0 + 4
   \   00003A   AB..         MOV     R3,?V0 + 5
   \   00003C   12....       LCALL   ??osal_mem_alloc?relay
   \   00003F   8A..         MOV     ?V0 + 4,R2
   \   000041   8B..         MOV     ?V0 + 5,R3
   \   000043   A8..         MOV     R0,?V0 + 4
   \   000045   A9..         MOV     R1,?V0 + 5
   \   000047   88..         MOV     ?V0 + 2,R0
   \   000049   89..         MOV     ?V0 + 3,R1
   \   00004B   E8           MOV     A,R0
   \   00004C   49           ORL     A,R1
   \   00004D   7005         JNZ     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_2
    436            {
    437              return ZMemError;
   \   00004F   7910         MOV     R1,#0x10
   \   000051   02....       LJMP    ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_3 & 0xFFFF
    438            }
    439          
    440            pBuf = buf;
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_2:
   \   000054   AE..         MOV     R6,?V0 + 2
   \   000056   AF..         MOV     R7,?V0 + 3
    441          
    442            *pBuf++ = LO_UINT16( keyEstablishmentSuite );
   \   000058   E5..         MOV     A,?V0 + 0
   \   00005A   8E82         MOV     DPL,R6
   \   00005C   8F83         MOV     DPH,R7
   \   00005E   E5..         MOV     A,?V0 + 0
   \   000060   F0           MOVX    @DPTR,A
   \   000061   8E82         MOV     DPL,R6
   \   000063   8F83         MOV     DPH,R7
   \   000065   A3           INC     DPTR
   \   000066   AE82         MOV     R6,DPL
   \   000068   AF83         MOV     R7,DPH
    443            *pBuf++ = HI_UINT16( keyEstablishmentSuite );
   \   00006A   A8..         MOV     R0,?V0 + 0
   \   00006C   A9..         MOV     R1,?V0 + 1
   \   00006E   E4           CLR     A
   \   00006F   E5..         MOV     A,?V0 + 1
   \   000071   A8..         MOV     R0,?V0 + 1
   \   000073   E5..         MOV     A,?V0 + 1
   \   000075   8E82         MOV     DPL,R6
   \   000077   8F83         MOV     DPH,R7
   \   000079   E5..         MOV     A,?V0 + 1
   \   00007B   F0           MOVX    @DPTR,A
   \   00007C   8E82         MOV     DPL,R6
   \   00007E   8F83         MOV     DPH,R7
   \   000080   A3           INC     DPTR
   \   000081   AE82         MOV     R6,DPL
   \   000083   AF83         MOV     R7,DPH
    444            *pBuf++ = keyGenerateTime;
   \   000085   E5..         MOV     A,?V0 + 9
   \   000087   8E82         MOV     DPL,R6
   \   000089   8F83         MOV     DPH,R7
   \   00008B   E5..         MOV     A,?V0 + 9
   \   00008D   F0           MOVX    @DPTR,A
   \   00008E   8E82         MOV     DPL,R6
   \   000090   8F83         MOV     DPH,R7
   \   000092   A3           INC     DPTR
   \   000093   AE82         MOV     R6,DPL
   \   000095   AF83         MOV     R7,DPH
    445            *pBuf++ = macGenerateTime;
   \   000097   E5..         MOV     A,?V0 + 8
   \   000099   8E82         MOV     DPL,R6
   \   00009B   8F83         MOV     DPH,R7
   \   00009D   E5..         MOV     A,?V0 + 8
   \   00009F   F0           MOVX    @DPTR,A
   \   0000A0   8E82         MOV     DPL,R6
   \   0000A2   8F83         MOV     DPH,R7
   \   0000A4   A3           INC     DPTR
   \   0000A5   AE82         MOV     R6,DPL
   \   0000A7   AF83         MOV     R7,DPH
    446            osal_memcpy( pBuf, certificate, ZCL_KE_IMPLICIT_CERTIFICATE_LEN );
   \   0000A9                ; Setup parameters for call to function osal_memcpy
   \   0000A9   741A         MOV     A,#0x1a
   \   0000AB   12....       LCALL   ?XSTACK_DISP0_8
   \   0000AE   E0           MOVX    A,@DPTR
   \   0000AF   F5..         MOV     ?V0 + 4,A
   \   0000B1   A3           INC     DPTR
   \   0000B2   E0           MOVX    A,@DPTR
   \   0000B3   F5..         MOV     ?V0 + 5,A
   \   0000B5   75..00       MOV     ?V0 + 6,#0x0
   \   0000B8   78..         MOV     R0,#?V0 + 4
   \   0000BA   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000BD   7C30         MOV     R4,#0x30
   \   0000BF   7D00         MOV     R5,#0x0
   \   0000C1   EE           MOV     A,R6
   \   0000C2   FA           MOV     R2,A
   \   0000C3   EF           MOV     A,R7
   \   0000C4   FB           MOV     R3,A
   \   0000C5   12....       LCALL   ??osal_memcpy?relay
   \   0000C8   7403         MOV     A,#0x3
   \   0000CA   12....       LCALL   ?DEALLOC_XSTACK8
    447          
    448            status = zcl_SendCommand( ZCL_KEY_ESTABLISHMENT_ENDPOINT, dstAddr,
    449                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    450                                     COMMAND_INITIATE_KEY_ESTABLISHMENT, TRUE,
    451                                     ZCL_FRAME_CLIENT_SERVER_DIR, disableDefaultRsp,
    452                                     0, seqNum, bufLen, buf );
   \   0000CD                ; Setup parameters for call to function zcl_SendCommand
   \   0000CD   78..         MOV     R0,#?V0 + 2
   \   0000CF   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D2   85....       MOV     ?V0 + 4,?V0 + 7
   \   0000D5   75..00       MOV     ?V0 + 5,#0x0
   \   0000D8   78..         MOV     R0,#?V0 + 4
   \   0000DA   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000DD   E5..         MOV     A,?V0 + 11
   \   0000DF   F5..         MOV     ?V0 + 4,A
   \   0000E1   78..         MOV     R0,#?V0 + 4
   \   0000E3   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000E6   E4           CLR     A
   \   0000E7   F5..         MOV     ?V0 + 4,A
   \   0000E9   F5..         MOV     ?V0 + 5,A
   \   0000EB   78..         MOV     R0,#?V0 + 4
   \   0000ED   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000F0   E5..         MOV     A,?V0 + 12
   \   0000F2   F5..         MOV     ?V0 + 4,A
   \   0000F4   78..         MOV     R0,#?V0 + 4
   \   0000F6   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000F9   75..00       MOV     ?V0 + 4,#0x0
   \   0000FC   78..         MOV     R0,#?V0 + 4
   \   0000FE   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000101   75..01       MOV     ?V0 + 4,#0x1
   \   000104   78..         MOV     R0,#?V0 + 4
   \   000106   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000109   75..00       MOV     ?V0 + 4,#0x0
   \   00010C   78..         MOV     R0,#?V0 + 4
   \   00010E   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000111   7C00         MOV     R4,#0x0
   \   000113   7D08         MOV     R5,#0x8
   \   000115   AA..         MOV     R2,?V0 + 14
   \   000117   AB..         MOV     R3,?V0 + 15
   \   000119   790A         MOV     R1,#0xa
   \   00011B   12....       LCALL   ??zcl_SendCommand?relay
   \   00011E   740B         MOV     A,#0xb
   \   000120   12....       LCALL   ?DEALLOC_XSTACK8
   \   000123   E9           MOV     A,R1
   \   000124   F5..         MOV     ?V0 + 10,A
    453          
    454            osal_mem_free(buf);
   \   000126                ; Setup parameters for call to function osal_mem_free
   \   000126   AA..         MOV     R2,?V0 + 2
   \   000128   AB..         MOV     R3,?V0 + 3
   \   00012A   12....       LCALL   ??osal_mem_free?relay
    455          
    456            return status;
   \   00012D   A9..         MOV     R1,?V0 + 10
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_3:
   \   00012F   7F10         MOV     R7,#0x10
   \   000131   02....       LJMP    ?BANKED_LEAVE_XDATA
    457          }
    458          
    459          /*********************************************************************
    460           * @fn      zclGeneral_KeyEstablish_Send_EphemeralDataReq
    461           *
    462           * @brief   Call to send out a Ephemeral Data Request Command
    463           *
    464           * @param   srcEP - Sending application's endpoint
    465           * @param   dstAddr - where you want the message to go
    466           * @param   eData - ephemeral data.
    467           * @param   disableDefaultRsp - disable default response
    468           * @param   seqNum - ZCL sequence number
    469           *
    470           * @return  ZStatus_t
    471           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    472          ZStatus_t zclGeneral_KeyEstablish_Send_EphemeralDataReq( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_EphemeralDataReq:
    473                                                       uint8 *eData,
    474                                                       uint8 disableDefaultRsp, uint8 seqNum )
    475          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 2,R4
   \   00000D   8D..         MOV     ?V0 + 3,R5
   \   00000F   7410         MOV     A,#0x10
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 1,A
   \   000017   7411         MOV     A,#0x11
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 4,A
    476            return zcl_SendCommand( srcEP, dstAddr,
    477                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    478                                     COMMAND_EPHEMERAL_DATA_REQUEST, TRUE,
    479                                     ZCL_FRAME_CLIENT_SERVER_DIR, disableDefaultRsp,
    480                                     0, seqNum, ZCL_KE_CA_PUBLIC_KEY_LEN, eData );
   \   00001F                ; Setup parameters for call to function zcl_SendCommand
   \   00001F   78..         MOV     R0,#?V0 + 2
   \   000021   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000024   75..16       MOV     ?V0 + 6,#0x16
   \   000027   75..00       MOV     ?V0 + 7,#0x0
   \   00002A   78..         MOV     R0,#?V0 + 6
   \   00002C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002F   E5..         MOV     A,?V0 + 4
   \   000031   F5..         MOV     ?V0 + 5,A
   \   000033   78..         MOV     R0,#?V0 + 5
   \   000035   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000038   E4           CLR     A
   \   000039   F5..         MOV     ?V0 + 6,A
   \   00003B   F5..         MOV     ?V0 + 7,A
   \   00003D   78..         MOV     R0,#?V0 + 6
   \   00003F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000042   E5..         MOV     A,?V0 + 1
   \   000044   F5..         MOV     ?V0 + 5,A
   \   000046   78..         MOV     R0,#?V0 + 5
   \   000048   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00004B   75..00       MOV     ?V0 + 5,#0x0
   \   00004E   78..         MOV     R0,#?V0 + 5
   \   000050   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000053   75..01       MOV     ?V0 + 5,#0x1
   \   000056   78..         MOV     R0,#?V0 + 5
   \   000058   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00005B   75..01       MOV     ?V0 + 5,#0x1
   \   00005E   78..         MOV     R0,#?V0 + 5
   \   000060   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000063   7C00         MOV     R4,#0x0
   \   000065   7D08         MOV     R5,#0x8
   \   000067   EE           MOV     A,R6
   \   000068   FA           MOV     R2,A
   \   000069   EF           MOV     A,R7
   \   00006A   FB           MOV     R3,A
   \   00006B   A9..         MOV     R1,?V0 + 0
   \   00006D   12....       LCALL   ??zcl_SendCommand?relay
   \   000070   740B         MOV     A,#0xb
   \   000072   12....       LCALL   ?DEALLOC_XSTACK8
   \   000075   7F08         MOV     R7,#0x8
   \   000077   02....       LJMP    ?BANKED_LEAVE_XDATA
    481          }
    482          
    483          /*********************************************************************
    484           * @fn      zclGeneral_KeyEstablish_Send_ConfirmKey
    485           *
    486           * @brief   Call to send out a Confirm Key Command
    487           *
    488           * @param   srcEP - Sending application's endpoint
    489           * @param   dstAddr - where you want the message to go
    490           * @param   mac - MAC.
    491           * @param   disableDefaultRsp - disable default response
    492           * @param   seqNum - ZCL sequence number
    493           *
    494           * @return  ZStatus_t
    495           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    496          ZStatus_t zclGeneral_KeyEstablish_Send_ConfirmKey( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_ConfirmKey:
    497                                                       uint8 *mac,
    498                                                       uint8 disableDefaultRsp, uint8 seqNum )
    499          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 2,R4
   \   00000D   8D..         MOV     ?V0 + 3,R5
   \   00000F   7410         MOV     A,#0x10
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 1,A
   \   000017   7411         MOV     A,#0x11
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 4,A
    500            return (zcl_SendCommand(srcEP, dstAddr,
    501                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    502                                     COMMAND_CONFIRM_KEY, TRUE,
    503                                     ZCL_FRAME_CLIENT_SERVER_DIR, disableDefaultRsp,
    504                                     0, seqNum, KEY_ESTABLISH_MAC_LENGTH, mac ));
   \   00001F                ; Setup parameters for call to function zcl_SendCommand
   \   00001F   78..         MOV     R0,#?V0 + 2
   \   000021   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000024   75..10       MOV     ?V0 + 6,#0x10
   \   000027   75..00       MOV     ?V0 + 7,#0x0
   \   00002A   78..         MOV     R0,#?V0 + 6
   \   00002C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002F   E5..         MOV     A,?V0 + 4
   \   000031   F5..         MOV     ?V0 + 5,A
   \   000033   78..         MOV     R0,#?V0 + 5
   \   000035   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000038   E4           CLR     A
   \   000039   F5..         MOV     ?V0 + 6,A
   \   00003B   F5..         MOV     ?V0 + 7,A
   \   00003D   78..         MOV     R0,#?V0 + 6
   \   00003F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000042   E5..         MOV     A,?V0 + 1
   \   000044   F5..         MOV     ?V0 + 5,A
   \   000046   78..         MOV     R0,#?V0 + 5
   \   000048   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00004B   75..00       MOV     ?V0 + 5,#0x0
   \   00004E   78..         MOV     R0,#?V0 + 5
   \   000050   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000053   75..01       MOV     ?V0 + 5,#0x1
   \   000056   78..         MOV     R0,#?V0 + 5
   \   000058   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00005B   75..02       MOV     ?V0 + 5,#0x2
   \   00005E   78..         MOV     R0,#?V0 + 5
   \   000060   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000063   7C00         MOV     R4,#0x0
   \   000065   7D08         MOV     R5,#0x8
   \   000067   EE           MOV     A,R6
   \   000068   FA           MOV     R2,A
   \   000069   EF           MOV     A,R7
   \   00006A   FB           MOV     R3,A
   \   00006B   A9..         MOV     R1,?V0 + 0
   \   00006D   12....       LCALL   ??zcl_SendCommand?relay
   \   000070   740B         MOV     A,#0xb
   \   000072   12....       LCALL   ?DEALLOC_XSTACK8
   \   000075   7F08         MOV     R7,#0x8
   \   000077   02....       LJMP    ?BANKED_LEAVE_XDATA
    505          }
    506          
    507          /*********************************************************************
    508           * @fn      zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
    509           *
    510           * @brief   Call to send out a Terminate Key Establishment Command
    511           *
    512           * @param   srcEP - Sending application's endpoint
    513           * @param   dstAddr - where you want the message to go
    514           * @param   status - status of the key establishment procedure.
    515           * @param   direction - client/server direction of the command
    516           * @param   disableDefaultRsp - disable default response
    517           * @param   seqNum - ZCL sequence number
    518           *
    519           * @return  ZStatus_t
    520           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    521          ZStatus_t zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( uint8 srcEP,
   \                     zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment:
    522                                                       afAddrType_t *dstAddr,
    523                                                       TermKeyStatus_t status,
    524                                                       uint8 waitTime,
    525                                                       uint16 keyEstablishmentSuite, uint8 direction,
    526                                                       uint8 disableDefaultRsp, uint8 seqNum )
    527          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 4
   \   000005   74FC         MOV     A,#-0x4
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   89..         MOV     ?V0 + 0,R1
   \   00000C   8A..         MOV     ?V0 + 8,R2
   \   00000E   8B..         MOV     ?V0 + 9,R3
   \   000010   8C..         MOV     ?V0 + 2,R4
   \   000012   8D..         MOV     ?V0 + 3,R5
   \   000014   7416         MOV     A,#0x16
   \   000016   12....       LCALL   ?XSTACK_DISP0_8
   \   000019   E0           MOVX    A,@DPTR
   \   00001A   FE           MOV     R6,A
   \   00001B   A3           INC     DPTR
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   FF           MOV     R7,A
   \   00001E   7418         MOV     A,#0x18
   \   000020   12....       LCALL   ?XSTACK_DISP0_8
   \   000023   E0           MOVX    A,@DPTR
   \   000024   F5..         MOV     ?V0 + 5,A
   \   000026   7419         MOV     A,#0x19
   \   000028   12....       LCALL   ?XSTACK_DISP0_8
   \   00002B   E0           MOVX    A,@DPTR
   \   00002C   F5..         MOV     ?V0 + 4,A
   \   00002E   741A         MOV     A,#0x1a
   \   000030   12....       LCALL   ?XSTACK_DISP0_8
   \   000033   E0           MOVX    A,@DPTR
   \   000034   F5..         MOV     ?V0 + 1,A
    528            uint8 buf[4];
    529          
    530            buf[0] = status;
   \   000036   E5..         MOV     A,?V0 + 2
   \   000038   85..82       MOV     DPL,?XSP + 0
   \   00003B   85..83       MOV     DPH,?XSP + 1
   \   00003E   E5..         MOV     A,?V0 + 2
   \   000040   F0           MOVX    @DPTR,A
    531            buf[1] = waitTime;
   \   000041   E5..         MOV     A,?V0 + 3
   \   000043   7401         MOV     A,#0x1
   \   000045   12....       LCALL   ?XSTACK_DISP0_8
   \   000048   E5..         MOV     A,?V0 + 3
   \   00004A   F0           MOVX    @DPTR,A
    532            buf[2] = LO_UINT16(keyEstablishmentSuite);
   \   00004B   EE           MOV     A,R6
   \   00004C   C0E0         PUSH    A
   \   00004E   7402         MOV     A,#0x2
   \   000050   12....       LCALL   ?XSTACK_DISP0_8
   \   000053   D0E0         POP     A
   \   000055   F0           MOVX    @DPTR,A
    533            buf[3] = HI_UINT16(keyEstablishmentSuite);
   \   000056   EE           MOV     A,R6
   \   000057   F8           MOV     R0,A
   \   000058   EF           MOV     A,R7
   \   000059   F9           MOV     R1,A
   \   00005A   E4           CLR     A
   \   00005B   E9           MOV     A,R1
   \   00005C   F8           MOV     R0,A
   \   00005D   C0E0         PUSH    A
   \   00005F   7403         MOV     A,#0x3
   \   000061   12....       LCALL   ?XSTACK_DISP0_8
   \   000064   D0E0         POP     A
   \   000066   F0           MOVX    @DPTR,A
    534          
    535            return zcl_SendCommand(srcEP, dstAddr,
    536                                   ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    537                                   COMMAND_TERMINATE_KEY_ESTABLISHMENT, TRUE,
    538                                   direction, disableDefaultRsp,
    539                                   0, seqNum, 4, buf );
   \   000067                ; Setup parameters for call to function zcl_SendCommand
   \   000067   85..82       MOV     DPL,?XSP + 0
   \   00006A   85..83       MOV     DPH,?XSP + 1
   \   00006D   8582..       MOV     ?V0 + 6,DPL
   \   000070   8583..       MOV     ?V0 + 7,DPH
   \   000073   78..         MOV     R0,#?V0 + 6
   \   000075   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000078   75..04       MOV     ?V0 + 6,#0x4
   \   00007B   75..00       MOV     ?V0 + 7,#0x0
   \   00007E   78..         MOV     R0,#?V0 + 6
   \   000080   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000083   E5..         MOV     A,?V0 + 1
   \   000085   F5..         MOV     ?V0 + 6,A
   \   000087   78..         MOV     R0,#?V0 + 6
   \   000089   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00008C   E4           CLR     A
   \   00008D   F5..         MOV     ?V0 + 6,A
   \   00008F   F5..         MOV     ?V0 + 7,A
   \   000091   78..         MOV     R0,#?V0 + 6
   \   000093   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000096   E5..         MOV     A,?V0 + 4
   \   000098   F5..         MOV     ?V0 + 6,A
   \   00009A   78..         MOV     R0,#?V0 + 6
   \   00009C   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00009F   E5..         MOV     A,?V0 + 5
   \   0000A1   F5..         MOV     ?V0 + 6,A
   \   0000A3   78..         MOV     R0,#?V0 + 6
   \   0000A5   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000A8   75..01       MOV     ?V0 + 6,#0x1
   \   0000AB   78..         MOV     R0,#?V0 + 6
   \   0000AD   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000B0   75..03       MOV     ?V0 + 6,#0x3
   \   0000B3   78..         MOV     R0,#?V0 + 6
   \   0000B5   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000B8   7C00         MOV     R4,#0x0
   \   0000BA   7D08         MOV     R5,#0x8
   \   0000BC   AA..         MOV     R2,?V0 + 8
   \   0000BE   AB..         MOV     R3,?V0 + 9
   \   0000C0   A9..         MOV     R1,?V0 + 0
   \   0000C2   12....       LCALL   ??zcl_SendCommand?relay
   \   0000C5   740B         MOV     A,#0xb
   \   0000C7   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000CA   7404         MOV     A,#0x4
   \   0000CC   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000CF   7F0A         MOV     R7,#0xa
   \   0000D1   02....       LJMP    ?BANKED_LEAVE_XDATA
    540          }
    541          
    542          /*********************************************************************
    543           * @fn      zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp
    544           *
    545           * @brief   Call to send out a Initiate Key Establishment Response
    546           *
    547           * @param   srcEP - Sending application's endpoint
    548           * @param   dstAddr - where you want the message to go
    549           * @param   status - status of the key establishment response.
    550           * @param   keyEstablishmentSuite - requested key establishment suite bitmap
    551           * @param   keyGenerateTime - how long it takes to generate key
    552           * @param   macGenerateTime - how long it takes to generate mac
    553           * @param   certificate - identity. For CBKE, it's the implicit certificate.
    554           * @param   disableDefaultRsp - disable default response
    555           * @param   seqNum - ZCL sequence number
    556           *
    557           * @return  ZStatus_t
    558           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    559          ZStatus_t zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp:
    560                                                       uint16 keyEstablishmentSuite,
    561                                                       uint8  keyGenerateTime,
    562                                                       uint8  macGenerateTime,
    563                                                       uint8 *certificate,
    564                                                       uint8 disableDefaultRsp, uint8 seqNum )
    565          {
   \   000000   74E8         MOV     A,#-0x18
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 24
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 10,R1
   \   000007   8A..         MOV     ?V0 + 14,R2
   \   000009   8B..         MOV     ?V0 + 15,R3
   \   00000B   8C..         MOV     ?V0 + 0,R4
   \   00000D   8D..         MOV     ?V0 + 1,R5
   \   00000F   7418         MOV     A,#0x18
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 9,A
   \   000017   7419         MOV     A,#0x19
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 8,A
   \   00001F   741C         MOV     A,#0x1c
   \   000021   12....       LCALL   ?XSTACK_DISP0_8
   \   000024   E0           MOVX    A,@DPTR
   \   000025   F5..         MOV     ?V0 + 13,A
   \   000027   741D         MOV     A,#0x1d
   \   000029   12....       LCALL   ?XSTACK_DISP0_8
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   F5..         MOV     ?V0 + 12,A
    566            uint8 *buf;
    567            uint8 bufLen;
    568            uint8 ret;
    569            uint8 *pBuf;
    570          
    571            bufLen = 2 + 1 + 1 + ZCL_KE_IMPLICIT_CERTIFICATE_LEN;
   \   00002F   75..34       MOV     ?V0 + 7,#0x34
    572          
    573            if ((buf = osal_mem_alloc(bufLen)) == NULL)
   \   000032                ; Setup parameters for call to function osal_mem_alloc
   \   000032   85....       MOV     ?V0 + 4,?V0 + 7
   \   000035   75..00       MOV     ?V0 + 5,#0x0
   \   000038   AA..         MOV     R2,?V0 + 4
   \   00003A   AB..         MOV     R3,?V0 + 5
   \   00003C   12....       LCALL   ??osal_mem_alloc?relay
   \   00003F   8A..         MOV     ?V0 + 4,R2
   \   000041   8B..         MOV     ?V0 + 5,R3
   \   000043   A8..         MOV     R0,?V0 + 4
   \   000045   A9..         MOV     R1,?V0 + 5
   \   000047   88..         MOV     ?V0 + 2,R0
   \   000049   89..         MOV     ?V0 + 3,R1
   \   00004B   E8           MOV     A,R0
   \   00004C   49           ORL     A,R1
   \   00004D   7005         JNZ     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_4
    574            {
    575              return ZMemError;
   \   00004F   7910         MOV     R1,#0x10
   \   000051   02....       LJMP    ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_5 & 0xFFFF
    576            }
    577          
    578            pBuf = buf;
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_4:
   \   000054   AE..         MOV     R6,?V0 + 2
   \   000056   AF..         MOV     R7,?V0 + 3
    579          
    580            *pBuf++ = LO_UINT16( keyEstablishmentSuite );
   \   000058   E5..         MOV     A,?V0 + 0
   \   00005A   8E82         MOV     DPL,R6
   \   00005C   8F83         MOV     DPH,R7
   \   00005E   E5..         MOV     A,?V0 + 0
   \   000060   F0           MOVX    @DPTR,A
   \   000061   8E82         MOV     DPL,R6
   \   000063   8F83         MOV     DPH,R7
   \   000065   A3           INC     DPTR
   \   000066   AE82         MOV     R6,DPL
   \   000068   AF83         MOV     R7,DPH
    581            *pBuf++ = HI_UINT16( keyEstablishmentSuite );
   \   00006A   A8..         MOV     R0,?V0 + 0
   \   00006C   A9..         MOV     R1,?V0 + 1
   \   00006E   E4           CLR     A
   \   00006F   E5..         MOV     A,?V0 + 1
   \   000071   A8..         MOV     R0,?V0 + 1
   \   000073   E5..         MOV     A,?V0 + 1
   \   000075   8E82         MOV     DPL,R6
   \   000077   8F83         MOV     DPH,R7
   \   000079   E5..         MOV     A,?V0 + 1
   \   00007B   F0           MOVX    @DPTR,A
   \   00007C   8E82         MOV     DPL,R6
   \   00007E   8F83         MOV     DPH,R7
   \   000080   A3           INC     DPTR
   \   000081   AE82         MOV     R6,DPL
   \   000083   AF83         MOV     R7,DPH
    582            *pBuf++ = keyGenerateTime;
   \   000085   E5..         MOV     A,?V0 + 9
   \   000087   8E82         MOV     DPL,R6
   \   000089   8F83         MOV     DPH,R7
   \   00008B   E5..         MOV     A,?V0 + 9
   \   00008D   F0           MOVX    @DPTR,A
   \   00008E   8E82         MOV     DPL,R6
   \   000090   8F83         MOV     DPH,R7
   \   000092   A3           INC     DPTR
   \   000093   AE82         MOV     R6,DPL
   \   000095   AF83         MOV     R7,DPH
    583            *pBuf++ = macGenerateTime;
   \   000097   E5..         MOV     A,?V0 + 8
   \   000099   8E82         MOV     DPL,R6
   \   00009B   8F83         MOV     DPH,R7
   \   00009D   E5..         MOV     A,?V0 + 8
   \   00009F   F0           MOVX    @DPTR,A
   \   0000A0   8E82         MOV     DPL,R6
   \   0000A2   8F83         MOV     DPH,R7
   \   0000A4   A3           INC     DPTR
   \   0000A5   AE82         MOV     R6,DPL
   \   0000A7   AF83         MOV     R7,DPH
    584            osal_memcpy( pBuf, certificate, ZCL_KE_IMPLICIT_CERTIFICATE_LEN );
   \   0000A9                ; Setup parameters for call to function osal_memcpy
   \   0000A9   741A         MOV     A,#0x1a
   \   0000AB   12....       LCALL   ?XSTACK_DISP0_8
   \   0000AE   E0           MOVX    A,@DPTR
   \   0000AF   F5..         MOV     ?V0 + 4,A
   \   0000B1   A3           INC     DPTR
   \   0000B2   E0           MOVX    A,@DPTR
   \   0000B3   F5..         MOV     ?V0 + 5,A
   \   0000B5   75..00       MOV     ?V0 + 6,#0x0
   \   0000B8   78..         MOV     R0,#?V0 + 4
   \   0000BA   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000BD   7C30         MOV     R4,#0x30
   \   0000BF   7D00         MOV     R5,#0x0
   \   0000C1   EE           MOV     A,R6
   \   0000C2   FA           MOV     R2,A
   \   0000C3   EF           MOV     A,R7
   \   0000C4   FB           MOV     R3,A
   \   0000C5   12....       LCALL   ??osal_memcpy?relay
   \   0000C8   7403         MOV     A,#0x3
   \   0000CA   12....       LCALL   ?DEALLOC_XSTACK8
    585          
    586            ret = zcl_SendCommand( srcEP, dstAddr,
    587                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    588                                     COMMAND_INITIATE_KEY_ESTABLISHMENT_RESPONSE, TRUE,
    589                                     ZCL_FRAME_SERVER_CLIENT_DIR, disableDefaultRsp,
    590                                     0, seqNum, bufLen, buf );
   \   0000CD                ; Setup parameters for call to function zcl_SendCommand
   \   0000CD   78..         MOV     R0,#?V0 + 2
   \   0000CF   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D2   85....       MOV     ?V0 + 4,?V0 + 7
   \   0000D5   75..00       MOV     ?V0 + 5,#0x0
   \   0000D8   78..         MOV     R0,#?V0 + 4
   \   0000DA   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000DD   E5..         MOV     A,?V0 + 12
   \   0000DF   F5..         MOV     ?V0 + 4,A
   \   0000E1   78..         MOV     R0,#?V0 + 4
   \   0000E3   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000E6   E4           CLR     A
   \   0000E7   F5..         MOV     ?V0 + 4,A
   \   0000E9   F5..         MOV     ?V0 + 5,A
   \   0000EB   78..         MOV     R0,#?V0 + 4
   \   0000ED   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000F0   E5..         MOV     A,?V0 + 13
   \   0000F2   F5..         MOV     ?V0 + 4,A
   \   0000F4   78..         MOV     R0,#?V0 + 4
   \   0000F6   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0000F9   75..01       MOV     ?V0 + 4,#0x1
   \   0000FC   78..         MOV     R0,#?V0 + 4
   \   0000FE   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000101   75..01       MOV     ?V0 + 4,#0x1
   \   000104   78..         MOV     R0,#?V0 + 4
   \   000106   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000109   75..00       MOV     ?V0 + 4,#0x0
   \   00010C   78..         MOV     R0,#?V0 + 4
   \   00010E   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000111   7C00         MOV     R4,#0x0
   \   000113   7D08         MOV     R5,#0x8
   \   000115   AA..         MOV     R2,?V0 + 14
   \   000117   AB..         MOV     R3,?V0 + 15
   \   000119   A9..         MOV     R1,?V0 + 10
   \   00011B   12....       LCALL   ??zcl_SendCommand?relay
   \   00011E   740B         MOV     A,#0xb
   \   000120   12....       LCALL   ?DEALLOC_XSTACK8
   \   000123   E9           MOV     A,R1
   \   000124   F5..         MOV     ?V0 + 11,A
    591            osal_mem_free(buf);
   \   000126                ; Setup parameters for call to function osal_mem_free
   \   000126   AA..         MOV     R2,?V0 + 2
   \   000128   AB..         MOV     R3,?V0 + 3
   \   00012A   12....       LCALL   ??osal_mem_free?relay
    592          
    593            return ret;
   \   00012D   A9..         MOV     R1,?V0 + 11
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_5:
   \   00012F   7F10         MOV     R7,#0x10
   \   000131   02....       LJMP    ?BANKED_LEAVE_XDATA
    594          }
    595          
    596          /*********************************************************************
    597           * @fn      zclGeneral_KeyEstablish_Send_EphemeralDataRsp
    598           *
    599           * @brief   Call to send out a Ephemeral Data Response Command
    600           *
    601           * @param   srcEP - Sending application's endpoint
    602           * @param   dstAddr - where you want the message to go
    603           * @param   eData - ephemeral data.
    604           * @param   disableDefaultRsp - disable default response
    605           * @param   seqNum - ZCL sequence number
    606           *
    607           * @return  ZStatus_t
    608           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    609          ZStatus_t zclGeneral_KeyEstablish_Send_EphemeralDataRsp( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_EphemeralDataRsp:
    610                                                       uint8 *eData,
    611                                                       uint8 disableDefaultRsp, uint8 seqNum )
    612          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 2,R4
   \   00000D   8D..         MOV     ?V0 + 3,R5
   \   00000F   7410         MOV     A,#0x10
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 1,A
   \   000017   7411         MOV     A,#0x11
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 4,A
    613            return (zcl_SendCommand( srcEP, dstAddr,
    614                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    615                                     COMMAND_EPHEMERAL_DATA_RESPONSE, TRUE,
    616                                     ZCL_FRAME_SERVER_CLIENT_DIR, disableDefaultRsp,
    617                                     0, seqNum, ZCL_KE_CA_PUBLIC_KEY_LEN, eData ));
   \   00001F                ; Setup parameters for call to function zcl_SendCommand
   \   00001F   78..         MOV     R0,#?V0 + 2
   \   000021   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000024   75..16       MOV     ?V0 + 6,#0x16
   \   000027   75..00       MOV     ?V0 + 7,#0x0
   \   00002A   78..         MOV     R0,#?V0 + 6
   \   00002C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002F   E5..         MOV     A,?V0 + 4
   \   000031   F5..         MOV     ?V0 + 5,A
   \   000033   78..         MOV     R0,#?V0 + 5
   \   000035   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000038   E4           CLR     A
   \   000039   F5..         MOV     ?V0 + 6,A
   \   00003B   F5..         MOV     ?V0 + 7,A
   \   00003D   78..         MOV     R0,#?V0 + 6
   \   00003F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000042   E5..         MOV     A,?V0 + 1
   \   000044   F5..         MOV     ?V0 + 5,A
   \   000046   78..         MOV     R0,#?V0 + 5
   \   000048   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00004B   75..01       MOV     ?V0 + 5,#0x1
   \   00004E   78..         MOV     R0,#?V0 + 5
   \   000050   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000053   75..01       MOV     ?V0 + 5,#0x1
   \   000056   78..         MOV     R0,#?V0 + 5
   \   000058   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00005B   75..01       MOV     ?V0 + 5,#0x1
   \   00005E   78..         MOV     R0,#?V0 + 5
   \   000060   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000063   7C00         MOV     R4,#0x0
   \   000065   7D08         MOV     R5,#0x8
   \   000067   EE           MOV     A,R6
   \   000068   FA           MOV     R2,A
   \   000069   EF           MOV     A,R7
   \   00006A   FB           MOV     R3,A
   \   00006B   A9..         MOV     R1,?V0 + 0
   \   00006D   12....       LCALL   ??zcl_SendCommand?relay
   \   000070   740B         MOV     A,#0xb
   \   000072   12....       LCALL   ?DEALLOC_XSTACK8
   \   000075   7F08         MOV     R7,#0x8
   \   000077   02....       LJMP    ?BANKED_LEAVE_XDATA
    618          }
    619          
    620          /*********************************************************************
    621           * @fn      zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
    622           *
    623           * @brief   Call to send out a Confirm Key Response
    624           *
    625           * @param   srcEP - Sending application's endpoint
    626           * @param   dstAddr - where you want the message to go
    627           * @param   mac - MAC
    628           * @param   disableDefaultRsp - disable default response
    629           * @param   seqNum - ZCL sequence number
    630           *
    631           * @return  ZStatus_t
    632           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    633          ZStatus_t zclGeneral_KeyEstablish_Send_ConfirmKeyRsp( uint8 srcEP, afAddrType_t *dstAddr,
   \                     zclGeneral_KeyEstablish_Send_ConfirmKeyRsp:
    634                                                       uint8 *mac,
    635                                                       uint8 disableDefaultRsp, uint8 seqNum )
    636          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   EA           MOV     A,R2
   \   000008   FE           MOV     R6,A
   \   000009   EB           MOV     A,R3
   \   00000A   FF           MOV     R7,A
   \   00000B   8C..         MOV     ?V0 + 2,R4
   \   00000D   8D..         MOV     ?V0 + 3,R5
   \   00000F   7410         MOV     A,#0x10
   \   000011   12....       LCALL   ?XSTACK_DISP0_8
   \   000014   E0           MOVX    A,@DPTR
   \   000015   F5..         MOV     ?V0 + 1,A
   \   000017   7411         MOV     A,#0x11
   \   000019   12....       LCALL   ?XSTACK_DISP0_8
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F5..         MOV     ?V0 + 4,A
    637            return (zcl_SendCommand(srcEP, dstAddr,
    638                                     ZCL_CLUSTER_ID_GEN_KEY_ESTABLISHMENT,
    639                                     COMMAND_CONFIRM_KEY_RESPONSE, TRUE,
    640                                     ZCL_FRAME_SERVER_CLIENT_DIR, disableDefaultRsp,
    641                                     0, seqNum, KEY_ESTABLISH_MAC_LENGTH, mac ));
   \   00001F                ; Setup parameters for call to function zcl_SendCommand
   \   00001F   78..         MOV     R0,#?V0 + 2
   \   000021   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000024   75..10       MOV     ?V0 + 6,#0x10
   \   000027   75..00       MOV     ?V0 + 7,#0x0
   \   00002A   78..         MOV     R0,#?V0 + 6
   \   00002C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002F   E5..         MOV     A,?V0 + 4
   \   000031   F5..         MOV     ?V0 + 5,A
   \   000033   78..         MOV     R0,#?V0 + 5
   \   000035   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000038   E4           CLR     A
   \   000039   F5..         MOV     ?V0 + 6,A
   \   00003B   F5..         MOV     ?V0 + 7,A
   \   00003D   78..         MOV     R0,#?V0 + 6
   \   00003F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000042   E5..         MOV     A,?V0 + 1
   \   000044   F5..         MOV     ?V0 + 5,A
   \   000046   78..         MOV     R0,#?V0 + 5
   \   000048   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00004B   75..01       MOV     ?V0 + 5,#0x1
   \   00004E   78..         MOV     R0,#?V0 + 5
   \   000050   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000053   75..01       MOV     ?V0 + 5,#0x1
   \   000056   78..         MOV     R0,#?V0 + 5
   \   000058   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00005B   75..02       MOV     ?V0 + 5,#0x2
   \   00005E   78..         MOV     R0,#?V0 + 5
   \   000060   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000063   7C00         MOV     R4,#0x0
   \   000065   7D08         MOV     R5,#0x8
   \   000067   EE           MOV     A,R6
   \   000068   FA           MOV     R2,A
   \   000069   EF           MOV     A,R7
   \   00006A   FB           MOV     R3,A
   \   00006B   A9..         MOV     R1,?V0 + 0
   \   00006D   12....       LCALL   ??zcl_SendCommand?relay
   \   000070   740B         MOV     A,#0xb
   \   000072   12....       LCALL   ?DEALLOC_XSTACK8
   \   000075   7F08         MOV     R7,#0x8
   \   000077   02....       LJMP    ?BANKED_LEAVE_XDATA
    642          }
    643          
    644          /*********************************************************************
    645           * @fn      zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
    646           *
    647           * @brief   Register the user defined yielding function
    648           *
    649           * @param   yield - Pointer to a function to allow user defined yielding.
    650           *          YieldFunc may be NULL if yieldLevel is 0
    651           * @param   yieldLevel - The yield level determines how often the user defined
    652           *          yield function will be called. This is a number from 0 to 10.
    653           *          0 will never yield. 1 will yield the most often. 10 will yield the
    654           *          least often.
    655           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    656          void zclGeneral_KeyEstablishment_RegYieldCB( YieldFunc *pFnYield,
   \                     zclGeneral_KeyEstablishment_RegYieldCB:
    657                                                       uint8 yieldLevel )
    658          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
    659            if( pFnYield == NULL )
   \   000004   EA           MOV     A,R2
   \   000005   4B           ORL     A,R3
   \   000006   7008         JNZ     ??zclGeneral_KeyEstablishment_RegYieldCB_0
    660            {
    661              zclKeyEstablish_YieldLevel = 0;
   \   000008   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   00000B   7400         MOV     A,#0x0
   \   00000D   F0           MOVX    @DPTR,A
   \   00000E   800D         SJMP    ??zclGeneral_KeyEstablishment_RegYieldCB_1
    662            }
    663            else
    664            {
    665              zclKeyEstablish_YieldFunc = pFnYield;
   \                     ??zclGeneral_KeyEstablishment_RegYieldCB_0:
   \   000010   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   000013   EA           MOV     A,R2
   \   000014   F0           MOVX    @DPTR,A
   \   000015   A3           INC     DPTR
   \   000016   EB           MOV     A,R3
   \   000017   F0           MOVX    @DPTR,A
    666              zclKeyEstablish_YieldLevel = yieldLevel;
   \   000018   E9           MOV     A,R1
   \   000019   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   00001C   F0           MOVX    @DPTR,A
    667            }
    668          }
   \                     ??zclGeneral_KeyEstablishment_RegYieldCB_1:
   \   00001D   D083         POP     DPH
   \   00001F   D082         POP     DPL
   \   000021   02....       LJMP    ?BRET
    669          
    670          /*********************************************************************
    671           * @fn      zclGeneral_KeyEstablish_HdlIncoming
    672           *
    673           * @brief   Callback from ZCL to process incoming Commands specific
    674           *          to this cluster library or Profile commands
    675           *
    676           * @param   pInMsg - pointer to the incoming message
    677           *
    678           * @return  ZStatus_t
    679           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    680          static ZStatus_t zclGeneral_KeyEstablish_HdlIncoming( zclIncoming_t *pInMsg )
   \                     zclGeneral_KeyEstablish_HdlIncoming:
    681          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    682            ZStatus_t stat = ZSuccess;
   \   000009   75..00       MOV     ?V0 + 0,#0x0
    683          
    684          #if defined ( INTER_PAN )
    685            if ( StubAPS_InterPan( pInMsg->msg->srcAddr.panId, pInMsg->msg->srcAddr.endPoint ) )
    686              return ( stat ); // Cluster not supported thru Inter-PAN
    687          #endif
    688          
    689            if ( zcl_ClusterCmd( pInMsg->hdr.fc.type ) )
   \   00000C   8E82         MOV     DPL,R6
   \   00000E   8F83         MOV     DPH,R7
   \   000010   A3           INC     DPTR
   \   000011   A3           INC     DPTR
   \   000012   E0           MOVX    A,@DPTR
   \   000013   5403         ANL     A,#0x3
   \   000015   F8           MOV     R0,A
   \   000016   A3           INC     DPTR
   \   000017   E0           MOVX    A,@DPTR
   \   000018   5400         ANL     A,#0x0
   \   00001A   F9           MOV     R1,A
   \   00001B   E8           MOV     A,R0
   \   00001C   6401         XRL     A,#0x1
   \   00001E   7030         JNZ     ??zclGeneral_KeyEstablish_HdlIncoming_0
    690            {
    691              // Is this a manufacturer specific command?
    692              if ( pInMsg->hdr.fc.manuSpecific == 0 )
   \   000020   8E82         MOV     DPL,R6
   \   000022   8F83         MOV     DPH,R7
   \   000024   A3           INC     DPTR
   \   000025   A3           INC     DPTR
   \   000026   E0           MOVX    A,@DPTR
   \   000027   F8           MOV     R0,A
   \   000028   A3           INC     DPTR
   \   000029   E0           MOVX    A,@DPTR
   \   00002A   F9           MOV     R1,A
   \   00002B   E8           MOV     A,R0
   \   00002C   13           RRC     A
   \   00002D   13           RRC     A
   \   00002E   543F         ANL     A,#0x3f
   \   000030   F8           MOV     R0,A
   \   000031   7900         MOV     R1,#0x0
   \   000033   5401         ANL     A,#0x1
   \   000035   F8           MOV     R0,A
   \   000036   E9           MOV     A,R1
   \   000037   5400         ANL     A,#0x0
   \   000039   F9           MOV     R1,A
   \   00003A   E8           MOV     A,R0
   \   00003B   A2E0         MOV     C,0xE0 /* A   */.0
   \   00003D   400C         JC      ??zclGeneral_KeyEstablish_HdlIncoming_1
    693              {
    694                stat = zclGeneral_KeyEstablish_HdlInSpecificCommands( pInMsg );
   \   00003F                ; Setup parameters for call to function zclGeneral_KeyEstablish_HdlInSpecificCommands
   \   00003F   EE           MOV     A,R6
   \   000040   FA           MOV     R2,A
   \   000041   EF           MOV     A,R7
   \   000042   FB           MOV     R3,A
   \   000043   12....       LCALL   ??zclGeneral_KeyEstablish_HdlInSpecificCommands
   \   000046   E9           MOV     A,R1
   \   000047   F5..         MOV     ?V0 + 0,A
   \   000049   8008         SJMP    ??zclGeneral_KeyEstablish_HdlIncoming_2
    695              }
    696              else
    697              {
    698                // We don't support any manufacturer specific command.
    699                stat = ZFailure;
   \                     ??zclGeneral_KeyEstablish_HdlIncoming_1:
   \   00004B   75..01       MOV     ?V0 + 0,#0x1
   \   00004E   8003         SJMP    ??zclGeneral_KeyEstablish_HdlIncoming_2
    700              }
    701            }
    702            else
    703            {
    704              // Handle all the normal (Read, Write...) commands -- should never get here
    705              stat = ZFailure;
   \                     ??zclGeneral_KeyEstablish_HdlIncoming_0:
   \   000050   75..01       MOV     ?V0 + 0,#0x1
    706            }
    707            return ( stat );
   \                     ??zclGeneral_KeyEstablish_HdlIncoming_2:
   \   000053   A9..         MOV     R1,?V0 + 0
   \   000055   7F01         MOV     R7,#0x1
   \   000057   02....       LJMP    ?BANKED_LEAVE_XDATA
    708          }
    709          
    710          /*********************************************************************
    711           * @fn      zclGeneral_KeyEstablish_HdlInSpecificCommands
    712           *
    713           * @brief   Callback from ZCL to process incoming Commands specific
    714           *          to this cluster library
    715          
    716           * @param   pInMsg - pointer to the incoming message
    717           *
    718           * @return  ZStatus_t
    719           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    720          static ZStatus_t zclGeneral_KeyEstablish_HdlInSpecificCommands( zclIncoming_t *pInMsg )
   \                     zclGeneral_KeyEstablish_HdlInSpecificCommands:
    721          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   \   000005   EA           MOV     A,R2
   \   000006   FE           MOV     R6,A
   \   000007   EB           MOV     A,R3
   \   000008   FF           MOV     R7,A
    722            ZStatus_t stat;
    723          
    724            if ( zcl_ServerCmd( pInMsg->hdr.fc.direction ) )
   \   000009   8E82         MOV     DPL,R6
   \   00000B   8F83         MOV     DPH,R7
   \   00000D   A3           INC     DPTR
   \   00000E   A3           INC     DPTR
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   F8           MOV     R0,A
   \   000011   A3           INC     DPTR
   \   000012   E0           MOVX    A,@DPTR
   \   000013   F9           MOV     R1,A
   \   000014   E8           MOV     A,R0
   \   000015   13           RRC     A
   \   000016   13           RRC     A
   \   000017   13           RRC     A
   \   000018   541F         ANL     A,#0x1f
   \   00001A   F8           MOV     R0,A
   \   00001B   7900         MOV     R1,#0x0
   \   00001D   5401         ANL     A,#0x1
   \   00001F   F8           MOV     R0,A
   \   000020   E9           MOV     A,R1
   \   000021   5400         ANL     A,#0x0
   \   000023   F9           MOV     R1,A
   \   000024   E8           MOV     A,R0
   \   000025   A2E0         MOV     C,0xE0 /* A   */.0
   \   000027   404E         JC      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_1
    725            {
    726              // Commands received by Server
    727              switch ( pInMsg->hdr.commandID )
   \   000029   8E82         MOV     DPL,R6
   \   00002B   8F83         MOV     DPH,R7
   \   00002D   A3           INC     DPTR
   \   00002E   A3           INC     DPTR
   \   00002F   A3           INC     DPTR
   \   000030   A3           INC     DPTR
   \   000031   A3           INC     DPTR
   \   000032   A3           INC     DPTR
   \   000033   A3           INC     DPTR
   \   000034   E0           MOVX    A,@DPTR
   \   000035   600B         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_2
   \   000037   14           DEC     A
   \   000038   6014         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_3
   \   00003A   14           DEC     A
   \   00003B   601D         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_4
   \   00003D   14           DEC     A
   \   00003E   6026         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_5
   \   000040   8030         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_6
    728              {
    729                case COMMAND_INITIATE_KEY_ESTABLISHMENT:
    730                  stat = zclGeneral_ProcessInCmd_InitiateKeyEstablish( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_2:
   \   000042                ; Setup parameters for call to function zclGeneral_ProcessInCmd_InitiateKeyEstablish
   \   000042   EE           MOV     A,R6
   \   000043   FA           MOV     R2,A
   \   000044   EF           MOV     A,R7
   \   000045   FB           MOV     R3,A
   \   000046   12....       LCALL   ??zclGeneral_ProcessInCmd_InitiateKeyEstablish?
   \   000049   E9           MOV     A,R1
   \   00004A   F5..         MOV     ?V0 + 0,A
    731                  break;
   \   00004C   8075         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    732          
    733                case COMMAND_EPHEMERAL_DATA_REQUEST:
    734                  stat = zclGeneral_ProcessInCmd_EphemeralDataReq( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_3:
   \   00004E                ; Setup parameters for call to function zclGeneral_ProcessInCmd_EphemeralDataReq
   \   00004E   EE           MOV     A,R6
   \   00004F   FA           MOV     R2,A
   \   000050   EF           MOV     A,R7
   \   000051   FB           MOV     R3,A
   \   000052   12....       LCALL   ??zclGeneral_ProcessInCmd_EphemeralDataReq?rela
   \   000055   E9           MOV     A,R1
   \   000056   F5..         MOV     ?V0 + 0,A
    735                  break;
   \   000058   8069         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    736          
    737                case COMMAND_CONFIRM_KEY:
    738                  stat = zclGeneral_ProcessInCmd_ConfirmKey( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_4:
   \   00005A                ; Setup parameters for call to function zclGeneral_ProcessInCmd_ConfirmKey
   \   00005A   EE           MOV     A,R6
   \   00005B   FA           MOV     R2,A
   \   00005C   EF           MOV     A,R7
   \   00005D   FB           MOV     R3,A
   \   00005E   12....       LCALL   ??zclGeneral_ProcessInCmd_ConfirmKey?relay
   \   000061   E9           MOV     A,R1
   \   000062   F5..         MOV     ?V0 + 0,A
    739                  break;
   \   000064   805D         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    740          
    741                case COMMAND_TERMINATE_KEY_ESTABLISHMENT:
    742                  stat = zclGeneral_ProcessInCmd_TerminateKeyEstablish( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_5:
   \   000066                ; Setup parameters for call to function zclGeneral_ProcessInCmd_TerminateKeyEstablish
   \   000066   EE           MOV     A,R6
   \   000067   FA           MOV     R2,A
   \   000068   EF           MOV     A,R7
   \   000069   FB           MOV     R3,A
   \   00006A   12....       LCALL   ??zclGeneral_ProcessInCmd_TerminateKeyEstablish
   \   00006D   E9           MOV     A,R1
   \   00006E   F5..         MOV     ?V0 + 0,A
    743                  break;
   \   000070   8051         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    744          
    745                default:
    746                  stat = ZFailure;
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_6:
   \   000072   75..01       MOV     ?V0 + 0,#0x1
    747                  break;
   \   000075   804C         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    748              }
    749            }
    750            else
    751            {
    752              // Commands received by Client
    753              switch ( pInMsg->hdr.commandID )
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_1:
   \   000077   8E82         MOV     DPL,R6
   \   000079   8F83         MOV     DPH,R7
   \   00007B   A3           INC     DPTR
   \   00007C   A3           INC     DPTR
   \   00007D   A3           INC     DPTR
   \   00007E   A3           INC     DPTR
   \   00007F   A3           INC     DPTR
   \   000080   A3           INC     DPTR
   \   000081   A3           INC     DPTR
   \   000082   E0           MOVX    A,@DPTR
   \   000083   600B         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_8
   \   000085   14           DEC     A
   \   000086   6014         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_9
   \   000088   14           DEC     A
   \   000089   601D         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_10
   \   00008B   14           DEC     A
   \   00008C   6026         JZ      ??zclGeneral_KeyEstablish_HdlInSpecificCommands_11
   \   00008E   8030         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_12
    754              {
    755                case COMMAND_INITIATE_KEY_ESTABLISHMENT_RESPONSE:
    756                  stat = zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_8:
   \   000090                ; Setup parameters for call to function zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp
   \   000090   EE           MOV     A,R6
   \   000091   FA           MOV     R2,A
   \   000092   EF           MOV     A,R7
   \   000093   FB           MOV     R3,A
   \   000094   12....       LCALL   ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR
   \   000097   E9           MOV     A,R1
   \   000098   F5..         MOV     ?V0 + 0,A
    757                  break;
   \   00009A   8027         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    758          
    759                case COMMAND_EPHEMERAL_DATA_RESPONSE:
    760                  stat = zclGeneral_ProcessInCmd_EphemeralDataRsp( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_9:
   \   00009C                ; Setup parameters for call to function zclGeneral_ProcessInCmd_EphemeralDataRsp
   \   00009C   EE           MOV     A,R6
   \   00009D   FA           MOV     R2,A
   \   00009E   EF           MOV     A,R7
   \   00009F   FB           MOV     R3,A
   \   0000A0   12....       LCALL   ??zclGeneral_ProcessInCmd_EphemeralDataRsp?rela
   \   0000A3   E9           MOV     A,R1
   \   0000A4   F5..         MOV     ?V0 + 0,A
    761                  break;
   \   0000A6   801B         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    762          
    763                case COMMAND_CONFIRM_KEY_RESPONSE:
    764                  stat = zclGeneral_ProcessInCmd_ConfirmKeyRsp( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_10:
   \   0000A8                ; Setup parameters for call to function zclGeneral_ProcessInCmd_ConfirmKeyRsp
   \   0000A8   EE           MOV     A,R6
   \   0000A9   FA           MOV     R2,A
   \   0000AA   EF           MOV     A,R7
   \   0000AB   FB           MOV     R3,A
   \   0000AC   12....       LCALL   ??zclGeneral_ProcessInCmd_ConfirmKeyRsp?relay
   \   0000AF   E9           MOV     A,R1
   \   0000B0   F5..         MOV     ?V0 + 0,A
    765                  break;
   \   0000B2   800F         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    766          
    767                case COMMAND_TERMINATE_KEY_ESTABLISHMENT:
    768                  stat = zclGeneral_ProcessInCmd_TerminateKeyEstablish( pInMsg );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_11:
   \   0000B4                ; Setup parameters for call to function zclGeneral_ProcessInCmd_TerminateKeyEstablish
   \   0000B4   EE           MOV     A,R6
   \   0000B5   FA           MOV     R2,A
   \   0000B6   EF           MOV     A,R7
   \   0000B7   FB           MOV     R3,A
   \   0000B8   12....       LCALL   ??zclGeneral_ProcessInCmd_TerminateKeyEstablish
   \   0000BB   E9           MOV     A,R1
   \   0000BC   F5..         MOV     ?V0 + 0,A
    769                  break;
   \   0000BE   8003         SJMP    ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7
    770          
    771                default:
    772                  stat = ZFailure;
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_12:
   \   0000C0   75..01       MOV     ?V0 + 0,#0x1
    773                  break;
    774              }
    775            }
    776          
    777            return ( stat );
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands_7:
   \   0000C3   A9..         MOV     R1,?V0 + 0
   \   0000C5   7F01         MOV     R7,#0x1
   \   0000C7   02....       LJMP    ?BANKED_LEAVE_XDATA
    778          }
    779          
    780          /*********************************************************************
    781           * @fn      zclGeneral_ProcessInCmd_InitiateKeyEstablish
    782           *
    783           * @brief   Process the received Initiate Key Establishment Request.
    784           *
    785           * @param   pInMsg - pointer to the incoming message
    786           *
    787           * @return  ZStatus_t - ZFailure @ Unsupported
    788           *                      ZCL_STATUS_MALFORMED_COMMAND
    789           *                      ZCL_STATUS_CMD_HAS_RSP
    790           *                      ZCL_STATUS_SOFTWARE_FAILURE
    791           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    792          static ZStatus_t zclGeneral_ProcessInCmd_InitiateKeyEstablish( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_InitiateKeyEstablish:
    793          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
    794            TermKeyStatus_t status = TermKeyStatus_Success;
   \   000009   7E00         MOV     R6,#0x0
    795            uint16 remoteKeyEstablishmentSuite;
    796            uint8 *implicitCert = NULL;
   \   00000B   75..00       MOV     ?V0 + 2,#0x0
   \   00000E   75..00       MOV     ?V0 + 3,#0x0
    797            uint8 index = MAX_KEY_ESTABLISHMENT_REC_ENTRY;  // set to non valid value
   \   000011   7F02         MOV     R7,#0x2
    798          
    799            // Check the incoming packet length
    800            if ( pInMsg->pDataLen < PACKET_LEN_INITIATE_KEY_EST_REQ )
   \   000013   85..82       MOV     DPL,?V0 + 0
   \   000016   85..83       MOV     DPH,?V0 + 1
   \   000019   A3           INC     DPTR
   \   00001A   A3           INC     DPTR
   \   00001B   A3           INC     DPTR
   \   00001C   A3           INC     DPTR
   \   00001D   A3           INC     DPTR
   \   00001E   A3           INC     DPTR
   \   00001F   A3           INC     DPTR
   \   000020   A3           INC     DPTR
   \   000021   A3           INC     DPTR
   \   000022   A3           INC     DPTR
   \   000023   C3           CLR     C
   \   000024   E0           MOVX    A,@DPTR
   \   000025   9434         SUBB    A,#0x34
   \   000027   A3           INC     DPTR
   \   000028   E0           MOVX    A,@DPTR
   \   000029   9400         SUBB    A,#0x0
   \   00002B   5005         JNC     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_0
    801            {
    802              status = TermKeyStatus_BadMessage;
   \   00002D   7E03         MOV     R6,#0x3
   \   00002F   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1 & 0xFFFF
    803            }
    804            else
    805            {
    806              // Start a new key establishment rec entry
    807              index = zclGeneral_AddKeyEstablishRec( &pInMsg->msg->srcAddr );
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_0:
   \   000032                ; Setup parameters for call to function zclGeneral_AddKeyEstablishRec
   \   000032   85..82       MOV     DPL,?V0 + 0
   \   000035   85..83       MOV     DPH,?V0 + 1
   \   000038   E0           MOVX    A,@DPTR
   \   000039   2406         ADD     A,#0x6
   \   00003B   FA           MOV     R2,A
   \   00003C   A3           INC     DPTR
   \   00003D   E0           MOVX    A,@DPTR
   \   00003E   3400         ADDC    A,#0x0
   \   000040   FB           MOV     R3,A
   \   000041   12....       LCALL   ??zclGeneral_AddKeyEstablishRec?relay
   \   000044   E9           MOV     A,R1
   \   000045   FF           MOV     R7,A
    808          
    809              if( index >= MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000046   EF           MOV     A,R7
   \   000047   C3           CLR     C
   \   000048   9402         SUBB    A,#0x2
   \   00004A   4005         JC      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_2
    810              {
    811                // Failed to add an entry
    812                status = TermKeyStatus_NoResources;
   \   00004C   7E04         MOV     R6,#0x4
   \   00004E   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1 & 0xFFFF
    813              }
    814              else
    815              {
    816                // Parse the incoming message
    817                // Copy the remote device certificate
    818                osal_memcpy(keyEstablishRec[index].pRemoteCertificate, &(pInMsg->pData[KEY_ESTABLISH_CERT_IDX]),
    819                            ZCL_KE_IMPLICIT_CERTIFICATE_LEN );
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_2:
   \   000051                ; Setup parameters for call to function osal_memcpy
   \   000051   85..82       MOV     DPL,?V0 + 0
   \   000054   85..83       MOV     DPH,?V0 + 1
   \   000057   A3           INC     DPTR
   \   000058   A3           INC     DPTR
   \   000059   A3           INC     DPTR
   \   00005A   A3           INC     DPTR
   \   00005B   A3           INC     DPTR
   \   00005C   A3           INC     DPTR
   \   00005D   A3           INC     DPTR
   \   00005E   A3           INC     DPTR
   \   00005F   E0           MOVX    A,@DPTR
   \   000060   2404         ADD     A,#0x4
   \   000062   F5..         MOV     ?V0 + 4,A
   \   000064   A3           INC     DPTR
   \   000065   E0           MOVX    A,@DPTR
   \   000066   3400         ADDC    A,#0x0
   \   000068   F5..         MOV     ?V0 + 5,A
   \   00006A   75..00       MOV     ?V0 + 6,#0x0
   \   00006D   78..         MOV     R0,#?V0 + 4
   \   00006F   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000072   7C30         MOV     R4,#0x30
   \   000074   7D00         MOV     R5,#0x0
   \   000076   EF           MOV     A,R7
   \   000077   F8           MOV     R0,A
   \   000078   7900         MOV     R1,#0x0
   \   00007A   E8           MOV     A,R0
   \   00007B   75F027       MOV     B,#0x27
   \   00007E   A4           MUL     AB
   \   00007F   C8           XCH     A,R0
   \   000080   AAF0         MOV     R2,B
   \   000082   75F000       MOV     B,#0x0
   \   000085   A4           MUL     AB
   \   000086   2A           ADD     A,R2
   \   000087   FA           MOV     R2,A
   \   000088   75F027       MOV     B,#0x27
   \   00008B   E9           MOV     A,R1
   \   00008C   A4           MUL     AB
   \   00008D   2A           ADD     A,R2
   \   00008E   F9           MOV     R1,A
   \   00008F   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   000091   28           ADD     A,R0
   \   000092   F582         MOV     DPL,A
   \   000094   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   000096   39           ADDC    A,R1
   \   000097   F583         MOV     DPH,A
   \   000099   E0           MOVX    A,@DPTR
   \   00009A   FA           MOV     R2,A
   \   00009B   A3           INC     DPTR
   \   00009C   E0           MOVX    A,@DPTR
   \   00009D   FB           MOV     R3,A
   \   00009E   12....       LCALL   ??osal_memcpy?relay
   \   0000A1   7403         MOV     A,#0x3
   \   0000A3   12....       LCALL   ?DEALLOC_XSTACK8
    820          
    821                // Verify the certificate issuer and key establishment suite
    822                remoteKeyEstablishmentSuite = BUILD_UINT16( pInMsg->pData[0], pInMsg->pData[1] );
   \   0000A6   85..82       MOV     DPL,?V0 + 0
   \   0000A9   85..83       MOV     DPH,?V0 + 1
   \   0000AC   A3           INC     DPTR
   \   0000AD   A3           INC     DPTR
   \   0000AE   A3           INC     DPTR
   \   0000AF   A3           INC     DPTR
   \   0000B0   A3           INC     DPTR
   \   0000B1   A3           INC     DPTR
   \   0000B2   A3           INC     DPTR
   \   0000B3   A3           INC     DPTR
   \   0000B4   E0           MOVX    A,@DPTR
   \   0000B5   F8           MOV     R0,A
   \   0000B6   A3           INC     DPTR
   \   0000B7   E0           MOVX    A,@DPTR
   \   0000B8   F583         MOV     DPH,A
   \   0000BA   8882         MOV     DPL,R0
   \   0000BC   E0           MOVX    A,@DPTR
   \   0000BD   FA           MOV     R2,A
   \   0000BE   7B00         MOV     R3,#0x0
   \   0000C0   85..82       MOV     DPL,?V0 + 0
   \   0000C3   85..83       MOV     DPH,?V0 + 1
   \   0000C6   A3           INC     DPTR
   \   0000C7   A3           INC     DPTR
   \   0000C8   A3           INC     DPTR
   \   0000C9   A3           INC     DPTR
   \   0000CA   A3           INC     DPTR
   \   0000CB   A3           INC     DPTR
   \   0000CC   A3           INC     DPTR
   \   0000CD   A3           INC     DPTR
   \   0000CE   E0           MOVX    A,@DPTR
   \   0000CF   F8           MOV     R0,A
   \   0000D0   A3           INC     DPTR
   \   0000D1   E0           MOVX    A,@DPTR
   \   0000D2   F583         MOV     DPH,A
   \   0000D4   8882         MOV     DPL,R0
   \   0000D6   A3           INC     DPTR
   \   0000D7   E0           MOVX    A,@DPTR
   \   0000D8   F8           MOV     R0,A
   \   0000D9   7900         MOV     R1,#0x0
   \   0000DB   E4           CLR     A
   \   0000DC   C8           XCH     A,R0
   \   0000DD   F9           MOV     R1,A
   \   0000DE   EA           MOV     A,R2
   \   0000DF   28           ADD     A,R0
   \   0000E0   F8           MOV     R0,A
   \   0000E1   EB           MOV     A,R3
   \   0000E2   39           ADDC    A,R1
   \   0000E3   F9           MOV     R1,A
   \   0000E4   88..         MOV     ?V0 + 8,R0
   \   0000E6   89..         MOV     ?V0 + 9,R1
    823          
    824                if ( remoteKeyEstablishmentSuite != KEY_ESTABLISHMENT_SUITE )
   \   0000E8   7401         MOV     A,#0x1
   \   0000EA   65..         XRL     A,?V0 + 8
   \   0000EC   7004         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_3
   \   0000EE   7400         MOV     A,#0x0
   \   0000F0   65..         XRL     A,?V0 + 9
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_3:
   \   0000F2   6005         JZ      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_4
    825                {
    826                  status = TermKeyStatus_UnSupportedSuite;
   \   0000F4   7E05         MOV     R6,#0x5
   \   0000F6   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1 & 0xFFFF
    827                }
    828                else
    829                {
    830                  // continue parsing message
    831                  // Save Ephemeral Data Generate Key and Confirm Key Time
    832                  if (pInMsg->pData[2] >= KEY_ESTABLISHMENT_EPH_DATA_GEN_INVALID_TIME)
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_4:
   \   0000F9   85..82       MOV     DPL,?V0 + 0
   \   0000FC   85..83       MOV     DPH,?V0 + 1
   \   0000FF   A3           INC     DPTR
   \   000100   A3           INC     DPTR
   \   000101   A3           INC     DPTR
   \   000102   A3           INC     DPTR
   \   000103   A3           INC     DPTR
   \   000104   A3           INC     DPTR
   \   000105   A3           INC     DPTR
   \   000106   A3           INC     DPTR
   \   000107   E0           MOVX    A,@DPTR
   \   000108   F8           MOV     R0,A
   \   000109   A3           INC     DPTR
   \   00010A   E0           MOVX    A,@DPTR
   \   00010B   F583         MOV     DPH,A
   \   00010D   8882         MOV     DPL,R0
   \   00010F   A3           INC     DPTR
   \   000110   A3           INC     DPTR
   \   000111   E0           MOVX    A,@DPTR
   \   000112   C3           CLR     C
   \   000113   94FF         SUBB    A,#-0x1
   \   000115   4005         JC      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_5
    833                  {
    834                    status = TermKeyStatus_BadMessage;
   \   000117   7E03         MOV     R6,#0x3
   \   000119   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1 & 0xFFFF
    835                  }
    836                  else
    837                  {
    838                    // continue parsing message
    839                    keyEstablishRec[index].remoteEphDataGenTime = pInMsg->pData[2];
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_5:
   \   00011C   85..82       MOV     DPL,?V0 + 0
   \   00011F   85..83       MOV     DPH,?V0 + 1
   \   000122   A3           INC     DPTR
   \   000123   A3           INC     DPTR
   \   000124   A3           INC     DPTR
   \   000125   A3           INC     DPTR
   \   000126   A3           INC     DPTR
   \   000127   A3           INC     DPTR
   \   000128   A3           INC     DPTR
   \   000129   A3           INC     DPTR
   \   00012A   E0           MOVX    A,@DPTR
   \   00012B   F8           MOV     R0,A
   \   00012C   A3           INC     DPTR
   \   00012D   E0           MOVX    A,@DPTR
   \   00012E   F583         MOV     DPH,A
   \   000130   8882         MOV     DPL,R0
   \   000132   A3           INC     DPTR
   \   000133   A3           INC     DPTR
   \   000134   E0           MOVX    A,@DPTR
   \   000135   C0E0         PUSH    A
   \   000137   EF           MOV     A,R7
   \   000138   F8           MOV     R0,A
   \   000139   7900         MOV     R1,#0x0
   \   00013B   E8           MOV     A,R0
   \   00013C   75F027       MOV     B,#0x27
   \   00013F   A4           MUL     AB
   \   000140   C8           XCH     A,R0
   \   000141   AAF0         MOV     R2,B
   \   000143   75F000       MOV     B,#0x0
   \   000146   A4           MUL     AB
   \   000147   2A           ADD     A,R2
   \   000148   FA           MOV     R2,A
   \   000149   75F027       MOV     B,#0x27
   \   00014C   E9           MOV     A,R1
   \   00014D   A4           MUL     AB
   \   00014E   2A           ADD     A,R2
   \   00014F   F9           MOV     R1,A
   \   000150   74..         MOV     A,#(keyEstablishRec + 37) & 0xff
   \   000152   28           ADD     A,R0
   \   000153   F582         MOV     DPL,A
   \   000155   74..         MOV     A,#((keyEstablishRec + 37) >> 8) & 0xff
   \   000157   39           ADDC    A,R1
   \   000158   F583         MOV     DPH,A
   \   00015A   D0E0         POP     A
   \   00015C   F0           MOVX    @DPTR,A
    840          
    841                    if (pInMsg->pData[3] >= KEY_ESTABLISHMENT_CONF_KEY_GEN_INVALID_TIME)
   \   00015D   85..82       MOV     DPL,?V0 + 0
   \   000160   85..83       MOV     DPH,?V0 + 1
   \   000163   A3           INC     DPTR
   \   000164   A3           INC     DPTR
   \   000165   A3           INC     DPTR
   \   000166   A3           INC     DPTR
   \   000167   A3           INC     DPTR
   \   000168   A3           INC     DPTR
   \   000169   A3           INC     DPTR
   \   00016A   A3           INC     DPTR
   \   00016B   E0           MOVX    A,@DPTR
   \   00016C   F8           MOV     R0,A
   \   00016D   A3           INC     DPTR
   \   00016E   E0           MOVX    A,@DPTR
   \   00016F   F583         MOV     DPH,A
   \   000171   8882         MOV     DPL,R0
   \   000173   A3           INC     DPTR
   \   000174   A3           INC     DPTR
   \   000175   A3           INC     DPTR
   \   000176   E0           MOVX    A,@DPTR
   \   000177   C3           CLR     C
   \   000178   94FF         SUBB    A,#-0x1
   \   00017A   4005         JC      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_6
    842                    {
    843                      status = TermKeyStatus_BadMessage;
   \   00017C   7E03         MOV     R6,#0x3
   \   00017E   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1 & 0xFFFF
    844                    }
    845                    else
    846                    {
    847                      // continue parsing message
    848                      keyEstablishRec[index].remoteConfKeyGenTime = pInMsg->pData[3];
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_6:
   \   000181   85..82       MOV     DPL,?V0 + 0
   \   000184   85..83       MOV     DPH,?V0 + 1
   \   000187   A3           INC     DPTR
   \   000188   A3           INC     DPTR
   \   000189   A3           INC     DPTR
   \   00018A   A3           INC     DPTR
   \   00018B   A3           INC     DPTR
   \   00018C   A3           INC     DPTR
   \   00018D   A3           INC     DPTR
   \   00018E   A3           INC     DPTR
   \   00018F   E0           MOVX    A,@DPTR
   \   000190   F8           MOV     R0,A
   \   000191   A3           INC     DPTR
   \   000192   E0           MOVX    A,@DPTR
   \   000193   F583         MOV     DPH,A
   \   000195   8882         MOV     DPL,R0
   \   000197   A3           INC     DPTR
   \   000198   A3           INC     DPTR
   \   000199   A3           INC     DPTR
   \   00019A   E0           MOVX    A,@DPTR
   \   00019B   C0E0         PUSH    A
   \   00019D   EF           MOV     A,R7
   \   00019E   F8           MOV     R0,A
   \   00019F   7900         MOV     R1,#0x0
   \   0001A1   E8           MOV     A,R0
   \   0001A2   75F027       MOV     B,#0x27
   \   0001A5   A4           MUL     AB
   \   0001A6   C8           XCH     A,R0
   \   0001A7   AAF0         MOV     R2,B
   \   0001A9   75F000       MOV     B,#0x0
   \   0001AC   A4           MUL     AB
   \   0001AD   2A           ADD     A,R2
   \   0001AE   FA           MOV     R2,A
   \   0001AF   75F027       MOV     B,#0x27
   \   0001B2   E9           MOV     A,R1
   \   0001B3   A4           MUL     AB
   \   0001B4   2A           ADD     A,R2
   \   0001B5   F9           MOV     R1,A
   \   0001B6   74..         MOV     A,#(keyEstablishRec + 38) & 0xff
   \   0001B8   28           ADD     A,R0
   \   0001B9   F582         MOV     DPL,A
   \   0001BB   74..         MOV     A,#((keyEstablishRec + 38) >> 8) & 0xff
   \   0001BD   39           ADDC    A,R1
   \   0001BE   F583         MOV     DPH,A
   \   0001C0   D0E0         POP     A
   \   0001C2   F0           MOVX    @DPTR,A
    849          
    850                      if ((implicitCert = osal_mem_alloc(ZCL_KE_IMPLICIT_CERTIFICATE_LEN)) == NULL)
   \   0001C3                ; Setup parameters for call to function osal_mem_alloc
   \   0001C3   7A30         MOV     R2,#0x30
   \   0001C5   7B00         MOV     R3,#0x0
   \   0001C7   12....       LCALL   ??osal_mem_alloc?relay
   \   0001CA   8A..         MOV     ?V0 + 4,R2
   \   0001CC   8B..         MOV     ?V0 + 5,R3
   \   0001CE   A8..         MOV     R0,?V0 + 4
   \   0001D0   A9..         MOV     R1,?V0 + 5
   \   0001D2   88..         MOV     ?V0 + 2,R0
   \   0001D4   89..         MOV     ?V0 + 3,R1
   \   0001D6   E8           MOV     A,R0
   \   0001D7   49           ORL     A,R1
   \   0001D8   700A         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_7
    851                      {
    852                        // Reset the entry
    853                        zclGeneral_ResetKeyEstablishRec( index );
   \   0001DA                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0001DA   EF           MOV     A,R7
   \   0001DB   F9           MOV     R1,A
   \   0001DC   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
    854          
    855                        return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   0001DF   79C1         MOV     R1,#-0x3f
   \   0001E1   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_8 & 0xFFFF
    856                      }
    857          
    858                      osal_nv_read(ZCD_NV_IMPLICIT_CERTIFICATE, 0, ZCL_KE_IMPLICIT_CERTIFICATE_LEN, implicitCert);
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_7:
   \   0001E4                ; Setup parameters for call to function osal_nv_read
   \   0001E4   78..         MOV     R0,#?V0 + 2
   \   0001E6   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001E9   75..30       MOV     ?V0 + 4,#0x30
   \   0001EC   75..00       MOV     ?V0 + 5,#0x0
   \   0001EF   78..         MOV     R0,#?V0 + 4
   \   0001F1   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0001F4   7C00         MOV     R4,#0x0
   \   0001F6   7D00         MOV     R5,#0x0
   \   0001F8   7A69         MOV     R2,#0x69
   \   0001FA   7B00         MOV     R3,#0x0
   \   0001FC   12....       LCALL   ??osal_nv_read?relay
   \   0001FF   7404         MOV     A,#0x4
   \   000201   12....       LCALL   ?DEALLOC_XSTACK8
   \   000204   E9           MOV     A,R1
    859          
    860                      if ( !osal_memcmp( &(keyEstablishRec[index].pRemoteCertificate[KEY_ESTABLISH_CERT_ISSUER_IDX]),
    861                                         &(implicitCert[KEY_ESTABLISH_CERT_ISSUER_IDX]),
    862                                         KEY_ESTABLISH_CERT_ISSUER_LENTGH ) )
   \   000205                ; Setup parameters for call to function osal_memcmp
   \   000205   E5..         MOV     A,?V0 + 2
   \   000207   241E         ADD     A,#0x1e
   \   000209   F5..         MOV     ?V0 + 4,A
   \   00020B   E5..         MOV     A,?V0 + 3
   \   00020D   3400         ADDC    A,#0x0
   \   00020F   F5..         MOV     ?V0 + 5,A
   \   000211   75..00       MOV     ?V0 + 6,#0x0
   \   000214   78..         MOV     R0,#?V0 + 4
   \   000216   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000219   7C08         MOV     R4,#0x8
   \   00021B   7D00         MOV     R5,#0x0
   \   00021D   EF           MOV     A,R7
   \   00021E   F8           MOV     R0,A
   \   00021F   7900         MOV     R1,#0x0
   \   000221   E8           MOV     A,R0
   \   000222   75F027       MOV     B,#0x27
   \   000225   A4           MUL     AB
   \   000226   C8           XCH     A,R0
   \   000227   AAF0         MOV     R2,B
   \   000229   75F000       MOV     B,#0x0
   \   00022C   A4           MUL     AB
   \   00022D   2A           ADD     A,R2
   \   00022E   FA           MOV     R2,A
   \   00022F   75F027       MOV     B,#0x27
   \   000232   E9           MOV     A,R1
   \   000233   A4           MUL     AB
   \   000234   2A           ADD     A,R2
   \   000235   F9           MOV     R1,A
   \   000236   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   000238   28           ADD     A,R0
   \   000239   F582         MOV     DPL,A
   \   00023B   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   00023D   39           ADDC    A,R1
   \   00023E   F583         MOV     DPH,A
   \   000240   E0           MOVX    A,@DPTR
   \   000241   F8           MOV     R0,A
   \   000242   A3           INC     DPTR
   \   000243   E0           MOVX    A,@DPTR
   \   000244   C8           XCH     A,R0
   \   000245   241E         ADD     A,#0x1e
   \   000247   F582         MOV     DPL,A
   \   000249   E8           MOV     A,R0
   \   00024A   3400         ADDC    A,#0x0
   \   00024C   F583         MOV     DPH,A
   \   00024E   A982         MOV     R1,DPL
   \   000250   AA83         MOV     R2,DPH
   \   000252   7B00         MOV     R3,#0x0
   \   000254   12....       LCALL   ??osal_memcmp?relay
   \   000257   7403         MOV     A,#0x3
   \   000259   12....       LCALL   ?DEALLOC_XSTACK8
   \   00025C   E9           MOV     A,R1
   \   00025D   7002         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1
    863                      {
    864                        status = TermKeyStatus_UnknowIssuer;
   \   00025F   7E01         MOV     R6,#0x1
    865                      }
    866                    }
    867                  }
    868                }
    869              } // end of parsing of the message
    870            }
    871          
    872            if ( status != TermKeyStatus_Success )
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_1:
   \   000261   EE           MOV     A,R6
   \   000262   606A         JZ      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_9
    873            {
    874              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
    875                                                                      &pInMsg->msg->srcAddr,
    876                                                                      status,
    877                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
    878                                                                      KEY_ESTABLISHMENT_SUITE,
    879                                                                      ZCL_FRAME_SERVER_CLIENT_DIR,
    880                                                                      FALSE, zcl_SeqNum++ );
   \   000264   90....       MOV     DPTR,#zcl_SeqNum
   \   000267   E0           MOVX    A,@DPTR
   \   000268   F8           MOV     R0,A
   \   000269   7401         MOV     A,#0x1
   \   00026B   28           ADD     A,R0
   \   00026C   90....       MOV     DPTR,#zcl_SeqNum
   \   00026F   F0           MOVX    @DPTR,A
   \   000270                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   000270   E8           MOV     A,R0
   \   000271   F5..         MOV     ?V0 + 4,A
   \   000273   78..         MOV     R0,#?V0 + 4
   \   000275   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000278   75..00       MOV     ?V0 + 4,#0x0
   \   00027B   78..         MOV     R0,#?V0 + 4
   \   00027D   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000280   75..01       MOV     ?V0 + 4,#0x1
   \   000283   78..         MOV     R0,#?V0 + 4
   \   000285   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000288   75..01       MOV     ?V0 + 4,#0x1
   \   00028B   75..00       MOV     ?V0 + 5,#0x0
   \   00028E   78..         MOV     R0,#?V0 + 4
   \   000290   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000293   7D1C         MOV     R5,#0x1c
   \   000295   EE           MOV     A,R6
   \   000296   FC           MOV     R4,A
   \   000297   85..82       MOV     DPL,?V0 + 0
   \   00029A   85..83       MOV     DPH,?V0 + 1
   \   00029D   E0           MOVX    A,@DPTR
   \   00029E   2406         ADD     A,#0x6
   \   0002A0   FA           MOV     R2,A
   \   0002A1   A3           INC     DPTR
   \   0002A2   E0           MOVX    A,@DPTR
   \   0002A3   3400         ADDC    A,#0x0
   \   0002A5   FB           MOV     R3,A
   \   0002A6   790A         MOV     R1,#0xa
   \   0002A8   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   0002AB   7405         MOV     A,#0x5
   \   0002AD   12....       LCALL   ?DEALLOC_XSTACK8
   \   0002B0   E9           MOV     A,R1
    881              if ( implicitCert != NULL )
   \   0002B1   E5..         MOV     A,?V0 + 2
   \   0002B3   45..         ORL     A,?V0 + 3
   \   0002B5   6007         JZ      ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_10
    882              {
    883                osal_mem_free(implicitCert);
   \   0002B7                ; Setup parameters for call to function osal_mem_free
   \   0002B7   AA..         MOV     R2,?V0 + 2
   \   0002B9   AB..         MOV     R3,?V0 + 3
   \   0002BB   12....       LCALL   ??osal_mem_free?relay
    884              }
    885          
    886              // Reset the entry
    887              if ( index < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_10:
   \   0002BE   EF           MOV     A,R7
   \   0002BF   C3           CLR     C
   \   0002C0   9402         SUBB    A,#0x2
   \   0002C2   5005         JNC     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_11
    888              {
    889                zclGeneral_ResetKeyEstablishRec( index );
   \   0002C4                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0002C4   EF           MOV     A,R7
   \   0002C5   F9           MOV     R1,A
   \   0002C6   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
    890              }
    891          
    892              return ZCL_STATUS_CMD_HAS_RSP;
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_11:
   \   0002C9   79FF         MOV     R1,#-0x1
   \   0002CB   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_8 & 0xFFFF
    893            }
    894          
    895            // Fill in partner's extended address
    896            SSP_MemCpyReverse( keyEstablishRec[index].partnerExtAddr,
    897                              &(keyEstablishRec[index].pRemoteCertificate[KEY_ESTABLISH_CERT_EXT_ADDR_IDX]),
    898                              Z_EXTADDR_LEN); // ID(L)
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_9:
   \   0002CE                ; Setup parameters for call to function SSP_MemCpyReverse
   \   0002CE   75..08       MOV     ?V0 + 4,#0x8
   \   0002D1   75..00       MOV     ?V0 + 5,#0x0
   \   0002D4   78..         MOV     R0,#?V0 + 4
   \   0002D6   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0002D9   EF           MOV     A,R7
   \   0002DA   F8           MOV     R0,A
   \   0002DB   7900         MOV     R1,#0x0
   \   0002DD   E8           MOV     A,R0
   \   0002DE   75F027       MOV     B,#0x27
   \   0002E1   A4           MUL     AB
   \   0002E2   C8           XCH     A,R0
   \   0002E3   AAF0         MOV     R2,B
   \   0002E5   75F000       MOV     B,#0x0
   \   0002E8   A4           MUL     AB
   \   0002E9   2A           ADD     A,R2
   \   0002EA   FA           MOV     R2,A
   \   0002EB   75F027       MOV     B,#0x27
   \   0002EE   E9           MOV     A,R1
   \   0002EF   A4           MUL     AB
   \   0002F0   2A           ADD     A,R2
   \   0002F1   F9           MOV     R1,A
   \   0002F2   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   0002F4   28           ADD     A,R0
   \   0002F5   F582         MOV     DPL,A
   \   0002F7   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   0002F9   39           ADDC    A,R1
   \   0002FA   F583         MOV     DPH,A
   \   0002FC   E0           MOVX    A,@DPTR
   \   0002FD   2416         ADD     A,#0x16
   \   0002FF   FC           MOV     R4,A
   \   000300   A3           INC     DPTR
   \   000301   E0           MOVX    A,@DPTR
   \   000302   3400         ADDC    A,#0x0
   \   000304   FD           MOV     R5,A
   \   000305   EF           MOV     A,R7
   \   000306   F8           MOV     R0,A
   \   000307   7900         MOV     R1,#0x0
   \   000309   E8           MOV     A,R0
   \   00030A   75F027       MOV     B,#0x27
   \   00030D   A4           MUL     AB
   \   00030E   C8           XCH     A,R0
   \   00030F   AAF0         MOV     R2,B
   \   000311   75F000       MOV     B,#0x0
   \   000314   A4           MUL     AB
   \   000315   2A           ADD     A,R2
   \   000316   FA           MOV     R2,A
   \   000317   75F027       MOV     B,#0x27
   \   00031A   E9           MOV     A,R1
   \   00031B   A4           MUL     AB
   \   00031C   2A           ADD     A,R2
   \   00031D   F9           MOV     R1,A
   \   00031E   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   000320   28           ADD     A,R0
   \   000321   FA           MOV     R2,A
   \   000322   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   000324   39           ADDC    A,R1
   \   000325   FB           MOV     R3,A
   \   000326   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   000329   7402         MOV     A,#0x2
   \   00032B   12....       LCALL   ?DEALLOC_XSTACK8
    899          
    900            // Change the state and wait for the Ephemeral Data Request
    901            keyEstablishRec[index].lastSeqNum = pInMsg->hdr.transSeqNum;
   \   00032E   85..82       MOV     DPL,?V0 + 0
   \   000331   85..83       MOV     DPH,?V0 + 1
   \   000334   A3           INC     DPTR
   \   000335   A3           INC     DPTR
   \   000336   A3           INC     DPTR
   \   000337   A3           INC     DPTR
   \   000338   A3           INC     DPTR
   \   000339   A3           INC     DPTR
   \   00033A   E0           MOVX    A,@DPTR
   \   00033B   C0E0         PUSH    A
   \   00033D   EF           MOV     A,R7
   \   00033E   F8           MOV     R0,A
   \   00033F   7900         MOV     R1,#0x0
   \   000341   E8           MOV     A,R0
   \   000342   75F027       MOV     B,#0x27
   \   000345   A4           MUL     AB
   \   000346   C8           XCH     A,R0
   \   000347   AAF0         MOV     R2,B
   \   000349   75F000       MOV     B,#0x0
   \   00034C   A4           MUL     AB
   \   00034D   2A           ADD     A,R2
   \   00034E   FA           MOV     R2,A
   \   00034F   75F027       MOV     B,#0x27
   \   000352   E9           MOV     A,R1
   \   000353   A4           MUL     AB
   \   000354   2A           ADD     A,R2
   \   000355   F9           MOV     R1,A
   \   000356   74..         MOV     A,#(keyEstablishRec + 12) & 0xff
   \   000358   28           ADD     A,R0
   \   000359   F582         MOV     DPL,A
   \   00035B   74..         MOV     A,#((keyEstablishRec + 12) >> 8) & 0xff
   \   00035D   39           ADDC    A,R1
   \   00035E   F583         MOV     DPH,A
   \   000360   D0E0         POP     A
   \   000362   F0           MOVX    @DPTR,A
    902            keyEstablishRec[index].state = KeyEstablishState_EDataPending;
   \   000363   EF           MOV     A,R7
   \   000364   F8           MOV     R0,A
   \   000365   7900         MOV     R1,#0x0
   \   000367   E8           MOV     A,R0
   \   000368   75F027       MOV     B,#0x27
   \   00036B   A4           MUL     AB
   \   00036C   C8           XCH     A,R0
   \   00036D   AAF0         MOV     R2,B
   \   00036F   75F000       MOV     B,#0x0
   \   000372   A4           MUL     AB
   \   000373   2A           ADD     A,R2
   \   000374   FA           MOV     R2,A
   \   000375   75F027       MOV     B,#0x27
   \   000378   E9           MOV     A,R1
   \   000379   A4           MUL     AB
   \   00037A   2A           ADD     A,R2
   \   00037B   F9           MOV     R1,A
   \   00037C   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   00037E   28           ADD     A,R0
   \   00037F   F582         MOV     DPL,A
   \   000381   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000383   39           ADDC    A,R1
   \   000384   F583         MOV     DPH,A
   \   000386   7402         MOV     A,#0x2
   \   000388   F0           MOVX    @DPTR,A
    903            keyEstablishRec[index].role = KEY_ESTABLISHMENT_RESPONDER;
   \   000389   EF           MOV     A,R7
   \   00038A   F8           MOV     R0,A
   \   00038B   7900         MOV     R1,#0x0
   \   00038D   E8           MOV     A,R0
   \   00038E   75F027       MOV     B,#0x27
   \   000391   A4           MUL     AB
   \   000392   C8           XCH     A,R0
   \   000393   AAF0         MOV     R2,B
   \   000395   75F000       MOV     B,#0x0
   \   000398   A4           MUL     AB
   \   000399   2A           ADD     A,R2
   \   00039A   FA           MOV     R2,A
   \   00039B   75F027       MOV     B,#0x27
   \   00039E   E9           MOV     A,R1
   \   00039F   A4           MUL     AB
   \   0003A0   2A           ADD     A,R2
   \   0003A1   F9           MOV     R1,A
   \   0003A2   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   0003A4   28           ADD     A,R0
   \   0003A5   F582         MOV     DPL,A
   \   0003A7   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   0003A9   39           ADDC    A,R1
   \   0003AA   F583         MOV     DPH,A
   \   0003AC   7401         MOV     A,#0x1
   \   0003AE   F0           MOVX    @DPTR,A
    904          
    905            zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
    906                      &pInMsg->msg->srcAddr,
    907                      KEY_ESTABLISHMENT_SUITE,
    908                      ZCL_KEY_ESTABLISHMENT_EKEY_GENERATE_TIMEOUT + ZCL_KEY_ESTABLISHMENT_KEY_GENERATE_TIMEOUT,
    909                      ZCL_KEY_ESTABLISHMENT_MAC_GENERATE_TIMEOUT * 2 ,
    910                      implicitCert, FALSE, pInMsg->hdr.transSeqNum );
   \   0003AF                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp
   \   0003AF   85..82       MOV     DPL,?V0 + 0
   \   0003B2   85..83       MOV     DPH,?V0 + 1
   \   0003B5   A3           INC     DPTR
   \   0003B6   A3           INC     DPTR
   \   0003B7   A3           INC     DPTR
   \   0003B8   A3           INC     DPTR
   \   0003B9   A3           INC     DPTR
   \   0003BA   A3           INC     DPTR
   \   0003BB   E0           MOVX    A,@DPTR
   \   0003BC   F5..         MOV     ?V0 + 4,A
   \   0003BE   78..         MOV     R0,#?V0 + 4
   \   0003C0   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003C3   75..00       MOV     ?V0 + 4,#0x0
   \   0003C6   78..         MOV     R0,#?V0 + 4
   \   0003C8   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003CB   78..         MOV     R0,#?V0 + 2
   \   0003CD   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0003D0   75..14       MOV     ?V0 + 4,#0x14
   \   0003D3   78..         MOV     R0,#?V0 + 4
   \   0003D5   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003D8   75..0E       MOV     ?V0 + 4,#0xe
   \   0003DB   78..         MOV     R0,#?V0 + 4
   \   0003DD   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003E0   7C01         MOV     R4,#0x1
   \   0003E2   7D00         MOV     R5,#0x0
   \   0003E4   85..82       MOV     DPL,?V0 + 0
   \   0003E7   85..83       MOV     DPH,?V0 + 1
   \   0003EA   E0           MOVX    A,@DPTR
   \   0003EB   2406         ADD     A,#0x6
   \   0003ED   FA           MOV     R2,A
   \   0003EE   A3           INC     DPTR
   \   0003EF   E0           MOVX    A,@DPTR
   \   0003F0   3400         ADDC    A,#0x0
   \   0003F2   FB           MOV     R3,A
   \   0003F3   790A         MOV     R1,#0xa
   \   0003F5   12....       LCALL   ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_1
   \   0003F8   7406         MOV     A,#0x6
   \   0003FA   12....       LCALL   ?DEALLOC_XSTACK8
   \   0003FD   E9           MOV     A,R1
    911          
    912            // The Request was processed successfuly, now the age timer needs to start based on the
    913            // remote Ephemeral Data Generate Time
    914            keyEstablishRec[index].age = keyEstablishRec[index].remoteEphDataGenTime;
   \   0003FE   EF           MOV     A,R7
   \   0003FF   F8           MOV     R0,A
   \   000400   7900         MOV     R1,#0x0
   \   000402   E8           MOV     A,R0
   \   000403   75F027       MOV     B,#0x27
   \   000406   A4           MUL     AB
   \   000407   C8           XCH     A,R0
   \   000408   AAF0         MOV     R2,B
   \   00040A   75F000       MOV     B,#0x0
   \   00040D   A4           MUL     AB
   \   00040E   2A           ADD     A,R2
   \   00040F   FA           MOV     R2,A
   \   000410   75F027       MOV     B,#0x27
   \   000413   E9           MOV     A,R1
   \   000414   A4           MUL     AB
   \   000415   2A           ADD     A,R2
   \   000416   F9           MOV     R1,A
   \   000417   74..         MOV     A,#(keyEstablishRec + 37) & 0xff
   \   000419   28           ADD     A,R0
   \   00041A   F582         MOV     DPL,A
   \   00041C   74..         MOV     A,#((keyEstablishRec + 37) >> 8) & 0xff
   \   00041E   39           ADDC    A,R1
   \   00041F   F583         MOV     DPH,A
   \   000421   E0           MOVX    A,@DPTR
   \   000422   C0E0         PUSH    A
   \   000424   EF           MOV     A,R7
   \   000425   F8           MOV     R0,A
   \   000426   7900         MOV     R1,#0x0
   \   000428   E8           MOV     A,R0
   \   000429   75F027       MOV     B,#0x27
   \   00042C   A4           MUL     AB
   \   00042D   C8           XCH     A,R0
   \   00042E   AAF0         MOV     R2,B
   \   000430   75F000       MOV     B,#0x0
   \   000433   A4           MUL     AB
   \   000434   2A           ADD     A,R2
   \   000435   FA           MOV     R2,A
   \   000436   75F027       MOV     B,#0x27
   \   000439   E9           MOV     A,R1
   \   00043A   A4           MUL     AB
   \   00043B   2A           ADD     A,R2
   \   00043C   F9           MOV     R1,A
   \   00043D   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   00043F   28           ADD     A,R0
   \   000440   F582         MOV     DPL,A
   \   000442   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   000444   39           ADDC    A,R1
   \   000445   F583         MOV     DPH,A
   \   000447   D0E0         POP     A
   \   000449   F0           MOVX    @DPTR,A
    915          
    916            // Start the Ephemeral Data Generate aging timer
    917            osal_start_reload_timer( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT,
    918                                     KEY_ESTABLISHMENT_REC_AGING_INTERVAL );
   \   00044A                ; Setup parameters for call to function osal_start_reload_timer
   \   00044A   7CE8         MOV     R4,#-0x18
   \   00044C   7D03         MOV     R5,#0x3
   \   00044E   7A01         MOV     R2,#0x1
   \   000450   7B00         MOV     R3,#0x0
   \   000452   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000455   E0           MOVX    A,@DPTR
   \   000456   F9           MOV     R1,A
   \   000457   12....       LCALL   ??osal_start_reload_timer?relay
   \   00045A   E9           MOV     A,R1
    919          
    920            osal_mem_free(implicitCert);
   \   00045B                ; Setup parameters for call to function osal_mem_free
   \   00045B   AA..         MOV     R2,?V0 + 2
   \   00045D   AB..         MOV     R3,?V0 + 3
   \   00045F   12....       LCALL   ??osal_mem_free?relay
    921          
    922          #if defined (NWK_AUTO_POLL)
    923            // For polling end device, set the Key Establishment poll rate
    924            zclSavedPollRate = zgPollRate;
   \   000462   90....       MOV     DPTR,#zgPollRate
   \   000465   E0           MOVX    A,@DPTR
   \   000466   F8           MOV     R0,A
   \   000467   A3           INC     DPTR
   \   000468   E0           MOVX    A,@DPTR
   \   000469   F9           MOV     R1,A
   \   00046A   90....       MOV     DPTR,#zclSavedPollRate
   \   00046D   E8           MOV     A,R0
   \   00046E   F0           MOVX    @DPTR,A
   \   00046F   A3           INC     DPTR
   \   000470   E9           MOV     A,R1
   \   000471   F0           MOVX    @DPTR,A
    925            NLME_SetPollRate(ZCL_KEY_ESTABLISH_POLL_RATE);
   \   000472                ; Setup parameters for call to function NLME_SetPollRate
   \   000472   7AE8         MOV     R2,#-0x18
   \   000474   7B03         MOV     R3,#0x3
   \   000476   12....       LCALL   ??NLME_SetPollRate?relay
    926          #endif
    927          
    928            return ZCL_STATUS_CMD_HAS_RSP;
   \   000479   79FF         MOV     R1,#-0x1
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish_8:
   \   00047B   7F0A         MOV     R7,#0xa
   \   00047D   02....       LJMP    ?BANKED_LEAVE_XDATA
    929          }
    930          
    931          /*********************************************************************
    932           * @fn      zclGeneral_ProcessInCmd_EphemeralDataReq
    933           *
    934           * @brief   Process the received Ephemeral Data Request.
    935           *
    936           * @param   pInMsg - pointer to the incoming message
    937           *
    938           * @return  ZStatus_t - ZFailure @ Unsupported
    939           *                      ZCL_STATUS_MALFORMED_COMMAND
    940           *                      ZCL_STATUS_CMD_HAS_RSP
    941           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
    942          static ZStatus_t zclGeneral_ProcessInCmd_EphemeralDataReq( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_EphemeralDataReq:
    943          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
    944            uint8 index;
    945            uint8 status = ZFailure;
   \   000009   7F01         MOV     R7,#0x1
    946          
    947            // Omit checking the incoming packet length
    948          
    949            // Stop the Ephemeral Data Generate timer because the message has been received
    950            osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   00000B                ; Setup parameters for call to function osal_stop_timerEx
   \   00000B   7A01         MOV     R2,#0x1
   \   00000D   7B00         MOV     R3,#0x0
   \   00000F   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000012   E0           MOVX    A,@DPTR
   \   000013   F9           MOV     R1,A
   \   000014   12....       LCALL   ??osal_stop_timerEx?relay
   \   000017   E9           MOV     A,R1
    951          
    952            // Check state of the key establishment record. If not match, terminate the procedure
    953            if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
    954                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000018                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000018   85..82       MOV     DPL,?V0 + 0
   \   00001B   85..83       MOV     DPH,?V0 + 1
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F8           MOV     R0,A
   \   000020   A3           INC     DPTR
   \   000021   E0           MOVX    A,@DPTR
   \   000022   C8           XCH     A,R0
   \   000023   2406         ADD     A,#0x6
   \   000025   F582         MOV     DPL,A
   \   000027   E8           MOV     A,R0
   \   000028   3400         ADDC    A,#0x0
   \   00002A   F583         MOV     DPH,A
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   FA           MOV     R2,A
   \   00002E   A3           INC     DPTR
   \   00002F   E0           MOVX    A,@DPTR
   \   000030   FB           MOV     R3,A
   \   000031   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   000034   E9           MOV     A,R1
   \   000035   F8           MOV     R0,A
   \   000036   E8           MOV     A,R0
   \   000037   FE           MOV     R6,A
   \   000038   E8           MOV     A,R0
   \   000039   C3           CLR     C
   \   00003A   9402         SUBB    A,#0x2
   \   00003C   4003         JC      $+5
   \   00003E   02....       LJMP    ??zclGeneral_ProcessInCmd_EphemeralDataReq_0 & 0xFFFF
    955            {
    956              if ( keyEstablishRec[index].role == KEY_ESTABLISHMENT_RESPONDER &&
    957                   keyEstablishRec[index].state == KeyEstablishState_EDataPending )
   \   000041   EE           MOV     A,R6
   \   000042   F8           MOV     R0,A
   \   000043   7900         MOV     R1,#0x0
   \   000045   E8           MOV     A,R0
   \   000046   75F027       MOV     B,#0x27
   \   000049   A4           MUL     AB
   \   00004A   C8           XCH     A,R0
   \   00004B   AAF0         MOV     R2,B
   \   00004D   75F000       MOV     B,#0x0
   \   000050   A4           MUL     AB
   \   000051   2A           ADD     A,R2
   \   000052   FA           MOV     R2,A
   \   000053   75F027       MOV     B,#0x27
   \   000056   E9           MOV     A,R1
   \   000057   A4           MUL     AB
   \   000058   2A           ADD     A,R2
   \   000059   F9           MOV     R1,A
   \   00005A   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   00005C   28           ADD     A,R0
   \   00005D   F582         MOV     DPL,A
   \   00005F   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000061   39           ADDC    A,R1
   \   000062   F583         MOV     DPH,A
   \   000064   E0           MOVX    A,@DPTR
   \   000065   6401         XRL     A,#0x1
   \   000067   707D         JNZ     ??zclGeneral_ProcessInCmd_EphemeralDataReq_1
   \   000069   EE           MOV     A,R6
   \   00006A   F8           MOV     R0,A
   \   00006B   7900         MOV     R1,#0x0
   \   00006D   E8           MOV     A,R0
   \   00006E   75F027       MOV     B,#0x27
   \   000071   A4           MUL     AB
   \   000072   C8           XCH     A,R0
   \   000073   AAF0         MOV     R2,B
   \   000075   75F000       MOV     B,#0x0
   \   000078   A4           MUL     AB
   \   000079   2A           ADD     A,R2
   \   00007A   FA           MOV     R2,A
   \   00007B   75F027       MOV     B,#0x27
   \   00007E   E9           MOV     A,R1
   \   00007F   A4           MUL     AB
   \   000080   2A           ADD     A,R2
   \   000081   F9           MOV     R1,A
   \   000082   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000084   28           ADD     A,R0
   \   000085   F582         MOV     DPL,A
   \   000087   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000089   39           ADDC    A,R1
   \   00008A   F583         MOV     DPH,A
   \   00008C   E0           MOVX    A,@DPTR
   \   00008D   6402         XRL     A,#0x2
   \   00008F   7055         JNZ     ??zclGeneral_ProcessInCmd_EphemeralDataReq_1
    958              {
    959                status = ZSuccess;
   \   000091   7F00         MOV     R7,#0x0
    960          
    961                // Copy the remote device Ephemeral Public key
    962                osal_memcpy( keyEstablishRec[index].pRemotePublicKey,
    963                        &(pInMsg->pData[0]),
    964                        ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   000093                ; Setup parameters for call to function osal_memcpy
   \   000093   85..82       MOV     DPL,?V0 + 0
   \   000096   85..83       MOV     DPH,?V0 + 1
   \   000099   A3           INC     DPTR
   \   00009A   A3           INC     DPTR
   \   00009B   A3           INC     DPTR
   \   00009C   A3           INC     DPTR
   \   00009D   A3           INC     DPTR
   \   00009E   A3           INC     DPTR
   \   00009F   A3           INC     DPTR
   \   0000A0   A3           INC     DPTR
   \   0000A1   E0           MOVX    A,@DPTR
   \   0000A2   F5..         MOV     ?V0 + 4,A
   \   0000A4   A3           INC     DPTR
   \   0000A5   E0           MOVX    A,@DPTR
   \   0000A6   F5..         MOV     ?V0 + 5,A
   \   0000A8   75..00       MOV     ?V0 + 6,#0x0
   \   0000AB   78..         MOV     R0,#?V0 + 4
   \   0000AD   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000B0   7C16         MOV     R4,#0x16
   \   0000B2   7D00         MOV     R5,#0x0
   \   0000B4   EE           MOV     A,R6
   \   0000B5   F8           MOV     R0,A
   \   0000B6   7900         MOV     R1,#0x0
   \   0000B8   E8           MOV     A,R0
   \   0000B9   75F027       MOV     B,#0x27
   \   0000BC   A4           MUL     AB
   \   0000BD   C8           XCH     A,R0
   \   0000BE   AAF0         MOV     R2,B
   \   0000C0   75F000       MOV     B,#0x0
   \   0000C3   A4           MUL     AB
   \   0000C4   2A           ADD     A,R2
   \   0000C5   FA           MOV     R2,A
   \   0000C6   75F027       MOV     B,#0x27
   \   0000C9   E9           MOV     A,R1
   \   0000CA   A4           MUL     AB
   \   0000CB   2A           ADD     A,R2
   \   0000CC   F9           MOV     R1,A
   \   0000CD   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   0000CF   28           ADD     A,R0
   \   0000D0   F582         MOV     DPL,A
   \   0000D2   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   0000D4   39           ADDC    A,R1
   \   0000D5   F583         MOV     DPH,A
   \   0000D7   E0           MOVX    A,@DPTR
   \   0000D8   FA           MOV     R2,A
   \   0000D9   A3           INC     DPTR
   \   0000DA   E0           MOVX    A,@DPTR
   \   0000DB   FB           MOV     R3,A
   \   0000DC   12....       LCALL   ??osal_memcpy?relay
   \   0000DF   7403         MOV     A,#0x3
   \   0000E1   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000E4   8005         SJMP    ??zclGeneral_ProcessInCmd_EphemeralDataReq_0
    965              }
    966              else
    967              {
    968                // Reset the entry
    969                zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataReq_1:
   \   0000E6                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0000E6   EE           MOV     A,R6
   \   0000E7   F9           MOV     R1,A
   \   0000E8   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
    970              }
    971            }
    972          
    973            if( status != ZSuccess )
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataReq_0:
   \   0000EB   EF           MOV     A,R7
   \   0000EC   605D         JZ      ??zclGeneral_ProcessInCmd_EphemeralDataReq_2
    974            {
    975              // Either the entry doesn't exist or in the wrong state, send termination back
    976              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
    977                                                                      &pInMsg->msg->srcAddr,
    978                                                                      TermKeyStatus_BadMessage,
    979                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
    980                                                                      KEY_ESTABLISHMENT_SUITE,
    981                                                                      ZCL_FRAME_SERVER_CLIENT_DIR,
    982                                                                      FALSE, zcl_SeqNum++ );
   \   0000EE   90....       MOV     DPTR,#zcl_SeqNum
   \   0000F1   E0           MOVX    A,@DPTR
   \   0000F2   F8           MOV     R0,A
   \   0000F3   7401         MOV     A,#0x1
   \   0000F5   28           ADD     A,R0
   \   0000F6   90....       MOV     DPTR,#zcl_SeqNum
   \   0000F9   F0           MOVX    @DPTR,A
   \   0000FA                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   0000FA   E8           MOV     A,R0
   \   0000FB   F5..         MOV     ?V0 + 2,A
   \   0000FD   78..         MOV     R0,#?V0 + 2
   \   0000FF   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000102   75..00       MOV     ?V0 + 2,#0x0
   \   000105   78..         MOV     R0,#?V0 + 2
   \   000107   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00010A   75..01       MOV     ?V0 + 2,#0x1
   \   00010D   78..         MOV     R0,#?V0 + 2
   \   00010F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000112   75..01       MOV     ?V0 + 2,#0x1
   \   000115   75..00       MOV     ?V0 + 3,#0x0
   \   000118   78..         MOV     R0,#?V0 + 2
   \   00011A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00011D   7D1C         MOV     R5,#0x1c
   \   00011F   7C03         MOV     R4,#0x3
   \   000121   85..82       MOV     DPL,?V0 + 0
   \   000124   85..83       MOV     DPH,?V0 + 1
   \   000127   E0           MOVX    A,@DPTR
   \   000128   2406         ADD     A,#0x6
   \   00012A   FA           MOV     R2,A
   \   00012B   A3           INC     DPTR
   \   00012C   E0           MOVX    A,@DPTR
   \   00012D   3400         ADDC    A,#0x0
   \   00012F   FB           MOV     R3,A
   \   000130   790A         MOV     R1,#0xa
   \   000132   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   000135   7405         MOV     A,#0x5
   \   000137   12....       LCALL   ?DEALLOC_XSTACK8
   \   00013A   E9           MOV     A,R1
    983          
    984          #if defined (NWK_AUTO_POLL)
    985            // Restore the saved poll rate for end device
    986            NLME_SetPollRate(zclSavedPollRate);
   \   00013B                ; Setup parameters for call to function NLME_SetPollRate
   \   00013B   90....       MOV     DPTR,#zclSavedPollRate
   \   00013E   E0           MOVX    A,@DPTR
   \   00013F   FA           MOV     R2,A
   \   000140   A3           INC     DPTR
   \   000141   E0           MOVX    A,@DPTR
   \   000142   FB           MOV     R3,A
   \   000143   12....       LCALL   ??NLME_SetPollRate?relay
    987          #endif
    988              return ZCL_STATUS_CMD_HAS_RSP;
   \   000146   79FF         MOV     R1,#-0x1
   \   000148   02....       LJMP    ??zclGeneral_ProcessInCmd_EphemeralDataReq_3 & 0xFFFF
    989            }
    990          
    991            // Generate Ephemeral Public/Private Key Pair
    992            ZSE_ECCGenerateKey( (unsigned char *)keyEstablishRec[index].pLocalEPrivateKey,
    993                              (unsigned char *)keyEstablishRec[index].pLocalEPublicKey,
    994                              zclGeneral_KeyEstablishment_GetRandom,
    995                              zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel );
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataReq_2:
   \   00014B                ; Setup parameters for call to function ZSE_ECCGenerateKey
   \   00014B   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   00014E   E0           MOVX    A,@DPTR
   \   00014F   F5..         MOV     ?V0 + 4,A
   \   000151   E4           CLR     A
   \   000152   F5..         MOV     ?V0 + 5,A
   \   000154   F5..         MOV     ?V0 + 6,A
   \   000156   F5..         MOV     ?V0 + 7,A
   \   000158   78..         MOV     R0,#?V0 + 4
   \   00015A   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   00015D   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   000160   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000163   75....       MOV     ?V0 + 2,#??zclGeneral_KeyEstablishment_GetRandom?relay & 0xff
   \   000166   75....       MOV     ?V0 + 3,#(??zclGeneral_KeyEstablishment_GetRandom?relay >> 8) & 0xff
   \   000169   78..         MOV     R0,#?V0 + 2
   \   00016B   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00016E   EE           MOV     A,R6
   \   00016F   F8           MOV     R0,A
   \   000170   7900         MOV     R1,#0x0
   \   000172   E8           MOV     A,R0
   \   000173   75F027       MOV     B,#0x27
   \   000176   A4           MUL     AB
   \   000177   C8           XCH     A,R0
   \   000178   AAF0         MOV     R2,B
   \   00017A   75F000       MOV     B,#0x0
   \   00017D   A4           MUL     AB
   \   00017E   2A           ADD     A,R2
   \   00017F   FA           MOV     R2,A
   \   000180   75F027       MOV     B,#0x27
   \   000183   E9           MOV     A,R1
   \   000184   A4           MUL     AB
   \   000185   2A           ADD     A,R2
   \   000186   F9           MOV     R1,A
   \   000187   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   000189   28           ADD     A,R0
   \   00018A   F582         MOV     DPL,A
   \   00018C   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   00018E   39           ADDC    A,R1
   \   00018F   F583         MOV     DPH,A
   \   000191   E0           MOVX    A,@DPTR
   \   000192   FC           MOV     R4,A
   \   000193   A3           INC     DPTR
   \   000194   E0           MOVX    A,@DPTR
   \   000195   FD           MOV     R5,A
   \   000196   EE           MOV     A,R6
   \   000197   F8           MOV     R0,A
   \   000198   7900         MOV     R1,#0x0
   \   00019A   E8           MOV     A,R0
   \   00019B   75F027       MOV     B,#0x27
   \   00019E   A4           MUL     AB
   \   00019F   C8           XCH     A,R0
   \   0001A0   AAF0         MOV     R2,B
   \   0001A2   75F000       MOV     B,#0x0
   \   0001A5   A4           MUL     AB
   \   0001A6   2A           ADD     A,R2
   \   0001A7   FA           MOV     R2,A
   \   0001A8   75F027       MOV     B,#0x27
   \   0001AB   E9           MOV     A,R1
   \   0001AC   A4           MUL     AB
   \   0001AD   2A           ADD     A,R2
   \   0001AE   F9           MOV     R1,A
   \   0001AF   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   0001B1   28           ADD     A,R0
   \   0001B2   F582         MOV     DPL,A
   \   0001B4   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   0001B6   39           ADDC    A,R1
   \   0001B7   F583         MOV     DPH,A
   \   0001B9   E0           MOVX    A,@DPTR
   \   0001BA   FA           MOV     R2,A
   \   0001BB   A3           INC     DPTR
   \   0001BC   E0           MOVX    A,@DPTR
   \   0001BD   FB           MOV     R3,A
   \   0001BE   12....       LCALL   ??ZSE_ECCGenerateKey?relay
   \   0001C1   7408         MOV     A,#0x8
   \   0001C3   12....       LCALL   ?DEALLOC_XSTACK8
    996          
    997          #if defined (DEBUG_STATIC_ECC)
    998          
    999            // For debug and testing purpose, use a fixed ephermeral key pair instead
   1000            // of the randomly generated one.
   1001            osal_memcpy( keyEstablishRec[index].pLocalEPrivateKey, private2, 21 );
   1002            osal_memcpy( keyEstablishRec[index].pLocalEPublicKey, public2, 22 );
   1003          #endif
   1004          
   1005            // Update Sequence Number
   1006            keyEstablishRec[index].lastSeqNum = pInMsg->hdr.transSeqNum;
   \   0001C6   85..82       MOV     DPL,?V0 + 0
   \   0001C9   85..83       MOV     DPH,?V0 + 1
   \   0001CC   A3           INC     DPTR
   \   0001CD   A3           INC     DPTR
   \   0001CE   A3           INC     DPTR
   \   0001CF   A3           INC     DPTR
   \   0001D0   A3           INC     DPTR
   \   0001D1   A3           INC     DPTR
   \   0001D2   E0           MOVX    A,@DPTR
   \   0001D3   C0E0         PUSH    A
   \   0001D5   EE           MOV     A,R6
   \   0001D6   F8           MOV     R0,A
   \   0001D7   7900         MOV     R1,#0x0
   \   0001D9   E8           MOV     A,R0
   \   0001DA   75F027       MOV     B,#0x27
   \   0001DD   A4           MUL     AB
   \   0001DE   C8           XCH     A,R0
   \   0001DF   AAF0         MOV     R2,B
   \   0001E1   75F000       MOV     B,#0x0
   \   0001E4   A4           MUL     AB
   \   0001E5   2A           ADD     A,R2
   \   0001E6   FA           MOV     R2,A
   \   0001E7   75F027       MOV     B,#0x27
   \   0001EA   E9           MOV     A,R1
   \   0001EB   A4           MUL     AB
   \   0001EC   2A           ADD     A,R2
   \   0001ED   F9           MOV     R1,A
   \   0001EE   74..         MOV     A,#(keyEstablishRec + 12) & 0xff
   \   0001F0   28           ADD     A,R0
   \   0001F1   F582         MOV     DPL,A
   \   0001F3   74..         MOV     A,#((keyEstablishRec + 12) >> 8) & 0xff
   \   0001F5   39           ADDC    A,R1
   \   0001F6   F583         MOV     DPH,A
   \   0001F8   D0E0         POP     A
   \   0001FA   F0           MOVX    @DPTR,A
   1007          
   1008            // Change the state and wait for the Key to be calculated
   1009            keyEstablishRec[index].state = KeyEstablishState_KeyCalculatePending;
   \   0001FB   EE           MOV     A,R6
   \   0001FC   F8           MOV     R0,A
   \   0001FD   7900         MOV     R1,#0x0
   \   0001FF   E8           MOV     A,R0
   \   000200   75F027       MOV     B,#0x27
   \   000203   A4           MUL     AB
   \   000204   C8           XCH     A,R0
   \   000205   AAF0         MOV     R2,B
   \   000207   75F000       MOV     B,#0x0
   \   00020A   A4           MUL     AB
   \   00020B   2A           ADD     A,R2
   \   00020C   FA           MOV     R2,A
   \   00020D   75F027       MOV     B,#0x27
   \   000210   E9           MOV     A,R1
   \   000211   A4           MUL     AB
   \   000212   2A           ADD     A,R2
   \   000213   F9           MOV     R1,A
   \   000214   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000216   28           ADD     A,R0
   \   000217   F582         MOV     DPL,A
   \   000219   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   00021B   39           ADDC    A,R1
   \   00021C   F583         MOV     DPH,A
   \   00021E   7403         MOV     A,#0x3
   \   000220   F0           MOVX    @DPTR,A
   1010          
   1011            osal_start_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_CMD_PROCESS_EVT,
   1012                                KEY_ESTABLISHMENT_WAIT_PERIOD );
   \   000221                ; Setup parameters for call to function osal_start_timerEx
   \   000221   7CF4         MOV     R4,#-0xc
   \   000223   7D01         MOV     R5,#0x1
   \   000225   7A02         MOV     R2,#0x2
   \   000227   7B00         MOV     R3,#0x0
   \   000229   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   00022C   E0           MOVX    A,@DPTR
   \   00022D   F9           MOV     R1,A
   \   00022E   12....       LCALL   ??osal_start_timerEx?relay
   \   000231   E9           MOV     A,R1
   1013          
   1014          
   1015            return ZCL_STATUS_CMD_HAS_RSP;
   \   000232   79FF         MOV     R1,#-0x1
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataReq_3:
   \   000234   7F08         MOV     R7,#0x8
   \   000236   02....       LJMP    ?BANKED_LEAVE_XDATA
   1016          }
   1017          
   1018          
   1019          /*********************************************************************
   1020           * @fn      zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp
   1021           *
   1022           * @brief   Process the received Initiate Key Establishment Response.
   1023           *
   1024           * @param   pInMsg - pointer to the incoming message
   1025           *
   1026           * @return  ZStatus_t - ZFailure @ Unsupported
   1027           *                      ZCL_STATUS_MALFORMED_COMMAND
   1028           *                      ZCL_STATUS_CMD_HAS_RSP
   1029           *                      ZCL_STATUS_SOFTWARE_FAILURE
   1030           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1031          static ZStatus_t zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp:
   1032          {
   \   000000   74EC         MOV     A,#-0x14
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 20
   \   000005                ; Auto size: 8
   \   000005   74F8         MOV     A,#-0x8
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 2,R2
   \   00000C   8B..         MOV     ?V0 + 3,R3
   1033            TermKeyStatus_t keyStatus = TermKeyStatus_Success;
   \   00000E   7F00         MOV     R7,#0x0
   1034            uint16 remoteKeyEstablishmentSuite;
   1035            uint8 index = MAX_KEY_ESTABLISHMENT_REC_ENTRY; // set to non valid value
   \   000010   7E02         MOV     R6,#0x2
   1036            uint8 status = ZFailure;
   \   000012   75..01       MOV     ?V0 + 0,#0x1
   1037            uint8 recvExtAddr[Z_EXTADDR_LEN];
   1038          
   1039            // Stop the Key Establishment aging timer because the message has been received
   1040            osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   000015                ; Setup parameters for call to function osal_stop_timerEx
   \   000015   7A01         MOV     R2,#0x1
   \   000017   7B00         MOV     R3,#0x0
   \   000019   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   00001C   E0           MOVX    A,@DPTR
   \   00001D   F9           MOV     R1,A
   \   00001E   12....       LCALL   ??osal_stop_timerEx?relay
   \   000021   E9           MOV     A,R1
   1041          
   1042            // Check the incoming packet length
   1043            if ( pInMsg->pDataLen >= PACKET_LEN_INITIATE_KEY_EST_RSP )
   \   000022   85..82       MOV     DPL,?V0 + 2
   \   000025   85..83       MOV     DPH,?V0 + 3
   \   000028   A3           INC     DPTR
   \   000029   A3           INC     DPTR
   \   00002A   A3           INC     DPTR
   \   00002B   A3           INC     DPTR
   \   00002C   A3           INC     DPTR
   \   00002D   A3           INC     DPTR
   \   00002E   A3           INC     DPTR
   \   00002F   A3           INC     DPTR
   \   000030   A3           INC     DPTR
   \   000031   A3           INC     DPTR
   \   000032   C3           CLR     C
   \   000033   E0           MOVX    A,@DPTR
   \   000034   9434         SUBB    A,#0x34
   \   000036   A3           INC     DPTR
   \   000037   E0           MOVX    A,@DPTR
   \   000038   9400         SUBB    A,#0x0
   \   00003A   5003         JNC     $+5
   \   00003C   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_1 & 0xFFFF
   1044            {
   1045              // Check state of the key establishment record. If not match, terminate the procedure
   1046              if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
   1047                  < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   00003F                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   00003F   85..82       MOV     DPL,?V0 + 2
   \   000042   85..83       MOV     DPH,?V0 + 3
   \   000045   E0           MOVX    A,@DPTR
   \   000046   F8           MOV     R0,A
   \   000047   A3           INC     DPTR
   \   000048   E0           MOVX    A,@DPTR
   \   000049   C8           XCH     A,R0
   \   00004A   2406         ADD     A,#0x6
   \   00004C   F582         MOV     DPL,A
   \   00004E   E8           MOV     A,R0
   \   00004F   3400         ADDC    A,#0x0
   \   000051   F583         MOV     DPH,A
   \   000053   E0           MOVX    A,@DPTR
   \   000054   FA           MOV     R2,A
   \   000055   A3           INC     DPTR
   \   000056   E0           MOVX    A,@DPTR
   \   000057   FB           MOV     R3,A
   \   000058   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   00005B   E9           MOV     A,R1
   \   00005C   F8           MOV     R0,A
   \   00005D   E8           MOV     A,R0
   \   00005E   FE           MOV     R6,A
   \   00005F   E8           MOV     A,R0
   \   000060   C3           CLR     C
   \   000061   9402         SUBB    A,#0x2
   \   000063   4003         JC      $+5
   \   000065   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_1 & 0xFFFF
   1048              {
   1049                if ( keyEstablishRec[index].role == KEY_ESTABLISHMENT_INITIATOR &&
   1050                    keyEstablishRec[index].state == KeyEstablishState_InitiatePending )
   \   000068   EE           MOV     A,R6
   \   000069   F8           MOV     R0,A
   \   00006A   7900         MOV     R1,#0x0
   \   00006C   E8           MOV     A,R0
   \   00006D   75F027       MOV     B,#0x27
   \   000070   A4           MUL     AB
   \   000071   C8           XCH     A,R0
   \   000072   AAF0         MOV     R2,B
   \   000074   75F000       MOV     B,#0x0
   \   000077   A4           MUL     AB
   \   000078   2A           ADD     A,R2
   \   000079   FA           MOV     R2,A
   \   00007A   75F027       MOV     B,#0x27
   \   00007D   E9           MOV     A,R1
   \   00007E   A4           MUL     AB
   \   00007F   2A           ADD     A,R2
   \   000080   F9           MOV     R1,A
   \   000081   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   000083   28           ADD     A,R0
   \   000084   F582         MOV     DPL,A
   \   000086   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000088   39           ADDC    A,R1
   \   000089   F583         MOV     DPH,A
   \   00008B   E0           MOVX    A,@DPTR
   \   00008C   6003         JZ      $+5
   \   00008E   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_2 & 0xFFFF
   \   000091   EE           MOV     A,R6
   \   000092   F8           MOV     R0,A
   \   000093   7900         MOV     R1,#0x0
   \   000095   E8           MOV     A,R0
   \   000096   75F027       MOV     B,#0x27
   \   000099   A4           MUL     AB
   \   00009A   C8           XCH     A,R0
   \   00009B   AAF0         MOV     R2,B
   \   00009D   75F000       MOV     B,#0x0
   \   0000A0   A4           MUL     AB
   \   0000A1   2A           ADD     A,R2
   \   0000A2   FA           MOV     R2,A
   \   0000A3   75F027       MOV     B,#0x27
   \   0000A6   E9           MOV     A,R1
   \   0000A7   A4           MUL     AB
   \   0000A8   2A           ADD     A,R2
   \   0000A9   F9           MOV     R1,A
   \   0000AA   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   0000AC   28           ADD     A,R0
   \   0000AD   F582         MOV     DPL,A
   \   0000AF   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   0000B1   39           ADDC    A,R1
   \   0000B2   F583         MOV     DPH,A
   \   0000B4   E0           MOVX    A,@DPTR
   \   0000B5   6401         XRL     A,#0x1
   \   0000B7   6003         JZ      $+5
   \   0000B9   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_2 & 0xFFFF
   1051                {
   1052                  // Parse the incoming message
   1053                  // Copy the remote device certificate
   1054                  osal_memcpy( keyEstablishRec[index].pRemoteCertificate, &(pInMsg->pData[KEY_ESTABLISH_CERT_IDX]),
   1055                               ZCL_KE_IMPLICIT_CERTIFICATE_LEN );
   \   0000BC                ; Setup parameters for call to function osal_memcpy
   \   0000BC   85..82       MOV     DPL,?V0 + 2
   \   0000BF   85..83       MOV     DPH,?V0 + 3
   \   0000C2   A3           INC     DPTR
   \   0000C3   A3           INC     DPTR
   \   0000C4   A3           INC     DPTR
   \   0000C5   A3           INC     DPTR
   \   0000C6   A3           INC     DPTR
   \   0000C7   A3           INC     DPTR
   \   0000C8   A3           INC     DPTR
   \   0000C9   A3           INC     DPTR
   \   0000CA   E0           MOVX    A,@DPTR
   \   0000CB   2404         ADD     A,#0x4
   \   0000CD   F5..         MOV     ?V0 + 4,A
   \   0000CF   A3           INC     DPTR
   \   0000D0   E0           MOVX    A,@DPTR
   \   0000D1   3400         ADDC    A,#0x0
   \   0000D3   F5..         MOV     ?V0 + 5,A
   \   0000D5   75..00       MOV     ?V0 + 6,#0x0
   \   0000D8   78..         MOV     R0,#?V0 + 4
   \   0000DA   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000DD   7C30         MOV     R4,#0x30
   \   0000DF   7D00         MOV     R5,#0x0
   \   0000E1   EE           MOV     A,R6
   \   0000E2   F8           MOV     R0,A
   \   0000E3   7900         MOV     R1,#0x0
   \   0000E5   E8           MOV     A,R0
   \   0000E6   75F027       MOV     B,#0x27
   \   0000E9   A4           MUL     AB
   \   0000EA   C8           XCH     A,R0
   \   0000EB   AAF0         MOV     R2,B
   \   0000ED   75F000       MOV     B,#0x0
   \   0000F0   A4           MUL     AB
   \   0000F1   2A           ADD     A,R2
   \   0000F2   FA           MOV     R2,A
   \   0000F3   75F027       MOV     B,#0x27
   \   0000F6   E9           MOV     A,R1
   \   0000F7   A4           MUL     AB
   \   0000F8   2A           ADD     A,R2
   \   0000F9   F9           MOV     R1,A
   \   0000FA   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   0000FC   28           ADD     A,R0
   \   0000FD   F582         MOV     DPL,A
   \   0000FF   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   000101   39           ADDC    A,R1
   \   000102   F583         MOV     DPH,A
   \   000104   E0           MOVX    A,@DPTR
   \   000105   FA           MOV     R2,A
   \   000106   A3           INC     DPTR
   \   000107   E0           MOVX    A,@DPTR
   \   000108   FB           MOV     R3,A
   \   000109   12....       LCALL   ??osal_memcpy?relay
   \   00010C   7403         MOV     A,#0x3
   \   00010E   12....       LCALL   ?DEALLOC_XSTACK8
   1056          
   1057                  // look for extended address of partner device
   1058                  AddrMgrExtAddrLookup(keyEstablishRec[index].dstAddr.addr.shortAddr,
   1059                                       keyEstablishRec[index].partnerExtAddr);
   \   000111                ; Setup parameters for call to function AddrMgrExtAddrLookup
   \   000111   EE           MOV     A,R6
   \   000112   F8           MOV     R0,A
   \   000113   7900         MOV     R1,#0x0
   \   000115   E8           MOV     A,R0
   \   000116   75F027       MOV     B,#0x27
   \   000119   A4           MUL     AB
   \   00011A   C8           XCH     A,R0
   \   00011B   AAF0         MOV     R2,B
   \   00011D   75F000       MOV     B,#0x0
   \   000120   A4           MUL     AB
   \   000121   2A           ADD     A,R2
   \   000122   FA           MOV     R2,A
   \   000123   75F027       MOV     B,#0x27
   \   000126   E9           MOV     A,R1
   \   000127   A4           MUL     AB
   \   000128   2A           ADD     A,R2
   \   000129   F9           MOV     R1,A
   \   00012A   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   00012C   28           ADD     A,R0
   \   00012D   FC           MOV     R4,A
   \   00012E   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   000130   39           ADDC    A,R1
   \   000131   FD           MOV     R5,A
   \   000132   EE           MOV     A,R6
   \   000133   F8           MOV     R0,A
   \   000134   7900         MOV     R1,#0x0
   \   000136   E8           MOV     A,R0
   \   000137   75F027       MOV     B,#0x27
   \   00013A   A4           MUL     AB
   \   00013B   C8           XCH     A,R0
   \   00013C   AAF0         MOV     R2,B
   \   00013E   75F000       MOV     B,#0x0
   \   000141   A4           MUL     AB
   \   000142   2A           ADD     A,R2
   \   000143   FA           MOV     R2,A
   \   000144   75F027       MOV     B,#0x27
   \   000147   E9           MOV     A,R1
   \   000148   A4           MUL     AB
   \   000149   2A           ADD     A,R2
   \   00014A   F9           MOV     R1,A
   \   00014B   74..         MOV     A,#keyEstablishRec & 0xff
   \   00014D   28           ADD     A,R0
   \   00014E   F582         MOV     DPL,A
   \   000150   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   000152   39           ADDC    A,R1
   \   000153   F583         MOV     DPH,A
   \   000155   E0           MOVX    A,@DPTR
   \   000156   FA           MOV     R2,A
   \   000157   A3           INC     DPTR
   \   000158   E0           MOVX    A,@DPTR
   \   000159   FB           MOV     R3,A
   \   00015A   12....       LCALL   ??AddrMgrExtAddrLookup?relay
   \   00015D   E9           MOV     A,R1
   1060          
   1061                  // retrieve extended address from certificate and reverse bytes
   1062                  SSP_MemCpyReverse( recvExtAddr,
   1063                                     &(keyEstablishRec[index].pRemoteCertificate[KEY_ESTABLISH_CERT_EXT_ADDR_IDX]),
   1064                                     Z_EXTADDR_LEN);
   \   00015E                ; Setup parameters for call to function SSP_MemCpyReverse
   \   00015E   75..08       MOV     ?V0 + 4,#0x8
   \   000161   75..00       MOV     ?V0 + 5,#0x0
   \   000164   78..         MOV     R0,#?V0 + 4
   \   000166   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000169   EE           MOV     A,R6
   \   00016A   F8           MOV     R0,A
   \   00016B   7900         MOV     R1,#0x0
   \   00016D   E8           MOV     A,R0
   \   00016E   75F027       MOV     B,#0x27
   \   000171   A4           MUL     AB
   \   000172   C8           XCH     A,R0
   \   000173   AAF0         MOV     R2,B
   \   000175   75F000       MOV     B,#0x0
   \   000178   A4           MUL     AB
   \   000179   2A           ADD     A,R2
   \   00017A   FA           MOV     R2,A
   \   00017B   75F027       MOV     B,#0x27
   \   00017E   E9           MOV     A,R1
   \   00017F   A4           MUL     AB
   \   000180   2A           ADD     A,R2
   \   000181   F9           MOV     R1,A
   \   000182   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   000184   28           ADD     A,R0
   \   000185   F582         MOV     DPL,A
   \   000187   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   000189   39           ADDC    A,R1
   \   00018A   F583         MOV     DPH,A
   \   00018C   E0           MOVX    A,@DPTR
   \   00018D   2416         ADD     A,#0x16
   \   00018F   FC           MOV     R4,A
   \   000190   A3           INC     DPTR
   \   000191   E0           MOVX    A,@DPTR
   \   000192   3400         ADDC    A,#0x0
   \   000194   FD           MOV     R5,A
   \   000195   7402         MOV     A,#0x2
   \   000197   12....       LCALL   ?XSTACK_DISP0_8
   \   00019A   AA82         MOV     R2,DPL
   \   00019C   AB83         MOV     R3,DPH
   \   00019E   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   0001A1   7402         MOV     A,#0x2
   \   0001A3   12....       LCALL   ?DEALLOC_XSTACK8
   1065          
   1066                  // verify extended address in certificate matches partner's extended address
   1067                  if (osal_memcmp(keyEstablishRec[index].partnerExtAddr, recvExtAddr, Z_EXTADDR_LEN))
   \   0001A6                ; Setup parameters for call to function osal_memcmp
   \   0001A6   85..82       MOV     DPL,?XSP + 0
   \   0001A9   85..83       MOV     DPH,?XSP + 1
   \   0001AC   A982         MOV     R1,DPL
   \   0001AE   AA83         MOV     R2,DPH
   \   0001B0   7B00         MOV     R3,#0x0
   \   0001B2   89..         MOV     ?V0 + 4,R1
   \   0001B4   8A..         MOV     ?V0 + 5,R2
   \   0001B6   8B..         MOV     ?V0 + 6,R3
   \   0001B8   78..         MOV     R0,#?V0 + 4
   \   0001BA   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0001BD   7C08         MOV     R4,#0x8
   \   0001BF   7D00         MOV     R5,#0x0
   \   0001C1   EE           MOV     A,R6
   \   0001C2   F8           MOV     R0,A
   \   0001C3   7900         MOV     R1,#0x0
   \   0001C5   E8           MOV     A,R0
   \   0001C6   75F027       MOV     B,#0x27
   \   0001C9   A4           MUL     AB
   \   0001CA   C8           XCH     A,R0
   \   0001CB   AAF0         MOV     R2,B
   \   0001CD   75F000       MOV     B,#0x0
   \   0001D0   A4           MUL     AB
   \   0001D1   2A           ADD     A,R2
   \   0001D2   FA           MOV     R2,A
   \   0001D3   75F027       MOV     B,#0x27
   \   0001D6   E9           MOV     A,R1
   \   0001D7   A4           MUL     AB
   \   0001D8   2A           ADD     A,R2
   \   0001D9   F9           MOV     R1,A
   \   0001DA   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   0001DC   28           ADD     A,R0
   \   0001DD   F5..         MOV     ?V0 + 4,A
   \   0001DF   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   0001E1   39           ADDC    A,R1
   \   0001E2   F5..         MOV     ?V0 + 5,A
   \   0001E4   A9..         MOV     R1,?V0 + 4
   \   0001E6   AA..         MOV     R2,?V0 + 5
   \   0001E8   7B00         MOV     R3,#0x0
   \   0001EA   12....       LCALL   ??osal_memcmp?relay
   \   0001ED   7403         MOV     A,#0x3
   \   0001EF   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001F2   E9           MOV     A,R1
   \   0001F3   600A         JZ      ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_1
   1068                  {
   1069                    status = ZSuccess;
   \   0001F5   75..00       MOV     ?V0 + 0,#0x0
   \   0001F8   8005         SJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_1
   1070                  }
   1071                }
   1072                else
   1073                {
   1074                  // Reset the entry from the rec table
   1075                  zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_2:
   \   0001FA                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0001FA   EE           MOV     A,R6
   \   0001FB   F9           MOV     R1,A
   \   0001FC   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1076                }
   1077              }
   1078            }
   1079          
   1080            if ( status == ZFailure )
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_1:
   \   0001FF   7401         MOV     A,#0x1
   \   000201   65..         XRL     A,?V0 + 0
   \   000203   7005         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_3
   1081            {
   1082              keyStatus = TermKeyStatus_BadMessage;
   \   000205   7F03         MOV     R7,#0x3
   \   000207   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_4 & 0xFFFF
   1083            }
   1084            else
   1085            {
   1086              uint8 *implicitCert;
   1087          
   1088              // Parse the incoming message
   1089              // Verify the certificate issuer and key establishment suite
   1090              remoteKeyEstablishmentSuite = BUILD_UINT16( pInMsg->pData[0], pInMsg->pData[1] );
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_3:
   \   00020A   85..82       MOV     DPL,?V0 + 2
   \   00020D   85..83       MOV     DPH,?V0 + 3
   \   000210   A3           INC     DPTR
   \   000211   A3           INC     DPTR
   \   000212   A3           INC     DPTR
   \   000213   A3           INC     DPTR
   \   000214   A3           INC     DPTR
   \   000215   A3           INC     DPTR
   \   000216   A3           INC     DPTR
   \   000217   A3           INC     DPTR
   \   000218   E0           MOVX    A,@DPTR
   \   000219   F8           MOV     R0,A
   \   00021A   A3           INC     DPTR
   \   00021B   E0           MOVX    A,@DPTR
   \   00021C   F583         MOV     DPH,A
   \   00021E   8882         MOV     DPL,R0
   \   000220   E0           MOVX    A,@DPTR
   \   000221   FA           MOV     R2,A
   \   000222   7B00         MOV     R3,#0x0
   \   000224   85..82       MOV     DPL,?V0 + 2
   \   000227   85..83       MOV     DPH,?V0 + 3
   \   00022A   A3           INC     DPTR
   \   00022B   A3           INC     DPTR
   \   00022C   A3           INC     DPTR
   \   00022D   A3           INC     DPTR
   \   00022E   A3           INC     DPTR
   \   00022F   A3           INC     DPTR
   \   000230   A3           INC     DPTR
   \   000231   A3           INC     DPTR
   \   000232   E0           MOVX    A,@DPTR
   \   000233   F8           MOV     R0,A
   \   000234   A3           INC     DPTR
   \   000235   E0           MOVX    A,@DPTR
   \   000236   F583         MOV     DPH,A
   \   000238   8882         MOV     DPL,R0
   \   00023A   A3           INC     DPTR
   \   00023B   E0           MOVX    A,@DPTR
   \   00023C   F8           MOV     R0,A
   \   00023D   7900         MOV     R1,#0x0
   \   00023F   E4           CLR     A
   \   000240   C8           XCH     A,R0
   \   000241   F9           MOV     R1,A
   \   000242   EA           MOV     A,R2
   \   000243   28           ADD     A,R0
   \   000244   F8           MOV     R0,A
   \   000245   EB           MOV     A,R3
   \   000246   39           ADDC    A,R1
   \   000247   F9           MOV     R1,A
   \   000248   88..         MOV     ?V0 + 8,R0
   \   00024A   89..         MOV     ?V0 + 9,R1
   1091              if ( remoteKeyEstablishmentSuite != KEY_ESTABLISHMENT_SUITE )
   \   00024C   7401         MOV     A,#0x1
   \   00024E   65..         XRL     A,?V0 + 8
   \   000250   7004         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_5
   \   000252   7400         MOV     A,#0x0
   \   000254   65..         XRL     A,?V0 + 9
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_5:
   \   000256   6005         JZ      ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_6
   1092              {
   1093                keyStatus = TermKeyStatus_UnSupportedSuite;
   \   000258   7F05         MOV     R7,#0x5
   \   00025A   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_4 & 0xFFFF
   1094              }
   1095              else
   1096              {
   1097                // continue parsing message
   1098          
   1099                // Save Ephemeral Data Generate Key and Confirm Key Time
   1100                if (pInMsg->pData[2] >= KEY_ESTABLISHMENT_EPH_DATA_GEN_INVALID_TIME)
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_6:
   \   00025D   85..82       MOV     DPL,?V0 + 2
   \   000260   85..83       MOV     DPH,?V0 + 3
   \   000263   A3           INC     DPTR
   \   000264   A3           INC     DPTR
   \   000265   A3           INC     DPTR
   \   000266   A3           INC     DPTR
   \   000267   A3           INC     DPTR
   \   000268   A3           INC     DPTR
   \   000269   A3           INC     DPTR
   \   00026A   A3           INC     DPTR
   \   00026B   E0           MOVX    A,@DPTR
   \   00026C   F8           MOV     R0,A
   \   00026D   A3           INC     DPTR
   \   00026E   E0           MOVX    A,@DPTR
   \   00026F   F583         MOV     DPH,A
   \   000271   8882         MOV     DPL,R0
   \   000273   A3           INC     DPTR
   \   000274   A3           INC     DPTR
   \   000275   E0           MOVX    A,@DPTR
   \   000276   C3           CLR     C
   \   000277   94FF         SUBB    A,#-0x1
   \   000279   4006         JC      ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_7
   1101                {
   1102                  status = TermKeyStatus_BadMessage;
   \   00027B   75..03       MOV     ?V0 + 0,#0x3
   \   00027E   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_4 & 0xFFFF
   1103                }
   1104                else
   1105                {
   1106                  // continue parsing message
   1107          
   1108                  keyEstablishRec[index].remoteEphDataGenTime = pInMsg->pData[2];
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_7:
   \   000281   85..82       MOV     DPL,?V0 + 2
   \   000284   85..83       MOV     DPH,?V0 + 3
   \   000287   A3           INC     DPTR
   \   000288   A3           INC     DPTR
   \   000289   A3           INC     DPTR
   \   00028A   A3           INC     DPTR
   \   00028B   A3           INC     DPTR
   \   00028C   A3           INC     DPTR
   \   00028D   A3           INC     DPTR
   \   00028E   A3           INC     DPTR
   \   00028F   E0           MOVX    A,@DPTR
   \   000290   F8           MOV     R0,A
   \   000291   A3           INC     DPTR
   \   000292   E0           MOVX    A,@DPTR
   \   000293   F583         MOV     DPH,A
   \   000295   8882         MOV     DPL,R0
   \   000297   A3           INC     DPTR
   \   000298   A3           INC     DPTR
   \   000299   E0           MOVX    A,@DPTR
   \   00029A   C0E0         PUSH    A
   \   00029C   EE           MOV     A,R6
   \   00029D   F8           MOV     R0,A
   \   00029E   7900         MOV     R1,#0x0
   \   0002A0   E8           MOV     A,R0
   \   0002A1   75F027       MOV     B,#0x27
   \   0002A4   A4           MUL     AB
   \   0002A5   C8           XCH     A,R0
   \   0002A6   AAF0         MOV     R2,B
   \   0002A8   75F000       MOV     B,#0x0
   \   0002AB   A4           MUL     AB
   \   0002AC   2A           ADD     A,R2
   \   0002AD   FA           MOV     R2,A
   \   0002AE   75F027       MOV     B,#0x27
   \   0002B1   E9           MOV     A,R1
   \   0002B2   A4           MUL     AB
   \   0002B3   2A           ADD     A,R2
   \   0002B4   F9           MOV     R1,A
   \   0002B5   74..         MOV     A,#(keyEstablishRec + 37) & 0xff
   \   0002B7   28           ADD     A,R0
   \   0002B8   F582         MOV     DPL,A
   \   0002BA   74..         MOV     A,#((keyEstablishRec + 37) >> 8) & 0xff
   \   0002BC   39           ADDC    A,R1
   \   0002BD   F583         MOV     DPH,A
   \   0002BF   D0E0         POP     A
   \   0002C1   F0           MOVX    @DPTR,A
   1109          
   1110                  if (pInMsg->pData[3] >= KEY_ESTABLISHMENT_CONF_KEY_GEN_INVALID_TIME)
   \   0002C2   85..82       MOV     DPL,?V0 + 2
   \   0002C5   85..83       MOV     DPH,?V0 + 3
   \   0002C8   A3           INC     DPTR
   \   0002C9   A3           INC     DPTR
   \   0002CA   A3           INC     DPTR
   \   0002CB   A3           INC     DPTR
   \   0002CC   A3           INC     DPTR
   \   0002CD   A3           INC     DPTR
   \   0002CE   A3           INC     DPTR
   \   0002CF   A3           INC     DPTR
   \   0002D0   E0           MOVX    A,@DPTR
   \   0002D1   F8           MOV     R0,A
   \   0002D2   A3           INC     DPTR
   \   0002D3   E0           MOVX    A,@DPTR
   \   0002D4   F583         MOV     DPH,A
   \   0002D6   8882         MOV     DPL,R0
   \   0002D8   A3           INC     DPTR
   \   0002D9   A3           INC     DPTR
   \   0002DA   A3           INC     DPTR
   \   0002DB   E0           MOVX    A,@DPTR
   \   0002DC   C3           CLR     C
   \   0002DD   94FF         SUBB    A,#-0x1
   \   0002DF   4006         JC      ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_8
   1111                  {
   1112                    status = TermKeyStatus_BadMessage;
   \   0002E1   75..03       MOV     ?V0 + 0,#0x3
   \   0002E4   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_4 & 0xFFFF
   1113                  }
   1114                  else
   1115                  {
   1116                    // continue parsing message
   1117          
   1118                    keyEstablishRec[index].remoteConfKeyGenTime = pInMsg->pData[3];
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_8:
   \   0002E7   85..82       MOV     DPL,?V0 + 2
   \   0002EA   85..83       MOV     DPH,?V0 + 3
   \   0002ED   A3           INC     DPTR
   \   0002EE   A3           INC     DPTR
   \   0002EF   A3           INC     DPTR
   \   0002F0   A3           INC     DPTR
   \   0002F1   A3           INC     DPTR
   \   0002F2   A3           INC     DPTR
   \   0002F3   A3           INC     DPTR
   \   0002F4   A3           INC     DPTR
   \   0002F5   E0           MOVX    A,@DPTR
   \   0002F6   F8           MOV     R0,A
   \   0002F7   A3           INC     DPTR
   \   0002F8   E0           MOVX    A,@DPTR
   \   0002F9   F583         MOV     DPH,A
   \   0002FB   8882         MOV     DPL,R0
   \   0002FD   A3           INC     DPTR
   \   0002FE   A3           INC     DPTR
   \   0002FF   A3           INC     DPTR
   \   000300   E0           MOVX    A,@DPTR
   \   000301   C0E0         PUSH    A
   \   000303   EE           MOV     A,R6
   \   000304   F8           MOV     R0,A
   \   000305   7900         MOV     R1,#0x0
   \   000307   E8           MOV     A,R0
   \   000308   75F027       MOV     B,#0x27
   \   00030B   A4           MUL     AB
   \   00030C   C8           XCH     A,R0
   \   00030D   AAF0         MOV     R2,B
   \   00030F   75F000       MOV     B,#0x0
   \   000312   A4           MUL     AB
   \   000313   2A           ADD     A,R2
   \   000314   FA           MOV     R2,A
   \   000315   75F027       MOV     B,#0x27
   \   000318   E9           MOV     A,R1
   \   000319   A4           MUL     AB
   \   00031A   2A           ADD     A,R2
   \   00031B   F9           MOV     R1,A
   \   00031C   74..         MOV     A,#(keyEstablishRec + 38) & 0xff
   \   00031E   28           ADD     A,R0
   \   00031F   F582         MOV     DPL,A
   \   000321   74..         MOV     A,#((keyEstablishRec + 38) >> 8) & 0xff
   \   000323   39           ADDC    A,R1
   \   000324   F583         MOV     DPH,A
   \   000326   D0E0         POP     A
   \   000328   F0           MOVX    @DPTR,A
   1119          
   1120                    if ((implicitCert = osal_mem_alloc(ZCL_KE_IMPLICIT_CERTIFICATE_LEN)) == NULL)
   \   000329                ; Setup parameters for call to function osal_mem_alloc
   \   000329   7A30         MOV     R2,#0x30
   \   00032B   7B00         MOV     R3,#0x0
   \   00032D   12....       LCALL   ??osal_mem_alloc?relay
   \   000330   8A..         MOV     ?V0 + 4,R2
   \   000332   8B..         MOV     ?V0 + 5,R3
   \   000334   A8..         MOV     R0,?V0 + 4
   \   000336   A9..         MOV     R1,?V0 + 5
   \   000338   88..         MOV     ?V0 + 10,R0
   \   00033A   89..         MOV     ?V0 + 11,R1
   \   00033C   E8           MOV     A,R0
   \   00033D   49           ORL     A,R1
   \   00033E   700A         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_9
   1121                    {
   1122                      // Reset the entry
   1123                      zclGeneral_ResetKeyEstablishRec( index );
   \   000340                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000340   EE           MOV     A,R6
   \   000341   F9           MOV     R1,A
   \   000342   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1124          
   1125                      return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   000345   79C1         MOV     R1,#-0x3f
   \   000347   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_10 & 0xFFFF
   1126                    }
   1127          
   1128                    osal_nv_read(ZCD_NV_IMPLICIT_CERTIFICATE, 0, ZCL_KE_IMPLICIT_CERTIFICATE_LEN, implicitCert);
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_9:
   \   00034A                ; Setup parameters for call to function osal_nv_read
   \   00034A   78..         MOV     R0,#?V0 + 10
   \   00034C   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00034F   75..30       MOV     ?V0 + 4,#0x30
   \   000352   75..00       MOV     ?V0 + 5,#0x0
   \   000355   78..         MOV     R0,#?V0 + 4
   \   000357   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00035A   7C00         MOV     R4,#0x0
   \   00035C   7D00         MOV     R5,#0x0
   \   00035E   7A69         MOV     R2,#0x69
   \   000360   7B00         MOV     R3,#0x0
   \   000362   12....       LCALL   ??osal_nv_read?relay
   \   000365   7404         MOV     A,#0x4
   \   000367   12....       LCALL   ?DEALLOC_XSTACK8
   \   00036A   E9           MOV     A,R1
   1129          
   1130                    if ( !osal_memcmp( &(keyEstablishRec[index].pRemoteCertificate[KEY_ESTABLISH_CERT_ISSUER_IDX]),
   1131                                      &(implicitCert[KEY_ESTABLISH_CERT_ISSUER_IDX]),
   1132                                      KEY_ESTABLISH_CERT_ISSUER_LENTGH ) )
   \   00036B                ; Setup parameters for call to function osal_memcmp
   \   00036B   E5..         MOV     A,?V0 + 10
   \   00036D   241E         ADD     A,#0x1e
   \   00036F   F5..         MOV     ?V0 + 4,A
   \   000371   E5..         MOV     A,?V0 + 11
   \   000373   3400         ADDC    A,#0x0
   \   000375   F5..         MOV     ?V0 + 5,A
   \   000377   75..00       MOV     ?V0 + 6,#0x0
   \   00037A   78..         MOV     R0,#?V0 + 4
   \   00037C   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   00037F   7C08         MOV     R4,#0x8
   \   000381   7D00         MOV     R5,#0x0
   \   000383   EE           MOV     A,R6
   \   000384   F8           MOV     R0,A
   \   000385   7900         MOV     R1,#0x0
   \   000387   E8           MOV     A,R0
   \   000388   75F027       MOV     B,#0x27
   \   00038B   A4           MUL     AB
   \   00038C   C8           XCH     A,R0
   \   00038D   AAF0         MOV     R2,B
   \   00038F   75F000       MOV     B,#0x0
   \   000392   A4           MUL     AB
   \   000393   2A           ADD     A,R2
   \   000394   FA           MOV     R2,A
   \   000395   75F027       MOV     B,#0x27
   \   000398   E9           MOV     A,R1
   \   000399   A4           MUL     AB
   \   00039A   2A           ADD     A,R2
   \   00039B   F9           MOV     R1,A
   \   00039C   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   00039E   28           ADD     A,R0
   \   00039F   F582         MOV     DPL,A
   \   0003A1   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   0003A3   39           ADDC    A,R1
   \   0003A4   F583         MOV     DPH,A
   \   0003A6   E0           MOVX    A,@DPTR
   \   0003A7   F8           MOV     R0,A
   \   0003A8   A3           INC     DPTR
   \   0003A9   E0           MOVX    A,@DPTR
   \   0003AA   C8           XCH     A,R0
   \   0003AB   241E         ADD     A,#0x1e
   \   0003AD   F582         MOV     DPL,A
   \   0003AF   E8           MOV     A,R0
   \   0003B0   3400         ADDC    A,#0x0
   \   0003B2   F583         MOV     DPH,A
   \   0003B4   A982         MOV     R1,DPL
   \   0003B6   AA83         MOV     R2,DPH
   \   0003B8   7B00         MOV     R3,#0x0
   \   0003BA   12....       LCALL   ??osal_memcmp?relay
   \   0003BD   7403         MOV     A,#0x3
   \   0003BF   12....       LCALL   ?DEALLOC_XSTACK8
   \   0003C2   E9           MOV     A,R1
   \   0003C3   7002         JNZ     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_11
   1133                    {
   1134                      keyStatus = TermKeyStatus_UnknowIssuer;
   \   0003C5   7F01         MOV     R7,#0x1
   1135                    }
   1136          
   1137                    osal_mem_free(implicitCert);
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_11:
   \   0003C7                ; Setup parameters for call to function osal_mem_free
   \   0003C7   AA..         MOV     R2,?V0 + 10
   \   0003C9   AB..         MOV     R3,?V0 + 11
   \   0003CB   12....       LCALL   ??osal_mem_free?relay
   1138                  }
   1139                }
   1140              }
   1141            } // end of parsing of the message
   1142          
   1143            if ( keyStatus == TermKeyStatus_Success )
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_4:
   \   0003CE   EF           MOV     A,R7
   \   0003CF   6003         JZ      $+5
   \   0003D1   02....       LJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_12 & 0xFFFF
   1144            {
   1145              keyEstablishRec[index].state = KeyEstablishState_EDataPending;
   \   0003D4   EE           MOV     A,R6
   \   0003D5   F8           MOV     R0,A
   \   0003D6   7900         MOV     R1,#0x0
   \   0003D8   E8           MOV     A,R0
   \   0003D9   75F027       MOV     B,#0x27
   \   0003DC   A4           MUL     AB
   \   0003DD   C8           XCH     A,R0
   \   0003DE   AAF0         MOV     R2,B
   \   0003E0   75F000       MOV     B,#0x0
   \   0003E3   A4           MUL     AB
   \   0003E4   2A           ADD     A,R2
   \   0003E5   FA           MOV     R2,A
   \   0003E6   75F027       MOV     B,#0x27
   \   0003E9   E9           MOV     A,R1
   \   0003EA   A4           MUL     AB
   \   0003EB   2A           ADD     A,R2
   \   0003EC   F9           MOV     R1,A
   \   0003ED   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   0003EF   28           ADD     A,R0
   \   0003F0   F582         MOV     DPL,A
   \   0003F2   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   0003F4   39           ADDC    A,R1
   \   0003F5   F583         MOV     DPH,A
   \   0003F7   7402         MOV     A,#0x2
   \   0003F9   F0           MOVX    @DPTR,A
   1146          
   1147              // Send Ephemeral Data Request back
   1148              zclGeneral_KeyEstablish_Send_EphemeralDataReq( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1149                                                            &pInMsg->msg->srcAddr,
   1150                                                            keyEstablishRec[index].pLocalEPublicKey,
   1151                                                            FALSE, zcl_SeqNum++ );
   \   0003FA   90....       MOV     DPTR,#zcl_SeqNum
   \   0003FD   E0           MOVX    A,@DPTR
   \   0003FE   F8           MOV     R0,A
   \   0003FF   7401         MOV     A,#0x1
   \   000401   28           ADD     A,R0
   \   000402   90....       MOV     DPTR,#zcl_SeqNum
   \   000405   F0           MOVX    @DPTR,A
   \   000406                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_EphemeralDataReq
   \   000406   E8           MOV     A,R0
   \   000407   F5..         MOV     ?V0 + 1,A
   \   000409   78..         MOV     R0,#?V0 + 1
   \   00040B   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00040E   75..00       MOV     ?V0 + 1,#0x0
   \   000411   78..         MOV     R0,#?V0 + 1
   \   000413   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000416   EE           MOV     A,R6
   \   000417   F8           MOV     R0,A
   \   000418   7900         MOV     R1,#0x0
   \   00041A   E8           MOV     A,R0
   \   00041B   75F027       MOV     B,#0x27
   \   00041E   A4           MUL     AB
   \   00041F   C8           XCH     A,R0
   \   000420   AAF0         MOV     R2,B
   \   000422   75F000       MOV     B,#0x0
   \   000425   A4           MUL     AB
   \   000426   2A           ADD     A,R2
   \   000427   FA           MOV     R2,A
   \   000428   75F027       MOV     B,#0x27
   \   00042B   E9           MOV     A,R1
   \   00042C   A4           MUL     AB
   \   00042D   2A           ADD     A,R2
   \   00042E   F9           MOV     R1,A
   \   00042F   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   000431   28           ADD     A,R0
   \   000432   F582         MOV     DPL,A
   \   000434   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   000436   39           ADDC    A,R1
   \   000437   F583         MOV     DPH,A
   \   000439   E0           MOVX    A,@DPTR
   \   00043A   FC           MOV     R4,A
   \   00043B   A3           INC     DPTR
   \   00043C   E0           MOVX    A,@DPTR
   \   00043D   FD           MOV     R5,A
   \   00043E   85..82       MOV     DPL,?V0 + 2
   \   000441   85..83       MOV     DPH,?V0 + 3
   \   000444   E0           MOVX    A,@DPTR
   \   000445   2406         ADD     A,#0x6
   \   000447   FA           MOV     R2,A
   \   000448   A3           INC     DPTR
   \   000449   E0           MOVX    A,@DPTR
   \   00044A   3400         ADDC    A,#0x0
   \   00044C   FB           MOV     R3,A
   \   00044D   790A         MOV     R1,#0xa
   \   00044F   12....       LCALL   ??zclGeneral_KeyEstablish_Send_EphemeralDataReq
   \   000452   7402         MOV     A,#0x2
   \   000454   12....       LCALL   ?DEALLOC_XSTACK8
   \   000457   E9           MOV     A,R1
   1152          
   1153              // The Request was processed successfuly, now the age timer needs to start based on the
   1154              // remote Ephemeral Data Generate Time
   1155              keyEstablishRec[index].age = keyEstablishRec[index].remoteEphDataGenTime;
   \   000458   EE           MOV     A,R6
   \   000459   F8           MOV     R0,A
   \   00045A   7900         MOV     R1,#0x0
   \   00045C   E8           MOV     A,R0
   \   00045D   75F027       MOV     B,#0x27
   \   000460   A4           MUL     AB
   \   000461   C8           XCH     A,R0
   \   000462   AAF0         MOV     R2,B
   \   000464   75F000       MOV     B,#0x0
   \   000467   A4           MUL     AB
   \   000468   2A           ADD     A,R2
   \   000469   FA           MOV     R2,A
   \   00046A   75F027       MOV     B,#0x27
   \   00046D   E9           MOV     A,R1
   \   00046E   A4           MUL     AB
   \   00046F   2A           ADD     A,R2
   \   000470   F9           MOV     R1,A
   \   000471   74..         MOV     A,#(keyEstablishRec + 37) & 0xff
   \   000473   28           ADD     A,R0
   \   000474   F582         MOV     DPL,A
   \   000476   74..         MOV     A,#((keyEstablishRec + 37) >> 8) & 0xff
   \   000478   39           ADDC    A,R1
   \   000479   F583         MOV     DPH,A
   \   00047B   E0           MOVX    A,@DPTR
   \   00047C   C0E0         PUSH    A
   \   00047E   EE           MOV     A,R6
   \   00047F   F8           MOV     R0,A
   \   000480   7900         MOV     R1,#0x0
   \   000482   E8           MOV     A,R0
   \   000483   75F027       MOV     B,#0x27
   \   000486   A4           MUL     AB
   \   000487   C8           XCH     A,R0
   \   000488   AAF0         MOV     R2,B
   \   00048A   75F000       MOV     B,#0x0
   \   00048D   A4           MUL     AB
   \   00048E   2A           ADD     A,R2
   \   00048F   FA           MOV     R2,A
   \   000490   75F027       MOV     B,#0x27
   \   000493   E9           MOV     A,R1
   \   000494   A4           MUL     AB
   \   000495   2A           ADD     A,R2
   \   000496   F9           MOV     R1,A
   \   000497   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   000499   28           ADD     A,R0
   \   00049A   F582         MOV     DPL,A
   \   00049C   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   00049E   39           ADDC    A,R1
   \   00049F   F583         MOV     DPH,A
   \   0004A1   D0E0         POP     A
   \   0004A3   F0           MOVX    @DPTR,A
   1156          
   1157              // Start the Ephemeral Data Generate aging timer
   1158              osal_start_reload_timer( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT,
   1159                                      KEY_ESTABLISHMENT_REC_AGING_INTERVAL );
   \   0004A4                ; Setup parameters for call to function osal_start_reload_timer
   \   0004A4   7CE8         MOV     R4,#-0x18
   \   0004A6   7D03         MOV     R5,#0x3
   \   0004A8   7A01         MOV     R2,#0x1
   \   0004AA   7B00         MOV     R3,#0x0
   \   0004AC   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   0004AF   E0           MOVX    A,@DPTR
   \   0004B0   F9           MOV     R1,A
   \   0004B1   12....       LCALL   ??osal_start_reload_timer?relay
   \   0004B4   E9           MOV     A,R1
   \   0004B5   8063         SJMP    ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_13
   1160            }
   1161            else
   1162            {
   1163              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1164                                                                     &pInMsg->msg->srcAddr,
   1165                                                                     keyStatus,
   1166                                                                     KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1167                                                                     KEY_ESTABLISHMENT_SUITE,
   1168                                                                     ZCL_FRAME_CLIENT_SERVER_DIR,
   1169                                                                     FALSE, zcl_SeqNum++ );
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_12:
   \   0004B7   90....       MOV     DPTR,#zcl_SeqNum
   \   0004BA   E0           MOVX    A,@DPTR
   \   0004BB   F8           MOV     R0,A
   \   0004BC   7401         MOV     A,#0x1
   \   0004BE   28           ADD     A,R0
   \   0004BF   90....       MOV     DPTR,#zcl_SeqNum
   \   0004C2   F0           MOVX    @DPTR,A
   \   0004C3                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   0004C3   E8           MOV     A,R0
   \   0004C4   F5..         MOV     ?V0 + 1,A
   \   0004C6   78..         MOV     R0,#?V0 + 1
   \   0004C8   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0004CB   75..00       MOV     ?V0 + 1,#0x0
   \   0004CE   78..         MOV     R0,#?V0 + 1
   \   0004D0   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0004D3   75..00       MOV     ?V0 + 1,#0x0
   \   0004D6   78..         MOV     R0,#?V0 + 1
   \   0004D8   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0004DB   75..01       MOV     ?V0 + 4,#0x1
   \   0004DE   75..00       MOV     ?V0 + 5,#0x0
   \   0004E1   78..         MOV     R0,#?V0 + 4
   \   0004E3   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0004E6   7D1C         MOV     R5,#0x1c
   \   0004E8   EF           MOV     A,R7
   \   0004E9   FC           MOV     R4,A
   \   0004EA   85..82       MOV     DPL,?V0 + 2
   \   0004ED   85..83       MOV     DPH,?V0 + 3
   \   0004F0   E0           MOVX    A,@DPTR
   \   0004F1   2406         ADD     A,#0x6
   \   0004F3   FA           MOV     R2,A
   \   0004F4   A3           INC     DPTR
   \   0004F5   E0           MOVX    A,@DPTR
   \   0004F6   3400         ADDC    A,#0x0
   \   0004F8   FB           MOV     R3,A
   \   0004F9   790A         MOV     R1,#0xa
   \   0004FB   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   0004FE   7405         MOV     A,#0x5
   \   000500   12....       LCALL   ?DEALLOC_XSTACK8
   \   000503   E9           MOV     A,R1
   1170          
   1171              // Reset the entry
   1172              if ( index < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000504   EE           MOV     A,R6
   \   000505   C3           CLR     C
   \   000506   9402         SUBB    A,#0x2
   \   000508   5005         JNC     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_14
   1173              {
   1174                zclGeneral_ResetKeyEstablishRec( index );
   \   00050A                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00050A   EE           MOV     A,R6
   \   00050B   F9           MOV     R1,A
   \   00050C   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1175              }
   1176          
   1177          #if defined (NWK_AUTO_POLL)
   1178              // Restore the saved poll rate for end device
   1179              NLME_SetPollRate(zclSavedPollRate);
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_14:
   \   00050F                ; Setup parameters for call to function NLME_SetPollRate
   \   00050F   90....       MOV     DPTR,#zclSavedPollRate
   \   000512   E0           MOVX    A,@DPTR
   \   000513   FA           MOV     R2,A
   \   000514   A3           INC     DPTR
   \   000515   E0           MOVX    A,@DPTR
   \   000516   FB           MOV     R3,A
   \   000517   12....       LCALL   ??NLME_SetPollRate?relay
   1180          #endif
   1181            }
   1182          
   1183            return ZCL_STATUS_CMD_HAS_RSP;
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_13:
   \   00051A   79FF         MOV     R1,#-0x1
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR_10:
   \   00051C   7408         MOV     A,#0x8
   \   00051E   12....       LCALL   ?DEALLOC_XSTACK8
   \   000521   7F0C         MOV     R7,#0xc
   \   000523   02....       LJMP    ?BANKED_LEAVE_XDATA
   1184          }
   1185          
   1186          /*********************************************************************
   1187           * @fn      zclGeneral_ProcessInCmd_EphemeralDataRsp
   1188           *
   1189           * @brief   Process the received Initiate Key Establishment Response.
   1190           *
   1191           * @param   pInMsg - pointer to the incoming message
   1192           *
   1193           * @return  ZStatus_t - ZFailure @ Unsupported
   1194           *                      ZCL_STATUS_MALFORMED_COMMAND
   1195           *                      ZCL_STATUS_CMD_HAS_RSP
   1196           *                      ZCL_STATUS_SOFTWARE_FAILURE
   1197           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1198          static ZStatus_t zclGeneral_ProcessInCmd_EphemeralDataRsp( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_EphemeralDataRsp:
   1199          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   1200            uint8 index;
   1201            uint8 status = ZFailure;
   \   000009   7F01         MOV     R7,#0x1
   1202          
   1203            // Stop the Ephemeral Data Generate timer because the message has been received
   1204            osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   00000B                ; Setup parameters for call to function osal_stop_timerEx
   \   00000B   7A01         MOV     R2,#0x1
   \   00000D   7B00         MOV     R3,#0x0
   \   00000F   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000012   E0           MOVX    A,@DPTR
   \   000013   F9           MOV     R1,A
   \   000014   12....       LCALL   ??osal_stop_timerEx?relay
   \   000017   E9           MOV     A,R1
   1205          
   1206            // Check state of the key establishment record. If not match, terminate the procedure
   1207            if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
   1208                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000018                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000018   85..82       MOV     DPL,?V0 + 0
   \   00001B   85..83       MOV     DPH,?V0 + 1
   \   00001E   E0           MOVX    A,@DPTR
   \   00001F   F8           MOV     R0,A
   \   000020   A3           INC     DPTR
   \   000021   E0           MOVX    A,@DPTR
   \   000022   C8           XCH     A,R0
   \   000023   2406         ADD     A,#0x6
   \   000025   F582         MOV     DPL,A
   \   000027   E8           MOV     A,R0
   \   000028   3400         ADDC    A,#0x0
   \   00002A   F583         MOV     DPH,A
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   FA           MOV     R2,A
   \   00002E   A3           INC     DPTR
   \   00002F   E0           MOVX    A,@DPTR
   \   000030   FB           MOV     R3,A
   \   000031   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   000034   E9           MOV     A,R1
   \   000035   F8           MOV     R0,A
   \   000036   E8           MOV     A,R0
   \   000037   FE           MOV     R6,A
   \   000038   E8           MOV     A,R0
   \   000039   C3           CLR     C
   \   00003A   9402         SUBB    A,#0x2
   \   00003C   4003         JC      $+5
   \   00003E   02....       LJMP    ??zclGeneral_ProcessInCmd_EphemeralDataRsp_0 & 0xFFFF
   1209            {
   1210              if ( keyEstablishRec[index].role == KEY_ESTABLISHMENT_INITIATOR &&
   1211                   keyEstablishRec[index].state == KeyEstablishState_EDataPending )
   \   000041   EE           MOV     A,R6
   \   000042   F8           MOV     R0,A
   \   000043   7900         MOV     R1,#0x0
   \   000045   E8           MOV     A,R0
   \   000046   75F027       MOV     B,#0x27
   \   000049   A4           MUL     AB
   \   00004A   C8           XCH     A,R0
   \   00004B   AAF0         MOV     R2,B
   \   00004D   75F000       MOV     B,#0x0
   \   000050   A4           MUL     AB
   \   000051   2A           ADD     A,R2
   \   000052   FA           MOV     R2,A
   \   000053   75F027       MOV     B,#0x27
   \   000056   E9           MOV     A,R1
   \   000057   A4           MUL     AB
   \   000058   2A           ADD     A,R2
   \   000059   F9           MOV     R1,A
   \   00005A   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   00005C   28           ADD     A,R0
   \   00005D   F582         MOV     DPL,A
   \   00005F   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000061   39           ADDC    A,R1
   \   000062   F583         MOV     DPH,A
   \   000064   E0           MOVX    A,@DPTR
   \   000065   707D         JNZ     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_1
   \   000067   EE           MOV     A,R6
   \   000068   F8           MOV     R0,A
   \   000069   7900         MOV     R1,#0x0
   \   00006B   E8           MOV     A,R0
   \   00006C   75F027       MOV     B,#0x27
   \   00006F   A4           MUL     AB
   \   000070   C8           XCH     A,R0
   \   000071   AAF0         MOV     R2,B
   \   000073   75F000       MOV     B,#0x0
   \   000076   A4           MUL     AB
   \   000077   2A           ADD     A,R2
   \   000078   FA           MOV     R2,A
   \   000079   75F027       MOV     B,#0x27
   \   00007C   E9           MOV     A,R1
   \   00007D   A4           MUL     AB
   \   00007E   2A           ADD     A,R2
   \   00007F   F9           MOV     R1,A
   \   000080   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000082   28           ADD     A,R0
   \   000083   F582         MOV     DPL,A
   \   000085   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000087   39           ADDC    A,R1
   \   000088   F583         MOV     DPH,A
   \   00008A   E0           MOVX    A,@DPTR
   \   00008B   6402         XRL     A,#0x2
   \   00008D   7055         JNZ     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_1
   1212              {
   1213                status = ZSuccess;
   \   00008F   7F00         MOV     R7,#0x0
   1214          
   1215                // Copy the remote device Ephemeral Public key
   1216                osal_memcpy( keyEstablishRec[index].pRemotePublicKey,
   1217                            &(pInMsg->pData[0]),
   1218                            ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   000091                ; Setup parameters for call to function osal_memcpy
   \   000091   85..82       MOV     DPL,?V0 + 0
   \   000094   85..83       MOV     DPH,?V0 + 1
   \   000097   A3           INC     DPTR
   \   000098   A3           INC     DPTR
   \   000099   A3           INC     DPTR
   \   00009A   A3           INC     DPTR
   \   00009B   A3           INC     DPTR
   \   00009C   A3           INC     DPTR
   \   00009D   A3           INC     DPTR
   \   00009E   A3           INC     DPTR
   \   00009F   E0           MOVX    A,@DPTR
   \   0000A0   F5..         MOV     ?V0 + 4,A
   \   0000A2   A3           INC     DPTR
   \   0000A3   E0           MOVX    A,@DPTR
   \   0000A4   F5..         MOV     ?V0 + 5,A
   \   0000A6   75..00       MOV     ?V0 + 6,#0x0
   \   0000A9   78..         MOV     R0,#?V0 + 4
   \   0000AB   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000AE   7C16         MOV     R4,#0x16
   \   0000B0   7D00         MOV     R5,#0x0
   \   0000B2   EE           MOV     A,R6
   \   0000B3   F8           MOV     R0,A
   \   0000B4   7900         MOV     R1,#0x0
   \   0000B6   E8           MOV     A,R0
   \   0000B7   75F027       MOV     B,#0x27
   \   0000BA   A4           MUL     AB
   \   0000BB   C8           XCH     A,R0
   \   0000BC   AAF0         MOV     R2,B
   \   0000BE   75F000       MOV     B,#0x0
   \   0000C1   A4           MUL     AB
   \   0000C2   2A           ADD     A,R2
   \   0000C3   FA           MOV     R2,A
   \   0000C4   75F027       MOV     B,#0x27
   \   0000C7   E9           MOV     A,R1
   \   0000C8   A4           MUL     AB
   \   0000C9   2A           ADD     A,R2
   \   0000CA   F9           MOV     R1,A
   \   0000CB   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   0000CD   28           ADD     A,R0
   \   0000CE   F582         MOV     DPL,A
   \   0000D0   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   0000D2   39           ADDC    A,R1
   \   0000D3   F583         MOV     DPH,A
   \   0000D5   E0           MOVX    A,@DPTR
   \   0000D6   FA           MOV     R2,A
   \   0000D7   A3           INC     DPTR
   \   0000D8   E0           MOVX    A,@DPTR
   \   0000D9   FB           MOV     R3,A
   \   0000DA   12....       LCALL   ??osal_memcpy?relay
   \   0000DD   7403         MOV     A,#0x3
   \   0000DF   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000E2   8005         SJMP    ??zclGeneral_ProcessInCmd_EphemeralDataRsp_0
   1219              }
   1220              else
   1221              {
   1222                // Reset the entry from the rec table
   1223                zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_1:
   \   0000E4                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0000E4   EE           MOV     A,R6
   \   0000E5   F9           MOV     R1,A
   \   0000E6   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1224              }
   1225            }
   1226          
   1227            if ( status == ZFailure )
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_0:
   \   0000E9   7401         MOV     A,#0x1
   \   0000EB   6F           XRL     A,R7
   \   0000EC   705A         JNZ     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_2
   1228            {
   1229              // No existing record found or the record found has a wrong state, terminate the procedure
   1230              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1231                                                                      &pInMsg->msg->srcAddr,
   1232                                                                      TermKeyStatus_BadMessage,
   1233                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1234                                                                      KEY_ESTABLISHMENT_SUITE,
   1235                                                                      ZCL_FRAME_CLIENT_SERVER_DIR,
   1236                                                                      FALSE, zcl_SeqNum++ );
   \   0000EE   90....       MOV     DPTR,#zcl_SeqNum
   \   0000F1   E0           MOVX    A,@DPTR
   \   0000F2   F8           MOV     R0,A
   \   0000F3   7401         MOV     A,#0x1
   \   0000F5   28           ADD     A,R0
   \   0000F6   90....       MOV     DPTR,#zcl_SeqNum
   \   0000F9   F0           MOVX    @DPTR,A
   \   0000FA                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   0000FA   E8           MOV     A,R0
   \   0000FB   F5..         MOV     ?V0 + 2,A
   \   0000FD   78..         MOV     R0,#?V0 + 2
   \   0000FF   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000102   75..00       MOV     ?V0 + 2,#0x0
   \   000105   78..         MOV     R0,#?V0 + 2
   \   000107   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00010A   75..00       MOV     ?V0 + 2,#0x0
   \   00010D   78..         MOV     R0,#?V0 + 2
   \   00010F   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000112   75..01       MOV     ?V0 + 2,#0x1
   \   000115   75..00       MOV     ?V0 + 3,#0x0
   \   000118   78..         MOV     R0,#?V0 + 2
   \   00011A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00011D   7D1C         MOV     R5,#0x1c
   \   00011F   7C03         MOV     R4,#0x3
   \   000121   85..82       MOV     DPL,?V0 + 0
   \   000124   85..83       MOV     DPH,?V0 + 1
   \   000127   E0           MOVX    A,@DPTR
   \   000128   2406         ADD     A,#0x6
   \   00012A   FA           MOV     R2,A
   \   00012B   A3           INC     DPTR
   \   00012C   E0           MOVX    A,@DPTR
   \   00012D   3400         ADDC    A,#0x0
   \   00012F   FB           MOV     R3,A
   \   000130   790A         MOV     R1,#0xa
   \   000132   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   000135   7405         MOV     A,#0x5
   \   000137   12....       LCALL   ?DEALLOC_XSTACK8
   \   00013A   E9           MOV     A,R1
   1237          #if defined (NWK_AUTO_POLL)
   1238              // Restore the saved poll rate for end device
   1239              NLME_SetPollRate(zclSavedPollRate);
   \   00013B                ; Setup parameters for call to function NLME_SetPollRate
   \   00013B   90....       MOV     DPTR,#zclSavedPollRate
   \   00013E   E0           MOVX    A,@DPTR
   \   00013F   FA           MOV     R2,A
   \   000140   A3           INC     DPTR
   \   000141   E0           MOVX    A,@DPTR
   \   000142   FB           MOV     R3,A
   \   000143   12....       LCALL   ??NLME_SetPollRate?relay
   \   000146   8037         SJMP    ??zclGeneral_ProcessInCmd_EphemeralDataRsp_3
   1240          #endif
   1241            }
   1242            else
   1243            {
   1244              keyEstablishRec[index].state = KeyEstablishState_KeyCalculatePending;
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_2:
   \   000148   EE           MOV     A,R6
   \   000149   F8           MOV     R0,A
   \   00014A   7900         MOV     R1,#0x0
   \   00014C   E8           MOV     A,R0
   \   00014D   75F027       MOV     B,#0x27
   \   000150   A4           MUL     AB
   \   000151   C8           XCH     A,R0
   \   000152   AAF0         MOV     R2,B
   \   000154   75F000       MOV     B,#0x0
   \   000157   A4           MUL     AB
   \   000158   2A           ADD     A,R2
   \   000159   FA           MOV     R2,A
   \   00015A   75F027       MOV     B,#0x27
   \   00015D   E9           MOV     A,R1
   \   00015E   A4           MUL     AB
   \   00015F   2A           ADD     A,R2
   \   000160   F9           MOV     R1,A
   \   000161   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000163   28           ADD     A,R0
   \   000164   F582         MOV     DPL,A
   \   000166   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000168   39           ADDC    A,R1
   \   000169   F583         MOV     DPH,A
   \   00016B   7403         MOV     A,#0x3
   \   00016D   F0           MOVX    @DPTR,A
   1245          
   1246              osal_start_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_RSP_PROCESS_EVT,
   1247                                 KEY_ESTABLISHMENT_WAIT_PERIOD );
   \   00016E                ; Setup parameters for call to function osal_start_timerEx
   \   00016E   7CF4         MOV     R4,#-0xc
   \   000170   7D01         MOV     R5,#0x1
   \   000172   7A04         MOV     R2,#0x4
   \   000174   7B00         MOV     R3,#0x0
   \   000176   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000179   E0           MOVX    A,@DPTR
   \   00017A   F9           MOV     R1,A
   \   00017B   12....       LCALL   ??osal_start_timerEx?relay
   \   00017E   E9           MOV     A,R1
   1248          
   1249            }
   1250          
   1251            return ZCL_STATUS_CMD_HAS_RSP;
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataRsp_3:
   \   00017F   79FF         MOV     R1,#-0x1
   \   000181   7F07         MOV     R7,#0x7
   \   000183   02....       LJMP    ?BANKED_LEAVE_XDATA
   1252          }
   1253          
   1254          /*********************************************************************
   1255           * @fn      zclGeneral_ProcessInCmd_ConfirmKey
   1256           *
   1257           * @brief   Process the received Confirm Key Command.
   1258           *
   1259           * @param   pInMsg - pointer to the incoming message
   1260           *
   1261           * @return  ZStatus_t - ZFailure @ Unsupported
   1262           *                      ZCL_STATUS_CMD_HAS_RSP
   1263           *                      ZCL_STATUS_SOFTWARE_FAILURE
   1264           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1265          static ZStatus_t zclGeneral_ProcessInCmd_ConfirmKey( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_ConfirmKey:
   1266          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 32
   \   000005   74E0         MOV     A,#-0x20
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 2,R2
   \   00000C   8B..         MOV     ?V0 + 3,R3
   1267            uint8 index;
   1268            uint8 status = ZFailure;
   \   00000E   75..01       MOV     ?V0 + 0,#0x1
   1269            uint8 MACu[KEY_ESTABLISH_MAC_KEY_LENGTH];
   1270            uint8 MACv[KEY_ESTABLISH_MAC_KEY_LENGTH];
   1271            TermKeyStatus_t keyStatus = TermKeyStatus_Success;
   \   000011   7F00         MOV     R7,#0x0
   1272          
   1273            // Stop the Config Key Generate aging timer because the message has been received
   1274            osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   000013                ; Setup parameters for call to function osal_stop_timerEx
   \   000013   7A01         MOV     R2,#0x1
   \   000015   7B00         MOV     R3,#0x0
   \   000017   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   00001A   E0           MOVX    A,@DPTR
   \   00001B   F9           MOV     R1,A
   \   00001C   12....       LCALL   ??osal_stop_timerEx?relay
   \   00001F   E9           MOV     A,R1
   1275          
   1276            // Check state of the key establishment record. If not match, terminate the procedure
   1277            if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
   1278                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000020                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000020   85..82       MOV     DPL,?V0 + 2
   \   000023   85..83       MOV     DPH,?V0 + 3
   \   000026   E0           MOVX    A,@DPTR
   \   000027   F8           MOV     R0,A
   \   000028   A3           INC     DPTR
   \   000029   E0           MOVX    A,@DPTR
   \   00002A   C8           XCH     A,R0
   \   00002B   2406         ADD     A,#0x6
   \   00002D   F582         MOV     DPL,A
   \   00002F   E8           MOV     A,R0
   \   000030   3400         ADDC    A,#0x0
   \   000032   F583         MOV     DPH,A
   \   000034   E0           MOVX    A,@DPTR
   \   000035   FA           MOV     R2,A
   \   000036   A3           INC     DPTR
   \   000037   E0           MOVX    A,@DPTR
   \   000038   FB           MOV     R3,A
   \   000039   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   00003C   E9           MOV     A,R1
   \   00003D   F8           MOV     R0,A
   \   00003E   E8           MOV     A,R0
   \   00003F   FE           MOV     R6,A
   \   000040   E8           MOV     A,R0
   \   000041   C3           CLR     C
   \   000042   9402         SUBB    A,#0x2
   \   000044   505A         JNC     ??zclGeneral_ProcessInCmd_ConfirmKey_0
   1279            {
   1280              if ( keyEstablishRec[index].role == KEY_ESTABLISHMENT_RESPONDER &&
   1281                   keyEstablishRec[index].state == KeyEstablishState_ConfirmPending )
   \   000046   EE           MOV     A,R6
   \   000047   F8           MOV     R0,A
   \   000048   7900         MOV     R1,#0x0
   \   00004A   E8           MOV     A,R0
   \   00004B   75F027       MOV     B,#0x27
   \   00004E   A4           MUL     AB
   \   00004F   C8           XCH     A,R0
   \   000050   AAF0         MOV     R2,B
   \   000052   75F000       MOV     B,#0x0
   \   000055   A4           MUL     AB
   \   000056   2A           ADD     A,R2
   \   000057   FA           MOV     R2,A
   \   000058   75F027       MOV     B,#0x27
   \   00005B   E9           MOV     A,R1
   \   00005C   A4           MUL     AB
   \   00005D   2A           ADD     A,R2
   \   00005E   F9           MOV     R1,A
   \   00005F   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   000061   28           ADD     A,R0
   \   000062   F582         MOV     DPL,A
   \   000064   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000066   39           ADDC    A,R1
   \   000067   F583         MOV     DPH,A
   \   000069   E0           MOVX    A,@DPTR
   \   00006A   6401         XRL     A,#0x1
   \   00006C   702D         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKey_1
   \   00006E   EE           MOV     A,R6
   \   00006F   F8           MOV     R0,A
   \   000070   7900         MOV     R1,#0x0
   \   000072   E8           MOV     A,R0
   \   000073   75F027       MOV     B,#0x27
   \   000076   A4           MUL     AB
   \   000077   C8           XCH     A,R0
   \   000078   AAF0         MOV     R2,B
   \   00007A   75F000       MOV     B,#0x0
   \   00007D   A4           MUL     AB
   \   00007E   2A           ADD     A,R2
   \   00007F   FA           MOV     R2,A
   \   000080   75F027       MOV     B,#0x27
   \   000083   E9           MOV     A,R1
   \   000084   A4           MUL     AB
   \   000085   2A           ADD     A,R2
   \   000086   F9           MOV     R1,A
   \   000087   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000089   28           ADD     A,R0
   \   00008A   F582         MOV     DPL,A
   \   00008C   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   00008E   39           ADDC    A,R1
   \   00008F   F583         MOV     DPH,A
   \   000091   E0           MOVX    A,@DPTR
   \   000092   6404         XRL     A,#0x4
   \   000094   7005         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKey_1
   1282              {
   1283                status = ZSuccess;
   \   000096   75..00       MOV     ?V0 + 0,#0x0
   \   000099   8005         SJMP    ??zclGeneral_ProcessInCmd_ConfirmKey_0
   1284              }
   1285              else
   1286              {
   1287                // Reset the entry
   1288                zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_1:
   \   00009B                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00009B   EE           MOV     A,R6
   \   00009C   F9           MOV     R1,A
   \   00009D   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1289              }
   1290            }
   1291          
   1292            if ( status == ZFailure )
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_0:
   \   0000A0   7401         MOV     A,#0x1
   \   0000A2   65..         XRL     A,?V0 + 0
   \   0000A4   7005         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKey_2
   1293            {
   1294              keyStatus = TermKeyStatus_BadMessage;
   \   0000A6   7F03         MOV     R7,#0x3
   \   0000A8   02....       LJMP    ??zclGeneral_ProcessInCmd_ConfirmKey_3 & 0xFFFF
   1295            }
   1296            else
   1297            {
   1298              // Calculate MAC(U). Note that the zData is also pointing to the macKey
   1299              zclGeneral_KeyEstablishment_GenerateMAC( index, TRUE, MACu );
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_2:
   \   0000AB                ; Setup parameters for call to function zclGeneral_KeyEstablishment_GenerateMAC
   \   0000AB   7410         MOV     A,#0x10
   \   0000AD   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B0   AC82         MOV     R4,DPL
   \   0000B2   AD83         MOV     R5,DPH
   \   0000B4   7A01         MOV     R2,#0x1
   \   0000B6   EE           MOV     A,R6
   \   0000B7   F9           MOV     R1,A
   \   0000B8   12....       LCALL   ??zclGeneral_KeyEstablishment_GenerateMAC?relay
   \   0000BB   E9           MOV     A,R1
   1300          
   1301              // Compare MAC(U) with MAC(V)
   1302              if ( osal_memcmp( MACu, pInMsg->pData, KEY_ESTABLISH_MAC_LENGTH ) == TRUE )
   \   0000BC                ; Setup parameters for call to function osal_memcmp
   \   0000BC   85..82       MOV     DPL,?V0 + 2
   \   0000BF   85..83       MOV     DPH,?V0 + 3
   \   0000C2   A3           INC     DPTR
   \   0000C3   A3           INC     DPTR
   \   0000C4   A3           INC     DPTR
   \   0000C5   A3           INC     DPTR
   \   0000C6   A3           INC     DPTR
   \   0000C7   A3           INC     DPTR
   \   0000C8   A3           INC     DPTR
   \   0000C9   A3           INC     DPTR
   \   0000CA   E0           MOVX    A,@DPTR
   \   0000CB   F5..         MOV     ?V0 + 4,A
   \   0000CD   A3           INC     DPTR
   \   0000CE   E0           MOVX    A,@DPTR
   \   0000CF   F5..         MOV     ?V0 + 5,A
   \   0000D1   75..00       MOV     ?V0 + 6,#0x0
   \   0000D4   78..         MOV     R0,#?V0 + 4
   \   0000D6   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000D9   7C10         MOV     R4,#0x10
   \   0000DB   7D00         MOV     R5,#0x0
   \   0000DD   7413         MOV     A,#0x13
   \   0000DF   12....       LCALL   ?XSTACK_DISP0_8
   \   0000E2   A982         MOV     R1,DPL
   \   0000E4   AA83         MOV     R2,DPH
   \   0000E6   7B00         MOV     R3,#0x0
   \   0000E8   12....       LCALL   ??osal_memcmp?relay
   \   0000EB   7403         MOV     A,#0x3
   \   0000ED   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000F0   E9           MOV     A,R1
   \   0000F1   6401         XRL     A,#0x1
   \   0000F3   6003         JZ      $+5
   \   0000F5   02....       LJMP    ??zclGeneral_ProcessInCmd_ConfirmKey_4 & 0xFFFF
   1303              {
   1304                // Send Confirm Key Response with Status - SUCCESS
   1305                keyEstablishRec[index].state = KeyEstablishState_TerminationPending;
   \   0000F8   EE           MOV     A,R6
   \   0000F9   F8           MOV     R0,A
   \   0000FA   7900         MOV     R1,#0x0
   \   0000FC   E8           MOV     A,R0
   \   0000FD   75F027       MOV     B,#0x27
   \   000100   A4           MUL     AB
   \   000101   C8           XCH     A,R0
   \   000102   AAF0         MOV     R2,B
   \   000104   75F000       MOV     B,#0x0
   \   000107   A4           MUL     AB
   \   000108   2A           ADD     A,R2
   \   000109   FA           MOV     R2,A
   \   00010A   75F027       MOV     B,#0x27
   \   00010D   E9           MOV     A,R1
   \   00010E   A4           MUL     AB
   \   00010F   2A           ADD     A,R2
   \   000110   F9           MOV     R1,A
   \   000111   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000113   28           ADD     A,R0
   \   000114   F582         MOV     DPL,A
   \   000116   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000118   39           ADDC    A,R1
   \   000119   F583         MOV     DPH,A
   \   00011B   7405         MOV     A,#0x5
   \   00011D   F0           MOVX    @DPTR,A
   1306          
   1307                // Store the key in the key table
   1308          
   1309                ZDSecMgrAddLinkKey( pInMsg->msg->srcAddr.addr.shortAddr,
   1310                                   keyEstablishRec[index].partnerExtAddr,
   1311                                   keyEstablishRec[index].pKey );
   \   00011E                ; Setup parameters for call to function ZDSecMgrAddLinkKey
   \   00011E   EE           MOV     A,R6
   \   00011F   F8           MOV     R0,A
   \   000120   7900         MOV     R1,#0x0
   \   000122   E8           MOV     A,R0
   \   000123   75F027       MOV     B,#0x27
   \   000126   A4           MUL     AB
   \   000127   C8           XCH     A,R0
   \   000128   AAF0         MOV     R2,B
   \   00012A   75F000       MOV     B,#0x0
   \   00012D   A4           MUL     AB
   \   00012E   2A           ADD     A,R2
   \   00012F   FA           MOV     R2,A
   \   000130   75F027       MOV     B,#0x27
   \   000133   E9           MOV     A,R1
   \   000134   A4           MUL     AB
   \   000135   2A           ADD     A,R2
   \   000136   F9           MOV     R1,A
   \   000137   74..         MOV     A,#(keyEstablishRec + 33) & 0xff
   \   000139   28           ADD     A,R0
   \   00013A   F582         MOV     DPL,A
   \   00013C   74..         MOV     A,#((keyEstablishRec + 33) >> 8) & 0xff
   \   00013E   39           ADDC    A,R1
   \   00013F   F583         MOV     DPH,A
   \   000141   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000144   EE           MOV     A,R6
   \   000145   F8           MOV     R0,A
   \   000146   7900         MOV     R1,#0x0
   \   000148   E8           MOV     A,R0
   \   000149   75F027       MOV     B,#0x27
   \   00014C   A4           MUL     AB
   \   00014D   C8           XCH     A,R0
   \   00014E   AAF0         MOV     R2,B
   \   000150   75F000       MOV     B,#0x0
   \   000153   A4           MUL     AB
   \   000154   2A           ADD     A,R2
   \   000155   FA           MOV     R2,A
   \   000156   75F027       MOV     B,#0x27
   \   000159   E9           MOV     A,R1
   \   00015A   A4           MUL     AB
   \   00015B   2A           ADD     A,R2
   \   00015C   F9           MOV     R1,A
   \   00015D   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   00015F   28           ADD     A,R0
   \   000160   FC           MOV     R4,A
   \   000161   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   000163   39           ADDC    A,R1
   \   000164   FD           MOV     R5,A
   \   000165   85..82       MOV     DPL,?V0 + 2
   \   000168   85..83       MOV     DPH,?V0 + 3
   \   00016B   E0           MOVX    A,@DPTR
   \   00016C   F8           MOV     R0,A
   \   00016D   A3           INC     DPTR
   \   00016E   E0           MOVX    A,@DPTR
   \   00016F   C8           XCH     A,R0
   \   000170   2406         ADD     A,#0x6
   \   000172   F582         MOV     DPL,A
   \   000174   E8           MOV     A,R0
   \   000175   3400         ADDC    A,#0x0
   \   000177   F583         MOV     DPH,A
   \   000179   E0           MOVX    A,@DPTR
   \   00017A   FA           MOV     R2,A
   \   00017B   A3           INC     DPTR
   \   00017C   E0           MOVX    A,@DPTR
   \   00017D   FB           MOV     R3,A
   \   00017E   12....       LCALL   ??ZDSecMgrAddLinkKey?relay
   \   000181   7402         MOV     A,#0x2
   \   000183   12....       LCALL   ?DEALLOC_XSTACK8
   \   000186   E9           MOV     A,R1
   1312          
   1313                // Calculate MAC(V) and send it back
   1314                zclGeneral_KeyEstablishment_GenerateMAC( index, FALSE, MACv );
   \   000187                ; Setup parameters for call to function zclGeneral_KeyEstablishment_GenerateMAC
   \   000187   85..82       MOV     DPL,?XSP + 0
   \   00018A   85..83       MOV     DPH,?XSP + 1
   \   00018D   AC82         MOV     R4,DPL
   \   00018F   AD83         MOV     R5,DPH
   \   000191   7A00         MOV     R2,#0x0
   \   000193   EE           MOV     A,R6
   \   000194   F9           MOV     R1,A
   \   000195   12....       LCALL   ??zclGeneral_KeyEstablishment_GenerateMAC?relay
   \   000198   E9           MOV     A,R1
   1315          
   1316                zclGeneral_KeyEstablish_Send_ConfirmKeyRsp( pInMsg->msg->endPoint,
   1317                                                           &pInMsg->msg->srcAddr,
   1318                                                           MACv,
   1319                                                           FALSE, pInMsg->hdr.transSeqNum );
   \   000199                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
   \   000199   85..82       MOV     DPL,?V0 + 2
   \   00019C   85..83       MOV     DPH,?V0 + 3
   \   00019F   A3           INC     DPTR
   \   0001A0   A3           INC     DPTR
   \   0001A1   A3           INC     DPTR
   \   0001A2   A3           INC     DPTR
   \   0001A3   A3           INC     DPTR
   \   0001A4   A3           INC     DPTR
   \   0001A5   E0           MOVX    A,@DPTR
   \   0001A6   F5..         MOV     ?V0 + 1,A
   \   0001A8   78..         MOV     R0,#?V0 + 1
   \   0001AA   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001AD   75..00       MOV     ?V0 + 1,#0x0
   \   0001B0   78..         MOV     R0,#?V0 + 1
   \   0001B2   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001B5   7402         MOV     A,#0x2
   \   0001B7   12....       LCALL   ?XSTACK_DISP0_8
   \   0001BA   AC82         MOV     R4,DPL
   \   0001BC   AD83         MOV     R5,DPH
   \   0001BE   85..82       MOV     DPL,?V0 + 2
   \   0001C1   85..83       MOV     DPH,?V0 + 3
   \   0001C4   E0           MOVX    A,@DPTR
   \   0001C5   2406         ADD     A,#0x6
   \   0001C7   FA           MOV     R2,A
   \   0001C8   A3           INC     DPTR
   \   0001C9   E0           MOVX    A,@DPTR
   \   0001CA   3400         ADDC    A,#0x0
   \   0001CC   FB           MOV     R3,A
   \   0001CD   85..82       MOV     DPL,?V0 + 2
   \   0001D0   85..83       MOV     DPH,?V0 + 3
   \   0001D3   E0           MOVX    A,@DPTR
   \   0001D4   F8           MOV     R0,A
   \   0001D5   A3           INC     DPTR
   \   0001D6   E0           MOVX    A,@DPTR
   \   0001D7   C8           XCH     A,R0
   \   0001D8   2414         ADD     A,#0x14
   \   0001DA   F582         MOV     DPL,A
   \   0001DC   E8           MOV     A,R0
   \   0001DD   3400         ADDC    A,#0x0
   \   0001DF   F583         MOV     DPH,A
   \   0001E1   E0           MOVX    A,@DPTR
   \   0001E2   F9           MOV     R1,A
   \   0001E3   12....       LCALL   ??zclGeneral_KeyEstablish_Send_ConfirmKeyRsp?re
   \   0001E6   7402         MOV     A,#0x2
   \   0001E8   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001EB   E9           MOV     A,R1
   \   0001EC   8002         SJMP    ??zclGeneral_ProcessInCmd_ConfirmKey_5
   1320              }
   1321              else
   1322              {
   1323                keyStatus = TermKeyStatus_BadKeyConfirm;
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_4:
   \   0001EE   7F02         MOV     R7,#0x2
   1324              }
   1325          
   1326              // Reset the entry, at this point the Key Establishment process has
   1327              // finished and the record is not needed anymore
   1328              zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_5:
   \   0001F0                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0001F0   EE           MOV     A,R6
   \   0001F1   F9           MOV     R1,A
   \   0001F2   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1329            }
   1330          
   1331            if( keyStatus != TermKeyStatus_Success)
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_3:
   \   0001F5   EF           MOV     A,R7
   \   0001F6   604D         JZ      ??zclGeneral_ProcessInCmd_ConfirmKey_6
   1332            {
   1333              // If MAC(U) does not match MAC(V), send response with failure
   1334              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1335                                                                      &pInMsg->msg->srcAddr,
   1336                                                                      keyStatus,
   1337                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1338                                                                      KEY_ESTABLISHMENT_SUITE,
   1339                                                                      ZCL_FRAME_SERVER_CLIENT_DIR,
   1340                                                                      FALSE, zcl_SeqNum++ );
   \   0001F8   90....       MOV     DPTR,#zcl_SeqNum
   \   0001FB   E0           MOVX    A,@DPTR
   \   0001FC   F8           MOV     R0,A
   \   0001FD   7401         MOV     A,#0x1
   \   0001FF   28           ADD     A,R0
   \   000200   90....       MOV     DPTR,#zcl_SeqNum
   \   000203   F0           MOVX    @DPTR,A
   \   000204                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   000204   E8           MOV     A,R0
   \   000205   F5..         MOV     ?V0 + 1,A
   \   000207   78..         MOV     R0,#?V0 + 1
   \   000209   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00020C   75..00       MOV     ?V0 + 1,#0x0
   \   00020F   78..         MOV     R0,#?V0 + 1
   \   000211   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000214   75..01       MOV     ?V0 + 1,#0x1
   \   000217   78..         MOV     R0,#?V0 + 1
   \   000219   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00021C   75..01       MOV     ?V0 + 4,#0x1
   \   00021F   75..00       MOV     ?V0 + 5,#0x0
   \   000222   78..         MOV     R0,#?V0 + 4
   \   000224   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000227   7D1C         MOV     R5,#0x1c
   \   000229   EF           MOV     A,R7
   \   00022A   FC           MOV     R4,A
   \   00022B   85..82       MOV     DPL,?V0 + 2
   \   00022E   85..83       MOV     DPH,?V0 + 3
   \   000231   E0           MOVX    A,@DPTR
   \   000232   2406         ADD     A,#0x6
   \   000234   FA           MOV     R2,A
   \   000235   A3           INC     DPTR
   \   000236   E0           MOVX    A,@DPTR
   \   000237   3400         ADDC    A,#0x0
   \   000239   FB           MOV     R3,A
   \   00023A   790A         MOV     R1,#0xa
   \   00023C   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   00023F   7405         MOV     A,#0x5
   \   000241   12....       LCALL   ?DEALLOC_XSTACK8
   \   000244   E9           MOV     A,R1
   1341            }
   1342          
   1343          #if defined (NWK_AUTO_POLL)
   1344            // Key Establishment Procedure complete. Restore the saved poll rate for end device
   1345            NLME_SetPollRate(zclSavedPollRate);
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey_6:
   \   000245                ; Setup parameters for call to function NLME_SetPollRate
   \   000245   90....       MOV     DPTR,#zclSavedPollRate
   \   000248   E0           MOVX    A,@DPTR
   \   000249   FA           MOV     R2,A
   \   00024A   A3           INC     DPTR
   \   00024B   E0           MOVX    A,@DPTR
   \   00024C   FB           MOV     R3,A
   \   00024D   12....       LCALL   ??NLME_SetPollRate?relay
   1346          #endif
   1347          
   1348            return ZCL_STATUS_CMD_HAS_RSP;
   \   000250   79FF         MOV     R1,#-0x1
   \   000252   7420         MOV     A,#0x20
   \   000254   12....       LCALL   ?DEALLOC_XSTACK8
   \   000257   7F07         MOV     R7,#0x7
   \   000259   02....       LJMP    ?BANKED_LEAVE_XDATA
   1349          }
   1350          
   1351          /*********************************************************************
   1352           * @fn      zclGeneral_ProcessInCmd_ConfirmKeyRsp
   1353           *
   1354           * @brief   Process the received Confirm Key Response.
   1355           *
   1356           * @param   pInMsg - pointer to the incoming message
   1357           *
   1358           * @return  ZStatus_t - ZFailure @ Unsupported
   1359           *                      ZCL_STATUS_MALFORMED_COMMAND
   1360           *                      ZCL_STATUS_CMD_HAS_RSP
   1361           *                      ZCL_STATUS_SOFTWARE_FAILURE
   1362           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1363          static ZStatus_t zclGeneral_ProcessInCmd_ConfirmKeyRsp( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_ConfirmKeyRsp:
   1364          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 16
   \   000005   74F0         MOV     A,#-0x10
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 0,R2
   \   00000C   8B..         MOV     ?V0 + 1,R3
   1365            uint8 index;
   1366            uint8 status = ZFailure;
   \   00000E   7F01         MOV     R7,#0x1
   1367            uint8 MACv[KEY_ESTABLISH_MAC_LENGTH];
   1368          
   1369            // Stop the Config Key Generate aging timer because the message has been received
   1370            osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   000010                ; Setup parameters for call to function osal_stop_timerEx
   \   000010   7A01         MOV     R2,#0x1
   \   000012   7B00         MOV     R3,#0x0
   \   000014   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000017   E0           MOVX    A,@DPTR
   \   000018   F9           MOV     R1,A
   \   000019   12....       LCALL   ??osal_stop_timerEx?relay
   \   00001C   E9           MOV     A,R1
   1371          
   1372            // Check state of the key establishment record. If not match, terminate the procedure
   1373            if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
   1374                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   00001D                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   00001D   85..82       MOV     DPL,?V0 + 0
   \   000020   85..83       MOV     DPH,?V0 + 1
   \   000023   E0           MOVX    A,@DPTR
   \   000024   F8           MOV     R0,A
   \   000025   A3           INC     DPTR
   \   000026   E0           MOVX    A,@DPTR
   \   000027   C8           XCH     A,R0
   \   000028   2406         ADD     A,#0x6
   \   00002A   F582         MOV     DPL,A
   \   00002C   E8           MOV     A,R0
   \   00002D   3400         ADDC    A,#0x0
   \   00002F   F583         MOV     DPH,A
   \   000031   E0           MOVX    A,@DPTR
   \   000032   FA           MOV     R2,A
   \   000033   A3           INC     DPTR
   \   000034   E0           MOVX    A,@DPTR
   \   000035   FB           MOV     R3,A
   \   000036   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   000039   E9           MOV     A,R1
   \   00003A   F8           MOV     R0,A
   \   00003B   E8           MOV     A,R0
   \   00003C   FE           MOV     R6,A
   \   00003D   E8           MOV     A,R0
   \   00003E   C3           CLR     C
   \   00003F   9402         SUBB    A,#0x2
   \   000041   5057         JNC     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_0
   1375            {
   1376              if ( keyEstablishRec[index].role == KEY_ESTABLISHMENT_INITIATOR &&
   1377                   keyEstablishRec[index].state == KeyEstablishState_ConfirmPending )
   \   000043   EE           MOV     A,R6
   \   000044   F8           MOV     R0,A
   \   000045   7900         MOV     R1,#0x0
   \   000047   E8           MOV     A,R0
   \   000048   75F027       MOV     B,#0x27
   \   00004B   A4           MUL     AB
   \   00004C   C8           XCH     A,R0
   \   00004D   AAF0         MOV     R2,B
   \   00004F   75F000       MOV     B,#0x0
   \   000052   A4           MUL     AB
   \   000053   2A           ADD     A,R2
   \   000054   FA           MOV     R2,A
   \   000055   75F027       MOV     B,#0x27
   \   000058   E9           MOV     A,R1
   \   000059   A4           MUL     AB
   \   00005A   2A           ADD     A,R2
   \   00005B   F9           MOV     R1,A
   \   00005C   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   00005E   28           ADD     A,R0
   \   00005F   F582         MOV     DPL,A
   \   000061   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   000063   39           ADDC    A,R1
   \   000064   F583         MOV     DPH,A
   \   000066   E0           MOVX    A,@DPTR
   \   000067   702C         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_1
   \   000069   EE           MOV     A,R6
   \   00006A   F8           MOV     R0,A
   \   00006B   7900         MOV     R1,#0x0
   \   00006D   E8           MOV     A,R0
   \   00006E   75F027       MOV     B,#0x27
   \   000071   A4           MUL     AB
   \   000072   C8           XCH     A,R0
   \   000073   AAF0         MOV     R2,B
   \   000075   75F000       MOV     B,#0x0
   \   000078   A4           MUL     AB
   \   000079   2A           ADD     A,R2
   \   00007A   FA           MOV     R2,A
   \   00007B   75F027       MOV     B,#0x27
   \   00007E   E9           MOV     A,R1
   \   00007F   A4           MUL     AB
   \   000080   2A           ADD     A,R2
   \   000081   F9           MOV     R1,A
   \   000082   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000084   28           ADD     A,R0
   \   000085   F582         MOV     DPL,A
   \   000087   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000089   39           ADDC    A,R1
   \   00008A   F583         MOV     DPH,A
   \   00008C   E0           MOVX    A,@DPTR
   \   00008D   6404         XRL     A,#0x4
   \   00008F   7004         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_1
   1378              {
   1379                status = ZSuccess;
   \   000091   7F00         MOV     R7,#0x0
   \   000093   8005         SJMP    ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_0
   1380              }
   1381              else
   1382              {
   1383                // Reset the entry from the rec table
   1384                zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_1:
   \   000095                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000095   EE           MOV     A,R6
   \   000096   F9           MOV     R1,A
   \   000097   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1385              }
   1386            }
   1387          
   1388            if ( status == ZFailure )
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_0:
   \   00009A   7401         MOV     A,#0x1
   \   00009C   6F           XRL     A,R7
   \   00009D   7005         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_2
   1389            {
   1390              status = TermKeyStatus_BadMessage;
   \   00009F   7F03         MOV     R7,#0x3
   \   0000A1   02....       LJMP    ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_3 & 0xFFFF
   1391            }
   1392            else
   1393            {
   1394              // Calculate MAC(V)
   1395              zclGeneral_KeyEstablishment_GenerateMAC( index, FALSE, MACv);
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_2:
   \   0000A4                ; Setup parameters for call to function zclGeneral_KeyEstablishment_GenerateMAC
   \   0000A4   85..82       MOV     DPL,?XSP + 0
   \   0000A7   85..83       MOV     DPH,?XSP + 1
   \   0000AA   AC82         MOV     R4,DPL
   \   0000AC   AD83         MOV     R5,DPH
   \   0000AE   7A00         MOV     R2,#0x0
   \   0000B0   EE           MOV     A,R6
   \   0000B1   F9           MOV     R1,A
   \   0000B2   12....       LCALL   ??zclGeneral_KeyEstablishment_GenerateMAC?relay
   \   0000B5   E9           MOV     A,R1
   1396          
   1397              // Compare M(U) with M(V)
   1398              if ( osal_memcmp( MACv, pInMsg->pData, KEY_ESTABLISH_MAC_LENGTH ) == TRUE )
   \   0000B6                ; Setup parameters for call to function osal_memcmp
   \   0000B6   85..82       MOV     DPL,?V0 + 0
   \   0000B9   85..83       MOV     DPH,?V0 + 1
   \   0000BC   A3           INC     DPTR
   \   0000BD   A3           INC     DPTR
   \   0000BE   A3           INC     DPTR
   \   0000BF   A3           INC     DPTR
   \   0000C0   A3           INC     DPTR
   \   0000C1   A3           INC     DPTR
   \   0000C2   A3           INC     DPTR
   \   0000C3   A3           INC     DPTR
   \   0000C4   E0           MOVX    A,@DPTR
   \   0000C5   F5..         MOV     ?V0 + 4,A
   \   0000C7   A3           INC     DPTR
   \   0000C8   E0           MOVX    A,@DPTR
   \   0000C9   F5..         MOV     ?V0 + 5,A
   \   0000CB   75..00       MOV     ?V0 + 6,#0x0
   \   0000CE   78..         MOV     R0,#?V0 + 4
   \   0000D0   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0000D3   7C10         MOV     R4,#0x10
   \   0000D5   7D00         MOV     R5,#0x0
   \   0000D7   7403         MOV     A,#0x3
   \   0000D9   12....       LCALL   ?XSTACK_DISP0_8
   \   0000DC   A982         MOV     R1,DPL
   \   0000DE   AA83         MOV     R2,DPH
   \   0000E0   7B00         MOV     R3,#0x0
   \   0000E2   12....       LCALL   ??osal_memcmp?relay
   \   0000E5   7403         MOV     A,#0x3
   \   0000E7   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000EA   E9           MOV     A,R1
   \   0000EB   6401         XRL     A,#0x1
   \   0000ED   706D         JNZ     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_4
   1399              {
   1400                status = TermKeyStatus_Success;
   \   0000EF   7F00         MOV     R7,#0x0
   1401          
   1402                // Store the link key
   1403                ZDSecMgrAddLinkKey( pInMsg->msg->srcAddr.addr.shortAddr,
   1404                               keyEstablishRec[index].partnerExtAddr,
   1405                               keyEstablishRec[index].pKey );
   \   0000F1                ; Setup parameters for call to function ZDSecMgrAddLinkKey
   \   0000F1   EE           MOV     A,R6
   \   0000F2   F8           MOV     R0,A
   \   0000F3   7900         MOV     R1,#0x0
   \   0000F5   E8           MOV     A,R0
   \   0000F6   75F027       MOV     B,#0x27
   \   0000F9   A4           MUL     AB
   \   0000FA   C8           XCH     A,R0
   \   0000FB   AAF0         MOV     R2,B
   \   0000FD   75F000       MOV     B,#0x0
   \   000100   A4           MUL     AB
   \   000101   2A           ADD     A,R2
   \   000102   FA           MOV     R2,A
   \   000103   75F027       MOV     B,#0x27
   \   000106   E9           MOV     A,R1
   \   000107   A4           MUL     AB
   \   000108   2A           ADD     A,R2
   \   000109   F9           MOV     R1,A
   \   00010A   74..         MOV     A,#(keyEstablishRec + 33) & 0xff
   \   00010C   28           ADD     A,R0
   \   00010D   F582         MOV     DPL,A
   \   00010F   74..         MOV     A,#((keyEstablishRec + 33) >> 8) & 0xff
   \   000111   39           ADDC    A,R1
   \   000112   F583         MOV     DPH,A
   \   000114   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000117   EE           MOV     A,R6
   \   000118   F8           MOV     R0,A
   \   000119   7900         MOV     R1,#0x0
   \   00011B   E8           MOV     A,R0
   \   00011C   75F027       MOV     B,#0x27
   \   00011F   A4           MUL     AB
   \   000120   C8           XCH     A,R0
   \   000121   AAF0         MOV     R2,B
   \   000123   75F000       MOV     B,#0x0
   \   000126   A4           MUL     AB
   \   000127   2A           ADD     A,R2
   \   000128   FA           MOV     R2,A
   \   000129   75F027       MOV     B,#0x27
   \   00012C   E9           MOV     A,R1
   \   00012D   A4           MUL     AB
   \   00012E   2A           ADD     A,R2
   \   00012F   F9           MOV     R1,A
   \   000130   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   000132   28           ADD     A,R0
   \   000133   FC           MOV     R4,A
   \   000134   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   000136   39           ADDC    A,R1
   \   000137   FD           MOV     R5,A
   \   000138   85..82       MOV     DPL,?V0 + 0
   \   00013B   85..83       MOV     DPH,?V0 + 1
   \   00013E   E0           MOVX    A,@DPTR
   \   00013F   F8           MOV     R0,A
   \   000140   A3           INC     DPTR
   \   000141   E0           MOVX    A,@DPTR
   \   000142   C8           XCH     A,R0
   \   000143   2406         ADD     A,#0x6
   \   000145   F582         MOV     DPL,A
   \   000147   E8           MOV     A,R0
   \   000148   3400         ADDC    A,#0x0
   \   00014A   F583         MOV     DPH,A
   \   00014C   E0           MOVX    A,@DPTR
   \   00014D   FA           MOV     R2,A
   \   00014E   A3           INC     DPTR
   \   00014F   E0           MOVX    A,@DPTR
   \   000150   FB           MOV     R3,A
   \   000151   12....       LCALL   ??ZDSecMgrAddLinkKey?relay
   \   000154   7402         MOV     A,#0x2
   \   000156   12....       LCALL   ?DEALLOC_XSTACK8
   \   000159   E9           MOV     A,R1
   \   00015A   8002         SJMP    ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_3
   1406              }
   1407              else
   1408              {
   1409                // If MAC(U) does not match MAC(V), send response with failure
   1410                status = TermKeyStatus_BadKeyConfirm;
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_4:
   \   00015C   7F02         MOV     R7,#0x2
   1411              }
   1412            }
   1413          
   1414            if( status != TermKeyStatus_Success )
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_3:
   \   00015E   EF           MOV     A,R7
   \   00015F   604D         JZ      ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_5
   1415            {
   1416              zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1417                                                                      &pInMsg->msg->srcAddr,
   1418                                                                      (TermKeyStatus_t)status,
   1419                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1420                                                                      KEY_ESTABLISHMENT_SUITE,
   1421                                                                      ZCL_FRAME_CLIENT_SERVER_DIR,
   1422                                                                      FALSE, zcl_SeqNum++ );
   \   000161   90....       MOV     DPTR,#zcl_SeqNum
   \   000164   E0           MOVX    A,@DPTR
   \   000165   F8           MOV     R0,A
   \   000166   7401         MOV     A,#0x1
   \   000168   28           ADD     A,R0
   \   000169   90....       MOV     DPTR,#zcl_SeqNum
   \   00016C   F0           MOVX    @DPTR,A
   \   00016D                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   00016D   E8           MOV     A,R0
   \   00016E   F5..         MOV     ?V0 + 2,A
   \   000170   78..         MOV     R0,#?V0 + 2
   \   000172   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000175   75..00       MOV     ?V0 + 2,#0x0
   \   000178   78..         MOV     R0,#?V0 + 2
   \   00017A   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00017D   75..00       MOV     ?V0 + 2,#0x0
   \   000180   78..         MOV     R0,#?V0 + 2
   \   000182   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000185   75..01       MOV     ?V0 + 2,#0x1
   \   000188   75..00       MOV     ?V0 + 3,#0x0
   \   00018B   78..         MOV     R0,#?V0 + 2
   \   00018D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000190   7D1C         MOV     R5,#0x1c
   \   000192   EF           MOV     A,R7
   \   000193   FC           MOV     R4,A
   \   000194   85..82       MOV     DPL,?V0 + 0
   \   000197   85..83       MOV     DPH,?V0 + 1
   \   00019A   E0           MOVX    A,@DPTR
   \   00019B   2406         ADD     A,#0x6
   \   00019D   FA           MOV     R2,A
   \   00019E   A3           INC     DPTR
   \   00019F   E0           MOVX    A,@DPTR
   \   0001A0   3400         ADDC    A,#0x0
   \   0001A2   FB           MOV     R3,A
   \   0001A3   790A         MOV     R1,#0xa
   \   0001A5   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   0001A8   7405         MOV     A,#0x5
   \   0001AA   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001AD   E9           MOV     A,R1
   1423            }
   1424          
   1425            // Send Osal message to the application to indicate the completion
   1426            if ( keyEstablishRec[index].appTaskID != INVALID_TASK_ID )
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_5:
   \   0001AE   EE           MOV     A,R6
   \   0001AF   F8           MOV     R0,A
   \   0001B0   7900         MOV     R1,#0x0
   \   0001B2   E8           MOV     A,R0
   \   0001B3   75F027       MOV     B,#0x27
   \   0001B6   A4           MUL     AB
   \   0001B7   C8           XCH     A,R0
   \   0001B8   AAF0         MOV     R2,B
   \   0001BA   75F000       MOV     B,#0x0
   \   0001BD   A4           MUL     AB
   \   0001BE   2A           ADD     A,R2
   \   0001BF   FA           MOV     R2,A
   \   0001C0   75F027       MOV     B,#0x27
   \   0001C3   E9           MOV     A,R1
   \   0001C4   A4           MUL     AB
   \   0001C5   2A           ADD     A,R2
   \   0001C6   F9           MOV     R1,A
   \   0001C7   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   0001C9   28           ADD     A,R0
   \   0001CA   F582         MOV     DPL,A
   \   0001CC   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   0001CE   39           ADDC    A,R1
   \   0001CF   F583         MOV     DPH,A
   \   0001D1   E0           MOVX    A,@DPTR
   \   0001D2   64FF         XRL     A,#0xff
   \   0001D4   6071         JZ      ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_6
   1427            {
   1428              keyEstablishmentInd_t *ind;
   1429          
   1430              ind = (keyEstablishmentInd_t *)osal_msg_allocate( sizeof( keyEstablishmentInd_t ) );
   \   0001D6                ; Setup parameters for call to function osal_msg_allocate
   \   0001D6   7A05         MOV     R2,#0x5
   \   0001D8   7B00         MOV     R3,#0x0
   \   0001DA   12....       LCALL   ??osal_msg_allocate?relay
   \   0001DD   8A..         MOV     ?V0 + 4,R2
   \   0001DF   8B..         MOV     ?V0 + 5,R3
   \   0001E1   85....       MOV     ?V0 + 2,?V0 + 4
   \   0001E4   85....       MOV     ?V0 + 3,?V0 + 5
   1431              if ( ind )
   \   0001E7   E5..         MOV     A,?V0 + 2
   \   0001E9   45..         ORL     A,?V0 + 3
   \   0001EB   605A         JZ      ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_6
   1432              {
   1433                ind->hdr.event = ZCL_KEY_ESTABLISH_IND;
   \   0001ED   85..82       MOV     DPL,?V0 + 2
   \   0001F0   85..83       MOV     DPH,?V0 + 3
   \   0001F3   7435         MOV     A,#0x35
   \   0001F5   F0           MOVX    @DPTR,A
   1434                ind->hdr.status = status;
   \   0001F6   EF           MOV     A,R7
   \   0001F7   85..82       MOV     DPL,?V0 + 2
   \   0001FA   85..83       MOV     DPH,?V0 + 3
   \   0001FD   A3           INC     DPTR
   \   0001FE   F0           MOVX    @DPTR,A
   1435          
   1436                // Clear remaining fields
   1437                ind->waitTime = 0;
   \   0001FF   85..82       MOV     DPL,?V0 + 2
   \   000202   85..83       MOV     DPH,?V0 + 3
   \   000205   A3           INC     DPTR
   \   000206   A3           INC     DPTR
   \   000207   7400         MOV     A,#0x0
   \   000209   F0           MOVX    @DPTR,A
   1438                ind->keyEstablishmentSuite = 0;
   \   00020A   85..82       MOV     DPL,?V0 + 2
   \   00020D   85..83       MOV     DPH,?V0 + 3
   \   000210   A3           INC     DPTR
   \   000211   A3           INC     DPTR
   \   000212   A3           INC     DPTR
   \   000213   7400         MOV     A,#0x0
   \   000215   F0           MOVX    @DPTR,A
   \   000216   A3           INC     DPTR
   \   000217   7400         MOV     A,#0x0
   \   000219   F0           MOVX    @DPTR,A
   1439          
   1440                osal_msg_send( keyEstablishRec[index].appTaskID, (uint8*)ind );
   \   00021A                ; Setup parameters for call to function osal_msg_send
   \   00021A   AA..         MOV     R2,?V0 + 2
   \   00021C   AB..         MOV     R3,?V0 + 3
   \   00021E   EE           MOV     A,R6
   \   00021F   F8           MOV     R0,A
   \   000220   7900         MOV     R1,#0x0
   \   000222   E8           MOV     A,R0
   \   000223   75F027       MOV     B,#0x27
   \   000226   A4           MUL     AB
   \   000227   C8           XCH     A,R0
   \   000228   ACF0         MOV     R4,B
   \   00022A   75F000       MOV     B,#0x0
   \   00022D   A4           MUL     AB
   \   00022E   2C           ADD     A,R4
   \   00022F   FC           MOV     R4,A
   \   000230   75F027       MOV     B,#0x27
   \   000233   E9           MOV     A,R1
   \   000234   A4           MUL     AB
   \   000235   2C           ADD     A,R4
   \   000236   F9           MOV     R1,A
   \   000237   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   000239   28           ADD     A,R0
   \   00023A   F582         MOV     DPL,A
   \   00023C   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   00023E   39           ADDC    A,R1
   \   00023F   F583         MOV     DPH,A
   \   000241   E0           MOVX    A,@DPTR
   \   000242   F9           MOV     R1,A
   \   000243   12....       LCALL   ??osal_msg_send?relay
   \   000246   E9           MOV     A,R1
   1441              }
   1442            }
   1443          
   1444            // End of this transection. Reset the entry from the rec table
   1445            zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp_6:
   \   000247                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000247   EE           MOV     A,R6
   \   000248   F9           MOV     R1,A
   \   000249   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1446          
   1447          #if defined (NWK_AUTO_POLL)
   1448            // Key Establishment Procedure complete. Restore the saved poll rate for end device
   1449            NLME_SetPollRate(zclSavedPollRate);
   \   00024C                ; Setup parameters for call to function NLME_SetPollRate
   \   00024C   90....       MOV     DPTR,#zclSavedPollRate
   \   00024F   E0           MOVX    A,@DPTR
   \   000250   FA           MOV     R2,A
   \   000251   A3           INC     DPTR
   \   000252   E0           MOVX    A,@DPTR
   \   000253   FB           MOV     R3,A
   \   000254   12....       LCALL   ??NLME_SetPollRate?relay
   1450          #endif
   1451            return ZCL_STATUS_CMD_HAS_RSP;
   \   000257   79FF         MOV     R1,#-0x1
   \   000259   7410         MOV     A,#0x10
   \   00025B   12....       LCALL   ?DEALLOC_XSTACK8
   \   00025E   7F07         MOV     R7,#0x7
   \   000260   02....       LJMP    ?BANKED_LEAVE_XDATA
   1452          }
   1453          
   1454          /*********************************************************************
   1455           * @fn      zclGeneral_ProcessInCmd_TerminateKeyEstablish
   1456           *
   1457           * @brief   Process the received Terminate Key Establishment Command.
   1458           *
   1459           * @param   pInMsg - pointer to the incoming message
   1460           *
   1461           * @return  ZStatus_t - ZFailure @ Unsupported
   1462           *                      ZSuccess @ Success
   1463           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1464          static ZStatus_t zclGeneral_ProcessInCmd_TerminateKeyEstablish( zclIncoming_t *pInMsg )
   \                     zclGeneral_ProcessInCmd_TerminateKeyEstablish:
   1465          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   1466            uint8 index;
   1467          
   1468            // Find the key establishment record and delete the record entry.
   1469            if ( ( index = zclGeneral_GetKeyEstablishRecIndex( pInMsg->msg->srcAddr.addr.shortAddr ) )
   1470                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000009                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000009   85..82       MOV     DPL,?V0 + 0
   \   00000C   85..83       MOV     DPH,?V0 + 1
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   F8           MOV     R0,A
   \   000011   A3           INC     DPTR
   \   000012   E0           MOVX    A,@DPTR
   \   000013   C8           XCH     A,R0
   \   000014   2406         ADD     A,#0x6
   \   000016   F582         MOV     DPL,A
   \   000018   E8           MOV     A,R0
   \   000019   3400         ADDC    A,#0x0
   \   00001B   F583         MOV     DPH,A
   \   00001D   E0           MOVX    A,@DPTR
   \   00001E   FA           MOV     R2,A
   \   00001F   A3           INC     DPTR
   \   000020   E0           MOVX    A,@DPTR
   \   000021   FB           MOV     R3,A
   \   000022   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   000025   E9           MOV     A,R1
   \   000026   F8           MOV     R0,A
   \   000027   88..         MOV     ?V0 + 2,R0
   \   000029   E8           MOV     A,R0
   \   00002A   C3           CLR     C
   \   00002B   9402         SUBB    A,#0x2
   \   00002D   4003         JC      $+5
   \   00002F   02....       LJMP    ??zclGeneral_ProcessInCmd_TerminateKeyEstablish_1 & 0xFFFF
   1471            {
   1472              if ( keyEstablishRec[index].appTaskID != INVALID_TASK_ID )
   \   000032   E5..         MOV     A,?V0 + 2
   \   000034   A8..         MOV     R0,?V0 + 2
   \   000036   7900         MOV     R1,#0x0
   \   000038   E8           MOV     A,R0
   \   000039   75F027       MOV     B,#0x27
   \   00003C   A4           MUL     AB
   \   00003D   C8           XCH     A,R0
   \   00003E   AAF0         MOV     R2,B
   \   000040   75F000       MOV     B,#0x0
   \   000043   A4           MUL     AB
   \   000044   2A           ADD     A,R2
   \   000045   FA           MOV     R2,A
   \   000046   75F027       MOV     B,#0x27
   \   000049   E9           MOV     A,R1
   \   00004A   A4           MUL     AB
   \   00004B   2A           ADD     A,R2
   \   00004C   F9           MOV     R1,A
   \   00004D   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   00004F   28           ADD     A,R0
   \   000050   F582         MOV     DPL,A
   \   000052   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   000054   39           ADDC    A,R1
   \   000055   F583         MOV     DPH,A
   \   000057   E0           MOVX    A,@DPTR
   \   000058   64FF         XRL     A,#0xff
   \   00005A   7003         JNZ     $+5
   \   00005C   02....       LJMP    ??zclGeneral_ProcessInCmd_TerminateKeyEstablish_2 & 0xFFFF
   1473              {
   1474                keyEstablishmentInd_t *ind;
   1475          
   1476                // Send osal message to the application
   1477                ind = (keyEstablishmentInd_t *)osal_msg_allocate( sizeof( keyEstablishmentInd_t ) );
   \   00005F                ; Setup parameters for call to function osal_msg_allocate
   \   00005F   7A05         MOV     R2,#0x5
   \   000061   7B00         MOV     R3,#0x0
   \   000063   12....       LCALL   ??osal_msg_allocate?relay
   \   000066   8A..         MOV     ?V0 + 4,R2
   \   000068   8B..         MOV     ?V0 + 5,R3
   \   00006A   AE..         MOV     R6,?V0 + 4
   \   00006C   AF..         MOV     R7,?V0 + 5
   1478                if ( ind )
   \   00006E   EE           MOV     A,R6
   \   00006F   4F           ORL     A,R7
   \   000070   7003         JNZ     $+5
   \   000072   02....       LJMP    ??zclGeneral_ProcessInCmd_TerminateKeyEstablish_2 & 0xFFFF
   1479                {
   1480                  ind->hdr.event = ZCL_KEY_ESTABLISH_IND;
   \   000075   8E82         MOV     DPL,R6
   \   000077   8F83         MOV     DPH,R7
   \   000079   7435         MOV     A,#0x35
   \   00007B   F0           MOVX    @DPTR,A
   1481                  ind->hdr.status = pInMsg->pData[0];
   \   00007C   85..82       MOV     DPL,?V0 + 0
   \   00007F   85..83       MOV     DPH,?V0 + 1
   \   000082   A3           INC     DPTR
   \   000083   A3           INC     DPTR
   \   000084   A3           INC     DPTR
   \   000085   A3           INC     DPTR
   \   000086   A3           INC     DPTR
   \   000087   A3           INC     DPTR
   \   000088   A3           INC     DPTR
   \   000089   A3           INC     DPTR
   \   00008A   E0           MOVX    A,@DPTR
   \   00008B   F8           MOV     R0,A
   \   00008C   A3           INC     DPTR
   \   00008D   E0           MOVX    A,@DPTR
   \   00008E   F583         MOV     DPH,A
   \   000090   8882         MOV     DPL,R0
   \   000092   E0           MOVX    A,@DPTR
   \   000093   8E82         MOV     DPL,R6
   \   000095   8F83         MOV     DPH,R7
   \   000097   A3           INC     DPTR
   \   000098   F0           MOVX    @DPTR,A
   1482                  ind->waitTime = pInMsg->pData[1];
   \   000099   85..82       MOV     DPL,?V0 + 0
   \   00009C   85..83       MOV     DPH,?V0 + 1
   \   00009F   A3           INC     DPTR
   \   0000A0   A3           INC     DPTR
   \   0000A1   A3           INC     DPTR
   \   0000A2   A3           INC     DPTR
   \   0000A3   A3           INC     DPTR
   \   0000A4   A3           INC     DPTR
   \   0000A5   A3           INC     DPTR
   \   0000A6   A3           INC     DPTR
   \   0000A7   E0           MOVX    A,@DPTR
   \   0000A8   F8           MOV     R0,A
   \   0000A9   A3           INC     DPTR
   \   0000AA   E0           MOVX    A,@DPTR
   \   0000AB   F583         MOV     DPH,A
   \   0000AD   8882         MOV     DPL,R0
   \   0000AF   A3           INC     DPTR
   \   0000B0   E0           MOVX    A,@DPTR
   \   0000B1   8E82         MOV     DPL,R6
   \   0000B3   8F83         MOV     DPH,R7
   \   0000B5   A3           INC     DPTR
   \   0000B6   A3           INC     DPTR
   \   0000B7   F0           MOVX    @DPTR,A
   1483                  ind->keyEstablishmentSuite = BUILD_UINT16( pInMsg->pData[2], pInMsg->pData[3] );
   \   0000B8   85..82       MOV     DPL,?V0 + 0
   \   0000BB   85..83       MOV     DPH,?V0 + 1
   \   0000BE   A3           INC     DPTR
   \   0000BF   A3           INC     DPTR
   \   0000C0   A3           INC     DPTR
   \   0000C1   A3           INC     DPTR
   \   0000C2   A3           INC     DPTR
   \   0000C3   A3           INC     DPTR
   \   0000C4   A3           INC     DPTR
   \   0000C5   A3           INC     DPTR
   \   0000C6   E0           MOVX    A,@DPTR
   \   0000C7   F8           MOV     R0,A
   \   0000C8   A3           INC     DPTR
   \   0000C9   E0           MOVX    A,@DPTR
   \   0000CA   F583         MOV     DPH,A
   \   0000CC   8882         MOV     DPL,R0
   \   0000CE   A3           INC     DPTR
   \   0000CF   A3           INC     DPTR
   \   0000D0   E0           MOVX    A,@DPTR
   \   0000D1   FA           MOV     R2,A
   \   0000D2   7B00         MOV     R3,#0x0
   \   0000D4   85..82       MOV     DPL,?V0 + 0
   \   0000D7   85..83       MOV     DPH,?V0 + 1
   \   0000DA   A3           INC     DPTR
   \   0000DB   A3           INC     DPTR
   \   0000DC   A3           INC     DPTR
   \   0000DD   A3           INC     DPTR
   \   0000DE   A3           INC     DPTR
   \   0000DF   A3           INC     DPTR
   \   0000E0   A3           INC     DPTR
   \   0000E1   A3           INC     DPTR
   \   0000E2   E0           MOVX    A,@DPTR
   \   0000E3   F8           MOV     R0,A
   \   0000E4   A3           INC     DPTR
   \   0000E5   E0           MOVX    A,@DPTR
   \   0000E6   F583         MOV     DPH,A
   \   0000E8   8882         MOV     DPL,R0
   \   0000EA   A3           INC     DPTR
   \   0000EB   A3           INC     DPTR
   \   0000EC   A3           INC     DPTR
   \   0000ED   E0           MOVX    A,@DPTR
   \   0000EE   F8           MOV     R0,A
   \   0000EF   7900         MOV     R1,#0x0
   \   0000F1   E4           CLR     A
   \   0000F2   C8           XCH     A,R0
   \   0000F3   F9           MOV     R1,A
   \   0000F4   EA           MOV     A,R2
   \   0000F5   28           ADD     A,R0
   \   0000F6   F8           MOV     R0,A
   \   0000F7   EB           MOV     A,R3
   \   0000F8   39           ADDC    A,R1
   \   0000F9   F9           MOV     R1,A
   \   0000FA   8E82         MOV     DPL,R6
   \   0000FC   8F83         MOV     DPH,R7
   \   0000FE   A3           INC     DPTR
   \   0000FF   A3           INC     DPTR
   \   000100   A3           INC     DPTR
   \   000101   E8           MOV     A,R0
   \   000102   F0           MOVX    @DPTR,A
   \   000103   A3           INC     DPTR
   \   000104   E9           MOV     A,R1
   \   000105   F0           MOVX    @DPTR,A
   1484                  osal_msg_send( keyEstablishRec[index].appTaskID, (uint8*)ind );
   \   000106                ; Setup parameters for call to function osal_msg_send
   \   000106   EE           MOV     A,R6
   \   000107   FA           MOV     R2,A
   \   000108   EF           MOV     A,R7
   \   000109   FB           MOV     R3,A
   \   00010A   E5..         MOV     A,?V0 + 2
   \   00010C   A8..         MOV     R0,?V0 + 2
   \   00010E   7900         MOV     R1,#0x0
   \   000110   E8           MOV     A,R0
   \   000111   75F027       MOV     B,#0x27
   \   000114   A4           MUL     AB
   \   000115   C8           XCH     A,R0
   \   000116   ACF0         MOV     R4,B
   \   000118   75F000       MOV     B,#0x0
   \   00011B   A4           MUL     AB
   \   00011C   2C           ADD     A,R4
   \   00011D   FC           MOV     R4,A
   \   00011E   75F027       MOV     B,#0x27
   \   000121   E9           MOV     A,R1
   \   000122   A4           MUL     AB
   \   000123   2C           ADD     A,R4
   \   000124   F9           MOV     R1,A
   \   000125   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   000127   28           ADD     A,R0
   \   000128   F582         MOV     DPL,A
   \   00012A   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   00012C   39           ADDC    A,R1
   \   00012D   F583         MOV     DPH,A
   \   00012F   E0           MOVX    A,@DPTR
   \   000130   F9           MOV     R1,A
   \   000131   12....       LCALL   ??osal_msg_send?relay
   \   000134   E9           MOV     A,R1
   1485                }
   1486              }
   1487              // In either case, remove the entry from the rec table
   1488              zclGeneral_ResetKeyEstablishRec( index );
   \                     ??zclGeneral_ProcessInCmd_TerminateKeyEstablish_2:
   \   000135                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000135   A9..         MOV     R1,?V0 + 2
   \   000137   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1489          
   1490          #if defined (NWK_AUTO_POLL)
   1491              // Restore the saved poll rate for end device
   1492              NLME_SetPollRate(zclSavedPollRate);
   \   00013A                ; Setup parameters for call to function NLME_SetPollRate
   \   00013A   90....       MOV     DPTR,#zclSavedPollRate
   \   00013D   E0           MOVX    A,@DPTR
   \   00013E   FA           MOV     R2,A
   \   00013F   A3           INC     DPTR
   \   000140   E0           MOVX    A,@DPTR
   \   000141   FB           MOV     R3,A
   \   000142   12....       LCALL   ??NLME_SetPollRate?relay
   1493          #endif
   1494            }
   1495            return ZSuccess;
   \                     ??zclGeneral_ProcessInCmd_TerminateKeyEstablish_1:
   \   000145   7900         MOV     R1,#0x0
   \   000147   7F06         MOV     R7,#0x6
   \   000149   02....       LJMP    ?BANKED_LEAVE_XDATA
   1496          }
   1497          
   1498          /*********************************************************************
   1499           * @fn      zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey
   1500           *
   1501           * @brief   Calculate the Key using ECC library upon receipt of Initiate
   1502                      Key Establishment Command.
   1503           *
   1504           * @param   none
   1505           *
   1506           * @return  ZStatus_t - ZFailure @ Entry pending key calculation not found
   1507           *                      ZSuccess
   1508           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1509          static ZStatus_t zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey( void )
   \                     zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey:
   1510          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 22
   \   000005   74EA         MOV     A,#-0x16
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   1511            uint8 zData[KEY_ESTABLISH_SHARED_SECRET_LENGTH];
   1512            uint8 *caPublicKey, *devicePrivateKey, *keyBit;
   1513            uint8 index, status, tmp;
   1514          
   1515            // It is possible to have multiple entries in the keyCalulationPending state.
   1516            // Here we assume the partner that starts the key establishment procedure earlier
   1517            // will have a smaller index in the table.
   1518            // However, this might not apply due to different processing capability of
   1519            // different processors.
   1520            if ( (index = zclGeneral_GetKeyEstablishRecIndex_State( KeyEstablishState_KeyCalculatePending ))
   1521                 >= MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   00000A                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex_State
   \   00000A   7903         MOV     R1,#0x3
   \   00000C   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex_State?rela
   \   00000F   E9           MOV     A,R1
   \   000010   F8           MOV     R0,A
   \   000011   E8           MOV     A,R0
   \   000012   FE           MOV     R6,A
   \   000013   E8           MOV     A,R0
   \   000014   C3           CLR     C
   \   000015   9402         SUBB    A,#0x2
   \   000017   4005         JC      ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_1
   1522            {
   1523              return ZFailure;
   \   000019   7901         MOV     R1,#0x1
   \   00001B   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2 & 0xFFFF
   1524            }
   1525          
   1526            if ((caPublicKey = osal_mem_alloc(ZCL_KE_CA_PUBLIC_KEY_LEN)) == NULL)
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_1:
   \   00001E                ; Setup parameters for call to function osal_mem_alloc
   \   00001E   7A16         MOV     R2,#0x16
   \   000020   7B00         MOV     R3,#0x0
   \   000022   12....       LCALL   ??osal_mem_alloc?relay
   \   000025   8A..         MOV     ?V0 + 4,R2
   \   000027   8B..         MOV     ?V0 + 5,R3
   \   000029   A8..         MOV     R0,?V0 + 4
   \   00002B   A9..         MOV     R1,?V0 + 5
   \   00002D   88..         MOV     ?V0 + 2,R0
   \   00002F   89..         MOV     ?V0 + 3,R1
   \   000031   E8           MOV     A,R0
   \   000032   49           ORL     A,R1
   \   000033   700A         JNZ     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_3
   1527            {
   1528              // Reset the entry
   1529              zclGeneral_ResetKeyEstablishRec( index );
   \   000035                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000035   EE           MOV     A,R6
   \   000036   F9           MOV     R1,A
   \   000037   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1530          
   1531              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   00003A   79C1         MOV     R1,#-0x3f
   \   00003C   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2 & 0xFFFF
   1532            }
   1533            if ((devicePrivateKey = osal_mem_alloc(ZCL_KE_DEVICE_PRIVATE_KEY_LEN)) == NULL)
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_3:
   \   00003F                ; Setup parameters for call to function osal_mem_alloc
   \   00003F   7A15         MOV     R2,#0x15
   \   000041   7B00         MOV     R3,#0x0
   \   000043   12....       LCALL   ??osal_mem_alloc?relay
   \   000046   8A..         MOV     ?V0 + 4,R2
   \   000048   8B..         MOV     ?V0 + 5,R3
   \   00004A   A8..         MOV     R0,?V0 + 4
   \   00004C   A9..         MOV     R1,?V0 + 5
   \   00004E   88..         MOV     ?V0 + 8,R0
   \   000050   89..         MOV     ?V0 + 9,R1
   \   000052   E8           MOV     A,R0
   \   000053   49           ORL     A,R1
   \   000054   7011         JNZ     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_4
   1534            {
   1535              osal_mem_free(caPublicKey);
   \   000056                ; Setup parameters for call to function osal_mem_free
   \   000056   AA..         MOV     R2,?V0 + 2
   \   000058   AB..         MOV     R3,?V0 + 3
   \   00005A   12....       LCALL   ??osal_mem_free?relay
   1536          
   1537              // Reset the entry
   1538              zclGeneral_ResetKeyEstablishRec( index );
   \   00005D                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00005D   EE           MOV     A,R6
   \   00005E   F9           MOV     R1,A
   \   00005F   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1539          
   1540              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   000062   79C1         MOV     R1,#-0x3f
   \   000064   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2 & 0xFFFF
   1541            }
   1542          
   1543            osal_nv_read(ZCD_NV_CA_PUBLIC_KEY, 0, ZCL_KE_CA_PUBLIC_KEY_LEN, caPublicKey);
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_4:
   \   000067                ; Setup parameters for call to function osal_nv_read
   \   000067   78..         MOV     R0,#?V0 + 2
   \   000069   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00006C   75..16       MOV     ?V0 + 4,#0x16
   \   00006F   75..00       MOV     ?V0 + 5,#0x0
   \   000072   78..         MOV     R0,#?V0 + 4
   \   000074   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000077   7C00         MOV     R4,#0x0
   \   000079   7D00         MOV     R5,#0x0
   \   00007B   7A6B         MOV     R2,#0x6b
   \   00007D   7B00         MOV     R3,#0x0
   \   00007F   12....       LCALL   ??osal_nv_read?relay
   \   000082   7404         MOV     A,#0x4
   \   000084   12....       LCALL   ?DEALLOC_XSTACK8
   \   000087   E9           MOV     A,R1
   1544            osal_nv_read(ZCD_NV_DEVICE_PRIVATE_KEY, 0, ZCL_KE_DEVICE_PRIVATE_KEY_LEN, devicePrivateKey);
   \   000088                ; Setup parameters for call to function osal_nv_read
   \   000088   78..         MOV     R0,#?V0 + 8
   \   00008A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008D   75..15       MOV     ?V0 + 4,#0x15
   \   000090   75..00       MOV     ?V0 + 5,#0x0
   \   000093   78..         MOV     R0,#?V0 + 4
   \   000095   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000098   7C00         MOV     R4,#0x0
   \   00009A   7D00         MOV     R5,#0x0
   \   00009C   7A6A         MOV     R2,#0x6a
   \   00009E   7B00         MOV     R3,#0x0
   \   0000A0   12....       LCALL   ??osal_nv_read?relay
   \   0000A3   7404         MOV     A,#0x4
   \   0000A5   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000A8   E9           MOV     A,R1
   1545          
   1546            // Turn off the radio
   1547            tmp = FALSE;
   \   0000A9   85..82       MOV     DPL,?XSP + 0
   \   0000AC   85..83       MOV     DPH,?XSP + 1
   \   0000AF   7400         MOV     A,#0x0
   \   0000B1   F0           MOVX    @DPTR,A
   1548            ZMacSetReq( ZMacRxOnIdle, &tmp );
   \   0000B2                ; Setup parameters for call to function ZMacSetReq
   \   0000B2   85..82       MOV     DPL,?XSP + 0
   \   0000B5   85..83       MOV     DPH,?XSP + 1
   \   0000B8   AA82         MOV     R2,DPL
   \   0000BA   AB83         MOV     R3,DPH
   \   0000BC   7952         MOV     R1,#0x52
   \   0000BE   12....       LCALL   ??ZMacSetReq?relay
   \   0000C1   E9           MOV     A,R1
   1549          
   1550            status = ZSE_ECCKeyBitGenerate( devicePrivateKey, keyEstablishRec[index].pLocalEPrivateKey,
   1551                              keyEstablishRec[index].pLocalEPublicKey,
   1552                              keyEstablishRec[index].pRemoteCertificate,
   1553                              keyEstablishRec[index].pRemotePublicKey,
   1554                              caPublicKey, zData,
   1555                              zclGeneral_KeyEstablishment_HashFunc,
   1556                              zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel);
   \   0000C2                ; Setup parameters for call to function ZSE_ECCKeyBitGenerate
   \   0000C2   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   0000C5   E0           MOVX    A,@DPTR
   \   0000C6   F5..         MOV     ?V0 + 4,A
   \   0000C8   E4           CLR     A
   \   0000C9   F5..         MOV     ?V0 + 5,A
   \   0000CB   F5..         MOV     ?V0 + 6,A
   \   0000CD   F5..         MOV     ?V0 + 7,A
   \   0000CF   78..         MOV     R0,#?V0 + 4
   \   0000D1   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   0000D4   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   0000D7   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   0000DA   75....       MOV     ?V0 + 4,#??zclGeneral_KeyEstablishment_HashFunc?relay & 0xff
   \   0000DD   75....       MOV     ?V0 + 5,#(??zclGeneral_KeyEstablishment_HashFunc?relay >> 8) & 0xff
   \   0000E0   78..         MOV     R0,#?V0 + 4
   \   0000E2   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000E5   7409         MOV     A,#0x9
   \   0000E7   12....       LCALL   ?XSTACK_DISP0_8
   \   0000EA   8582..       MOV     ?V0 + 4,DPL
   \   0000ED   8583..       MOV     ?V0 + 5,DPH
   \   0000F0   78..         MOV     R0,#?V0 + 4
   \   0000F2   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000F5   78..         MOV     R0,#?V0 + 2
   \   0000F7   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000FA   EE           MOV     A,R6
   \   0000FB   F8           MOV     R0,A
   \   0000FC   7900         MOV     R1,#0x0
   \   0000FE   E8           MOV     A,R0
   \   0000FF   75F027       MOV     B,#0x27
   \   000102   A4           MUL     AB
   \   000103   C8           XCH     A,R0
   \   000104   AAF0         MOV     R2,B
   \   000106   75F000       MOV     B,#0x0
   \   000109   A4           MUL     AB
   \   00010A   2A           ADD     A,R2
   \   00010B   FA           MOV     R2,A
   \   00010C   75F027       MOV     B,#0x27
   \   00010F   E9           MOV     A,R1
   \   000110   A4           MUL     AB
   \   000111   2A           ADD     A,R2
   \   000112   F9           MOV     R1,A
   \   000113   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   000115   28           ADD     A,R0
   \   000116   F582         MOV     DPL,A
   \   000118   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   00011A   39           ADDC    A,R1
   \   00011B   F583         MOV     DPH,A
   \   00011D   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000120   EE           MOV     A,R6
   \   000121   F8           MOV     R0,A
   \   000122   7900         MOV     R1,#0x0
   \   000124   E8           MOV     A,R0
   \   000125   75F027       MOV     B,#0x27
   \   000128   A4           MUL     AB
   \   000129   C8           XCH     A,R0
   \   00012A   AAF0         MOV     R2,B
   \   00012C   75F000       MOV     B,#0x0
   \   00012F   A4           MUL     AB
   \   000130   2A           ADD     A,R2
   \   000131   FA           MOV     R2,A
   \   000132   75F027       MOV     B,#0x27
   \   000135   E9           MOV     A,R1
   \   000136   A4           MUL     AB
   \   000137   2A           ADD     A,R2
   \   000138   F9           MOV     R1,A
   \   000139   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   00013B   28           ADD     A,R0
   \   00013C   F582         MOV     DPL,A
   \   00013E   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   000140   39           ADDC    A,R1
   \   000141   F583         MOV     DPH,A
   \   000143   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000146   EE           MOV     A,R6
   \   000147   F8           MOV     R0,A
   \   000148   7900         MOV     R1,#0x0
   \   00014A   E8           MOV     A,R0
   \   00014B   75F027       MOV     B,#0x27
   \   00014E   A4           MUL     AB
   \   00014F   C8           XCH     A,R0
   \   000150   AAF0         MOV     R2,B
   \   000152   75F000       MOV     B,#0x0
   \   000155   A4           MUL     AB
   \   000156   2A           ADD     A,R2
   \   000157   FA           MOV     R2,A
   \   000158   75F027       MOV     B,#0x27
   \   00015B   E9           MOV     A,R1
   \   00015C   A4           MUL     AB
   \   00015D   2A           ADD     A,R2
   \   00015E   F9           MOV     R1,A
   \   00015F   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   000161   28           ADD     A,R0
   \   000162   F582         MOV     DPL,A
   \   000164   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   000166   39           ADDC    A,R1
   \   000167   F583         MOV     DPH,A
   \   000169   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00016C   EE           MOV     A,R6
   \   00016D   F8           MOV     R0,A
   \   00016E   7900         MOV     R1,#0x0
   \   000170   E8           MOV     A,R0
   \   000171   75F027       MOV     B,#0x27
   \   000174   A4           MUL     AB
   \   000175   C8           XCH     A,R0
   \   000176   AAF0         MOV     R2,B
   \   000178   75F000       MOV     B,#0x0
   \   00017B   A4           MUL     AB
   \   00017C   2A           ADD     A,R2
   \   00017D   FA           MOV     R2,A
   \   00017E   75F027       MOV     B,#0x27
   \   000181   E9           MOV     A,R1
   \   000182   A4           MUL     AB
   \   000183   2A           ADD     A,R2
   \   000184   F9           MOV     R1,A
   \   000185   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   000187   28           ADD     A,R0
   \   000188   F582         MOV     DPL,A
   \   00018A   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   00018C   39           ADDC    A,R1
   \   00018D   F583         MOV     DPH,A
   \   00018F   E0           MOVX    A,@DPTR
   \   000190   FC           MOV     R4,A
   \   000191   A3           INC     DPTR
   \   000192   E0           MOVX    A,@DPTR
   \   000193   FD           MOV     R5,A
   \   000194   AA..         MOV     R2,?V0 + 8
   \   000196   AB..         MOV     R3,?V0 + 9
   \   000198   12....       LCALL   ??ZSE_ECCKeyBitGenerate?relay
   \   00019B   7412         MOV     A,#0x12
   \   00019D   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001A0   EA           MOV     A,R2
   \   0001A1   FF           MOV     R7,A
   1557            tmp = TRUE;
   \   0001A2   85..82       MOV     DPL,?XSP + 0
   \   0001A5   85..83       MOV     DPH,?XSP + 1
   \   0001A8   7401         MOV     A,#0x1
   \   0001AA   F0           MOVX    @DPTR,A
   1558            ZMacSetReq( ZMacRxOnIdle, &tmp );  // Turn the radio back on
   \   0001AB                ; Setup parameters for call to function ZMacSetReq
   \   0001AB   85..82       MOV     DPL,?XSP + 0
   \   0001AE   85..83       MOV     DPH,?XSP + 1
   \   0001B1   AA82         MOV     R2,DPL
   \   0001B3   AB83         MOV     R3,DPH
   \   0001B5   7952         MOV     R1,#0x52
   \   0001B7   12....       LCALL   ??ZMacSetReq?relay
   \   0001BA   E9           MOV     A,R1
   1559          
   1560            osal_mem_free(caPublicKey);
   \   0001BB                ; Setup parameters for call to function osal_mem_free
   \   0001BB   AA..         MOV     R2,?V0 + 2
   \   0001BD   AB..         MOV     R3,?V0 + 3
   \   0001BF   12....       LCALL   ??osal_mem_free?relay
   1561            osal_mem_free(devicePrivateKey);
   \   0001C2                ; Setup parameters for call to function osal_mem_free
   \   0001C2   AA..         MOV     R2,?V0 + 8
   \   0001C4   AB..         MOV     R3,?V0 + 9
   \   0001C6   12....       LCALL   ??osal_mem_free?relay
   1562          
   1563            if( status == MCE_SUCCESS )
   \   0001C9   EF           MOV     A,R7
   \   0001CA   6003         JZ      $+5
   \   0001CC   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_5 & 0xFFFF
   1564            {
   1565              // Allocate buffer to store KDF(Z) = MacKey || KeyData
   1566              if ( (keyBit = osal_mem_alloc( KEY_ESTABLISH_KEY_DATA_LENGTH +
   1567                                           KEY_ESTABLISH_MAC_KEY_LENGTH)) == NULL )
   \   0001CF                ; Setup parameters for call to function osal_mem_alloc
   \   0001CF   7A20         MOV     R2,#0x20
   \   0001D1   7B00         MOV     R3,#0x0
   \   0001D3   12....       LCALL   ??osal_mem_alloc?relay
   \   0001D6   8A..         MOV     ?V0 + 4,R2
   \   0001D8   8B..         MOV     ?V0 + 5,R3
   \   0001DA   A8..         MOV     R0,?V0 + 4
   \   0001DC   A9..         MOV     R1,?V0 + 5
   \   0001DE   88..         MOV     ?V0 + 0,R0
   \   0001E0   89..         MOV     ?V0 + 1,R1
   \   0001E2   E8           MOV     A,R0
   \   0001E3   49           ORL     A,R1
   \   0001E4   700A         JNZ     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_6
   1568              {
   1569                // Reset the entry
   1570                zclGeneral_ResetKeyEstablishRec( index );
   \   0001E6                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   0001E6   EE           MOV     A,R6
   \   0001E7   F9           MOV     R1,A
   \   0001E8   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1571          
   1572                return  ZCL_STATUS_SOFTWARE_FAILURE; // Memory allocation failure
   \   0001EB   79C1         MOV     R1,#-0x3f
   \   0001ED   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2 & 0xFFFF
   1573              }
   1574          
   1575              // Derive the keying data using KDF function
   1576              zclGeneral_KeyEstablishment_KeyDeriveFunction(zData,
   1577                                                            KEY_ESTABLISH_SHARED_SECRET_LENGTH,
   1578                                                            keyBit );
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_6:
   \   0001F0                ; Setup parameters for call to function zclGeneral_KeyEstablishment_KeyDeriveFunction
   \   0001F0   AC..         MOV     R4,?V0 + 0
   \   0001F2   AD..         MOV     R5,?V0 + 1
   \   0001F4   7915         MOV     R1,#0x15
   \   0001F6   7401         MOV     A,#0x1
   \   0001F8   12....       LCALL   ?XSTACK_DISP0_8
   \   0001FB   AA82         MOV     R2,DPL
   \   0001FD   AB83         MOV     R3,DPH
   \   0001FF   12....       LCALL   ??zclGeneral_KeyEstablishment_KeyDeriveFunction
   1579          
   1580              // Save the derived 128-bit key and macKey
   1581              osal_memcpy( keyEstablishRec[index].pMacKey, keyBit, KEY_ESTABLISH_MAC_KEY_LENGTH );
   \   000202                ; Setup parameters for call to function osal_memcpy
   \   000202   85....       MOV     ?V0 + 4,?V0 + 0
   \   000205   85....       MOV     ?V0 + 5,?V0 + 1
   \   000208   75..00       MOV     ?V0 + 6,#0x0
   \   00020B   78..         MOV     R0,#?V0 + 4
   \   00020D   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000210   7C10         MOV     R4,#0x10
   \   000212   7D00         MOV     R5,#0x0
   \   000214   EE           MOV     A,R6
   \   000215   F8           MOV     R0,A
   \   000216   7900         MOV     R1,#0x0
   \   000218   E8           MOV     A,R0
   \   000219   75F027       MOV     B,#0x27
   \   00021C   A4           MUL     AB
   \   00021D   C8           XCH     A,R0
   \   00021E   AAF0         MOV     R2,B
   \   000220   75F000       MOV     B,#0x0
   \   000223   A4           MUL     AB
   \   000224   2A           ADD     A,R2
   \   000225   FA           MOV     R2,A
   \   000226   75F027       MOV     B,#0x27
   \   000229   E9           MOV     A,R1
   \   00022A   A4           MUL     AB
   \   00022B   2A           ADD     A,R2
   \   00022C   F9           MOV     R1,A
   \   00022D   74..         MOV     A,#(keyEstablishRec + 35) & 0xff
   \   00022F   28           ADD     A,R0
   \   000230   F582         MOV     DPL,A
   \   000232   74..         MOV     A,#((keyEstablishRec + 35) >> 8) & 0xff
   \   000234   39           ADDC    A,R1
   \   000235   F583         MOV     DPH,A
   \   000237   E0           MOVX    A,@DPTR
   \   000238   FA           MOV     R2,A
   \   000239   A3           INC     DPTR
   \   00023A   E0           MOVX    A,@DPTR
   \   00023B   FB           MOV     R3,A
   \   00023C   12....       LCALL   ??osal_memcpy?relay
   \   00023F   7403         MOV     A,#0x3
   \   000241   12....       LCALL   ?DEALLOC_XSTACK8
   1582              osal_memcpy( keyEstablishRec[index].pKey, &(keyBit[KEY_ESTABLISH_MAC_KEY_LENGTH]),
   1583                          KEY_ESTABLISH_KEY_DATA_LENGTH);
   \   000244                ; Setup parameters for call to function osal_memcpy
   \   000244   E5..         MOV     A,?V0 + 0
   \   000246   2410         ADD     A,#0x10
   \   000248   F5..         MOV     ?V0 + 4,A
   \   00024A   E5..         MOV     A,?V0 + 1
   \   00024C   3400         ADDC    A,#0x0
   \   00024E   F5..         MOV     ?V0 + 5,A
   \   000250   75..00       MOV     ?V0 + 6,#0x0
   \   000253   78..         MOV     R0,#?V0 + 4
   \   000255   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000258   7C10         MOV     R4,#0x10
   \   00025A   7D00         MOV     R5,#0x0
   \   00025C   EE           MOV     A,R6
   \   00025D   F8           MOV     R0,A
   \   00025E   7900         MOV     R1,#0x0
   \   000260   E8           MOV     A,R0
   \   000261   75F027       MOV     B,#0x27
   \   000264   A4           MUL     AB
   \   000265   C8           XCH     A,R0
   \   000266   AAF0         MOV     R2,B
   \   000268   75F000       MOV     B,#0x0
   \   00026B   A4           MUL     AB
   \   00026C   2A           ADD     A,R2
   \   00026D   FA           MOV     R2,A
   \   00026E   75F027       MOV     B,#0x27
   \   000271   E9           MOV     A,R1
   \   000272   A4           MUL     AB
   \   000273   2A           ADD     A,R2
   \   000274   F9           MOV     R1,A
   \   000275   74..         MOV     A,#(keyEstablishRec + 33) & 0xff
   \   000277   28           ADD     A,R0
   \   000278   F582         MOV     DPL,A
   \   00027A   74..         MOV     A,#((keyEstablishRec + 33) >> 8) & 0xff
   \   00027C   39           ADDC    A,R1
   \   00027D   F583         MOV     DPH,A
   \   00027F   E0           MOVX    A,@DPTR
   \   000280   FA           MOV     R2,A
   \   000281   A3           INC     DPTR
   \   000282   E0           MOVX    A,@DPTR
   \   000283   FB           MOV     R3,A
   \   000284   12....       LCALL   ??osal_memcpy?relay
   \   000287   7403         MOV     A,#0x3
   \   000289   12....       LCALL   ?DEALLOC_XSTACK8
   1584              osal_mem_free( keyBit );
   \   00028C                ; Setup parameters for call to function osal_mem_free
   \   00028C   AA..         MOV     R2,?V0 + 0
   \   00028E   AB..         MOV     R3,?V0 + 1
   \   000290   12....       LCALL   ??osal_mem_free?relay
   1585          
   1586              // Key Bit generation success, send Ephemeral Data Response back
   1587              zclGeneral_KeyEstablish_Send_EphemeralDataRsp( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1588                                                             &(keyEstablishRec[index].dstAddr),
   1589                                                             keyEstablishRec[index].pLocalEPublicKey,
   1590                                                             FALSE, keyEstablishRec[index].lastSeqNum );
   \   000293                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_EphemeralDataRsp
   \   000293   EE           MOV     A,R6
   \   000294   F8           MOV     R0,A
   \   000295   7900         MOV     R1,#0x0
   \   000297   E8           MOV     A,R0
   \   000298   75F027       MOV     B,#0x27
   \   00029B   A4           MUL     AB
   \   00029C   C8           XCH     A,R0
   \   00029D   AAF0         MOV     R2,B
   \   00029F   75F000       MOV     B,#0x0
   \   0002A2   A4           MUL     AB
   \   0002A3   2A           ADD     A,R2
   \   0002A4   FA           MOV     R2,A
   \   0002A5   75F027       MOV     B,#0x27
   \   0002A8   E9           MOV     A,R1
   \   0002A9   A4           MUL     AB
   \   0002AA   2A           ADD     A,R2
   \   0002AB   F9           MOV     R1,A
   \   0002AC   74..         MOV     A,#(keyEstablishRec + 12) & 0xff
   \   0002AE   28           ADD     A,R0
   \   0002AF   F582         MOV     DPL,A
   \   0002B1   74..         MOV     A,#((keyEstablishRec + 12) >> 8) & 0xff
   \   0002B3   39           ADDC    A,R1
   \   0002B4   F583         MOV     DPH,A
   \   0002B6   E0           MOVX    A,@DPTR
   \   0002B7   F5..         MOV     ?V0 + 4,A
   \   0002B9   78..         MOV     R0,#?V0 + 4
   \   0002BB   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0002BE   75..00       MOV     ?V0 + 4,#0x0
   \   0002C1   78..         MOV     R0,#?V0 + 4
   \   0002C3   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0002C6   EE           MOV     A,R6
   \   0002C7   F8           MOV     R0,A
   \   0002C8   7900         MOV     R1,#0x0
   \   0002CA   E8           MOV     A,R0
   \   0002CB   75F027       MOV     B,#0x27
   \   0002CE   A4           MUL     AB
   \   0002CF   C8           XCH     A,R0
   \   0002D0   AAF0         MOV     R2,B
   \   0002D2   75F000       MOV     B,#0x0
   \   0002D5   A4           MUL     AB
   \   0002D6   2A           ADD     A,R2
   \   0002D7   FA           MOV     R2,A
   \   0002D8   75F027       MOV     B,#0x27
   \   0002DB   E9           MOV     A,R1
   \   0002DC   A4           MUL     AB
   \   0002DD   2A           ADD     A,R2
   \   0002DE   F9           MOV     R1,A
   \   0002DF   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   0002E1   28           ADD     A,R0
   \   0002E2   F582         MOV     DPL,A
   \   0002E4   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   0002E6   39           ADDC    A,R1
   \   0002E7   F583         MOV     DPH,A
   \   0002E9   E0           MOVX    A,@DPTR
   \   0002EA   FC           MOV     R4,A
   \   0002EB   A3           INC     DPTR
   \   0002EC   E0           MOVX    A,@DPTR
   \   0002ED   FD           MOV     R5,A
   \   0002EE   EE           MOV     A,R6
   \   0002EF   F8           MOV     R0,A
   \   0002F0   7900         MOV     R1,#0x0
   \   0002F2   E8           MOV     A,R0
   \   0002F3   75F027       MOV     B,#0x27
   \   0002F6   A4           MUL     AB
   \   0002F7   C8           XCH     A,R0
   \   0002F8   AAF0         MOV     R2,B
   \   0002FA   75F000       MOV     B,#0x0
   \   0002FD   A4           MUL     AB
   \   0002FE   2A           ADD     A,R2
   \   0002FF   FA           MOV     R2,A
   \   000300   75F027       MOV     B,#0x27
   \   000303   E9           MOV     A,R1
   \   000304   A4           MUL     AB
   \   000305   2A           ADD     A,R2
   \   000306   F9           MOV     R1,A
   \   000307   74..         MOV     A,#keyEstablishRec & 0xff
   \   000309   28           ADD     A,R0
   \   00030A   FA           MOV     R2,A
   \   00030B   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   00030D   39           ADDC    A,R1
   \   00030E   FB           MOV     R3,A
   \   00030F   790A         MOV     R1,#0xa
   \   000311   12....       LCALL   ??zclGeneral_KeyEstablish_Send_EphemeralDataRsp
   \   000314   7402         MOV     A,#0x2
   \   000316   12....       LCALL   ?DEALLOC_XSTACK8
   \   000319   E9           MOV     A,R1
   1591          
   1592              // The Request was processed successfuly, now the age timer needs to start based on the
   1593              // remote Config Key Generate
   1594              keyEstablishRec[index].age = keyEstablishRec[index].remoteConfKeyGenTime;
   \   00031A   EE           MOV     A,R6
   \   00031B   F8           MOV     R0,A
   \   00031C   7900         MOV     R1,#0x0
   \   00031E   E8           MOV     A,R0
   \   00031F   75F027       MOV     B,#0x27
   \   000322   A4           MUL     AB
   \   000323   C8           XCH     A,R0
   \   000324   AAF0         MOV     R2,B
   \   000326   75F000       MOV     B,#0x0
   \   000329   A4           MUL     AB
   \   00032A   2A           ADD     A,R2
   \   00032B   FA           MOV     R2,A
   \   00032C   75F027       MOV     B,#0x27
   \   00032F   E9           MOV     A,R1
   \   000330   A4           MUL     AB
   \   000331   2A           ADD     A,R2
   \   000332   F9           MOV     R1,A
   \   000333   74..         MOV     A,#(keyEstablishRec + 38) & 0xff
   \   000335   28           ADD     A,R0
   \   000336   F582         MOV     DPL,A
   \   000338   74..         MOV     A,#((keyEstablishRec + 38) >> 8) & 0xff
   \   00033A   39           ADDC    A,R1
   \   00033B   F583         MOV     DPH,A
   \   00033D   E0           MOVX    A,@DPTR
   \   00033E   C0E0         PUSH    A
   \   000340   EE           MOV     A,R6
   \   000341   F8           MOV     R0,A
   \   000342   7900         MOV     R1,#0x0
   \   000344   E8           MOV     A,R0
   \   000345   75F027       MOV     B,#0x27
   \   000348   A4           MUL     AB
   \   000349   C8           XCH     A,R0
   \   00034A   AAF0         MOV     R2,B
   \   00034C   75F000       MOV     B,#0x0
   \   00034F   A4           MUL     AB
   \   000350   2A           ADD     A,R2
   \   000351   FA           MOV     R2,A
   \   000352   75F027       MOV     B,#0x27
   \   000355   E9           MOV     A,R1
   \   000356   A4           MUL     AB
   \   000357   2A           ADD     A,R2
   \   000358   F9           MOV     R1,A
   \   000359   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   00035B   28           ADD     A,R0
   \   00035C   F582         MOV     DPL,A
   \   00035E   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   000360   39           ADDC    A,R1
   \   000361   F583         MOV     DPH,A
   \   000363   D0E0         POP     A
   \   000365   F0           MOVX    @DPTR,A
   1595          
   1596              // Start the Config Key Generate aging timer
   1597              osal_start_reload_timer( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT,
   1598                                       KEY_ESTABLISHMENT_REC_AGING_INTERVAL );
   \   000366                ; Setup parameters for call to function osal_start_reload_timer
   \   000366   7CE8         MOV     R4,#-0x18
   \   000368   7D03         MOV     R5,#0x3
   \   00036A   7A01         MOV     R2,#0x1
   \   00036C   7B00         MOV     R3,#0x0
   \   00036E   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   000371   E0           MOVX    A,@DPTR
   \   000372   F9           MOV     R1,A
   \   000373   12....       LCALL   ??osal_start_reload_timer?relay
   \   000376   E9           MOV     A,R1
   1599            }
   1600            else
   1601            {
   1602              // Key Bit generation failure. Send terminate key command
   1603               zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1604                                                                      &(keyEstablishRec[index].dstAddr),
   1605                                                                      TermKeyStatus_BadKeyConfirm,
   1606                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1607                                                                      KEY_ESTABLISHMENT_SUITE,
   1608                                                                      ZCL_FRAME_SERVER_CLIENT_DIR,
   1609                                                                      FALSE, zcl_SeqNum++ );
   1610              // Reset the entry
   1611              zclGeneral_ResetKeyEstablishRec( index );
   1612          
   1613          #if defined (NWK_AUTO_POLL)
   1614              // Restore the saved poll rate for end device
   1615              NLME_SetPollRate(zclSavedPollRate);
   1616          #endif
   1617          
   1618               return ZFailure;
   1619            }
   1620          
   1621            keyEstablishRec[index].state = KeyEstablishState_ConfirmPending;
   \   000377   EE           MOV     A,R6
   \   000378   F8           MOV     R0,A
   \   000379   7900         MOV     R1,#0x0
   \   00037B   E8           MOV     A,R0
   \   00037C   75F027       MOV     B,#0x27
   \   00037F   A4           MUL     AB
   \   000380   C8           XCH     A,R0
   \   000381   AAF0         MOV     R2,B
   \   000383   75F000       MOV     B,#0x0
   \   000386   A4           MUL     AB
   \   000387   2A           ADD     A,R2
   \   000388   FA           MOV     R2,A
   \   000389   75F027       MOV     B,#0x27
   \   00038C   E9           MOV     A,R1
   \   00038D   A4           MUL     AB
   \   00038E   2A           ADD     A,R2
   \   00038F   F9           MOV     R1,A
   \   000390   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000392   28           ADD     A,R0
   \   000393   F582         MOV     DPL,A
   \   000395   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000397   39           ADDC    A,R1
   \   000398   F583         MOV     DPH,A
   \   00039A   7404         MOV     A,#0x4
   \   00039C   F0           MOVX    @DPTR,A
   1622            return ZSuccess;
   \   00039D   7900         MOV     R1,#0x0
   \   00039F   8071         SJMP    ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_5:
   \   0003A1   90....       MOV     DPTR,#zcl_SeqNum
   \   0003A4   E0           MOVX    A,@DPTR
   \   0003A5   F8           MOV     R0,A
   \   0003A6   7401         MOV     A,#0x1
   \   0003A8   28           ADD     A,R0
   \   0003A9   90....       MOV     DPTR,#zcl_SeqNum
   \   0003AC   F0           MOVX    @DPTR,A
   \   0003AD                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   0003AD   E8           MOV     A,R0
   \   0003AE   F5..         MOV     ?V0 + 4,A
   \   0003B0   78..         MOV     R0,#?V0 + 4
   \   0003B2   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003B5   75..00       MOV     ?V0 + 4,#0x0
   \   0003B8   78..         MOV     R0,#?V0 + 4
   \   0003BA   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003BD   75..01       MOV     ?V0 + 4,#0x1
   \   0003C0   78..         MOV     R0,#?V0 + 4
   \   0003C2   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0003C5   75..01       MOV     ?V0 + 4,#0x1
   \   0003C8   75..00       MOV     ?V0 + 5,#0x0
   \   0003CB   78..         MOV     R0,#?V0 + 4
   \   0003CD   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0003D0   7D1C         MOV     R5,#0x1c
   \   0003D2   7C02         MOV     R4,#0x2
   \   0003D4   EE           MOV     A,R6
   \   0003D5   F8           MOV     R0,A
   \   0003D6   7900         MOV     R1,#0x0
   \   0003D8   E8           MOV     A,R0
   \   0003D9   75F027       MOV     B,#0x27
   \   0003DC   A4           MUL     AB
   \   0003DD   C8           XCH     A,R0
   \   0003DE   AAF0         MOV     R2,B
   \   0003E0   75F000       MOV     B,#0x0
   \   0003E3   A4           MUL     AB
   \   0003E4   2A           ADD     A,R2
   \   0003E5   FA           MOV     R2,A
   \   0003E6   75F027       MOV     B,#0x27
   \   0003E9   E9           MOV     A,R1
   \   0003EA   A4           MUL     AB
   \   0003EB   2A           ADD     A,R2
   \   0003EC   F9           MOV     R1,A
   \   0003ED   74..         MOV     A,#keyEstablishRec & 0xff
   \   0003EF   28           ADD     A,R0
   \   0003F0   FA           MOV     R2,A
   \   0003F1   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   0003F3   39           ADDC    A,R1
   \   0003F4   FB           MOV     R3,A
   \   0003F5   790A         MOV     R1,#0xa
   \   0003F7   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   0003FA   7405         MOV     A,#0x5
   \   0003FC   12....       LCALL   ?DEALLOC_XSTACK8
   \   0003FF   E9           MOV     A,R1
   \   000400                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000400   EE           MOV     A,R6
   \   000401   F9           MOV     R1,A
   \   000402   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   \   000405                ; Setup parameters for call to function NLME_SetPollRate
   \   000405   90....       MOV     DPTR,#zclSavedPollRate
   \   000408   E0           MOVX    A,@DPTR
   \   000409   FA           MOV     R2,A
   \   00040A   A3           INC     DPTR
   \   00040B   E0           MOVX    A,@DPTR
   \   00040C   FB           MOV     R3,A
   \   00040D   12....       LCALL   ??NLME_SetPollRate?relay
   \   000410   7901         MOV     R1,#0x1
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate_2:
   \   000412   7416         MOV     A,#0x16
   \   000414   12....       LCALL   ?DEALLOC_XSTACK8
   \   000417   7F0A         MOV     R7,#0xa
   \   000419   02....       LJMP    ?BANKED_LEAVE_XDATA
   1623          }
   1624          
   1625          /*********************************************************************
   1626           * @fn      zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey
   1627           *
   1628           * @brief   Calculate the Key using ECC library upon receipt of
   1629           *          Ephemeral Data Response.
   1630           *
   1631           * @param   none
   1632           *
   1633           * @return  ZStatus_t - ZFailure @ Unsupported
   1634           *                      ZCL_STATUS_MALFORMED_COMMAND
   1635           *                      ZCL_STATUS_CMD_HAS_RSP
   1636           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1637          static ZStatus_t zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey( void )
   \                     zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey:
   1638          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 39
   \   000005   74D9         MOV     A,#-0x27
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   1639            uint8 zData[KEY_ESTABLISH_SHARED_SECRET_LENGTH];
   1640            uint8 MACu[KEY_ESTABLISH_MAC_LENGTH];
   1641            uint8 *caPublicKey, *devicePrivateKey, *keyBit;
   1642            uint8 index, ret, tmp, currentRxState;
   1643          
   1644            // It is possible to have multiple entries in the keyCalulationPending state.
   1645            // Here we assume the partner that starts the key establishment procedure earlier
   1646            // will have a smaller index in the table.
   1647            // However, this might not apply due to different processing capability of
   1648            // different processors.
   1649            if ( (index = zclGeneral_GetKeyEstablishRecIndex_State( KeyEstablishState_KeyCalculatePending ))
   1650                 >= MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   00000A                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex_State
   \   00000A   7903         MOV     R1,#0x3
   \   00000C   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex_State?rela
   \   00000F   E9           MOV     A,R1
   \   000010   F8           MOV     R0,A
   \   000011   E8           MOV     A,R0
   \   000012   FE           MOV     R6,A
   \   000013   E8           MOV     A,R0
   \   000014   C3           CLR     C
   \   000015   9402         SUBB    A,#0x2
   \   000017   4005         JC      ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_1
   1651            {
   1652              return ZFailure;
   \   000019   7901         MOV     R1,#0x1
   \   00001B   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2 & 0xFFFF
   1653            }
   1654          
   1655            if ((caPublicKey = osal_mem_alloc(ZCL_KE_CA_PUBLIC_KEY_LEN)) == NULL)
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_1:
   \   00001E                ; Setup parameters for call to function osal_mem_alloc
   \   00001E   7A16         MOV     R2,#0x16
   \   000020   7B00         MOV     R3,#0x0
   \   000022   12....       LCALL   ??osal_mem_alloc?relay
   \   000025   8A..         MOV     ?V0 + 4,R2
   \   000027   8B..         MOV     ?V0 + 5,R3
   \   000029   A8..         MOV     R0,?V0 + 4
   \   00002B   A9..         MOV     R1,?V0 + 5
   \   00002D   88..         MOV     ?V0 + 2,R0
   \   00002F   89..         MOV     ?V0 + 3,R1
   \   000031   E8           MOV     A,R0
   \   000032   49           ORL     A,R1
   \   000033   700A         JNZ     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_3
   1656            {
   1657              // Reset the entry from the rec table
   1658              zclGeneral_ResetKeyEstablishRec( index );
   \   000035                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000035   EE           MOV     A,R6
   \   000036   F9           MOV     R1,A
   \   000037   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1659          
   1660              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   00003A   79C1         MOV     R1,#-0x3f
   \   00003C   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2 & 0xFFFF
   1661            }
   1662            if ((devicePrivateKey = osal_mem_alloc(ZCL_KE_DEVICE_PRIVATE_KEY_LEN)) == NULL)
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_3:
   \   00003F                ; Setup parameters for call to function osal_mem_alloc
   \   00003F   7A15         MOV     R2,#0x15
   \   000041   7B00         MOV     R3,#0x0
   \   000043   12....       LCALL   ??osal_mem_alloc?relay
   \   000046   8A..         MOV     ?V0 + 4,R2
   \   000048   8B..         MOV     ?V0 + 5,R3
   \   00004A   A8..         MOV     R0,?V0 + 4
   \   00004C   A9..         MOV     R1,?V0 + 5
   \   00004E   88..         MOV     ?V0 + 8,R0
   \   000050   89..         MOV     ?V0 + 9,R1
   \   000052   E8           MOV     A,R0
   \   000053   49           ORL     A,R1
   \   000054   7011         JNZ     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_4
   1663            {
   1664              // Reset the entry from the rec table
   1665              zclGeneral_ResetKeyEstablishRec( index );
   \   000056                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000056   EE           MOV     A,R6
   \   000057   F9           MOV     R1,A
   \   000058   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1666          
   1667              osal_mem_free(caPublicKey);
   \   00005B                ; Setup parameters for call to function osal_mem_free
   \   00005B   AA..         MOV     R2,?V0 + 2
   \   00005D   AB..         MOV     R3,?V0 + 3
   \   00005F   12....       LCALL   ??osal_mem_free?relay
   1668              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   000062   79C1         MOV     R1,#-0x3f
   \   000064   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2 & 0xFFFF
   1669            }
   1670            osal_nv_read(ZCD_NV_CA_PUBLIC_KEY, 0, ZCL_KE_CA_PUBLIC_KEY_LEN, caPublicKey);
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_4:
   \   000067                ; Setup parameters for call to function osal_nv_read
   \   000067   78..         MOV     R0,#?V0 + 2
   \   000069   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00006C   75..16       MOV     ?V0 + 4,#0x16
   \   00006F   75..00       MOV     ?V0 + 5,#0x0
   \   000072   78..         MOV     R0,#?V0 + 4
   \   000074   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000077   7C00         MOV     R4,#0x0
   \   000079   7D00         MOV     R5,#0x0
   \   00007B   7A6B         MOV     R2,#0x6b
   \   00007D   7B00         MOV     R3,#0x0
   \   00007F   12....       LCALL   ??osal_nv_read?relay
   \   000082   7404         MOV     A,#0x4
   \   000084   12....       LCALL   ?DEALLOC_XSTACK8
   \   000087   E9           MOV     A,R1
   1671            osal_nv_read(ZCD_NV_DEVICE_PRIVATE_KEY, 0, ZCL_KE_DEVICE_PRIVATE_KEY_LEN, devicePrivateKey);
   \   000088                ; Setup parameters for call to function osal_nv_read
   \   000088   78..         MOV     R0,#?V0 + 8
   \   00008A   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008D   75..15       MOV     ?V0 + 4,#0x15
   \   000090   75..00       MOV     ?V0 + 5,#0x0
   \   000093   78..         MOV     R0,#?V0 + 4
   \   000095   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000098   7C00         MOV     R4,#0x0
   \   00009A   7D00         MOV     R5,#0x0
   \   00009C   7A6A         MOV     R2,#0x6a
   \   00009E   7B00         MOV     R3,#0x0
   \   0000A0   12....       LCALL   ??osal_nv_read?relay
   \   0000A3   7404         MOV     A,#0x4
   \   0000A5   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000A8   E9           MOV     A,R1
   1672          
   1673            ZMacGetReq( ZMacRxOnIdle, &currentRxState );  // Save current radio state
   \   0000A9                ; Setup parameters for call to function ZMacGetReq
   \   0000A9   85..82       MOV     DPL,?XSP + 0
   \   0000AC   85..83       MOV     DPH,?XSP + 1
   \   0000AF   AA82         MOV     R2,DPL
   \   0000B1   AB83         MOV     R3,DPH
   \   0000B3   7952         MOV     R1,#0x52
   \   0000B5   12....       LCALL   ??ZMacGetReq?relay
   \   0000B8   E9           MOV     A,R1
   1674            // Turn off the radio before the key bit generation, in order to avoid
   1675            // incoming messages accumulation by interrupts during the long process time.
   1676            tmp = FALSE;
   \   0000B9   7401         MOV     A,#0x1
   \   0000BB   12....       LCALL   ?XSTACK_DISP0_8
   \   0000BE   7400         MOV     A,#0x0
   \   0000C0   F0           MOVX    @DPTR,A
   1677            ZMacSetReq( ZMacRxOnIdle, &tmp );
   \   0000C1                ; Setup parameters for call to function ZMacSetReq
   \   0000C1   7401         MOV     A,#0x1
   \   0000C3   12....       LCALL   ?XSTACK_DISP0_8
   \   0000C6   AA82         MOV     R2,DPL
   \   0000C8   AB83         MOV     R3,DPH
   \   0000CA   7952         MOV     R1,#0x52
   \   0000CC   12....       LCALL   ??ZMacSetReq?relay
   \   0000CF   E9           MOV     A,R1
   1678          
   1679            // Generate the Key Bits
   1680            ret = ZSE_ECCKeyBitGenerate( devicePrivateKey, keyEstablishRec[index].pLocalEPrivateKey,
   1681                                       keyEstablishRec[index].pLocalEPublicKey,
   1682                                       keyEstablishRec[index].pRemoteCertificate,
   1683                                       keyEstablishRec[index].pRemotePublicKey,
   1684                                       caPublicKey, zData,
   1685                                       zclGeneral_KeyEstablishment_HashFunc,
   1686                                       zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel);
   \   0000D0                ; Setup parameters for call to function ZSE_ECCKeyBitGenerate
   \   0000D0   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   0000D3   E0           MOVX    A,@DPTR
   \   0000D4   F5..         MOV     ?V0 + 4,A
   \   0000D6   E4           CLR     A
   \   0000D7   F5..         MOV     ?V0 + 5,A
   \   0000D9   F5..         MOV     ?V0 + 6,A
   \   0000DB   F5..         MOV     ?V0 + 7,A
   \   0000DD   78..         MOV     R0,#?V0 + 4
   \   0000DF   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   0000E2   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   0000E5   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   0000E8   75....       MOV     ?V0 + 4,#??zclGeneral_KeyEstablishment_HashFunc?relay & 0xff
   \   0000EB   75....       MOV     ?V0 + 5,#(??zclGeneral_KeyEstablishment_HashFunc?relay >> 8) & 0xff
   \   0000EE   78..         MOV     R0,#?V0 + 4
   \   0000F0   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000F3   741A         MOV     A,#0x1a
   \   0000F5   12....       LCALL   ?XSTACK_DISP0_8
   \   0000F8   8582..       MOV     ?V0 + 4,DPL
   \   0000FB   8583..       MOV     ?V0 + 5,DPH
   \   0000FE   78..         MOV     R0,#?V0 + 4
   \   000100   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000103   78..         MOV     R0,#?V0 + 2
   \   000105   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000108   EE           MOV     A,R6
   \   000109   F8           MOV     R0,A
   \   00010A   7900         MOV     R1,#0x0
   \   00010C   E8           MOV     A,R0
   \   00010D   75F027       MOV     B,#0x27
   \   000110   A4           MUL     AB
   \   000111   C8           XCH     A,R0
   \   000112   AAF0         MOV     R2,B
   \   000114   75F000       MOV     B,#0x0
   \   000117   A4           MUL     AB
   \   000118   2A           ADD     A,R2
   \   000119   FA           MOV     R2,A
   \   00011A   75F027       MOV     B,#0x27
   \   00011D   E9           MOV     A,R1
   \   00011E   A4           MUL     AB
   \   00011F   2A           ADD     A,R2
   \   000120   F9           MOV     R1,A
   \   000121   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   000123   28           ADD     A,R0
   \   000124   F582         MOV     DPL,A
   \   000126   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   000128   39           ADDC    A,R1
   \   000129   F583         MOV     DPH,A
   \   00012B   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00012E   EE           MOV     A,R6
   \   00012F   F8           MOV     R0,A
   \   000130   7900         MOV     R1,#0x0
   \   000132   E8           MOV     A,R0
   \   000133   75F027       MOV     B,#0x27
   \   000136   A4           MUL     AB
   \   000137   C8           XCH     A,R0
   \   000138   AAF0         MOV     R2,B
   \   00013A   75F000       MOV     B,#0x0
   \   00013D   A4           MUL     AB
   \   00013E   2A           ADD     A,R2
   \   00013F   FA           MOV     R2,A
   \   000140   75F027       MOV     B,#0x27
   \   000143   E9           MOV     A,R1
   \   000144   A4           MUL     AB
   \   000145   2A           ADD     A,R2
   \   000146   F9           MOV     R1,A
   \   000147   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   000149   28           ADD     A,R0
   \   00014A   F582         MOV     DPL,A
   \   00014C   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   00014E   39           ADDC    A,R1
   \   00014F   F583         MOV     DPH,A
   \   000151   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000154   EE           MOV     A,R6
   \   000155   F8           MOV     R0,A
   \   000156   7900         MOV     R1,#0x0
   \   000158   E8           MOV     A,R0
   \   000159   75F027       MOV     B,#0x27
   \   00015C   A4           MUL     AB
   \   00015D   C8           XCH     A,R0
   \   00015E   AAF0         MOV     R2,B
   \   000160   75F000       MOV     B,#0x0
   \   000163   A4           MUL     AB
   \   000164   2A           ADD     A,R2
   \   000165   FA           MOV     R2,A
   \   000166   75F027       MOV     B,#0x27
   \   000169   E9           MOV     A,R1
   \   00016A   A4           MUL     AB
   \   00016B   2A           ADD     A,R2
   \   00016C   F9           MOV     R1,A
   \   00016D   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   00016F   28           ADD     A,R0
   \   000170   F582         MOV     DPL,A
   \   000172   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   000174   39           ADDC    A,R1
   \   000175   F583         MOV     DPH,A
   \   000177   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00017A   EE           MOV     A,R6
   \   00017B   F8           MOV     R0,A
   \   00017C   7900         MOV     R1,#0x0
   \   00017E   E8           MOV     A,R0
   \   00017F   75F027       MOV     B,#0x27
   \   000182   A4           MUL     AB
   \   000183   C8           XCH     A,R0
   \   000184   AAF0         MOV     R2,B
   \   000186   75F000       MOV     B,#0x0
   \   000189   A4           MUL     AB
   \   00018A   2A           ADD     A,R2
   \   00018B   FA           MOV     R2,A
   \   00018C   75F027       MOV     B,#0x27
   \   00018F   E9           MOV     A,R1
   \   000190   A4           MUL     AB
   \   000191   2A           ADD     A,R2
   \   000192   F9           MOV     R1,A
   \   000193   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   000195   28           ADD     A,R0
   \   000196   F582         MOV     DPL,A
   \   000198   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   00019A   39           ADDC    A,R1
   \   00019B   F583         MOV     DPH,A
   \   00019D   E0           MOVX    A,@DPTR
   \   00019E   FC           MOV     R4,A
   \   00019F   A3           INC     DPTR
   \   0001A0   E0           MOVX    A,@DPTR
   \   0001A1   FD           MOV     R5,A
   \   0001A2   AA..         MOV     R2,?V0 + 8
   \   0001A4   AB..         MOV     R3,?V0 + 9
   \   0001A6   12....       LCALL   ??ZSE_ECCKeyBitGenerate?relay
   \   0001A9   7412         MOV     A,#0x12
   \   0001AB   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001AE   EA           MOV     A,R2
   \   0001AF   FF           MOV     R7,A
   1687          
   1688            ZMacSetReq( ZMacRxOnIdle, &currentRxState );  // Resume saved radio state
   \   0001B0                ; Setup parameters for call to function ZMacSetReq
   \   0001B0   85..82       MOV     DPL,?XSP + 0
   \   0001B3   85..83       MOV     DPH,?XSP + 1
   \   0001B6   AA82         MOV     R2,DPL
   \   0001B8   AB83         MOV     R3,DPH
   \   0001BA   7952         MOV     R1,#0x52
   \   0001BC   12....       LCALL   ??ZMacSetReq?relay
   \   0001BF   E9           MOV     A,R1
   1689          
   1690            osal_mem_free(caPublicKey);
   \   0001C0                ; Setup parameters for call to function osal_mem_free
   \   0001C0   AA..         MOV     R2,?V0 + 2
   \   0001C2   AB..         MOV     R3,?V0 + 3
   \   0001C4   12....       LCALL   ??osal_mem_free?relay
   1691            osal_mem_free(devicePrivateKey);
   \   0001C7                ; Setup parameters for call to function osal_mem_free
   \   0001C7   AA..         MOV     R2,?V0 + 8
   \   0001C9   AB..         MOV     R3,?V0 + 9
   \   0001CB   12....       LCALL   ??osal_mem_free?relay
   1692          
   1693            if ( ret != MCE_SUCCESS )
   \   0001CE   EF           MOV     A,R7
   \   0001CF   6074         JZ      ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_5
   1694            {
   1695              // Key Bit generation failure. Send terminate key command
   1696               zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1697                                                                      &(keyEstablishRec[index].dstAddr),
   1698                                                                      TermKeyStatus_BadKeyConfirm,
   1699                                                                      KEY_ESTABLISHMENT_AVG_TIMEOUT,
   1700                                                                      KEY_ESTABLISHMENT_SUITE,
   1701                                                                      ZCL_FRAME_CLIENT_SERVER_DIR,
   1702                                                                      FALSE, zcl_SeqNum++ );
   \   0001D1   90....       MOV     DPTR,#zcl_SeqNum
   \   0001D4   E0           MOVX    A,@DPTR
   \   0001D5   F8           MOV     R0,A
   \   0001D6   7401         MOV     A,#0x1
   \   0001D8   28           ADD     A,R0
   \   0001D9   90....       MOV     DPTR,#zcl_SeqNum
   \   0001DC   F0           MOVX    @DPTR,A
   \   0001DD                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
   \   0001DD   E8           MOV     A,R0
   \   0001DE   F5..         MOV     ?V0 + 4,A
   \   0001E0   78..         MOV     R0,#?V0 + 4
   \   0001E2   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001E5   75..00       MOV     ?V0 + 4,#0x0
   \   0001E8   78..         MOV     R0,#?V0 + 4
   \   0001EA   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001ED   75..00       MOV     ?V0 + 4,#0x0
   \   0001F0   78..         MOV     R0,#?V0 + 4
   \   0001F2   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   0001F5   75..01       MOV     ?V0 + 4,#0x1
   \   0001F8   75..00       MOV     ?V0 + 5,#0x0
   \   0001FB   78..         MOV     R0,#?V0 + 4
   \   0001FD   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000200   7D1C         MOV     R5,#0x1c
   \   000202   7C02         MOV     R4,#0x2
   \   000204   EE           MOV     A,R6
   \   000205   F8           MOV     R0,A
   \   000206   7900         MOV     R1,#0x0
   \   000208   E8           MOV     A,R0
   \   000209   75F027       MOV     B,#0x27
   \   00020C   A4           MUL     AB
   \   00020D   C8           XCH     A,R0
   \   00020E   AAF0         MOV     R2,B
   \   000210   75F000       MOV     B,#0x0
   \   000213   A4           MUL     AB
   \   000214   2A           ADD     A,R2
   \   000215   FA           MOV     R2,A
   \   000216   75F027       MOV     B,#0x27
   \   000219   E9           MOV     A,R1
   \   00021A   A4           MUL     AB
   \   00021B   2A           ADD     A,R2
   \   00021C   F9           MOV     R1,A
   \   00021D   74..         MOV     A,#keyEstablishRec & 0xff
   \   00021F   28           ADD     A,R0
   \   000220   FA           MOV     R2,A
   \   000221   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   000223   39           ADDC    A,R1
   \   000224   FB           MOV     R3,A
   \   000225   790A         MOV     R1,#0xa
   \   000227   12....       LCALL   ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
   \   00022A   7405         MOV     A,#0x5
   \   00022C   12....       LCALL   ?DEALLOC_XSTACK8
   \   00022F   E9           MOV     A,R1
   1703               // Reset the entry from the rec table
   1704               zclGeneral_ResetKeyEstablishRec( index );
   \   000230                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000230   EE           MOV     A,R6
   \   000231   F9           MOV     R1,A
   \   000232   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1705          
   1706          #if defined (NWK_AUTO_POLL)
   1707              // Restore the saved poll rate for end device
   1708              NLME_SetPollRate(zclSavedPollRate);
   \   000235                ; Setup parameters for call to function NLME_SetPollRate
   \   000235   90....       MOV     DPTR,#zclSavedPollRate
   \   000238   E0           MOVX    A,@DPTR
   \   000239   FA           MOV     R2,A
   \   00023A   A3           INC     DPTR
   \   00023B   E0           MOVX    A,@DPTR
   \   00023C   FB           MOV     R3,A
   \   00023D   12....       LCALL   ??NLME_SetPollRate?relay
   1709          #endif
   1710          
   1711              return ZFailure;
   \   000240   7901         MOV     R1,#0x1
   \   000242   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2 & 0xFFFF
   1712            }
   1713            else
   1714            {
   1715              // Allocate buffer to store KDF(Z) = MacKey || KeyData
   1716              if ( (keyBit = osal_mem_alloc( KEY_ESTABLISH_KEY_DATA_LENGTH +
   1717                                           KEY_ESTABLISH_MAC_KEY_LENGTH)) == NULL )
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_5:
   \   000245                ; Setup parameters for call to function osal_mem_alloc
   \   000245   7A20         MOV     R2,#0x20
   \   000247   7B00         MOV     R3,#0x0
   \   000249   12....       LCALL   ??osal_mem_alloc?relay
   \   00024C   8A..         MOV     ?V0 + 4,R2
   \   00024E   8B..         MOV     ?V0 + 5,R3
   \   000250   A8..         MOV     R0,?V0 + 4
   \   000252   A9..         MOV     R1,?V0 + 5
   \   000254   88..         MOV     ?V0 + 0,R0
   \   000256   89..         MOV     ?V0 + 1,R1
   \   000258   E8           MOV     A,R0
   \   000259   49           ORL     A,R1
   \   00025A   700A         JNZ     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_6
   1718              {
   1719                // Reset the entry from the rec table
   1720                zclGeneral_ResetKeyEstablishRec( index );
   \   00025C                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00025C   EE           MOV     A,R6
   \   00025D   F9           MOV     R1,A
   \   00025E   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1721          
   1722                return  ZCL_STATUS_SOFTWARE_FAILURE; // Memory allocation failure
   \   000261   79C1         MOV     R1,#-0x3f
   \   000263   02....       LJMP    ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2 & 0xFFFF
   1723              }
   1724          
   1725              // Derive the keying data using KDF function
   1726              zclGeneral_KeyEstablishment_KeyDeriveFunction(zData,
   1727                                                            KEY_ESTABLISH_SHARED_SECRET_LENGTH,
   1728                                                            keyBit );
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_6:
   \   000266                ; Setup parameters for call to function zclGeneral_KeyEstablishment_KeyDeriveFunction
   \   000266   AC..         MOV     R4,?V0 + 0
   \   000268   AD..         MOV     R5,?V0 + 1
   \   00026A   7915         MOV     R1,#0x15
   \   00026C   7412         MOV     A,#0x12
   \   00026E   12....       LCALL   ?XSTACK_DISP0_8
   \   000271   AA82         MOV     R2,DPL
   \   000273   AB83         MOV     R3,DPH
   \   000275   12....       LCALL   ??zclGeneral_KeyEstablishment_KeyDeriveFunction
   1729          
   1730              // Save the derived 128-bit keyData
   1731              osal_memcpy( keyEstablishRec[index].pMacKey, keyBit, KEY_ESTABLISH_KEY_DATA_LENGTH);
   \   000278                ; Setup parameters for call to function osal_memcpy
   \   000278   85....       MOV     ?V0 + 4,?V0 + 0
   \   00027B   85....       MOV     ?V0 + 5,?V0 + 1
   \   00027E   75..00       MOV     ?V0 + 6,#0x0
   \   000281   78..         MOV     R0,#?V0 + 4
   \   000283   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000286   7C10         MOV     R4,#0x10
   \   000288   7D00         MOV     R5,#0x0
   \   00028A   EE           MOV     A,R6
   \   00028B   F8           MOV     R0,A
   \   00028C   7900         MOV     R1,#0x0
   \   00028E   E8           MOV     A,R0
   \   00028F   75F027       MOV     B,#0x27
   \   000292   A4           MUL     AB
   \   000293   C8           XCH     A,R0
   \   000294   AAF0         MOV     R2,B
   \   000296   75F000       MOV     B,#0x0
   \   000299   A4           MUL     AB
   \   00029A   2A           ADD     A,R2
   \   00029B   FA           MOV     R2,A
   \   00029C   75F027       MOV     B,#0x27
   \   00029F   E9           MOV     A,R1
   \   0002A0   A4           MUL     AB
   \   0002A1   2A           ADD     A,R2
   \   0002A2   F9           MOV     R1,A
   \   0002A3   74..         MOV     A,#(keyEstablishRec + 35) & 0xff
   \   0002A5   28           ADD     A,R0
   \   0002A6   F582         MOV     DPL,A
   \   0002A8   74..         MOV     A,#((keyEstablishRec + 35) >> 8) & 0xff
   \   0002AA   39           ADDC    A,R1
   \   0002AB   F583         MOV     DPH,A
   \   0002AD   E0           MOVX    A,@DPTR
   \   0002AE   FA           MOV     R2,A
   \   0002AF   A3           INC     DPTR
   \   0002B0   E0           MOVX    A,@DPTR
   \   0002B1   FB           MOV     R3,A
   \   0002B2   12....       LCALL   ??osal_memcpy?relay
   \   0002B5   7403         MOV     A,#0x3
   \   0002B7   12....       LCALL   ?DEALLOC_XSTACK8
   1732              osal_memcpy( keyEstablishRec[index].pKey, &(keyBit[KEY_ESTABLISH_MAC_KEY_LENGTH]),
   1733                           KEY_ESTABLISH_KEY_DATA_LENGTH);
   \   0002BA                ; Setup parameters for call to function osal_memcpy
   \   0002BA   E5..         MOV     A,?V0 + 0
   \   0002BC   2410         ADD     A,#0x10
   \   0002BE   F5..         MOV     ?V0 + 4,A
   \   0002C0   E5..         MOV     A,?V0 + 1
   \   0002C2   3400         ADDC    A,#0x0
   \   0002C4   F5..         MOV     ?V0 + 5,A
   \   0002C6   75..00       MOV     ?V0 + 6,#0x0
   \   0002C9   78..         MOV     R0,#?V0 + 4
   \   0002CB   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0002CE   7C10         MOV     R4,#0x10
   \   0002D0   7D00         MOV     R5,#0x0
   \   0002D2   EE           MOV     A,R6
   \   0002D3   F8           MOV     R0,A
   \   0002D4   7900         MOV     R1,#0x0
   \   0002D6   E8           MOV     A,R0
   \   0002D7   75F027       MOV     B,#0x27
   \   0002DA   A4           MUL     AB
   \   0002DB   C8           XCH     A,R0
   \   0002DC   AAF0         MOV     R2,B
   \   0002DE   75F000       MOV     B,#0x0
   \   0002E1   A4           MUL     AB
   \   0002E2   2A           ADD     A,R2
   \   0002E3   FA           MOV     R2,A
   \   0002E4   75F027       MOV     B,#0x27
   \   0002E7   E9           MOV     A,R1
   \   0002E8   A4           MUL     AB
   \   0002E9   2A           ADD     A,R2
   \   0002EA   F9           MOV     R1,A
   \   0002EB   74..         MOV     A,#(keyEstablishRec + 33) & 0xff
   \   0002ED   28           ADD     A,R0
   \   0002EE   F582         MOV     DPL,A
   \   0002F0   74..         MOV     A,#((keyEstablishRec + 33) >> 8) & 0xff
   \   0002F2   39           ADDC    A,R1
   \   0002F3   F583         MOV     DPH,A
   \   0002F5   E0           MOVX    A,@DPTR
   \   0002F6   FA           MOV     R2,A
   \   0002F7   A3           INC     DPTR
   \   0002F8   E0           MOVX    A,@DPTR
   \   0002F9   FB           MOV     R3,A
   \   0002FA   12....       LCALL   ??osal_memcpy?relay
   \   0002FD   7403         MOV     A,#0x3
   \   0002FF   12....       LCALL   ?DEALLOC_XSTACK8
   1734          
   1735              // Calculate MAC(U). Note that the keyBit is also pointing to the macKey
   1736              zclGeneral_KeyEstablishment_GenerateMAC( index, TRUE, MACu );
   \   000302                ; Setup parameters for call to function zclGeneral_KeyEstablishment_GenerateMAC
   \   000302   7402         MOV     A,#0x2
   \   000304   12....       LCALL   ?XSTACK_DISP0_8
   \   000307   AC82         MOV     R4,DPL
   \   000309   AD83         MOV     R5,DPH
   \   00030B   7A01         MOV     R2,#0x1
   \   00030D   EE           MOV     A,R6
   \   00030E   F9           MOV     R1,A
   \   00030F   12....       LCALL   ??zclGeneral_KeyEstablishment_GenerateMAC?relay
   \   000312   E9           MOV     A,R1
   1737              osal_mem_free( keyBit );
   \   000313                ; Setup parameters for call to function osal_mem_free
   \   000313   AA..         MOV     R2,?V0 + 0
   \   000315   AB..         MOV     R3,?V0 + 1
   \   000317   12....       LCALL   ??osal_mem_free?relay
   1738          
   1739              // Send MAC(U) to the Partner
   1740              zclGeneral_KeyEstablish_Send_ConfirmKey( ZCL_KEY_ESTABLISHMENT_ENDPOINT,
   1741                                                       &(keyEstablishRec[index].dstAddr),
   1742                                                       MACu,
   1743                                                       FALSE, zcl_SeqNum++ );
   \   00031A   90....       MOV     DPTR,#zcl_SeqNum
   \   00031D   E0           MOVX    A,@DPTR
   \   00031E   F8           MOV     R0,A
   \   00031F   7401         MOV     A,#0x1
   \   000321   28           ADD     A,R0
   \   000322   90....       MOV     DPTR,#zcl_SeqNum
   \   000325   F0           MOVX    @DPTR,A
   \   000326                ; Setup parameters for call to function zclGeneral_KeyEstablish_Send_ConfirmKey
   \   000326   E8           MOV     A,R0
   \   000327   F5..         MOV     ?V0 + 4,A
   \   000329   78..         MOV     R0,#?V0 + 4
   \   00032B   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   00032E   75..00       MOV     ?V0 + 4,#0x0
   \   000331   78..         MOV     R0,#?V0 + 4
   \   000333   12....       LCALL   ?PUSH_XSTACK_I_ONE
   \   000336   7404         MOV     A,#0x4
   \   000338   12....       LCALL   ?XSTACK_DISP0_8
   \   00033B   AC82         MOV     R4,DPL
   \   00033D   AD83         MOV     R5,DPH
   \   00033F   EE           MOV     A,R6
   \   000340   F8           MOV     R0,A
   \   000341   7900         MOV     R1,#0x0
   \   000343   E8           MOV     A,R0
   \   000344   75F027       MOV     B,#0x27
   \   000347   A4           MUL     AB
   \   000348   C8           XCH     A,R0
   \   000349   AAF0         MOV     R2,B
   \   00034B   75F000       MOV     B,#0x0
   \   00034E   A4           MUL     AB
   \   00034F   2A           ADD     A,R2
   \   000350   FA           MOV     R2,A
   \   000351   75F027       MOV     B,#0x27
   \   000354   E9           MOV     A,R1
   \   000355   A4           MUL     AB
   \   000356   2A           ADD     A,R2
   \   000357   F9           MOV     R1,A
   \   000358   74..         MOV     A,#keyEstablishRec & 0xff
   \   00035A   28           ADD     A,R0
   \   00035B   FA           MOV     R2,A
   \   00035C   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   00035E   39           ADDC    A,R1
   \   00035F   FB           MOV     R3,A
   \   000360   790A         MOV     R1,#0xa
   \   000362   12....       LCALL   ??zclGeneral_KeyEstablish_Send_ConfirmKey?relay
   \   000365   7402         MOV     A,#0x2
   \   000367   12....       LCALL   ?DEALLOC_XSTACK8
   \   00036A   E9           MOV     A,R1
   1744          
   1745              // The Request was processed successfuly, now the age timer needs to start based on the
   1746              // remote Config Key Generate
   1747              keyEstablishRec[index].age = keyEstablishRec[index].remoteConfKeyGenTime;
   \   00036B   EE           MOV     A,R6
   \   00036C   F8           MOV     R0,A
   \   00036D   7900         MOV     R1,#0x0
   \   00036F   E8           MOV     A,R0
   \   000370   75F027       MOV     B,#0x27
   \   000373   A4           MUL     AB
   \   000374   C8           XCH     A,R0
   \   000375   AAF0         MOV     R2,B
   \   000377   75F000       MOV     B,#0x0
   \   00037A   A4           MUL     AB
   \   00037B   2A           ADD     A,R2
   \   00037C   FA           MOV     R2,A
   \   00037D   75F027       MOV     B,#0x27
   \   000380   E9           MOV     A,R1
   \   000381   A4           MUL     AB
   \   000382   2A           ADD     A,R2
   \   000383   F9           MOV     R1,A
   \   000384   74..         MOV     A,#(keyEstablishRec + 38) & 0xff
   \   000386   28           ADD     A,R0
   \   000387   F582         MOV     DPL,A
   \   000389   74..         MOV     A,#((keyEstablishRec + 38) >> 8) & 0xff
   \   00038B   39           ADDC    A,R1
   \   00038C   F583         MOV     DPH,A
   \   00038E   E0           MOVX    A,@DPTR
   \   00038F   C0E0         PUSH    A
   \   000391   EE           MOV     A,R6
   \   000392   F8           MOV     R0,A
   \   000393   7900         MOV     R1,#0x0
   \   000395   E8           MOV     A,R0
   \   000396   75F027       MOV     B,#0x27
   \   000399   A4           MUL     AB
   \   00039A   C8           XCH     A,R0
   \   00039B   AAF0         MOV     R2,B
   \   00039D   75F000       MOV     B,#0x0
   \   0003A0   A4           MUL     AB
   \   0003A1   2A           ADD     A,R2
   \   0003A2   FA           MOV     R2,A
   \   0003A3   75F027       MOV     B,#0x27
   \   0003A6   E9           MOV     A,R1
   \   0003A7   A4           MUL     AB
   \   0003A8   2A           ADD     A,R2
   \   0003A9   F9           MOV     R1,A
   \   0003AA   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   0003AC   28           ADD     A,R0
   \   0003AD   F582         MOV     DPL,A
   \   0003AF   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   0003B1   39           ADDC    A,R1
   \   0003B2   F583         MOV     DPH,A
   \   0003B4   D0E0         POP     A
   \   0003B6   F0           MOVX    @DPTR,A
   1748          
   1749              // Start the Config Key Generate aging timer
   1750              osal_start_reload_timer( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT,
   1751                                       KEY_ESTABLISHMENT_REC_AGING_INTERVAL );
   \   0003B7                ; Setup parameters for call to function osal_start_reload_timer
   \   0003B7   7CE8         MOV     R4,#-0x18
   \   0003B9   7D03         MOV     R5,#0x3
   \   0003BB   7A01         MOV     R2,#0x1
   \   0003BD   7B00         MOV     R3,#0x0
   \   0003BF   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   0003C2   E0           MOVX    A,@DPTR
   \   0003C3   F9           MOV     R1,A
   \   0003C4   12....       LCALL   ??osal_start_reload_timer?relay
   \   0003C7   E9           MOV     A,R1
   1752          
   1753              keyEstablishRec[index].state = KeyEstablishState_ConfirmPending;
   \   0003C8   EE           MOV     A,R6
   \   0003C9   F8           MOV     R0,A
   \   0003CA   7900         MOV     R1,#0x0
   \   0003CC   E8           MOV     A,R0
   \   0003CD   75F027       MOV     B,#0x27
   \   0003D0   A4           MUL     AB
   \   0003D1   C8           XCH     A,R0
   \   0003D2   AAF0         MOV     R2,B
   \   0003D4   75F000       MOV     B,#0x0
   \   0003D7   A4           MUL     AB
   \   0003D8   2A           ADD     A,R2
   \   0003D9   FA           MOV     R2,A
   \   0003DA   75F027       MOV     B,#0x27
   \   0003DD   E9           MOV     A,R1
   \   0003DE   A4           MUL     AB
   \   0003DF   2A           ADD     A,R2
   \   0003E0   F9           MOV     R1,A
   \   0003E1   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   0003E3   28           ADD     A,R0
   \   0003E4   F582         MOV     DPL,A
   \   0003E6   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   0003E8   39           ADDC    A,R1
   \   0003E9   F583         MOV     DPH,A
   \   0003EB   7404         MOV     A,#0x4
   \   0003ED   F0           MOVX    @DPTR,A
   1754          
   1755              return ZSuccess;
   \   0003EE   7900         MOV     R1,#0x0
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate_2:
   \   0003F0   7427         MOV     A,#0x27
   \   0003F2   12....       LCALL   ?DEALLOC_XSTACK8
   \   0003F5   7F0A         MOV     R7,#0xa
   \   0003F7   02....       LJMP    ?BANKED_LEAVE_XDATA
   1756            }
   1757          }
   1758          
   1759          /*********************************************************************
   1760           * @fn      zclGeneral_InitKeyEstablishRecTable
   1761           *
   1762           * @brief   Initializae key establishment record table entries.
   1763           *
   1764           * @param   none
   1765           *
   1766           * @return  none
   1767           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1768          static void zclGeneral_InitKeyEstablishRecTable( void )
   \                     zclGeneral_InitKeyEstablishRecTable:
   1769          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   1770            uint8 i;
   1771          
   1772            for ( i = 0; i < MAX_KEY_ESTABLISHMENT_REC_ENTRY; i++ )
   \   000005   7E00         MOV     R6,#0x0
   \                     ??zclGeneral_InitKeyEstablishRecTable_0:
   \   000007   EE           MOV     A,R6
   \   000008   C3           CLR     C
   \   000009   9402         SUBB    A,#0x2
   \   00000B   5008         JNC     ??zclGeneral_InitKeyEstablishRecTable_1
   1773            {
   1774              zclGeneral_ResetKeyEstablishRec(i);
   \   00000D                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00000D   EE           MOV     A,R6
   \   00000E   F9           MOV     R1,A
   \   00000F   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1775            }
   \   000012   0E           INC     R6
   \   000013   80F2         SJMP    ??zclGeneral_InitKeyEstablishRecTable_0
   1776          }
   \                     ??zclGeneral_InitKeyEstablishRecTable_1:
   \   000015   7F01         MOV     R7,#0x1
   \   000017   02....       LJMP    ?BANKED_LEAVE_XDATA
   1777          
   1778          /*********************************************************************
   1779           * @fn      zclGeneral_GetKeyEstablishRecIndex
   1780           *
   1781           * @brief   Get the index of a particular key establishment record.
   1782           *          If the input is INVALID_PARTNER_ADDR, return an empty slot.
   1783           *
   1784           * @param   partnerAddress - address of the partner that the local device
   1785           *                           is establishing key with.
   1786           *
   1787           * @return   index of the record
   1788           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1789          static uint8 zclGeneral_GetKeyEstablishRecIndex( uint16 partnerAddress )
   \                     zclGeneral_GetKeyEstablishRecIndex:
   1790          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   1791            uint8 i;
   1792          
   1793            // Find an existing entry or vacant entry, depends on what DstAddress is
   1794            for ( i = 0; i < MAX_KEY_ESTABLISHMENT_REC_ENTRY ; i++ )
   \   000004   7900         MOV     R1,#0x0
   \                     ??zclGeneral_GetKeyEstablishRecIndex_0:
   \   000006   E9           MOV     A,R1
   \   000007   C3           CLR     C
   \   000008   9402         SUBB    A,#0x2
   \   00000A   502F         JNC     ??zclGeneral_GetKeyEstablishRecIndex_1
   1795            {
   1796              if ( keyEstablishRec[i].dstAddr.addr.shortAddr == partnerAddress )
   \   00000C   E9           MOV     A,R1
   \   00000D   FC           MOV     R4,A
   \   00000E   7D00         MOV     R5,#0x0
   \   000010   EC           MOV     A,R4
   \   000011   75F027       MOV     B,#0x27
   \   000014   A4           MUL     AB
   \   000015   CC           XCH     A,R4
   \   000016   A8F0         MOV     R0,B
   \   000018   75F000       MOV     B,#0x0
   \   00001B   A4           MUL     AB
   \   00001C   28           ADD     A,R0
   \   00001D   F8           MOV     R0,A
   \   00001E   75F027       MOV     B,#0x27
   \   000021   ED           MOV     A,R5
   \   000022   A4           MUL     AB
   \   000023   28           ADD     A,R0
   \   000024   FD           MOV     R5,A
   \   000025   74..         MOV     A,#keyEstablishRec & 0xff
   \   000027   2C           ADD     A,R4
   \   000028   F582         MOV     DPL,A
   \   00002A   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   00002C   3D           ADDC    A,R5
   \   00002D   F583         MOV     DPH,A
   \   00002F   E0           MOVX    A,@DPTR
   \   000030   6A           XRL     A,R2
   \   000031   7003         JNZ     ??zclGeneral_GetKeyEstablishRecIndex_2
   \   000033   A3           INC     DPTR
   \   000034   E0           MOVX    A,@DPTR
   \   000035   6B           XRL     A,R3
   \                     ??zclGeneral_GetKeyEstablishRecIndex_2:
   \   000036   6003         JZ      ??zclGeneral_GetKeyEstablishRecIndex_1
   1797              {
   1798                // entry found
   1799                break;
   1800              }
   1801            }
   \   000038   09           INC     R1
   \   000039   80CB         SJMP    ??zclGeneral_GetKeyEstablishRecIndex_0
   1802          
   1803            return i;
   \                     ??zclGeneral_GetKeyEstablishRecIndex_1:
   \   00003B   D083         POP     DPH
   \   00003D   D082         POP     DPL
   \   00003F   02....       LJMP    ?BRET
   1804          }
   1805          
   1806          /*********************************************************************
   1807           * @fn      zclGeneral_GetKeyEstablishRecIndex
   1808           *
   1809           * @brief   Get the index of a particular key establishment record.
   1810           *          If the input is INVALID_PARTNER_ADDR, return an empty slot.
   1811           *
   1812           * @param   state - state to find.
   1813           *
   1814           * @return   index of the record
   1815           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1816          static uint8 zclGeneral_GetKeyEstablishRecIndex_State( KeyEstablishState_t state )
   \                     zclGeneral_GetKeyEstablishRecIndex_State:
   1817          {
   \   000000   C082         PUSH    DPL
   \   000002   C083         PUSH    DPH
   \   000004                ; Saved register size: 2
   \   000004                ; Auto size: 0
   \   000004   E9           MOV     A,R1
   \   000005   FC           MOV     R4,A
   1818            uint8 i;
   1819          
   1820            // Find an existing entry or vacant entry, depends on what DstAddress is
   1821            for ( i = 0; i < MAX_KEY_ESTABLISHMENT_REC_ENTRY ; i++ )
   \   000006   7900         MOV     R1,#0x0
   \                     ??zclGeneral_GetKeyEstablishRecIndex_State_0:
   \   000008   E9           MOV     A,R1
   \   000009   C3           CLR     C
   \   00000A   9402         SUBB    A,#0x2
   \   00000C   502A         JNC     ??zclGeneral_GetKeyEstablishRecIndex_State_1
   1822            {
   1823              if ( keyEstablishRec[i].state == state )
   \   00000E   E9           MOV     A,R1
   \   00000F   FA           MOV     R2,A
   \   000010   7B00         MOV     R3,#0x0
   \   000012   EA           MOV     A,R2
   \   000013   75F027       MOV     B,#0x27
   \   000016   A4           MUL     AB
   \   000017   CA           XCH     A,R2
   \   000018   A8F0         MOV     R0,B
   \   00001A   75F000       MOV     B,#0x0
   \   00001D   A4           MUL     AB
   \   00001E   28           ADD     A,R0
   \   00001F   F8           MOV     R0,A
   \   000020   75F027       MOV     B,#0x27
   \   000023   EB           MOV     A,R3
   \   000024   A4           MUL     AB
   \   000025   28           ADD     A,R0
   \   000026   FB           MOV     R3,A
   \   000027   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   000029   2A           ADD     A,R2
   \   00002A   F582         MOV     DPL,A
   \   00002C   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   00002E   3B           ADDC    A,R3
   \   00002F   F583         MOV     DPH,A
   \   000031   E0           MOVX    A,@DPTR
   \   000032   6C           XRL     A,R4
   \   000033   6003         JZ      ??zclGeneral_GetKeyEstablishRecIndex_State_1
   1824              {
   1825                // entry found
   1826                break;
   1827              }
   1828            }
   \   000035   09           INC     R1
   \   000036   80D0         SJMP    ??zclGeneral_GetKeyEstablishRecIndex_State_0
   1829          
   1830            return i;
   \                     ??zclGeneral_GetKeyEstablishRecIndex_State_1:
   \   000038   D083         POP     DPH
   \   00003A   D082         POP     DPL
   \   00003C   02....       LJMP    ?BRET
   1831          }
   1832          
   1833          /*********************************************************************
   1834           * @fn      zclGeneral_AddKeyEstablishRec
   1835           *
   1836           * @brief   Add a new key establishment record. If one already exist,
   1837           *          remove the existng entry. After initialization, fill in
   1838           *          partner short address and extended address. If partner extended
   1839           *          address not available, return failure.
   1840           *
   1841           * @param   addr - address of the partner
   1842           *
   1843           * @return  index - 0..(MAX_KEY_ESTABLISHMENT_REC_ENTRY-1) @ success
   1844           *                - MAX_KEY_ESTABLISHMENT_REC_ENTRY @ failure due to rec table full or
   1845           *                  partner IEEE address not available or failure to allocate key buffers.
   1846           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1847          static uint8 zclGeneral_AddKeyEstablishRec( afAddrType_t *addr )
   \                     zclGeneral_AddKeyEstablishRec:
   1848          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   1849            uint8 index, *pBuf;
   1850          
   1851            // Search for all current key establishment record
   1852            // If not found, create a new entry
   1853            if ( ( index = zclGeneral_GetKeyEstablishRecIndex(addr->addr.shortAddr) )
   1854                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \   000009                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000009   85..82       MOV     DPL,?V0 + 0
   \   00000C   85..83       MOV     DPH,?V0 + 1
   \   00000F   E0           MOVX    A,@DPTR
   \   000010   FA           MOV     R2,A
   \   000011   A3           INC     DPTR
   \   000012   E0           MOVX    A,@DPTR
   \   000013   FB           MOV     R3,A
   \   000014   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   000017   E9           MOV     A,R1
   \   000018   F8           MOV     R0,A
   \   000019   88..         MOV     ?V0 + 2,R0
   \   00001B   E8           MOV     A,R0
   \   00001C   C3           CLR     C
   \   00001D   9402         SUBB    A,#0x2
   \   00001F   5005         JNC     ??zclGeneral_AddKeyEstablishRec_0
   1855            {
   1856              // expire the existing entry for this address
   1857              zclGeneral_ResetKeyEstablishRec( index );
   \   000021                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   000021   A9..         MOV     R1,?V0 + 2
   \   000023   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   1858            }
   1859          
   1860            // Create a new Entry
   1861            if ( (index = zclGeneral_GetKeyEstablishRecIndex(INVALID_PARTNER_ADDR))
   1862                < MAX_KEY_ESTABLISHMENT_REC_ENTRY )
   \                     ??zclGeneral_AddKeyEstablishRec_0:
   \   000026                ; Setup parameters for call to function zclGeneral_GetKeyEstablishRecIndex
   \   000026   7AFE         MOV     R2,#-0x2
   \   000028   7BFF         MOV     R3,#-0x1
   \   00002A   12....       LCALL   ??zclGeneral_GetKeyEstablishRecIndex?relay
   \   00002D   E9           MOV     A,R1
   \   00002E   F8           MOV     R0,A
   \   00002F   88..         MOV     ?V0 + 2,R0
   \   000031   E8           MOV     A,R0
   \   000032   C3           CLR     C
   \   000033   9402         SUBB    A,#0x2
   \   000035   4003         JC      $+5
   \   000037   02....       LJMP    ??zclGeneral_AddKeyEstablishRec_1 & 0xFFFF
   1863            {
   1864              // Allocate memory for the rest of the fields
   1865              if ( (pBuf = osal_mem_alloc( ZCL_KE_DEVICE_PRIVATE_KEY_LEN +
   1866                                           ZCL_KE_CA_PUBLIC_KEY_LEN +
   1867                                           ZCL_KE_CA_PUBLIC_KEY_LEN +
   1868                                           ZCL_KE_IMPLICIT_CERTIFICATE_LEN +
   1869                                           KEY_ESTABLISH_KEY_DATA_LENGTH +
   1870                                           KEY_ESTABLISH_MAC_KEY_LENGTH )) != NULL )
   \   00003A                ; Setup parameters for call to function osal_mem_alloc
   \   00003A   7A91         MOV     R2,#-0x6f
   \   00003C   7B00         MOV     R3,#0x0
   \   00003E   12....       LCALL   ??osal_mem_alloc?relay
   \   000041   8A..         MOV     ?V0 + 4,R2
   \   000043   8B..         MOV     ?V0 + 5,R3
   \   000045   A8..         MOV     R0,?V0 + 4
   \   000047   A9..         MOV     R1,?V0 + 5
   \   000049   E8           MOV     A,R0
   \   00004A   FE           MOV     R6,A
   \   00004B   E9           MOV     A,R1
   \   00004C   FF           MOV     R7,A
   \   00004D   E8           MOV     A,R0
   \   00004E   49           ORL     A,R1
   \   00004F   7003         JNZ     $+5
   \   000051   02....       LJMP    ??zclGeneral_AddKeyEstablishRec_2 & 0xFFFF
   1871              {
   1872                keyEstablishRec[index].pLocalEPrivateKey =  pBuf;
   \   000054   E5..         MOV     A,?V0 + 2
   \   000056   A8..         MOV     R0,?V0 + 2
   \   000058   7900         MOV     R1,#0x0
   \   00005A   E8           MOV     A,R0
   \   00005B   75F027       MOV     B,#0x27
   \   00005E   A4           MUL     AB
   \   00005F   C8           XCH     A,R0
   \   000060   AAF0         MOV     R2,B
   \   000062   75F000       MOV     B,#0x0
   \   000065   A4           MUL     AB
   \   000066   2A           ADD     A,R2
   \   000067   FA           MOV     R2,A
   \   000068   75F027       MOV     B,#0x27
   \   00006B   E9           MOV     A,R1
   \   00006C   A4           MUL     AB
   \   00006D   2A           ADD     A,R2
   \   00006E   F9           MOV     R1,A
   \   00006F   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   000071   28           ADD     A,R0
   \   000072   F582         MOV     DPL,A
   \   000074   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   000076   39           ADDC    A,R1
   \   000077   F583         MOV     DPH,A
   \   000079   EE           MOV     A,R6
   \   00007A   F0           MOVX    @DPTR,A
   \   00007B   A3           INC     DPTR
   \   00007C   EF           MOV     A,R7
   \   00007D   F0           MOVX    @DPTR,A
   1873                                                            pBuf += ZCL_KE_DEVICE_PRIVATE_KEY_LEN;
   \   00007E   EE           MOV     A,R6
   \   00007F   2415         ADD     A,#0x15
   \   000081   FE           MOV     R6,A
   \   000082   EF           MOV     A,R7
   \   000083   3400         ADDC    A,#0x0
   \   000085   FF           MOV     R7,A
   1874                keyEstablishRec[index].pLocalEPublicKey =   pBuf;
   \   000086   E5..         MOV     A,?V0 + 2
   \   000088   A8..         MOV     R0,?V0 + 2
   \   00008A   7900         MOV     R1,#0x0
   \   00008C   E8           MOV     A,R0
   \   00008D   75F027       MOV     B,#0x27
   \   000090   A4           MUL     AB
   \   000091   C8           XCH     A,R0
   \   000092   AAF0         MOV     R2,B
   \   000094   75F000       MOV     B,#0x0
   \   000097   A4           MUL     AB
   \   000098   2A           ADD     A,R2
   \   000099   FA           MOV     R2,A
   \   00009A   75F027       MOV     B,#0x27
   \   00009D   E9           MOV     A,R1
   \   00009E   A4           MUL     AB
   \   00009F   2A           ADD     A,R2
   \   0000A0   F9           MOV     R1,A
   \   0000A1   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   0000A3   28           ADD     A,R0
   \   0000A4   F582         MOV     DPL,A
   \   0000A6   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   0000A8   39           ADDC    A,R1
   \   0000A9   F583         MOV     DPH,A
   \   0000AB   EE           MOV     A,R6
   \   0000AC   F0           MOVX    @DPTR,A
   \   0000AD   A3           INC     DPTR
   \   0000AE   EF           MOV     A,R7
   \   0000AF   F0           MOVX    @DPTR,A
   1875                                                            pBuf += ZCL_KE_CA_PUBLIC_KEY_LEN;
   \   0000B0   EE           MOV     A,R6
   \   0000B1   2416         ADD     A,#0x16
   \   0000B3   FE           MOV     R6,A
   \   0000B4   EF           MOV     A,R7
   \   0000B5   3400         ADDC    A,#0x0
   \   0000B7   FF           MOV     R7,A
   1876                keyEstablishRec[index].pRemotePublicKey =   pBuf;
   \   0000B8   E5..         MOV     A,?V0 + 2
   \   0000BA   A8..         MOV     R0,?V0 + 2
   \   0000BC   7900         MOV     R1,#0x0
   \   0000BE   E8           MOV     A,R0
   \   0000BF   75F027       MOV     B,#0x27
   \   0000C2   A4           MUL     AB
   \   0000C3   C8           XCH     A,R0
   \   0000C4   AAF0         MOV     R2,B
   \   0000C6   75F000       MOV     B,#0x0
   \   0000C9   A4           MUL     AB
   \   0000CA   2A           ADD     A,R2
   \   0000CB   FA           MOV     R2,A
   \   0000CC   75F027       MOV     B,#0x27
   \   0000CF   E9           MOV     A,R1
   \   0000D0   A4           MUL     AB
   \   0000D1   2A           ADD     A,R2
   \   0000D2   F9           MOV     R1,A
   \   0000D3   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   0000D5   28           ADD     A,R0
   \   0000D6   F582         MOV     DPL,A
   \   0000D8   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   0000DA   39           ADDC    A,R1
   \   0000DB   F583         MOV     DPH,A
   \   0000DD   EE           MOV     A,R6
   \   0000DE   F0           MOVX    @DPTR,A
   \   0000DF   A3           INC     DPTR
   \   0000E0   EF           MOV     A,R7
   \   0000E1   F0           MOVX    @DPTR,A
   1877                                                            pBuf += ZCL_KE_CA_PUBLIC_KEY_LEN;
   \   0000E2   EE           MOV     A,R6
   \   0000E3   2416         ADD     A,#0x16
   \   0000E5   FE           MOV     R6,A
   \   0000E6   EF           MOV     A,R7
   \   0000E7   3400         ADDC    A,#0x0
   \   0000E9   FF           MOV     R7,A
   1878                keyEstablishRec[index].pRemoteCertificate = pBuf;
   \   0000EA   E5..         MOV     A,?V0 + 2
   \   0000EC   A8..         MOV     R0,?V0 + 2
   \   0000EE   7900         MOV     R1,#0x0
   \   0000F0   E8           MOV     A,R0
   \   0000F1   75F027       MOV     B,#0x27
   \   0000F4   A4           MUL     AB
   \   0000F5   C8           XCH     A,R0
   \   0000F6   AAF0         MOV     R2,B
   \   0000F8   75F000       MOV     B,#0x0
   \   0000FB   A4           MUL     AB
   \   0000FC   2A           ADD     A,R2
   \   0000FD   FA           MOV     R2,A
   \   0000FE   75F027       MOV     B,#0x27
   \   000101   E9           MOV     A,R1
   \   000102   A4           MUL     AB
   \   000103   2A           ADD     A,R2
   \   000104   F9           MOV     R1,A
   \   000105   74..         MOV     A,#(keyEstablishRec + 31) & 0xff
   \   000107   28           ADD     A,R0
   \   000108   F582         MOV     DPL,A
   \   00010A   74..         MOV     A,#((keyEstablishRec + 31) >> 8) & 0xff
   \   00010C   39           ADDC    A,R1
   \   00010D   F583         MOV     DPH,A
   \   00010F   EE           MOV     A,R6
   \   000110   F0           MOVX    @DPTR,A
   \   000111   A3           INC     DPTR
   \   000112   EF           MOV     A,R7
   \   000113   F0           MOVX    @DPTR,A
   1879                                                            pBuf += ZCL_KE_IMPLICIT_CERTIFICATE_LEN;
   \   000114   EE           MOV     A,R6
   \   000115   2430         ADD     A,#0x30
   \   000117   FE           MOV     R6,A
   \   000118   EF           MOV     A,R7
   \   000119   3400         ADDC    A,#0x0
   \   00011B   FF           MOV     R7,A
   1880                keyEstablishRec[index].pKey =               pBuf;
   \   00011C   E5..         MOV     A,?V0 + 2
   \   00011E   A8..         MOV     R0,?V0 + 2
   \   000120   7900         MOV     R1,#0x0
   \   000122   E8           MOV     A,R0
   \   000123   75F027       MOV     B,#0x27
   \   000126   A4           MUL     AB
   \   000127   C8           XCH     A,R0
   \   000128   AAF0         MOV     R2,B
   \   00012A   75F000       MOV     B,#0x0
   \   00012D   A4           MUL     AB
   \   00012E   2A           ADD     A,R2
   \   00012F   FA           MOV     R2,A
   \   000130   75F027       MOV     B,#0x27
   \   000133   E9           MOV     A,R1
   \   000134   A4           MUL     AB
   \   000135   2A           ADD     A,R2
   \   000136   F9           MOV     R1,A
   \   000137   74..         MOV     A,#(keyEstablishRec + 33) & 0xff
   \   000139   28           ADD     A,R0
   \   00013A   F582         MOV     DPL,A
   \   00013C   74..         MOV     A,#((keyEstablishRec + 33) >> 8) & 0xff
   \   00013E   39           ADDC    A,R1
   \   00013F   F583         MOV     DPH,A
   \   000141   EE           MOV     A,R6
   \   000142   F0           MOVX    @DPTR,A
   \   000143   A3           INC     DPTR
   \   000144   EF           MOV     A,R7
   \   000145   F0           MOVX    @DPTR,A
   1881                                                            pBuf += KEY_ESTABLISH_KEY_DATA_LENGTH;
   \   000146   EE           MOV     A,R6
   \   000147   2410         ADD     A,#0x10
   \   000149   FE           MOV     R6,A
   \   00014A   EF           MOV     A,R7
   \   00014B   3400         ADDC    A,#0x0
   \   00014D   FF           MOV     R7,A
   1882                keyEstablishRec[index].pMacKey =            pBuf;
   \   00014E   E5..         MOV     A,?V0 + 2
   \   000150   A8..         MOV     R0,?V0 + 2
   \   000152   7900         MOV     R1,#0x0
   \   000154   E8           MOV     A,R0
   \   000155   75F027       MOV     B,#0x27
   \   000158   A4           MUL     AB
   \   000159   C8           XCH     A,R0
   \   00015A   AAF0         MOV     R2,B
   \   00015C   75F000       MOV     B,#0x0
   \   00015F   A4           MUL     AB
   \   000160   2A           ADD     A,R2
   \   000161   FA           MOV     R2,A
   \   000162   75F027       MOV     B,#0x27
   \   000165   E9           MOV     A,R1
   \   000166   A4           MUL     AB
   \   000167   2A           ADD     A,R2
   \   000168   F9           MOV     R1,A
   \   000169   74..         MOV     A,#(keyEstablishRec + 35) & 0xff
   \   00016B   28           ADD     A,R0
   \   00016C   F582         MOV     DPL,A
   \   00016E   74..         MOV     A,#((keyEstablishRec + 35) >> 8) & 0xff
   \   000170   39           ADDC    A,R1
   \   000171   F583         MOV     DPH,A
   \   000173   EE           MOV     A,R6
   \   000174   F0           MOVX    @DPTR,A
   \   000175   A3           INC     DPTR
   \   000176   EF           MOV     A,R7
   \   000177   F0           MOVX    @DPTR,A
   1883          
   1884                (void)osal_memcpy(&keyEstablishRec[index].dstAddr, addr, sizeof(afAddrType_t));
   \   000178                ; Setup parameters for call to function osal_memcpy
   \   000178   85....       MOV     ?V0 + 4,?V0 + 0
   \   00017B   85....       MOV     ?V0 + 5,?V0 + 1
   \   00017E   75..00       MOV     ?V0 + 6,#0x0
   \   000181   78..         MOV     R0,#?V0 + 4
   \   000183   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000186   7C0C         MOV     R4,#0xc
   \   000188   7D00         MOV     R5,#0x0
   \   00018A   E5..         MOV     A,?V0 + 2
   \   00018C   A8..         MOV     R0,?V0 + 2
   \   00018E   7900         MOV     R1,#0x0
   \   000190   E8           MOV     A,R0
   \   000191   75F027       MOV     B,#0x27
   \   000194   A4           MUL     AB
   \   000195   C8           XCH     A,R0
   \   000196   AAF0         MOV     R2,B
   \   000198   75F000       MOV     B,#0x0
   \   00019B   A4           MUL     AB
   \   00019C   2A           ADD     A,R2
   \   00019D   FA           MOV     R2,A
   \   00019E   75F027       MOV     B,#0x27
   \   0001A1   E9           MOV     A,R1
   \   0001A2   A4           MUL     AB
   \   0001A3   2A           ADD     A,R2
   \   0001A4   F9           MOV     R1,A
   \   0001A5   74..         MOV     A,#keyEstablishRec & 0xff
   \   0001A7   28           ADD     A,R0
   \   0001A8   FA           MOV     R2,A
   \   0001A9   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   0001AB   39           ADDC    A,R1
   \   0001AC   FB           MOV     R3,A
   \   0001AD   12....       LCALL   ??osal_memcpy?relay
   \   0001B0   7403         MOV     A,#0x3
   \   0001B2   12....       LCALL   ?DEALLOC_XSTACK8
   \   0001B5   8A..         MOV     ?V0 + 4,R2
   \   0001B7   8B..         MOV     ?V0 + 5,R3
   \   0001B9   85..82       MOV     DPL,?V0 + 4
   \   0001BC   85..83       MOV     DPH,?V0 + 5
   \   0001BF   8003         SJMP    ??zclGeneral_AddKeyEstablishRec_1
   1885          
   1886                // extAddr will be unknown when the initator first initiates the key establishment
   1887                // It will be filled in later after the remote certificate is received.
   1888              }
   1889              else
   1890              {
   1891                index = MAX_KEY_ESTABLISHMENT_REC_ENTRY;
   \                     ??zclGeneral_AddKeyEstablishRec_2:
   \   0001C1   75..02       MOV     ?V0 + 2,#0x2
   1892              }
   1893            }
   1894          
   1895            return index;
   \                     ??zclGeneral_AddKeyEstablishRec_1:
   \   0001C4   A9..         MOV     R1,?V0 + 2
   \   0001C6   7F07         MOV     R7,#0x7
   \   0001C8   02....       LJMP    ?BANKED_LEAVE_XDATA
   1896          }
   1897          
   1898          /*********************************************************************
   1899           * @fn      zclGeneral_AgeKeyEstablishRec
   1900           *
   1901           * @brief   Function to age Key Establish Rec. This function is called
   1902           *          as event handler for KEY_ESTABLISHMENT_REC_AGING_EVT every
   1903           *          second.
   1904           *
   1905           * @param   none
   1906           *
   1907           * @return  none
   1908           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1909          static void zclGeneral_AgeKeyEstablishRec( void )
   \                     zclGeneral_AgeKeyEstablishRec:
   1910          {
   \   000000   74F7         MOV     A,#-0x9
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 9
   \   000005                ; Auto size: 0
   1911            uint8 i;
   1912            bool recFound = FALSE;
   \   000005   7F00         MOV     R7,#0x0
   1913          
   1914            for ( i = 0; i < MAX_KEY_ESTABLISHMENT_REC_ENTRY; i++ )
   \   000007   7E00         MOV     R6,#0x0
   \                     ??zclGeneral_AgeKeyEstablishRec_0:
   \   000009   EE           MOV     A,R6
   \   00000A   C3           CLR     C
   \   00000B   9402         SUBB    A,#0x2
   \   00000D   4003         JC      $+5
   \   00000F   02....       LJMP    ??zclGeneral_AgeKeyEstablishRec_1 & 0xFFFF
   1915            {
   1916              // Only age valid rec entry
   1917              if (keyEstablishRec[i].dstAddr.addrMode == afAddrNotPresent)
   \   000012   EE           MOV     A,R6
   \   000013   F8           MOV     R0,A
   \   000014   7900         MOV     R1,#0x0
   \   000016   E8           MOV     A,R0
   \   000017   75F027       MOV     B,#0x27
   \   00001A   A4           MUL     AB
   \   00001B   C8           XCH     A,R0
   \   00001C   AAF0         MOV     R2,B
   \   00001E   75F000       MOV     B,#0x0
   \   000021   A4           MUL     AB
   \   000022   2A           ADD     A,R2
   \   000023   FA           MOV     R2,A
   \   000024   75F027       MOV     B,#0x27
   \   000027   E9           MOV     A,R1
   \   000028   A4           MUL     AB
   \   000029   2A           ADD     A,R2
   \   00002A   F9           MOV     R1,A
   \   00002B   74..         MOV     A,#(keyEstablishRec + 8) & 0xff
   \   00002D   28           ADD     A,R0
   \   00002E   F582         MOV     DPL,A
   \   000030   74..         MOV     A,#((keyEstablishRec + 8) >> 8) & 0xff
   \   000032   39           ADDC    A,R1
   \   000033   F583         MOV     DPH,A
   \   000035   E0           MOVX    A,@DPTR
   \   000036   605C         JZ      ??zclGeneral_AgeKeyEstablishRec_2
   1918              {
   1919                continue;
   1920              }
   1921          
   1922              if (--(keyEstablishRec[i].age) == 0)
   \   000038   EE           MOV     A,R6
   \   000039   F8           MOV     R0,A
   \   00003A   7900         MOV     R1,#0x0
   \   00003C   E8           MOV     A,R0
   \   00003D   75F027       MOV     B,#0x27
   \   000040   A4           MUL     AB
   \   000041   C8           XCH     A,R0
   \   000042   AAF0         MOV     R2,B
   \   000044   75F000       MOV     B,#0x0
   \   000047   A4           MUL     AB
   \   000048   2A           ADD     A,R2
   \   000049   FA           MOV     R2,A
   \   00004A   75F027       MOV     B,#0x27
   \   00004D   E9           MOV     A,R1
   \   00004E   A4           MUL     AB
   \   00004F   2A           ADD     A,R2
   \   000050   F9           MOV     R1,A
   \   000051   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   000053   28           ADD     A,R0
   \   000054   F582         MOV     DPL,A
   \   000056   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   000058   39           ADDC    A,R1
   \   000059   F583         MOV     DPH,A
   \   00005B   E0           MOVX    A,@DPTR
   \   00005C   24FF         ADD     A,#-0x1
   \   00005E   FB           MOV     R3,A
   \   00005F   EB           MOV     A,R3
   \   000060   C0E0         PUSH    A
   \   000062   EE           MOV     A,R6
   \   000063   F8           MOV     R0,A
   \   000064   7900         MOV     R1,#0x0
   \   000066   E8           MOV     A,R0
   \   000067   75F027       MOV     B,#0x27
   \   00006A   A4           MUL     AB
   \   00006B   C8           XCH     A,R0
   \   00006C   AAF0         MOV     R2,B
   \   00006E   75F000       MOV     B,#0x0
   \   000071   A4           MUL     AB
   \   000072   2A           ADD     A,R2
   \   000073   FA           MOV     R2,A
   \   000074   75F027       MOV     B,#0x27
   \   000077   E9           MOV     A,R1
   \   000078   A4           MUL     AB
   \   000079   2A           ADD     A,R2
   \   00007A   F9           MOV     R1,A
   \   00007B   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   00007D   28           ADD     A,R0
   \   00007E   F582         MOV     DPL,A
   \   000080   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   000082   39           ADDC    A,R1
   \   000083   F583         MOV     DPH,A
   \   000085   D0E0         POP     A
   \   000087   F0           MOVX    @DPTR,A
   \   000088   EB           MOV     A,R3
   \   000089   7007         JNZ     ??zclGeneral_AgeKeyEstablishRec_3
   1923              {
   1924                // Reset this table entry
   1925                zclGeneral_ResetKeyEstablishRec( i );
   \   00008B                ; Setup parameters for call to function zclGeneral_ResetKeyEstablishRec
   \   00008B   EE           MOV     A,R6
   \   00008C   F9           MOV     R1,A
   \   00008D   12....       LCALL   ??zclGeneral_ResetKeyEstablishRec?relay
   \   000090   8002         SJMP    ??zclGeneral_AgeKeyEstablishRec_2
   1926              }
   1927              else
   1928              {
   1929                 recFound = TRUE;
   \                     ??zclGeneral_AgeKeyEstablishRec_3:
   \   000092   7F01         MOV     R7,#0x1
   1930              }
   1931            }
   \                     ??zclGeneral_AgeKeyEstablishRec_2:
   \   000094   0E           INC     R6
   \   000095   02....       LJMP    ??zclGeneral_AgeKeyEstablishRec_0 & 0xFFFF
   1932          
   1933            if ( recFound == FALSE )
   \                     ??zclGeneral_AgeKeyEstablishRec_1:
   \   000098   EF           MOV     A,R7
   \   000099   700D         JNZ     ??zclGeneral_AgeKeyEstablishRec_4
   1934            {
   1935              osal_stop_timerEx( zcl_KeyEstablishment_TaskID, KEY_ESTABLISHMENT_REC_AGING_EVT );
   \   00009B                ; Setup parameters for call to function osal_stop_timerEx
   \   00009B   7A01         MOV     R2,#0x1
   \   00009D   7B00         MOV     R3,#0x0
   \   00009F   90....       MOV     DPTR,#zcl_KeyEstablishment_TaskID
   \   0000A2   E0           MOVX    A,@DPTR
   \   0000A3   F9           MOV     R1,A
   \   0000A4   12....       LCALL   ??osal_stop_timerEx?relay
   \   0000A7   E9           MOV     A,R1
   1936            }
   1937          }
   \                     ??zclGeneral_AgeKeyEstablishRec_4:
   \   0000A8   7F01         MOV     R7,#0x1
   \   0000AA   02....       LJMP    ?BANKED_LEAVE_XDATA
   1938          
   1939          /*********************************************************************
   1940           * @fn      zclGeneral_ResetKeyEstablishRec
   1941           *
   1942           * @brief   Reset specified key establishment record to initial value.
   1943           *
   1944           * @param   index - index of table entry to reset
   1945           *
   1946           * @return   ZStatus_t - ZSuccess or ZFailure
   1947           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1948          static void zclGeneral_ResetKeyEstablishRec( uint8 index )
   \                     zclGeneral_ResetKeyEstablishRec:
   1949          {
   \   000000   74F2         MOV     A,#-0xe
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 14
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   1950            uint8 *pKeys;
   1951          
   1952            pKeys = keyEstablishRec[index].pLocalEPrivateKey;
   \   000007   E5..         MOV     A,?V0 + 0
   \   000009   A8..         MOV     R0,?V0 + 0
   \   00000B   7900         MOV     R1,#0x0
   \   00000D   E8           MOV     A,R0
   \   00000E   75F027       MOV     B,#0x27
   \   000011   A4           MUL     AB
   \   000012   C8           XCH     A,R0
   \   000013   AAF0         MOV     R2,B
   \   000015   75F000       MOV     B,#0x0
   \   000018   A4           MUL     AB
   \   000019   2A           ADD     A,R2
   \   00001A   FA           MOV     R2,A
   \   00001B   75F027       MOV     B,#0x27
   \   00001E   E9           MOV     A,R1
   \   00001F   A4           MUL     AB
   \   000020   2A           ADD     A,R2
   \   000021   F9           MOV     R1,A
   \   000022   74..         MOV     A,#(keyEstablishRec + 25) & 0xff
   \   000024   28           ADD     A,R0
   \   000025   F582         MOV     DPL,A
   \   000027   74..         MOV     A,#((keyEstablishRec + 25) >> 8) & 0xff
   \   000029   39           ADDC    A,R1
   \   00002A   F583         MOV     DPH,A
   \   00002C   E0           MOVX    A,@DPTR
   \   00002D   F8           MOV     R0,A
   \   00002E   A3           INC     DPTR
   \   00002F   E0           MOVX    A,@DPTR
   \   000030   F9           MOV     R1,A
   \   000031   E8           MOV     A,R0
   \   000032   FE           MOV     R6,A
   \   000033   E9           MOV     A,R1
   \   000034   FF           MOV     R7,A
   1953            if ( pKeys != NULL )
   \   000035   EE           MOV     A,R6
   \   000036   4F           ORL     A,R7
   \   000037   601E         JZ      ??zclGeneral_ResetKeyEstablishRec_0
   1954            {
   1955              // All "Key infomation" was allocated in one block,
   1956              // Clear the allocated memory to remove all copies of keys,
   1957              (void)osal_memset( pKeys, 0, ZCL_KE_DEVICE_PRIVATE_KEY_LEN +
   1958                                           ZCL_KE_CA_PUBLIC_KEY_LEN +
   1959                                           ZCL_KE_CA_PUBLIC_KEY_LEN +
   1960                                           ZCL_KE_IMPLICIT_CERTIFICATE_LEN +
   1961                                           KEY_ESTABLISH_KEY_DATA_LENGTH +
   1962                                           KEY_ESTABLISH_MAC_KEY_LENGTH );
   \   000039                ; Setup parameters for call to function osal_memset
   \   000039   7C91         MOV     R4,#-0x6f
   \   00003B   7D00         MOV     R5,#0x0
   \   00003D   7900         MOV     R1,#0x0
   \   00003F   EE           MOV     A,R6
   \   000040   FA           MOV     R2,A
   \   000041   EF           MOV     A,R7
   \   000042   FB           MOV     R3,A
   \   000043   12....       LCALL   ??osal_memset?relay
   \   000046   8A..         MOV     ?V0 + 4,R2
   \   000048   8B..         MOV     ?V0 + 5,R3
   \   00004A   85....       MOV     ?V0 + 2,?V0 + 4
   \   00004D   85....       MOV     ?V0 + 3,?V0 + 5
   1963              osal_mem_free( pKeys );
   \   000050                ; Setup parameters for call to function osal_mem_free
   \   000050   EE           MOV     A,R6
   \   000051   FA           MOV     R2,A
   \   000052   EF           MOV     A,R7
   \   000053   FB           MOV     R3,A
   \   000054   12....       LCALL   ??osal_mem_free?relay
   1964            }
   1965          
   1966            // Reset the table entry to initial state
   1967            (void)osal_memset( &(keyEstablishRec[index]), 0, sizeof( zclKeyEstablishRec_t ) );
   \                     ??zclGeneral_ResetKeyEstablishRec_0:
   \   000057                ; Setup parameters for call to function osal_memset
   \   000057   7C27         MOV     R4,#0x27
   \   000059   7D00         MOV     R5,#0x0
   \   00005B   7900         MOV     R1,#0x0
   \   00005D   E5..         MOV     A,?V0 + 0
   \   00005F   AA..         MOV     R2,?V0 + 0
   \   000061   7B00         MOV     R3,#0x0
   \   000063   EA           MOV     A,R2
   \   000064   75F027       MOV     B,#0x27
   \   000067   A4           MUL     AB
   \   000068   CA           XCH     A,R2
   \   000069   A8F0         MOV     R0,B
   \   00006B   75F000       MOV     B,#0x0
   \   00006E   A4           MUL     AB
   \   00006F   28           ADD     A,R0
   \   000070   F8           MOV     R0,A
   \   000071   75F027       MOV     B,#0x27
   \   000074   EB           MOV     A,R3
   \   000075   A4           MUL     AB
   \   000076   28           ADD     A,R0
   \   000077   FB           MOV     R3,A
   \   000078   74..         MOV     A,#keyEstablishRec & 0xff
   \   00007A   2A           ADD     A,R2
   \   00007B   FA           MOV     R2,A
   \   00007C   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   00007E   3B           ADDC    A,R3
   \   00007F   FB           MOV     R3,A
   \   000080   12....       LCALL   ??osal_memset?relay
   \   000083   8A..         MOV     ?V0 + 2,R2
   \   000085   8B..         MOV     ?V0 + 3,R3
   \   000087   AC..         MOV     R4,?V0 + 2
   \   000089   AD..         MOV     R5,?V0 + 3
   1968            keyEstablishRec[index].dstAddr.addrMode = afAddrNotPresent;
   \   00008B   E5..         MOV     A,?V0 + 0
   \   00008D   A8..         MOV     R0,?V0 + 0
   \   00008F   7900         MOV     R1,#0x0
   \   000091   E8           MOV     A,R0
   \   000092   75F027       MOV     B,#0x27
   \   000095   A4           MUL     AB
   \   000096   C8           XCH     A,R0
   \   000097   AAF0         MOV     R2,B
   \   000099   75F000       MOV     B,#0x0
   \   00009C   A4           MUL     AB
   \   00009D   2A           ADD     A,R2
   \   00009E   FA           MOV     R2,A
   \   00009F   75F027       MOV     B,#0x27
   \   0000A2   E9           MOV     A,R1
   \   0000A3   A4           MUL     AB
   \   0000A4   2A           ADD     A,R2
   \   0000A5   F9           MOV     R1,A
   \   0000A6   74..         MOV     A,#(keyEstablishRec + 8) & 0xff
   \   0000A8   28           ADD     A,R0
   \   0000A9   F582         MOV     DPL,A
   \   0000AB   74..         MOV     A,#((keyEstablishRec + 8) >> 8) & 0xff
   \   0000AD   39           ADDC    A,R1
   \   0000AE   F583         MOV     DPH,A
   \   0000B0   7400         MOV     A,#0x0
   \   0000B2   F0           MOVX    @DPTR,A
   1969            keyEstablishRec[index].dstAddr.addr.shortAddr = INVALID_PARTNER_ADDR;
   \   0000B3   E5..         MOV     A,?V0 + 0
   \   0000B5   A8..         MOV     R0,?V0 + 0
   \   0000B7   7900         MOV     R1,#0x0
   \   0000B9   E8           MOV     A,R0
   \   0000BA   75F027       MOV     B,#0x27
   \   0000BD   A4           MUL     AB
   \   0000BE   C8           XCH     A,R0
   \   0000BF   AAF0         MOV     R2,B
   \   0000C1   75F000       MOV     B,#0x0
   \   0000C4   A4           MUL     AB
   \   0000C5   2A           ADD     A,R2
   \   0000C6   FA           MOV     R2,A
   \   0000C7   75F027       MOV     B,#0x27
   \   0000CA   E9           MOV     A,R1
   \   0000CB   A4           MUL     AB
   \   0000CC   2A           ADD     A,R2
   \   0000CD   F9           MOV     R1,A
   \   0000CE   74..         MOV     A,#keyEstablishRec & 0xff
   \   0000D0   28           ADD     A,R0
   \   0000D1   F582         MOV     DPL,A
   \   0000D3   74..         MOV     A,#(keyEstablishRec >> 8) & 0xff
   \   0000D5   39           ADDC    A,R1
   \   0000D6   F583         MOV     DPH,A
   \   0000D8   74FE         MOV     A,#-0x2
   \   0000DA   F0           MOVX    @DPTR,A
   \   0000DB   A3           INC     DPTR
   \   0000DC   74FF         MOV     A,#-0x1
   \   0000DE   F0           MOVX    @DPTR,A
   1970            keyEstablishRec[index].appTaskID = INVALID_TASK_ID;
   \   0000DF   E5..         MOV     A,?V0 + 0
   \   0000E1   A8..         MOV     R0,?V0 + 0
   \   0000E3   7900         MOV     R1,#0x0
   \   0000E5   E8           MOV     A,R0
   \   0000E6   75F027       MOV     B,#0x27
   \   0000E9   A4           MUL     AB
   \   0000EA   C8           XCH     A,R0
   \   0000EB   AAF0         MOV     R2,B
   \   0000ED   75F000       MOV     B,#0x0
   \   0000F0   A4           MUL     AB
   \   0000F1   2A           ADD     A,R2
   \   0000F2   FA           MOV     R2,A
   \   0000F3   75F027       MOV     B,#0x27
   \   0000F6   E9           MOV     A,R1
   \   0000F7   A4           MUL     AB
   \   0000F8   2A           ADD     A,R2
   \   0000F9   F9           MOV     R1,A
   \   0000FA   74..         MOV     A,#(keyEstablishRec + 13) & 0xff
   \   0000FC   28           ADD     A,R0
   \   0000FD   F582         MOV     DPL,A
   \   0000FF   74..         MOV     A,#((keyEstablishRec + 13) >> 8) & 0xff
   \   000101   39           ADDC    A,R1
   \   000102   F583         MOV     DPH,A
   \   000104   74FF         MOV     A,#-0x1
   \   000106   F0           MOVX    @DPTR,A
   1971            keyEstablishRec[index].age = KEY_ESTABLISHMENT_REC_EXPIRY_TIME;
   \   000107   E5..         MOV     A,?V0 + 0
   \   000109   A8..         MOV     R0,?V0 + 0
   \   00010B   7900         MOV     R1,#0x0
   \   00010D   E8           MOV     A,R0
   \   00010E   75F027       MOV     B,#0x27
   \   000111   A4           MUL     AB
   \   000112   C8           XCH     A,R0
   \   000113   AAF0         MOV     R2,B
   \   000115   75F000       MOV     B,#0x0
   \   000118   A4           MUL     AB
   \   000119   2A           ADD     A,R2
   \   00011A   FA           MOV     R2,A
   \   00011B   75F027       MOV     B,#0x27
   \   00011E   E9           MOV     A,R1
   \   00011F   A4           MUL     AB
   \   000120   2A           ADD     A,R2
   \   000121   F9           MOV     R1,A
   \   000122   74..         MOV     A,#(keyEstablishRec + 23) & 0xff
   \   000124   28           ADD     A,R0
   \   000125   F582         MOV     DPL,A
   \   000127   74..         MOV     A,#((keyEstablishRec + 23) >> 8) & 0xff
   \   000129   39           ADDC    A,R1
   \   00012A   F583         MOV     DPH,A
   \   00012C   74FF         MOV     A,#-0x1
   \   00012E   F0           MOVX    @DPTR,A
   1972            keyEstablishRec[index].state = KeyEstablishState_Idle;
   \   00012F   E5..         MOV     A,?V0 + 0
   \   000131   A8..         MOV     R0,?V0 + 0
   \   000133   7900         MOV     R1,#0x0
   \   000135   E8           MOV     A,R0
   \   000136   75F027       MOV     B,#0x27
   \   000139   A4           MUL     AB
   \   00013A   C8           XCH     A,R0
   \   00013B   AAF0         MOV     R2,B
   \   00013D   75F000       MOV     B,#0x0
   \   000140   A4           MUL     AB
   \   000141   2A           ADD     A,R2
   \   000142   FA           MOV     R2,A
   \   000143   75F027       MOV     B,#0x27
   \   000146   E9           MOV     A,R1
   \   000147   A4           MUL     AB
   \   000148   2A           ADD     A,R2
   \   000149   F9           MOV     R1,A
   \   00014A   74..         MOV     A,#(keyEstablishRec + 24) & 0xff
   \   00014C   28           ADD     A,R0
   \   00014D   F582         MOV     DPL,A
   \   00014F   74..         MOV     A,#((keyEstablishRec + 24) >> 8) & 0xff
   \   000151   39           ADDC    A,R1
   \   000152   F583         MOV     DPH,A
   \   000154   7400         MOV     A,#0x0
   \   000156   F0           MOVX    @DPTR,A
   1973            keyEstablishRec[index].remoteEphDataGenTime = KEY_ESTABLISHMENT_EPH_DATA_GEN_INVALID_TIME;
   \   000157   E5..         MOV     A,?V0 + 0
   \   000159   A8..         MOV     R0,?V0 + 0
   \   00015B   7900         MOV     R1,#0x0
   \   00015D   E8           MOV     A,R0
   \   00015E   75F027       MOV     B,#0x27
   \   000161   A4           MUL     AB
   \   000162   C8           XCH     A,R0
   \   000163   AAF0         MOV     R2,B
   \   000165   75F000       MOV     B,#0x0
   \   000168   A4           MUL     AB
   \   000169   2A           ADD     A,R2
   \   00016A   FA           MOV     R2,A
   \   00016B   75F027       MOV     B,#0x27
   \   00016E   E9           MOV     A,R1
   \   00016F   A4           MUL     AB
   \   000170   2A           ADD     A,R2
   \   000171   F9           MOV     R1,A
   \   000172   74..         MOV     A,#(keyEstablishRec + 37) & 0xff
   \   000174   28           ADD     A,R0
   \   000175   F582         MOV     DPL,A
   \   000177   74..         MOV     A,#((keyEstablishRec + 37) >> 8) & 0xff
   \   000179   39           ADDC    A,R1
   \   00017A   F583         MOV     DPH,A
   \   00017C   74FF         MOV     A,#-0x1
   \   00017E   F0           MOVX    @DPTR,A
   1974            keyEstablishRec[index].remoteConfKeyGenTime = KEY_ESTABLISHMENT_CONF_KEY_GEN_INVALID_TIME;
   \   00017F   E5..         MOV     A,?V0 + 0
   \   000181   A8..         MOV     R0,?V0 + 0
   \   000183   7900         MOV     R1,#0x0
   \   000185   E8           MOV     A,R0
   \   000186   75F027       MOV     B,#0x27
   \   000189   A4           MUL     AB
   \   00018A   C8           XCH     A,R0
   \   00018B   AAF0         MOV     R2,B
   \   00018D   75F000       MOV     B,#0x0
   \   000190   A4           MUL     AB
   \   000191   2A           ADD     A,R2
   \   000192   FA           MOV     R2,A
   \   000193   75F027       MOV     B,#0x27
   \   000196   E9           MOV     A,R1
   \   000197   A4           MUL     AB
   \   000198   2A           ADD     A,R2
   \   000199   F9           MOV     R1,A
   \   00019A   74..         MOV     A,#(keyEstablishRec + 38) & 0xff
   \   00019C   28           ADD     A,R0
   \   00019D   F582         MOV     DPL,A
   \   00019F   74..         MOV     A,#((keyEstablishRec + 38) >> 8) & 0xff
   \   0001A1   39           ADDC    A,R1
   \   0001A2   F583         MOV     DPH,A
   \   0001A4   74FF         MOV     A,#-0x1
   \   0001A6   F0           MOVX    @DPTR,A
   1975          }
   \   0001A7   7F06         MOV     R7,#0x6
   \   0001A9   02....       LJMP    ?BANKED_LEAVE_XDATA
   1976          
   1977          /*********************************************************************
   1978           * @fn      zclGeneral_KeyEstablishment_GetRandom
   1979           *
   1980           * @brief   Fill in a buffer with random numbers
   1981           *
   1982           * @param   buffer - output buffer
   1983           *          len - length of the buffer
   1984           *
   1985           * @return  MCE_SUCCESS indicates success
   1986           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   1987          static int zclGeneral_KeyEstablishment_GetRandom(unsigned char *buffer, unsigned long len)
   \                     zclGeneral_KeyEstablishment_GetRandom:
   1988          {
   \   000000   74F0         MOV     A,#-0x10
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 16
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 0,R2
   \   000007   8B..         MOV     ?V0 + 1,R3
   \   000009   7410         MOV     A,#0x10
   \   00000B   12....       LCALL   ?XSTACK_DISP0_8
   \   00000E   78..         MOV     R0,#?V0 + 4
   \   000010   12....       LCALL   ?L_MOV_X
   1989            uint8 *pBuf;
   1990          
   1991            pBuf = buffer;
   \   000013   AE..         MOV     R6,?V0 + 0
   \   000015   AF..         MOV     R7,?V0 + 1
   1992          
   1993            // Input to SSP_GetTrueRandAES assumes len <= SEC_KEY_LEN
   1994            // Therefore, call SSP_GetTrueRandAES multiple times to
   1995            // fill out the buffer.
   1996            while( len > SEC_KEY_LEN )
   \                     ??zclGeneral_KeyEstablishment_GetRandom_0:
   \   000017   90....       MOV     DPTR,#__Constant_11
   \   00001A   78..         MOV     R0,#?V0 + 4
   \   00001C   12....       LCALL   ?UL_GE_X
   \   00001F   501C         JNC     ??zclGeneral_KeyEstablishment_GetRandom_1
   1997            {
   1998              SSP_GetTrueRandAES( SEC_KEY_LEN, pBuf );
   \   000021                ; Setup parameters for call to function SSP_GetTrueRandAES
   \   000021   EE           MOV     A,R6
   \   000022   FA           MOV     R2,A
   \   000023   EF           MOV     A,R7
   \   000024   FB           MOV     R3,A
   \   000025   7910         MOV     R1,#0x10
   \   000027   12....       LCALL   ??SSP_GetTrueRandAES?relay
   \   00002A   E9           MOV     A,R1
   1999              len -= SEC_KEY_LEN;
   \   00002B   90....       MOV     DPTR,#__Constant_fffffff0
   \   00002E   78..         MOV     R0,#?V0 + 4
   \   000030   12....       LCALL   ?L_ADD_X
   2000              pBuf += SEC_KEY_LEN;
   \   000033   EE           MOV     A,R6
   \   000034   2410         ADD     A,#0x10
   \   000036   FE           MOV     R6,A
   \   000037   EF           MOV     A,R7
   \   000038   3400         ADDC    A,#0x0
   \   00003A   FF           MOV     R7,A
   \   00003B   80DA         SJMP    ??zclGeneral_KeyEstablishment_GetRandom_0
   2001            }
   2002            SSP_GetTrueRandAES( len, pBuf );
   \                     ??zclGeneral_KeyEstablishment_GetRandom_1:
   \   00003D                ; Setup parameters for call to function SSP_GetTrueRandAES
   \   00003D   EE           MOV     A,R6
   \   00003E   FA           MOV     R2,A
   \   00003F   EF           MOV     A,R7
   \   000040   FB           MOV     R3,A
   \   000041   A8..         MOV     R0,?V0 + 4
   \   000043   A9..         MOV     R1,?V0 + 5
   \   000045   E5..         MOV     A,?V0 + 4
   \   000047   A9..         MOV     R1,?V0 + 4
   \   000049   12....       LCALL   ??SSP_GetTrueRandAES?relay
   \   00004C   E9           MOV     A,R1
   2003            return MCE_SUCCESS;
   \   00004D   7A00         MOV     R2,#0x0
   \   00004F   7B00         MOV     R3,#0x0
   \   000051   7F08         MOV     R7,#0x8
   \   000053   02....       LJMP    ?BANKED_LEAVE_XDATA
   2004          }
   2005          
   2006          /*********************************************************************
   2007           * @fn      zclGeneral_KeyEstablishment_HashFunc
   2008           *
   2009           * @brief   Hash Function
   2010           *
   2011           * @param   digest - output buffer 16 bytes
   2012           *          len - length of the input buffer
   2013           *          data - input buffer
   2014           *
   2015           * @return  MCE_SUCCESS indicates success
   2016           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2017          static int zclGeneral_KeyEstablishment_HashFunc(unsigned char *digest, unsigned long len, unsigned char *data)
   \                     zclGeneral_KeyEstablishment_HashFunc:
   2018          {
   \   000000   74EC         MOV     A,#-0x14
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 20
   \   000005                ; Auto size: 0
   \   000005   8A..         MOV     ?V0 + 2,R2
   \   000007   8B..         MOV     ?V0 + 3,R3
   \   000009   EC           MOV     A,R4
   \   00000A   FE           MOV     R6,A
   \   00000B   ED           MOV     A,R5
   \   00000C   FF           MOV     R7,A
   \   00000D   7414         MOV     A,#0x14
   \   00000F   12....       LCALL   ?XSTACK_DISP0_8
   \   000012   78..         MOV     R0,#?V0 + 4
   \   000014   12....       LCALL   ?L_MOV_X
   2019            len *= 8;  // Convert to bit length
   \   000017   90....       MOV     DPTR,#__Constant_8
   \   00001A   78..         MOV     R0,#?V0 + 8
   \   00001C   12....       LCALL   ?L_MOV_X
   \   00001F   78..         MOV     R0,#?V0 + 4
   \   000021   79..         MOV     R1,#?V0 + 8
   \   000023   12....       LCALL   ?L_MUL
   2020            sspMMOHash( NULL, 0, data, (uint16)len, digest );
   \   000026                ; Setup parameters for call to function sspMMOHash
   \   000026   78..         MOV     R0,#?V0 + 2
   \   000028   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00002B   85....       MOV     ?V0 + 0,?V0 + 4
   \   00002E   85....       MOV     ?V0 + 1,?V0 + 5
   \   000031   78..         MOV     R0,#?V0 + 0
   \   000033   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000036   EE           MOV     A,R6
   \   000037   FC           MOV     R4,A
   \   000038   EF           MOV     A,R7
   \   000039   FD           MOV     R5,A
   \   00003A   7900         MOV     R1,#0x0
   \   00003C   7A00         MOV     R2,#0x0
   \   00003E   7B00         MOV     R3,#0x0
   \   000040   12....       LCALL   ??sspMMOHash?relay
   \   000043   7404         MOV     A,#0x4
   \   000045   12....       LCALL   ?DEALLOC_XSTACK8
   2021            return MCE_SUCCESS;
   \   000048   7A00         MOV     R2,#0x0
   \   00004A   7B00         MOV     R3,#0x0
   \   00004C   7F0C         MOV     R7,#0xc
   \   00004E   02....       LJMP    ?BANKED_LEAVE_XDATA
   2022          }
   2023          
   2024          /*********************************************************************
   2025           * @fn      zclGeneral_KeyEstablishment_KeyDeriveFunction
   2026           *
   2027           * @brief   Key Derive Function (ANSI X9.63).
   2028           *          Note this is not a generalized KDF. It only applies to the KDF
   2029           *          specified in ZigBee SE profile. Only the first two hashed keys
   2030           *          are calculated and concatenated.
   2031           *
   2032           * @param   zData - input shared secret (length = KEY_ESTABLISH_SHARED_SECRET_LENGTH)
   2033           *          keyBitLen - input key data length
   2034           *          keyBit - output buffer ( 16*2 bytes)
   2035           *
   2036           * @return  none
   2037           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2038          static void zclGeneral_KeyEstablishment_KeyDeriveFunction( uint8 *zData,
   \                     zclGeneral_KeyEstablishment_KeyDeriveFunction:
   2039                                                                     uint8 keyBitLen,
   2040                                                                     uint8 *keyBit )
   2041          {
   \   000000   74F1         MOV     A,#-0xf
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 15
   \   000005                ; Auto size: 29
   \   000005   74E3         MOV     A,#-0x1d
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   8A..         MOV     ?V0 + 0,R2
   \   00000C   8B..         MOV     ?V0 + 1,R3
   \   00000E   E9           MOV     A,R1
   \   00000F   FE           MOV     R6,A
   \   000010   8C..         MOV     ?V0 + 2,R4
   \   000012   8D..         MOV     ?V0 + 3,R5
   2042            uint8 hashCounter[4] = {0x00, 0x00, 0x00, 0x01};
   \   000014   90....       MOV     DPTR,#`?<Constant {0, 0, 0, 1}>`
   \   000017   C082         PUSH    DPL
   \   000019   C083         PUSH    DPH
   \   00001B   85..82       MOV     DPL,?XSP + 0
   \   00001E   85..83       MOV     DPH,?XSP + 1
   \   000021   AC82         MOV     R4,DPL
   \   000023   AD83         MOV     R5,DPH
   \   000025   D083         POP     DPH
   \   000027   D082         POP     DPL
   \   000029   7404         MOV     A,#0x4
   \   00002B   12....       LCALL   ?MOVE_LONG8_XDATA_XDATA
   2043            uint8 hashedData[KEY_ESTABLISH_SHARED_SECRET_LENGTH + 4];
   2044            uint8 bitLen;
   2045          
   2046            bitLen = (keyBitLen + 4 ) * 8;
   \   00002E   75F008       MOV     B,#0x8
   \   000031   7404         MOV     A,#0x4
   \   000033   2E           ADD     A,R6
   \   000034   A4           MUL     AB
   \   000035   FF           MOV     R7,A
   2047          
   2048            // Calculate K1: Ki = Hash(Z || Counter1 )
   2049            osal_memcpy( hashedData, zData, KEY_ESTABLISH_SHARED_SECRET_LENGTH );
   \   000036                ; Setup parameters for call to function osal_memcpy
   \   000036   85....       MOV     ?V0 + 4,?V0 + 0
   \   000039   85....       MOV     ?V0 + 5,?V0 + 1
   \   00003C   75..00       MOV     ?V0 + 6,#0x0
   \   00003F   78..         MOV     R0,#?V0 + 4
   \   000041   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000044   7C15         MOV     R4,#0x15
   \   000046   7D00         MOV     R5,#0x0
   \   000048   7407         MOV     A,#0x7
   \   00004A   12....       LCALL   ?XSTACK_DISP0_8
   \   00004D   AA82         MOV     R2,DPL
   \   00004F   AB83         MOV     R3,DPH
   \   000051   12....       LCALL   ??osal_memcpy?relay
   \   000054   7403         MOV     A,#0x3
   \   000056   12....       LCALL   ?DEALLOC_XSTACK8
   2050            osal_memcpy( &(hashedData[KEY_ESTABLISH_SHARED_SECRET_LENGTH]), hashCounter, 4);
   \   000059                ; Setup parameters for call to function osal_memcpy
   \   000059   85..82       MOV     DPL,?XSP + 0
   \   00005C   85..83       MOV     DPH,?XSP + 1
   \   00005F   A982         MOV     R1,DPL
   \   000061   AA83         MOV     R2,DPH
   \   000063   7B00         MOV     R3,#0x0
   \   000065   89..         MOV     ?V0 + 4,R1
   \   000067   8A..         MOV     ?V0 + 5,R2
   \   000069   8B..         MOV     ?V0 + 6,R3
   \   00006B   78..         MOV     R0,#?V0 + 4
   \   00006D   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000070   7C04         MOV     R4,#0x4
   \   000072   7D00         MOV     R5,#0x0
   \   000074   741C         MOV     A,#0x1c
   \   000076   12....       LCALL   ?XSTACK_DISP0_8
   \   000079   AA82         MOV     R2,DPL
   \   00007B   AB83         MOV     R3,DPH
   \   00007D   12....       LCALL   ??osal_memcpy?relay
   \   000080   7403         MOV     A,#0x3
   \   000082   12....       LCALL   ?DEALLOC_XSTACK8
   2051          
   2052            sspMMOHash(NULL, 0, hashedData, bitLen, keyBit);
   \   000085                ; Setup parameters for call to function sspMMOHash
   \   000085   78..         MOV     R0,#?V0 + 2
   \   000087   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00008A   8F..         MOV     ?V0 + 4,R7
   \   00008C   75..00       MOV     ?V0 + 5,#0x0
   \   00008F   78..         MOV     R0,#?V0 + 4
   \   000091   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000094   7408         MOV     A,#0x8
   \   000096   12....       LCALL   ?XSTACK_DISP0_8
   \   000099   AC82         MOV     R4,DPL
   \   00009B   AD83         MOV     R5,DPH
   \   00009D   7900         MOV     R1,#0x0
   \   00009F   7A00         MOV     R2,#0x0
   \   0000A1   7B00         MOV     R3,#0x0
   \   0000A3   12....       LCALL   ??sspMMOHash?relay
   \   0000A6   7404         MOV     A,#0x4
   \   0000A8   12....       LCALL   ?DEALLOC_XSTACK8
   2053          
   2054            // Indrement the counter
   2055            hashedData[KEY_ESTABLISH_SHARED_SECRET_LENGTH + 3] = 0x02;
   \   0000AB   741C         MOV     A,#0x1c
   \   0000AD   12....       LCALL   ?XSTACK_DISP0_8
   \   0000B0   7402         MOV     A,#0x2
   \   0000B2   F0           MOVX    @DPTR,A
   2056          
   2057            sspMMOHash(NULL, 0, hashedData, bitLen, &(keyBit[KEY_ESTABLISH_KEY_DATA_LENGTH]));
   \   0000B3                ; Setup parameters for call to function sspMMOHash
   \   0000B3   E5..         MOV     A,?V0 + 2
   \   0000B5   2410         ADD     A,#0x10
   \   0000B7   F5..         MOV     ?V0 + 4,A
   \   0000B9   E5..         MOV     A,?V0 + 3
   \   0000BB   3400         ADDC    A,#0x0
   \   0000BD   F5..         MOV     ?V0 + 5,A
   \   0000BF   78..         MOV     R0,#?V0 + 4
   \   0000C1   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000C4   8F..         MOV     ?V0 + 4,R7
   \   0000C6   75..00       MOV     ?V0 + 5,#0x0
   \   0000C9   78..         MOV     R0,#?V0 + 4
   \   0000CB   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000CE   7408         MOV     A,#0x8
   \   0000D0   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D3   AC82         MOV     R4,DPL
   \   0000D5   AD83         MOV     R5,DPH
   \   0000D7   7900         MOV     R1,#0x0
   \   0000D9   7A00         MOV     R2,#0x0
   \   0000DB   7B00         MOV     R3,#0x0
   \   0000DD   12....       LCALL   ??sspMMOHash?relay
   \   0000E0   7404         MOV     A,#0x4
   \   0000E2   12....       LCALL   ?DEALLOC_XSTACK8
   2058          }
   \   0000E5   741D         MOV     A,#0x1d
   \   0000E7   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000EA   7F07         MOV     R7,#0x7
   \   0000EC   02....       LJMP    ?BANKED_LEAVE_XDATA
   2059          
   2060          /*********************************************************************
   2061           * @fn      zclGeneral_KeyEstablishment_GenerateMAC
   2062           *
   2063           * @brief   Key Derive Function (ANSI X9.63).
   2064           *          Note this is not a generalized KDF. It only applies to the KDF
   2065           *          specified in ZigBee SE profile. Only the first two hashed keys
   2066           *          are calculated and concatenated.
   2067           *
   2068           * @param   recIndex - input key establishment record index
   2069           *          ifMACu - use M(U) if TRUE, otherwise M(V)
   2070           *          MAC - output buffer ( 16 bytes )
   2071           *
   2072           * @return  ZStatus_t - success
   2073           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2074          static ZStatus_t zclGeneral_KeyEstablishment_GenerateMAC(uint8 recIndex,
   \                     zclGeneral_KeyEstablishment_GenerateMAC:
   2075                                                                   uint8 ifMACu,
   2076                                                                   uint8 *MAC)
   2077          {
   \   000000   74EC         MOV     A,#-0x14
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 20
   \   000005                ; Auto size: 0
   \   000005   89..         MOV     ?V0 + 0,R1
   \   000007   8A..         MOV     ?V0 + 8,R2
   \   000009   8C..         MOV     ?V0 + 10,R4
   \   00000B   8D..         MOV     ?V0 + 11,R5
   2078            uint8 i;
   2079            uint8 M;
   2080            uint8 *hashBuf;
   2081            uint16 bufLen;
   2082          
   2083            // Assumption for M(U) and M(V) is: M(U) = 0x02, M(V) = 0x03
   2084            if( ifMACu == TRUE )
   \   00000D   7401         MOV     A,#0x1
   \   00000F   65..         XRL     A,?V0 + 8
   \   000011   7005         JNZ     ??zclGeneral_KeyEstablishment_GenerateMAC_0
   2085            {
   2086              M = 0x02;  // Assumption
   \   000013   75..02       MOV     ?V0 + 7,#0x2
   \   000016   8003         SJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_1
   2087            }
   2088            else
   2089            {
   2090              M = 0x03;  // Assumption
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_0:
   \   000018   75..03       MOV     ?V0 + 7,#0x3
   2091            }
   2092          
   2093            // At this point, it is assumed the device has already
   2094            // obtained the IEEE address of the partner device.
   2095            for ( i = 0; i < Z_EXTADDR_LEN; i++ )
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_1:
   \   00001B   75..00       MOV     ?V0 + 1,#0x0
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_2:
   \   00001E   E5..         MOV     A,?V0 + 1
   \   000020   C3           CLR     C
   \   000021   9408         SUBB    A,#0x8
   \   000023   503A         JNC     ??zclGeneral_KeyEstablishment_GenerateMAC_3
   2096            {
   2097              if ( keyEstablishRec[recIndex].partnerExtAddr[i] != 0 )
   \   000025   E5..         MOV     A,?V0 + 0
   \   000027   A8..         MOV     R0,?V0 + 0
   \   000029   7900         MOV     R1,#0x0
   \   00002B   E8           MOV     A,R0
   \   00002C   75F027       MOV     B,#0x27
   \   00002F   A4           MUL     AB
   \   000030   C8           XCH     A,R0
   \   000031   AAF0         MOV     R2,B
   \   000033   75F000       MOV     B,#0x0
   \   000036   A4           MUL     AB
   \   000037   2A           ADD     A,R2
   \   000038   FA           MOV     R2,A
   \   000039   75F027       MOV     B,#0x27
   \   00003C   E9           MOV     A,R1
   \   00003D   A4           MUL     AB
   \   00003E   2A           ADD     A,R2
   \   00003F   F9           MOV     R1,A
   \   000040   85....       MOV     ?V0 + 4,?V0 + 1
   \   000043   75..00       MOV     ?V0 + 5,#0x0
   \   000046   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   000048   25..         ADD     A,?V0 + 4
   \   00004A   FA           MOV     R2,A
   \   00004B   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   00004D   35..         ADDC    A,?V0 + 5
   \   00004F   FB           MOV     R3,A
   \   000050   EA           MOV     A,R2
   \   000051   28           ADD     A,R0
   \   000052   F582         MOV     DPL,A
   \   000054   EB           MOV     A,R3
   \   000055   39           ADDC    A,R1
   \   000056   F583         MOV     DPH,A
   \   000058   E0           MOVX    A,@DPTR
   \   000059   7004         JNZ     ??zclGeneral_KeyEstablishment_GenerateMAC_3
   2098              {
   2099                break;
   2100              }
   2101            }
   \   00005B   05..         INC     ?V0 + 1
   \   00005D   80BF         SJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_2
   2102            if ( i == Z_EXTADDR_LEN )
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_3:
   \   00005F   7408         MOV     A,#0x8
   \   000061   65..         XRL     A,?V0 + 1
   \   000063   7005         JNZ     ??zclGeneral_KeyEstablishment_GenerateMAC_4
   2103            {
   2104              return ZFailure;  // Partner IEEE address not available, return failure.
   \   000065   7901         MOV     R1,#0x1
   \   000067   02....       LJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_5 & 0xFFFF
   2105            }
   2106          
   2107            // MAC(U) = MAC(MacKey) { M(U) || ID(U) || ID(V) || E(U) || E(V) }
   2108            bufLen = (1 + (Z_EXTADDR_LEN * 2) + (ZCL_KE_CA_PUBLIC_KEY_LEN * 2));
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_4:
   \   00006A   7E3D         MOV     R6,#0x3d
   \   00006C   7F00         MOV     R7,#0x0
   2109            if( ( hashBuf = osal_mem_alloc( (bufLen) )) == NULL )
   \   00006E                ; Setup parameters for call to function osal_mem_alloc
   \   00006E   EE           MOV     A,R6
   \   00006F   FA           MOV     R2,A
   \   000070   EF           MOV     A,R7
   \   000071   FB           MOV     R3,A
   \   000072   12....       LCALL   ??osal_mem_alloc?relay
   \   000075   8A..         MOV     ?V0 + 4,R2
   \   000077   8B..         MOV     ?V0 + 5,R3
   \   000079   A8..         MOV     R0,?V0 + 4
   \   00007B   A9..         MOV     R1,?V0 + 5
   \   00007D   88..         MOV     ?V0 + 2,R0
   \   00007F   89..         MOV     ?V0 + 3,R1
   \   000081   E8           MOV     A,R0
   \   000082   49           ORL     A,R1
   \   000083   7005         JNZ     ??zclGeneral_KeyEstablishment_GenerateMAC_6
   2110            {
   2111              return ZMemError;  // Memory allocation error
   \   000085   7910         MOV     R1,#0x10
   \   000087   02....       LJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_5 & 0xFFFF
   2112            }
   2113          
   2114            // Fill in the buffer
   2115            hashBuf[0] = M;  // M(U)
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_6:
   \   00008A   E5..         MOV     A,?V0 + 7
   \   00008C   85..82       MOV     DPL,?V0 + 2
   \   00008F   85..83       MOV     DPH,?V0 + 3
   \   000092   E5..         MOV     A,?V0 + 7
   \   000094   F0           MOVX    @DPTR,A
   2116            bufLen = bufLen * 8;  // Convert to bitlength
   \   000095   EE           MOV     A,R6
   \   000096   75F008       MOV     B,#0x8
   \   000099   A4           MUL     AB
   \   00009A   CE           XCH     A,R6
   \   00009B   A8F0         MOV     R0,B
   \   00009D   75F000       MOV     B,#0x0
   \   0000A0   A4           MUL     AB
   \   0000A1   28           ADD     A,R0
   \   0000A2   F8           MOV     R0,A
   \   0000A3   75F008       MOV     B,#0x8
   \   0000A6   EF           MOV     A,R7
   \   0000A7   A4           MUL     AB
   \   0000A8   28           ADD     A,R0
   \   0000A9   FF           MOV     R7,A
   2117          
   2118            if ( (keyEstablishRec[recIndex].role == KEY_ESTABLISHMENT_INITIATOR && ifMACu == TRUE) ||
   2119                 (keyEstablishRec[recIndex].role == KEY_ESTABLISHMENT_RESPONDER && ifMACu == FALSE))
   \   0000AA   E5..         MOV     A,?V0 + 0
   \   0000AC   A8..         MOV     R0,?V0 + 0
   \   0000AE   7900         MOV     R1,#0x0
   \   0000B0   E8           MOV     A,R0
   \   0000B1   75F027       MOV     B,#0x27
   \   0000B4   A4           MUL     AB
   \   0000B5   C8           XCH     A,R0
   \   0000B6   AAF0         MOV     R2,B
   \   0000B8   75F000       MOV     B,#0x0
   \   0000BB   A4           MUL     AB
   \   0000BC   2A           ADD     A,R2
   \   0000BD   FA           MOV     R2,A
   \   0000BE   75F027       MOV     B,#0x27
   \   0000C1   E9           MOV     A,R1
   \   0000C2   A4           MUL     AB
   \   0000C3   2A           ADD     A,R2
   \   0000C4   F9           MOV     R1,A
   \   0000C5   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   0000C7   28           ADD     A,R0
   \   0000C8   F582         MOV     DPL,A
   \   0000CA   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   0000CC   39           ADDC    A,R1
   \   0000CD   F583         MOV     DPH,A
   \   0000CF   E0           MOVX    A,@DPTR
   \   0000D0   7006         JNZ     ??zclGeneral_KeyEstablishment_GenerateMAC_7
   \   0000D2   7401         MOV     A,#0x1
   \   0000D4   65..         XRL     A,?V0 + 8
   \   0000D6   6034         JZ      ??zclGeneral_KeyEstablishment_GenerateMAC_8
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_7:
   \   0000D8   E5..         MOV     A,?V0 + 0
   \   0000DA   A8..         MOV     R0,?V0 + 0
   \   0000DC   7900         MOV     R1,#0x0
   \   0000DE   E8           MOV     A,R0
   \   0000DF   75F027       MOV     B,#0x27
   \   0000E2   A4           MUL     AB
   \   0000E3   C8           XCH     A,R0
   \   0000E4   AAF0         MOV     R2,B
   \   0000E6   75F000       MOV     B,#0x0
   \   0000E9   A4           MUL     AB
   \   0000EA   2A           ADD     A,R2
   \   0000EB   FA           MOV     R2,A
   \   0000EC   75F027       MOV     B,#0x27
   \   0000EF   E9           MOV     A,R1
   \   0000F0   A4           MUL     AB
   \   0000F1   2A           ADD     A,R2
   \   0000F2   F9           MOV     R1,A
   \   0000F3   74..         MOV     A,#(keyEstablishRec + 22) & 0xff
   \   0000F5   28           ADD     A,R0
   \   0000F6   F582         MOV     DPL,A
   \   0000F8   74..         MOV     A,#((keyEstablishRec + 22) >> 8) & 0xff
   \   0000FA   39           ADDC    A,R1
   \   0000FB   F583         MOV     DPH,A
   \   0000FD   E0           MOVX    A,@DPTR
   \   0000FE   6401         XRL     A,#0x1
   \   000100   6003         JZ      $+5
   \   000102   02....       LJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_9 & 0xFFFF
   \   000105   E5..         MOV     A,?V0 + 8
   \   000107   6003         JZ      $+5
   \   000109   02....       LJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_9 & 0xFFFF
   2120            {
   2121              // MAC = MAC(MacKey) { M() || ID(L) || ID(R) || E(L) || E(R) }
   2122              // L - Local, R - Remote
   2123              SSP_MemCpyReverse( &(hashBuf[1]), NLME_GetExtAddr(), Z_EXTADDR_LEN); // ID(U)
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_8:
   \   00010C                ; Setup parameters for call to function SSP_MemCpyReverse
   \   00010C   75..08       MOV     ?V0 + 4,#0x8
   \   00010F   75..00       MOV     ?V0 + 5,#0x0
   \   000112   78..         MOV     R0,#?V0 + 4
   \   000114   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000117                ; Setup parameters for call to function NLME_GetExtAddr
   \   000117   12....       LCALL   ??NLME_GetExtAddr?relay
   \   00011A   EA           MOV     A,R2
   \   00011B   FC           MOV     R4,A
   \   00011C   EB           MOV     A,R3
   \   00011D   FD           MOV     R5,A
   \   00011E   85..82       MOV     DPL,?V0 + 2
   \   000121   85..83       MOV     DPH,?V0 + 3
   \   000124   A3           INC     DPTR
   \   000125   AA82         MOV     R2,DPL
   \   000127   AB83         MOV     R3,DPH
   \   000129   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   00012C   7402         MOV     A,#0x2
   \   00012E   12....       LCALL   ?DEALLOC_XSTACK8
   2124              SSP_MemCpyReverse( &(hashBuf[1+Z_EXTADDR_LEN]), keyEstablishRec[recIndex].partnerExtAddr,
   2125                          Z_EXTADDR_LEN); // ID(V)
   \   000131                ; Setup parameters for call to function SSP_MemCpyReverse
   \   000131   75..08       MOV     ?V0 + 4,#0x8
   \   000134   75..00       MOV     ?V0 + 5,#0x0
   \   000137   78..         MOV     R0,#?V0 + 4
   \   000139   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00013C   E5..         MOV     A,?V0 + 0
   \   00013E   A8..         MOV     R0,?V0 + 0
   \   000140   7900         MOV     R1,#0x0
   \   000142   E8           MOV     A,R0
   \   000143   75F027       MOV     B,#0x27
   \   000146   A4           MUL     AB
   \   000147   C8           XCH     A,R0
   \   000148   AAF0         MOV     R2,B
   \   00014A   75F000       MOV     B,#0x0
   \   00014D   A4           MUL     AB
   \   00014E   2A           ADD     A,R2
   \   00014F   FA           MOV     R2,A
   \   000150   75F027       MOV     B,#0x27
   \   000153   E9           MOV     A,R1
   \   000154   A4           MUL     AB
   \   000155   2A           ADD     A,R2
   \   000156   F9           MOV     R1,A
   \   000157   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   000159   28           ADD     A,R0
   \   00015A   FC           MOV     R4,A
   \   00015B   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   00015D   39           ADDC    A,R1
   \   00015E   FD           MOV     R5,A
   \   00015F   E5..         MOV     A,?V0 + 2
   \   000161   2409         ADD     A,#0x9
   \   000163   FA           MOV     R2,A
   \   000164   E5..         MOV     A,?V0 + 3
   \   000166   3400         ADDC    A,#0x0
   \   000168   FB           MOV     R3,A
   \   000169   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   00016C   7402         MOV     A,#0x2
   \   00016E   12....       LCALL   ?DEALLOC_XSTACK8
   2126              osal_memcpy( &(hashBuf[1 + (2 * Z_EXTADDR_LEN)]),                               // E(U)
   2127                          keyEstablishRec[recIndex].pLocalEPublicKey,
   2128                          ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   000171                ; Setup parameters for call to function osal_memcpy
   \   000171   E5..         MOV     A,?V0 + 0
   \   000173   A8..         MOV     R0,?V0 + 0
   \   000175   7900         MOV     R1,#0x0
   \   000177   E8           MOV     A,R0
   \   000178   75F027       MOV     B,#0x27
   \   00017B   A4           MUL     AB
   \   00017C   C8           XCH     A,R0
   \   00017D   AAF0         MOV     R2,B
   \   00017F   75F000       MOV     B,#0x0
   \   000182   A4           MUL     AB
   \   000183   2A           ADD     A,R2
   \   000184   FA           MOV     R2,A
   \   000185   75F027       MOV     B,#0x27
   \   000188   E9           MOV     A,R1
   \   000189   A4           MUL     AB
   \   00018A   2A           ADD     A,R2
   \   00018B   F9           MOV     R1,A
   \   00018C   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   00018E   28           ADD     A,R0
   \   00018F   F582         MOV     DPL,A
   \   000191   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   000193   39           ADDC    A,R1
   \   000194   F583         MOV     DPH,A
   \   000196   E0           MOVX    A,@DPTR
   \   000197   F5..         MOV     ?V0 + 4,A
   \   000199   A3           INC     DPTR
   \   00019A   E0           MOVX    A,@DPTR
   \   00019B   F5..         MOV     ?V0 + 5,A
   \   00019D   75..00       MOV     ?V0 + 6,#0x0
   \   0001A0   78..         MOV     R0,#?V0 + 4
   \   0001A2   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0001A5   7C16         MOV     R4,#0x16
   \   0001A7   7D00         MOV     R5,#0x0
   \   0001A9   E5..         MOV     A,?V0 + 2
   \   0001AB   2411         ADD     A,#0x11
   \   0001AD   FA           MOV     R2,A
   \   0001AE   E5..         MOV     A,?V0 + 3
   \   0001B0   3400         ADDC    A,#0x0
   \   0001B2   FB           MOV     R3,A
   \   0001B3   12....       LCALL   ??osal_memcpy?relay
   \   0001B6   7403         MOV     A,#0x3
   \   0001B8   12....       LCALL   ?DEALLOC_XSTACK8
   2129              osal_memcpy( &(hashBuf[1 + (2 * Z_EXTADDR_LEN) + ZCL_KE_CA_PUBLIC_KEY_LEN]), // E(V)
   2130                          keyEstablishRec[recIndex].pRemotePublicKey, ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   0001BB                ; Setup parameters for call to function osal_memcpy
   \   0001BB   E5..         MOV     A,?V0 + 0
   \   0001BD   A8..         MOV     R0,?V0 + 0
   \   0001BF   7900         MOV     R1,#0x0
   \   0001C1   E8           MOV     A,R0
   \   0001C2   75F027       MOV     B,#0x27
   \   0001C5   A4           MUL     AB
   \   0001C6   C8           XCH     A,R0
   \   0001C7   AAF0         MOV     R2,B
   \   0001C9   75F000       MOV     B,#0x0
   \   0001CC   A4           MUL     AB
   \   0001CD   2A           ADD     A,R2
   \   0001CE   FA           MOV     R2,A
   \   0001CF   75F027       MOV     B,#0x27
   \   0001D2   E9           MOV     A,R1
   \   0001D3   A4           MUL     AB
   \   0001D4   2A           ADD     A,R2
   \   0001D5   F9           MOV     R1,A
   \   0001D6   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   0001D8   28           ADD     A,R0
   \   0001D9   F582         MOV     DPL,A
   \   0001DB   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   0001DD   39           ADDC    A,R1
   \   0001DE   F583         MOV     DPH,A
   \   0001E0   E0           MOVX    A,@DPTR
   \   0001E1   F5..         MOV     ?V0 + 4,A
   \   0001E3   A3           INC     DPTR
   \   0001E4   E0           MOVX    A,@DPTR
   \   0001E5   F5..         MOV     ?V0 + 5,A
   \   0001E7   75..00       MOV     ?V0 + 6,#0x0
   \   0001EA   78..         MOV     R0,#?V0 + 4
   \   0001EC   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0001EF   7C16         MOV     R4,#0x16
   \   0001F1   7D00         MOV     R5,#0x0
   \   0001F3   E5..         MOV     A,?V0 + 2
   \   0001F5   2427         ADD     A,#0x27
   \   0001F7   FA           MOV     R2,A
   \   0001F8   E5..         MOV     A,?V0 + 3
   \   0001FA   3400         ADDC    A,#0x0
   \   0001FC   FB           MOV     R3,A
   \   0001FD   12....       LCALL   ??osal_memcpy?relay
   \   000200   7403         MOV     A,#0x3
   \   000202   12....       LCALL   ?DEALLOC_XSTACK8
   2131          
   2132              SSP_KeyedHash (hashBuf, bufLen, keyEstablishRec[recIndex].pMacKey, MAC);
   \   000205                ; Setup parameters for call to function SSP_KeyedHash
   \   000205   78..         MOV     R0,#?V0 + 10
   \   000207   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   00020A   E5..         MOV     A,?V0 + 0
   \   00020C   A8..         MOV     R0,?V0 + 0
   \   00020E   7900         MOV     R1,#0x0
   \   000210   E8           MOV     A,R0
   \   000211   75F027       MOV     B,#0x27
   \   000214   A4           MUL     AB
   \   000215   C8           XCH     A,R0
   \   000216   AAF0         MOV     R2,B
   \   000218   75F000       MOV     B,#0x0
   \   00021B   A4           MUL     AB
   \   00021C   2A           ADD     A,R2
   \   00021D   FA           MOV     R2,A
   \   00021E   75F027       MOV     B,#0x27
   \   000221   E9           MOV     A,R1
   \   000222   A4           MUL     AB
   \   000223   2A           ADD     A,R2
   \   000224   F9           MOV     R1,A
   \   000225   74..         MOV     A,#(keyEstablishRec + 35) & 0xff
   \   000227   28           ADD     A,R0
   \   000228   F582         MOV     DPL,A
   \   00022A   74..         MOV     A,#((keyEstablishRec + 35) >> 8) & 0xff
   \   00022C   39           ADDC    A,R1
   \   00022D   F583         MOV     DPH,A
   \   00022F   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000232   EE           MOV     A,R6
   \   000233   FC           MOV     R4,A
   \   000234   EF           MOV     A,R7
   \   000235   FD           MOV     R5,A
   \   000236   AA..         MOV     R2,?V0 + 2
   \   000238   AB..         MOV     R3,?V0 + 3
   \   00023A   12....       LCALL   ??SSP_KeyedHash?relay
   \   00023D   7404         MOV     A,#0x4
   \   00023F   12....       LCALL   ?DEALLOC_XSTACK8
   \   000242   02....       LJMP    ??zclGeneral_KeyEstablishment_GenerateMAC_10 & 0xFFFF
   2133            }
   2134            else
   2135            {
   2136              // MAC = MAC(MacKey) { M() || ID(R) || ID(L) || E(R) || E(L) }
   2137              // L - Local, R - Remote
   2138              SSP_MemCpyReverse( &(hashBuf[1]), keyEstablishRec[recIndex].partnerExtAddr,
   2139                          Z_EXTADDR_LEN); // ID(R)
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_9:
   \   000245                ; Setup parameters for call to function SSP_MemCpyReverse
   \   000245   75..08       MOV     ?V0 + 4,#0x8
   \   000248   75..00       MOV     ?V0 + 5,#0x0
   \   00024B   78..         MOV     R0,#?V0 + 4
   \   00024D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000250   E5..         MOV     A,?V0 + 0
   \   000252   A8..         MOV     R0,?V0 + 0
   \   000254   7900         MOV     R1,#0x0
   \   000256   E8           MOV     A,R0
   \   000257   75F027       MOV     B,#0x27
   \   00025A   A4           MUL     AB
   \   00025B   C8           XCH     A,R0
   \   00025C   AAF0         MOV     R2,B
   \   00025E   75F000       MOV     B,#0x0
   \   000261   A4           MUL     AB
   \   000262   2A           ADD     A,R2
   \   000263   FA           MOV     R2,A
   \   000264   75F027       MOV     B,#0x27
   \   000267   E9           MOV     A,R1
   \   000268   A4           MUL     AB
   \   000269   2A           ADD     A,R2
   \   00026A   F9           MOV     R1,A
   \   00026B   74..         MOV     A,#(keyEstablishRec + 14) & 0xff
   \   00026D   28           ADD     A,R0
   \   00026E   FC           MOV     R4,A
   \   00026F   74..         MOV     A,#((keyEstablishRec + 14) >> 8) & 0xff
   \   000271   39           ADDC    A,R1
   \   000272   FD           MOV     R5,A
   \   000273   85..82       MOV     DPL,?V0 + 2
   \   000276   85..83       MOV     DPH,?V0 + 3
   \   000279   A3           INC     DPTR
   \   00027A   AA82         MOV     R2,DPL
   \   00027C   AB83         MOV     R3,DPH
   \   00027E   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   000281   7402         MOV     A,#0x2
   \   000283   12....       LCALL   ?DEALLOC_XSTACK8
   2140              SSP_MemCpyReverse( &(hashBuf[1 + Z_EXTADDR_LEN]), NLME_GetExtAddr(), Z_EXTADDR_LEN); // ID(L)
   \   000286                ; Setup parameters for call to function SSP_MemCpyReverse
   \   000286   75..08       MOV     ?V0 + 4,#0x8
   \   000289   75..00       MOV     ?V0 + 5,#0x0
   \   00028C   78..         MOV     R0,#?V0 + 4
   \   00028E   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000291                ; Setup parameters for call to function NLME_GetExtAddr
   \   000291   12....       LCALL   ??NLME_GetExtAddr?relay
   \   000294   EA           MOV     A,R2
   \   000295   FC           MOV     R4,A
   \   000296   EB           MOV     A,R3
   \   000297   FD           MOV     R5,A
   \   000298   E5..         MOV     A,?V0 + 2
   \   00029A   2409         ADD     A,#0x9
   \   00029C   FA           MOV     R2,A
   \   00029D   E5..         MOV     A,?V0 + 3
   \   00029F   3400         ADDC    A,#0x0
   \   0002A1   FB           MOV     R3,A
   \   0002A2   12....       LCALL   ??SSP_MemCpyReverse?relay
   \   0002A5   7402         MOV     A,#0x2
   \   0002A7   12....       LCALL   ?DEALLOC_XSTACK8
   2141              osal_memcpy( &(hashBuf[ 1 + (2 * Z_EXTADDR_LEN)]), // E(R)
   2142                          keyEstablishRec[recIndex].pRemotePublicKey,
   2143                          ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   0002AA                ; Setup parameters for call to function osal_memcpy
   \   0002AA   E5..         MOV     A,?V0 + 0
   \   0002AC   A8..         MOV     R0,?V0 + 0
   \   0002AE   7900         MOV     R1,#0x0
   \   0002B0   E8           MOV     A,R0
   \   0002B1   75F027       MOV     B,#0x27
   \   0002B4   A4           MUL     AB
   \   0002B5   C8           XCH     A,R0
   \   0002B6   AAF0         MOV     R2,B
   \   0002B8   75F000       MOV     B,#0x0
   \   0002BB   A4           MUL     AB
   \   0002BC   2A           ADD     A,R2
   \   0002BD   FA           MOV     R2,A
   \   0002BE   75F027       MOV     B,#0x27
   \   0002C1   E9           MOV     A,R1
   \   0002C2   A4           MUL     AB
   \   0002C3   2A           ADD     A,R2
   \   0002C4   F9           MOV     R1,A
   \   0002C5   74..         MOV     A,#(keyEstablishRec + 29) & 0xff
   \   0002C7   28           ADD     A,R0
   \   0002C8   F582         MOV     DPL,A
   \   0002CA   74..         MOV     A,#((keyEstablishRec + 29) >> 8) & 0xff
   \   0002CC   39           ADDC    A,R1
   \   0002CD   F583         MOV     DPH,A
   \   0002CF   E0           MOVX    A,@DPTR
   \   0002D0   F5..         MOV     ?V0 + 4,A
   \   0002D2   A3           INC     DPTR
   \   0002D3   E0           MOVX    A,@DPTR
   \   0002D4   F5..         MOV     ?V0 + 5,A
   \   0002D6   75..00       MOV     ?V0 + 6,#0x0
   \   0002D9   78..         MOV     R0,#?V0 + 4
   \   0002DB   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   0002DE   7C16         MOV     R4,#0x16
   \   0002E0   7D00         MOV     R5,#0x0
   \   0002E2   E5..         MOV     A,?V0 + 2
   \   0002E4   2411         ADD     A,#0x11
   \   0002E6   FA           MOV     R2,A
   \   0002E7   E5..         MOV     A,?V0 + 3
   \   0002E9   3400         ADDC    A,#0x0
   \   0002EB   FB           MOV     R3,A
   \   0002EC   12....       LCALL   ??osal_memcpy?relay
   \   0002EF   7403         MOV     A,#0x3
   \   0002F1   12....       LCALL   ?DEALLOC_XSTACK8
   2144              osal_memcpy( &(hashBuf[1 + (2 * Z_EXTADDR_LEN) + ZCL_KE_CA_PUBLIC_KEY_LEN]),                               // E(U)
   2145                          keyEstablishRec[recIndex].pLocalEPublicKey,
   2146                          ZCL_KE_CA_PUBLIC_KEY_LEN );
   \   0002F4                ; Setup parameters for call to function osal_memcpy
   \   0002F4   E5..         MOV     A,?V0 + 0
   \   0002F6   A8..         MOV     R0,?V0 + 0
   \   0002F8   7900         MOV     R1,#0x0
   \   0002FA   E8           MOV     A,R0
   \   0002FB   75F027       MOV     B,#0x27
   \   0002FE   A4           MUL     AB
   \   0002FF   C8           XCH     A,R0
   \   000300   AAF0         MOV     R2,B
   \   000302   75F000       MOV     B,#0x0
   \   000305   A4           MUL     AB
   \   000306   2A           ADD     A,R2
   \   000307   FA           MOV     R2,A
   \   000308   75F027       MOV     B,#0x27
   \   00030B   E9           MOV     A,R1
   \   00030C   A4           MUL     AB
   \   00030D   2A           ADD     A,R2
   \   00030E   F9           MOV     R1,A
   \   00030F   74..         MOV     A,#(keyEstablishRec + 27) & 0xff
   \   000311   28           ADD     A,R0
   \   000312   F582         MOV     DPL,A
   \   000314   74..         MOV     A,#((keyEstablishRec + 27) >> 8) & 0xff
   \   000316   39           ADDC    A,R1
   \   000317   F583         MOV     DPH,A
   \   000319   E0           MOVX    A,@DPTR
   \   00031A   F5..         MOV     ?V0 + 4,A
   \   00031C   A3           INC     DPTR
   \   00031D   E0           MOVX    A,@DPTR
   \   00031E   F5..         MOV     ?V0 + 5,A
   \   000320   75..00       MOV     ?V0 + 6,#0x0
   \   000323   78..         MOV     R0,#?V0 + 4
   \   000325   12....       LCALL   ?PUSH_XSTACK_I_THREE
   \   000328   7C16         MOV     R4,#0x16
   \   00032A   7D00         MOV     R5,#0x0
   \   00032C   E5..         MOV     A,?V0 + 2
   \   00032E   2427         ADD     A,#0x27
   \   000330   FA           MOV     R2,A
   \   000331   E5..         MOV     A,?V0 + 3
   \   000333   3400         ADDC    A,#0x0
   \   000335   FB           MOV     R3,A
   \   000336   12....       LCALL   ??osal_memcpy?relay
   \   000339   7403         MOV     A,#0x3
   \   00033B   12....       LCALL   ?DEALLOC_XSTACK8
   2147              SSP_KeyedHash (hashBuf, bufLen, keyEstablishRec[recIndex].pMacKey, MAC);
   \   00033E                ; Setup parameters for call to function SSP_KeyedHash
   \   00033E   78..         MOV     R0,#?V0 + 10
   \   000340   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000343   E5..         MOV     A,?V0 + 0
   \   000345   A8..         MOV     R0,?V0 + 0
   \   000347   7900         MOV     R1,#0x0
   \   000349   E8           MOV     A,R0
   \   00034A   75F027       MOV     B,#0x27
   \   00034D   A4           MUL     AB
   \   00034E   C8           XCH     A,R0
   \   00034F   AAF0         MOV     R2,B
   \   000351   75F000       MOV     B,#0x0
   \   000354   A4           MUL     AB
   \   000355   2A           ADD     A,R2
   \   000356   FA           MOV     R2,A
   \   000357   75F027       MOV     B,#0x27
   \   00035A   E9           MOV     A,R1
   \   00035B   A4           MUL     AB
   \   00035C   2A           ADD     A,R2
   \   00035D   F9           MOV     R1,A
   \   00035E   74..         MOV     A,#(keyEstablishRec + 35) & 0xff
   \   000360   28           ADD     A,R0
   \   000361   F582         MOV     DPL,A
   \   000363   74..         MOV     A,#((keyEstablishRec + 35) >> 8) & 0xff
   \   000365   39           ADDC    A,R1
   \   000366   F583         MOV     DPH,A
   \   000368   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   00036B   EE           MOV     A,R6
   \   00036C   FC           MOV     R4,A
   \   00036D   EF           MOV     A,R7
   \   00036E   FD           MOV     R5,A
   \   00036F   AA..         MOV     R2,?V0 + 2
   \   000371   AB..         MOV     R3,?V0 + 3
   \   000373   12....       LCALL   ??SSP_KeyedHash?relay
   \   000376   7404         MOV     A,#0x4
   \   000378   12....       LCALL   ?DEALLOC_XSTACK8
   2148            }
   2149          
   2150            osal_mem_free(hashBuf);
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_10:
   \   00037B                ; Setup parameters for call to function osal_mem_free
   \   00037B   AA..         MOV     R2,?V0 + 2
   \   00037D   AB..         MOV     R3,?V0 + 3
   \   00037F   12....       LCALL   ??osal_mem_free?relay
   2151            return ZSuccess;
   \   000382   7900         MOV     R1,#0x0
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC_5:
   \   000384   7F0C         MOV     R7,#0xc
   \   000386   02....       LJMP    ?BANKED_LEAVE_XDATA
   2152          }
   2153          
   2154          /*********************************************************************
   2155           * @fn      zclGeneral_KeyEstablishment_ECDSASign
   2156           *
   2157           * @brief    Creates an ECDSA signature of a message digest.
   2158           *
   2159           * @param   input - input data buffer
   2160           *          inputLen - byte length of the input buffer
   2161           *          output - output buffer ( 21x2 bytes )
   2162           *
   2163           * @return  ZStatus_t - success
   2164           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2165          ZStatus_t zclGeneral_KeyEstablishment_ECDSASign( uint8 *input,  uint8 inputLen,
   \                     zclGeneral_KeyEstablishment_ECDSASign:
   2166                                                       uint8 *output)
   2167          {
   \   000000   74EC         MOV     A,#-0x14
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 20
   \   000005                ; Auto size: 16
   \   000005   74F0         MOV     A,#-0x10
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
   \   00000E   89..         MOV     ?V0 + 0,R1
   \   000010   8C..         MOV     ?V0 + 10,R4
   \   000012   8D..         MOV     ?V0 + 11,R5
   2168            uint8 msgDigest[KEY_ESTABLISH_AES_MMO_HASH_SIZE];
   2169            uint16 bitLen = inputLen * 8;
   \   000014   E5..         MOV     A,?V0 + 0
   \   000016   F5..         MOV     ?V0 + 8,A
   \   000018   75..00       MOV     ?V0 + 9,#0x0
   \   00001B   E5..         MOV     A,?V0 + 8
   \   00001D   75F008       MOV     B,#0x8
   \   000020   A4           MUL     AB
   \   000021   C5..         XCH     A,?V0 + 8
   \   000023   A8F0         MOV     R0,B
   \   000025   75F000       MOV     B,#0x0
   \   000028   A4           MUL     AB
   \   000029   28           ADD     A,R0
   \   00002A   F8           MOV     R0,A
   \   00002B   75F008       MOV     B,#0x8
   \   00002E   E5..         MOV     A,?V0 + 9
   \   000030   A4           MUL     AB
   \   000031   28           ADD     A,R0
   \   000032   F5..         MOV     ?V0 + 9,A
   2170            uint8 status;
   2171            uint8 *devicePrivateKey;
   2172          
   2173            if ((devicePrivateKey = osal_mem_alloc(ZCL_KE_DEVICE_PRIVATE_KEY_LEN)) == NULL)
   \   000034                ; Setup parameters for call to function osal_mem_alloc
   \   000034   7A15         MOV     R2,#0x15
   \   000036   7B00         MOV     R3,#0x0
   \   000038   12....       LCALL   ??osal_mem_alloc?relay
   \   00003B   8A..         MOV     ?V0 + 4,R2
   \   00003D   8B..         MOV     ?V0 + 5,R3
   \   00003F   A8..         MOV     R0,?V0 + 4
   \   000041   A9..         MOV     R1,?V0 + 5
   \   000043   88..         MOV     ?V0 + 2,R0
   \   000045   89..         MOV     ?V0 + 3,R1
   \   000047   E8           MOV     A,R0
   \   000048   49           ORL     A,R1
   \   000049   7005         JNZ     ??zclGeneral_KeyEstablishment_ECDSASign_0
   2174            {
   2175              return ZCL_STATUS_SOFTWARE_FAILURE;  // Memory allocation failure.
   \   00004B   79C1         MOV     R1,#-0x3f
   \   00004D   02....       LJMP    ??zclGeneral_KeyEstablishment_ECDSASign_1 & 0xFFFF
   2176            }
   2177            osal_nv_read(ZCD_NV_DEVICE_PRIVATE_KEY, 0, ZCL_KE_DEVICE_PRIVATE_KEY_LEN, devicePrivateKey);
   \                     ??zclGeneral_KeyEstablishment_ECDSASign_0:
   \   000050                ; Setup parameters for call to function osal_nv_read
   \   000050   78..         MOV     R0,#?V0 + 2
   \   000052   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000055   75..15       MOV     ?V0 + 4,#0x15
   \   000058   75..00       MOV     ?V0 + 5,#0x0
   \   00005B   78..         MOV     R0,#?V0 + 4
   \   00005D   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000060   7C00         MOV     R4,#0x0
   \   000062   7D00         MOV     R5,#0x0
   \   000064   7A6A         MOV     R2,#0x6a
   \   000066   7B00         MOV     R3,#0x0
   \   000068   12....       LCALL   ??osal_nv_read?relay
   \   00006B   7404         MOV     A,#0x4
   \   00006D   12....       LCALL   ?DEALLOC_XSTACK8
   \   000070   E9           MOV     A,R1
   2178          
   2179            // First hash the input buffer
   2180            sspMMOHash(NULL, 0, input, bitLen, msgDigest);
   \   000071                ; Setup parameters for call to function sspMMOHash
   \   000071   85..82       MOV     DPL,?XSP + 0
   \   000074   85..83       MOV     DPH,?XSP + 1
   \   000077   8582..       MOV     ?V0 + 4,DPL
   \   00007A   8583..       MOV     ?V0 + 5,DPH
   \   00007D   78..         MOV     R0,#?V0 + 4
   \   00007F   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000082   78..         MOV     R0,#?V0 + 8
   \   000084   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000087   EE           MOV     A,R6
   \   000088   FC           MOV     R4,A
   \   000089   EF           MOV     A,R7
   \   00008A   FD           MOV     R5,A
   \   00008B   7900         MOV     R1,#0x0
   \   00008D   7A00         MOV     R2,#0x0
   \   00008F   7B00         MOV     R3,#0x0
   \   000091   12....       LCALL   ??sspMMOHash?relay
   \   000094   7404         MOV     A,#0x4
   \   000096   12....       LCALL   ?DEALLOC_XSTACK8
   2181          
   2182            status = ZSE_ECDSASign( (unsigned char*)devicePrivateKey, (unsigned char*)msgDigest,
   2183                          zclGeneral_KeyEstablishment_GetRandom,
   2184                         (unsigned char*)output, (unsigned char*)output + KEY_ESTABLISH_POINT_ORDER_SIZE,
   2185                         zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel );
   \   000099                ; Setup parameters for call to function ZSE_ECDSASign
   \   000099   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   00009C   E0           MOVX    A,@DPTR
   \   00009D   F5..         MOV     ?V0 + 4,A
   \   00009F   E4           CLR     A
   \   0000A0   F5..         MOV     ?V0 + 5,A
   \   0000A2   F5..         MOV     ?V0 + 6,A
   \   0000A4   F5..         MOV     ?V0 + 7,A
   \   0000A6   78..         MOV     R0,#?V0 + 4
   \   0000A8   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   0000AB   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   0000AE   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   0000B1   E5..         MOV     A,?V0 + 10
   \   0000B3   2415         ADD     A,#0x15
   \   0000B5   F5..         MOV     ?V0 + 4,A
   \   0000B7   E5..         MOV     A,?V0 + 11
   \   0000B9   3400         ADDC    A,#0x0
   \   0000BB   F5..         MOV     ?V0 + 5,A
   \   0000BD   78..         MOV     R0,#?V0 + 4
   \   0000BF   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000C2   78..         MOV     R0,#?V0 + 10
   \   0000C4   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000C7   75....       MOV     ?V0 + 4,#??zclGeneral_KeyEstablishment_GetRandom?relay & 0xff
   \   0000CA   75....       MOV     ?V0 + 5,#(??zclGeneral_KeyEstablishment_GetRandom?relay >> 8) & 0xff
   \   0000CD   78..         MOV     R0,#?V0 + 4
   \   0000CF   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   0000D2   740C         MOV     A,#0xc
   \   0000D4   12....       LCALL   ?XSTACK_DISP0_8
   \   0000D7   AC82         MOV     R4,DPL
   \   0000D9   AD83         MOV     R5,DPH
   \   0000DB   AA..         MOV     R2,?V0 + 2
   \   0000DD   AB..         MOV     R3,?V0 + 3
   \   0000DF   12....       LCALL   ??ZSE_ECDSASign?relay
   \   0000E2   740C         MOV     A,#0xc
   \   0000E4   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000E7   EA           MOV     A,R2
   \   0000E8   F5..         MOV     ?V0 + 1,A
   2186          
   2187            osal_mem_free(devicePrivateKey);
   \   0000EA                ; Setup parameters for call to function osal_mem_free
   \   0000EA   AA..         MOV     R2,?V0 + 2
   \   0000EC   AB..         MOV     R3,?V0 + 3
   \   0000EE   12....       LCALL   ??osal_mem_free?relay
   2188          
   2189            if (status == MCE_SUCCESS )
   \   0000F1   E5..         MOV     A,?V0 + 1
   \   0000F3   7004         JNZ     ??zclGeneral_KeyEstablishment_ECDSASign_2
   2190            {
   2191              return ZSuccess;
   \   0000F5   7900         MOV     R1,#0x0
   \   0000F7   8002         SJMP    ??zclGeneral_KeyEstablishment_ECDSASign_1
   2192            }
   2193          
   2194            return ZFailure;
   \                     ??zclGeneral_KeyEstablishment_ECDSASign_2:
   \   0000F9   7901         MOV     R1,#0x1
   \                     ??zclGeneral_KeyEstablishment_ECDSASign_1:
   \   0000FB   7410         MOV     A,#0x10
   \   0000FD   12....       LCALL   ?DEALLOC_XSTACK8
   \   000100   7F0C         MOV     R7,#0xc
   \   000102   02....       LJMP    ?BANKED_LEAVE_XDATA
   2195          }
   2196          
   2197          /*********************************************************************
   2198           * @fn      zclGeneral_KeyEstablishment_ECDSAVerify
   2199           *
   2200           * @brief    Verify an ECDSA signature of a message digest.
   2201           *
   2202           * @param   input - input data buffer
   2203           *          inputLen - byte length of the input buffer
   2204           *          signature - input signature ( 21x2 bytes )
   2205           *
   2206           * @return  ZSuccess - success verify
   2207           *          ZFailure - fail to verify
   2208           */

   \                                 In  segment BANKED_CODE, align 1, keep-with-next
   2209          ZStatus_t zclGeneral_KeyEstablishment_ECDSAVerify( uint8 *input,  uint8 inputLen,
   \                     zclGeneral_KeyEstablishment_ECDSAVerify:
   2210                                                       uint8 *signature)
   2211          {
   \   000000   74EE         MOV     A,#-0x12
   \   000002   12....       LCALL   ?BANKED_ENTER_XDATA
   \   000005                ; Saved register size: 18
   \   000005                ; Auto size: 16
   \   000005   74F0         MOV     A,#-0x10
   \   000007   12....       LCALL   ?ALLOC_XSTACK8
   \   00000A   EA           MOV     A,R2
   \   00000B   FE           MOV     R6,A
   \   00000C   EB           MOV     A,R3
   \   00000D   FF           MOV     R7,A
   \   00000E   89..         MOV     ?V0 + 0,R1
   \   000010   8C..         MOV     ?V0 + 8,R4
   \   000012   8D..         MOV     ?V0 + 9,R5
   2212          
   2213            uint8 msgDigest[KEY_ESTABLISH_AES_MMO_HASH_SIZE];
   2214            uint16 bitLen;
   2215            uint8 ret;
   2216          
   2217            bitLen = inputLen * 8;
   \   000014   E5..         MOV     A,?V0 + 0
   \   000016   A8..         MOV     R0,?V0 + 0
   \   000018   7900         MOV     R1,#0x0
   \   00001A   E8           MOV     A,R0
   \   00001B   75F008       MOV     B,#0x8
   \   00001E   A4           MUL     AB
   \   00001F   C8           XCH     A,R0
   \   000020   AAF0         MOV     R2,B
   \   000022   75F000       MOV     B,#0x0
   \   000025   A4           MUL     AB
   \   000026   2A           ADD     A,R2
   \   000027   FA           MOV     R2,A
   \   000028   75F008       MOV     B,#0x8
   \   00002B   E9           MOV     A,R1
   \   00002C   A4           MUL     AB
   \   00002D   2A           ADD     A,R2
   \   00002E   F9           MOV     R1,A
   \   00002F   88..         MOV     ?V0 + 2,R0
   \   000031   89..         MOV     ?V0 + 3,R1
   2218          
   2219            // First hash the input buffer
   2220            sspMMOHash(NULL, 0, input, bitLen, msgDigest);
   \   000033                ; Setup parameters for call to function sspMMOHash
   \   000033   85..82       MOV     DPL,?XSP + 0
   \   000036   85..83       MOV     DPH,?XSP + 1
   \   000039   8582..       MOV     ?V0 + 4,DPL
   \   00003C   8583..       MOV     ?V0 + 5,DPH
   \   00003F   78..         MOV     R0,#?V0 + 4
   \   000041   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000044   78..         MOV     R0,#?V0 + 2
   \   000046   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000049   EE           MOV     A,R6
   \   00004A   FC           MOV     R4,A
   \   00004B   EF           MOV     A,R7
   \   00004C   FD           MOV     R5,A
   \   00004D   7900         MOV     R1,#0x0
   \   00004F   7A00         MOV     R2,#0x0
   \   000051   7B00         MOV     R3,#0x0
   \   000053   12....       LCALL   ??sspMMOHash?relay
   \   000056   7404         MOV     A,#0x4
   \   000058   12....       LCALL   ?DEALLOC_XSTACK8
   2221          
   2222            ret = ZSE_ECDSAVerify((unsigned char*)NULL, (unsigned char*)msgDigest,
   2223                       (unsigned char*)signature, (unsigned char*)signature + KEY_ESTABLISH_POINT_ORDER_SIZE,
   2224                       zclKeyEstablish_YieldFunc, zclKeyEstablish_YieldLevel );
   \   00005B                ; Setup parameters for call to function ZSE_ECDSAVerify
   \   00005B   90....       MOV     DPTR,#zclKeyEstablish_YieldLevel
   \   00005E   E0           MOVX    A,@DPTR
   \   00005F   F5..         MOV     ?V0 + 4,A
   \   000061   E4           CLR     A
   \   000062   F5..         MOV     ?V0 + 5,A
   \   000064   F5..         MOV     ?V0 + 6,A
   \   000066   F5..         MOV     ?V0 + 7,A
   \   000068   78..         MOV     R0,#?V0 + 4
   \   00006A   12....       LCALL   ?PUSH_XSTACK_I_FOUR
   \   00006D   90....       MOV     DPTR,#zclKeyEstablish_YieldFunc
   \   000070   12....       LCALL   ?PUSH_XSTACK8_X_TWO
   \   000073   E5..         MOV     A,?V0 + 8
   \   000075   2415         ADD     A,#0x15
   \   000077   F5..         MOV     ?V0 + 4,A
   \   000079   E5..         MOV     A,?V0 + 9
   \   00007B   3400         ADDC    A,#0x0
   \   00007D   F5..         MOV     ?V0 + 5,A
   \   00007F   78..         MOV     R0,#?V0 + 4
   \   000081   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000084   78..         MOV     R0,#?V0 + 8
   \   000086   12....       LCALL   ?PUSH_XSTACK_I_TWO
   \   000089   740A         MOV     A,#0xa
   \   00008B   12....       LCALL   ?XSTACK_DISP0_8
   \   00008E   AC82         MOV     R4,DPL
   \   000090   AD83         MOV     R5,DPH
   \   000092   7A00         MOV     R2,#0x0
   \   000094   7B00         MOV     R3,#0x0
   \   000096   12....       LCALL   ??ZSE_ECDSAVerify?relay
   \   000099   740A         MOV     A,#0xa
   \   00009B   12....       LCALL   ?DEALLOC_XSTACK8
   \   00009E   EA           MOV     A,R2
   \   00009F   F5..         MOV     ?V0 + 1,A
   2225          
   2226            if ( ret == MCE_SUCCESS )
   \   0000A1   E5..         MOV     A,?V0 + 1
   \   0000A3   7004         JNZ     ??zclGeneral_KeyEstablishment_ECDSAVerify_0
   2227            {
   2228              return ZSuccess;
   \   0000A5   7900         MOV     R1,#0x0
   \   0000A7   8002         SJMP    ??zclGeneral_KeyEstablishment_ECDSAVerify_1
   2229            }
   2230          
   2231            return ZFailure;
   \                     ??zclGeneral_KeyEstablishment_ECDSAVerify_0:
   \   0000A9   7901         MOV     R1,#0x1
   \                     ??zclGeneral_KeyEstablishment_ECDSAVerify_1:
   \   0000AB   7410         MOV     A,#0x10
   \   0000AD   12....       LCALL   ?DEALLOC_XSTACK8
   \   0000B0   7F0A         MOV     R7,#0xa
   \   0000B2   02....       LJMP    ?BANKED_LEAVE_XDATA
   2232          }

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for zclKeyEstablish_Options>`:
   \   000000   0008         DW 2048
   \   000002   10           DB 16

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for zclSavedPollRate>`:
   \   000000   E803         DW 1000

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for zclKeyEstablish_SimpleDesc>`:
   \   000000   0A           DB 10
   \   000001   0901         DW 265
   \   000003   0705         DW 1287
   \   000005   00           DB 0
   \   000006   01           DB 1
   \   000007   ....         DW zclKeyEstablish_InClusterList
   \   000009   01           DB 1
   \   00000A   ....         DW zclKeyEstablish_OutClusterList

   \                                 In  segment XDATA_ID, align 1, keep-with-next
   \                     `?<Initializer for zclKeyEstablish_Ep>`:
   \   000000   0A           DB 10
   \   000001   ....         DW zcl_TaskID
   \   000003   ....         DW zclKeyEstablish_SimpleDesc
   \   000005   00           DB 0

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Init?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Init

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclKeyEstablish_event_loop?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclKeyEstablish_event_loop

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_InitiateKeyEstablishm:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_InitiateKeyEstablishment

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_EphemeralDataReq:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_EphemeralDataReq

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_ConfirmKey?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_ConfirmKey

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_1:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_EphemeralDataRsp:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_EphemeralDataRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_Send_ConfirmKeyRsp?re:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_Send_ConfirmKeyRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_RegYieldCB?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_RegYieldCB

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_HdlIncoming?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_HdlIncoming

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablish_HdlInSpecificCommands:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablish_HdlInSpecificCommands

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablish?:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_InitiateKeyEstablish

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataReq?rela:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_EphemeralDataReq

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_EphemeralDataRsp?rela:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_EphemeralDataRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_ConfirmKey?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_ConfirmKey

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_ConfirmKeyRsp?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_ConfirmKeyRsp

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ProcessInCmd_TerminateKeyEstablish:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ProcessInCmd_TerminateKeyEstablish

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_InitKeyEstablishRecTable?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_InitKeyEstablishRecTable

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_GetKeyEstablishRecIndex?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_GetKeyEstablishRecIndex

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_GetKeyEstablishRecIndex_State?rela:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_GetKeyEstablishRecIndex_State

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_AddKeyEstablishRec?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_AddKeyEstablishRec

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_AgeKeyEstablishRec?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_AgeKeyEstablishRec

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_ResetKeyEstablishRec?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_ResetKeyEstablishRec

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_GetRandom?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_GetRandom

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_HashFunc?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_HashFunc

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_KeyDeriveFunction:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_KeyDeriveFunction

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_GenerateMAC?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_GenerateMAC

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_ECDSASign?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_ECDSASign

   \                                 In  segment BANK_RELAYS, align 1
   \                     ??zclGeneral_KeyEstablishment_ECDSAVerify?relay:
   \   000000   12....       LCALL   ?BDISPATCH
   \   000003   ......       DC24    zclGeneral_KeyEstablishment_ECDSAVerify

   \                                 In  segment XDATA_ROM_C, align 1
   \                     `?<Constant {0, 0, 0, 1}>`:
   \   000000   00           DB 0
   \   000001   00           DB 0
   \   000002   00           DB 0
   \   000003   01           DB 1

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_11:
   \   000000   11000000     DD 17

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_fffffff0:
   \   000000   F0FFFFFF     DD 4294967280

   \                                 In  segment XDATA_ROM_C, align 1
   \                     __Constant_8:
   \   000000   08000000     DD 8
   2233          #endif // ZCL_KEY_ESTABLISH
   2234          
   2235          /***************************************************************************
   2236          ****************************************************************************/

   Maximum stack usage in bytes:

   ISTACK PSTACK XSTACK Function
   ------ ------ ------ --------
       0      0     36  zclGeneral_AddKeyEstablishRec
                          0 0 15 -> osal_mem_alloc
                          0 0 18 -> osal_memcpy
                          0 0 15 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 15 -> zclGeneral_ResetKeyEstablishRec
       1      0     23  zclGeneral_AgeKeyEstablishRec
                          0 0  9 -> osal_stop_timerEx
                          0 0  9 -> zclGeneral_ResetKeyEstablishRec
       2      0     47  zclGeneral_GetKeyEstablishRecIndex
       2      0     57  zclGeneral_GetKeyEstablishRecIndex_State
       0      0     19  zclGeneral_InitKeyEstablishRecTable
                          0 0  9 -> zclGeneral_ResetKeyEstablishRec
       1      0     72  zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey
                          0 0 40 -> NLME_SetPollRate
                          0 0 40 -> ZMacSetReq
                          0 0 58 -> ZSE_ECCKeyBitGenerate
                          0 0 40 -> osal_mem_alloc
                          0 0 40 -> osal_mem_free
                          0 0 43 -> osal_memcpy
                          0 0 44 -> osal_nv_read
                          0 0 40 -> osal_start_reload_timer
                          0 0 40 -> zclGeneral_GetKeyEstablishRecIndex_State
                          0 0 42 -> zclGeneral_KeyEstablish_Send_EphemeralDataRsp
                          0 0 45 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 40 -> zclGeneral_KeyEstablishment_KeyDeriveFunction
                          0 0 40 -> zclGeneral_ResetKeyEstablishRec
       1      0     89  zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey
                          0 0 57 -> NLME_SetPollRate
                          0 0 57 -> ZMacGetReq
                          0 0 57 -> ZMacSetReq
                          0 0 75 -> ZSE_ECCKeyBitGenerate
                          0 0 57 -> osal_mem_alloc
                          0 0 57 -> osal_mem_free
                          0 0 60 -> osal_memcpy
                          0 0 61 -> osal_nv_read
                          0 0 57 -> osal_start_reload_timer
                          0 0 57 -> zclGeneral_GetKeyEstablishRecIndex_State
                          0 0 59 -> zclGeneral_KeyEstablish_Send_ConfirmKey
                          0 0 62 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 57 -> zclGeneral_KeyEstablishment_GenerateMAC
                          0 0 57 -> zclGeneral_KeyEstablishment_KeyDeriveFunction
                          0 0 57 -> zclGeneral_ResetKeyEstablishRec
       0      0     18  zclGeneral_KeyEstablish_HdlInSpecificCommands
                          0 0  9 -> zclGeneral_ProcessInCmd_ConfirmKey
                          0 0  9 -> zclGeneral_ProcessInCmd_ConfirmKeyRsp
                          0 0  9 -> zclGeneral_ProcessInCmd_EphemeralDataReq
                          0 0  9 -> zclGeneral_ProcessInCmd_EphemeralDataRsp
                          0 0  9 -> zclGeneral_ProcessInCmd_InitiateKeyEstablish
                          0 0  9 -> zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp
                          0 0  9 -> zclGeneral_ProcessInCmd_TerminateKeyEstablish
       0      0      9  zclGeneral_KeyEstablish_HdlIncoming
                          0 0  9 -> zclGeneral_KeyEstablish_HdlInSpecificCommands
       0      0     12  zclGeneral_KeyEstablish_Init
                          0 0 10 -> afRegister
                          0 0 10 -> zclGeneral_InitKeyEstablishRecTable
                          0 0 10 -> zcl_registerClusterOptionList
                          0 0 12 -> zcl_registerPlugin
       1      0     26  zclGeneral_KeyEstablish_InitiateKeyEstablishment
                          0 0 18 -> NLME_SetPollRate
                          0 0 26 -> ZSE_ECCGenerateKey
                          0 0 18 -> osal_mem_alloc
                          0 0 18 -> osal_mem_free
                          0 0 22 -> osal_nv_read
                          0 0 18 -> osal_start_reload_timer
                          0 0 18 -> zclGeneral_AddKeyEstablishRec
                          0 0 24 -> zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment
       0      0     86  zclGeneral_KeyEstablish_Send_ConfirmKey
                          0 0 27 -> zcl_SendCommand
       0      0     76  zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
                          0 0 27 -> zcl_SendCommand
       0      0     57  zclGeneral_KeyEstablish_Send_EphemeralDataReq
                          0 0 27 -> zcl_SendCommand
       0      0     69  zclGeneral_KeyEstablish_Send_EphemeralDataRsp
                          0 0 27 -> zcl_SendCommand
       1      0     59  zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment
                          0 0 24 -> osal_mem_alloc
                          0 0 24 -> osal_mem_free
                          0 0 27 -> osal_memcpy
                          0 0 35 -> zcl_SendCommand
       1      0     59  zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp
                          0 0 24 -> osal_mem_alloc
                          0 0 24 -> osal_mem_free
                          0 0 27 -> osal_memcpy
                          0 0 35 -> zcl_SendCommand
       1      0     95  zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 33 -> zcl_SendCommand
       0      0     48  zclGeneral_KeyEstablishment_ECDSASign
                          0 0 48 -> ZSE_ECDSASign
                          0 0 36 -> osal_mem_alloc
                          0 0 36 -> osal_mem_free
                          0 0 40 -> osal_nv_read
                          0 0 40 -> sspMMOHash
       0      0     44  zclGeneral_KeyEstablishment_ECDSAVerify
                          0 0 44 -> ZSE_ECDSAVerify
                          0 0 38 -> sspMMOHash
       1      0     81  zclGeneral_KeyEstablishment_GenerateMAC
                          0 0 22 -> NLME_GetExtAddr
                          0 0 24 -> SSP_KeyedHash
                          0 0 22 -> SSP_MemCpyReverse
                          0 0 20 -> osal_mem_alloc
                          0 0 20 -> osal_mem_free
                          0 0 23 -> osal_memcpy
       0      0     20  zclGeneral_KeyEstablishment_GetRandom
                          0 0 16 -> SSP_GetTrueRandAES
       0      0     28  zclGeneral_KeyEstablishment_HashFunc
                          0 0 24 -> sspMMOHash
       2      0    105  zclGeneral_KeyEstablishment_KeyDeriveFunction
                          0 0 47 -> osal_memcpy
                          0 0 48 -> sspMMOHash
       2      0      0  zclGeneral_KeyEstablishment_RegYieldCB
       0      0     61  zclGeneral_ProcessInCmd_ConfirmKey
                          0 0 47 -> NLME_SetPollRate
                          0 0 49 -> ZDSecMgrAddLinkKey
                          0 0 50 -> osal_memcmp
                          0 0 47 -> osal_stop_timerEx
                          0 0 47 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 49 -> zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
                          0 0 52 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 47 -> zclGeneral_KeyEstablishment_GenerateMAC
                          0 0 47 -> zclGeneral_ResetKeyEstablishRec
       1      0     45  zclGeneral_ProcessInCmd_ConfirmKeyRsp
                          0 0 31 -> NLME_SetPollRate
                          0 0 33 -> ZDSecMgrAddLinkKey
                          0 0 34 -> osal_memcmp
                          0 0 31 -> osal_msg_allocate
                          0 0 31 -> osal_msg_send
                          0 0 31 -> osal_stop_timerEx
                          0 0 31 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 36 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 31 -> zclGeneral_KeyEstablishment_GenerateMAC
                          0 0 31 -> zclGeneral_ResetKeyEstablishRec
       1      0     33  zclGeneral_ProcessInCmd_EphemeralDataReq
                          0 0 16 -> NLME_SetPollRate
                          0 0 24 -> ZSE_ECCGenerateKey
                          0 0 19 -> osal_memcpy
                          0 0 16 -> osal_start_timerEx
                          0 0 16 -> osal_stop_timerEx
                          0 0 16 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 21 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 16 -> zclGeneral_ResetKeyEstablishRec
       0      0     29  zclGeneral_ProcessInCmd_EphemeralDataRsp
                          0 0 15 -> NLME_SetPollRate
                          0 0 18 -> osal_memcpy
                          0 0 15 -> osal_start_timerEx
                          0 0 15 -> osal_stop_timerEx
                          0 0 15 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 20 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 15 -> zclGeneral_ResetKeyEstablishRec
       1      0     33  zclGeneral_ProcessInCmd_InitiateKeyEstablish
                          0 0 18 -> NLME_SetPollRate
                          0 0 20 -> SSP_MemCpyReverse
                          0 0 18 -> osal_mem_alloc
                          0 0 18 -> osal_mem_free
                          0 0 21 -> osal_memcmp
                          0 0 21 -> osal_memcpy
                          0 0 22 -> osal_nv_read
                          0 0 18 -> osal_start_reload_timer
                          0 0 18 -> zclGeneral_AddKeyEstablishRec
                          0 0 24 -> zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp
                          0 0 23 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 18 -> zclGeneral_ResetKeyEstablishRec
       1      0     42  zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp
                          0 0 28 -> AddrMgrExtAddrLookup
                          0 0 28 -> NLME_SetPollRate
                          0 0 30 -> SSP_MemCpyReverse
                          0 0 28 -> osal_mem_alloc
                          0 0 28 -> osal_mem_free
                          0 0 31 -> osal_memcmp
                          0 0 31 -> osal_memcpy
                          0 0 32 -> osal_nv_read
                          0 0 28 -> osal_start_reload_timer
                          0 0 28 -> osal_stop_timerEx
                          0 0 28 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 30 -> zclGeneral_KeyEstablish_Send_EphemeralDataReq
                          0 0 33 -> zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
                          0 0 28 -> zclGeneral_ResetKeyEstablishRec
       1      0     23  zclGeneral_ProcessInCmd_TerminateKeyEstablish
                          0 0 14 -> NLME_SetPollRate
                          0 0 14 -> osal_msg_allocate
                          0 0 14 -> osal_msg_send
                          0 0 14 -> zclGeneral_GetKeyEstablishRecIndex
                          0 0 14 -> zclGeneral_ResetKeyEstablishRec
       0      0     71  zclGeneral_ResetKeyEstablishRec
                          0 0 14 -> osal_mem_free
                          0 0 14 -> osal_memset
       0      0     14  zclKeyEstablish_event_loop
                          0 0 14 -> osal_msg_deallocate
                          0 0 14 -> osal_msg_receive
                          0 0 14 -> zclGeneral_AgeKeyEstablishRec
                          0 0 14 -> zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey
                          0 0 14 -> zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey


   Segment part sizes:

   Bytes  Function/Label
   -----  --------------
       4  ?<Constant {0, 0, 0, 1}>
       6  ?<Initializer for zclKeyEstablish_Ep>
       3  ?<Initializer for zclKeyEstablish_Options>
      12  ?<Initializer for zclKeyEstablish_SimpleDesc>
       2  ?<Initializer for zclSavedPollRate>
       6  ??zclGeneral_AddKeyEstablishRec?relay
       6  ??zclGeneral_AgeKeyEstablishRec?relay
       6  ??zclGeneral_GetKeyEstablishRecIndex?relay
       6  ??zclGeneral_GetKeyEstablishRecIndex_State?rela
       6  ??zclGeneral_InitKeyEstablishRecTable?relay
       6  ??zclGeneral_InitiateKeyEstablish_Cmd_Calculate
       6  ??zclGeneral_InitiateKeyEstablish_Rsp_Calculate
       6  ??zclGeneral_KeyEstablish_HdlInSpecificCommands
       6  ??zclGeneral_KeyEstablish_HdlIncoming?relay
       6  ??zclGeneral_KeyEstablish_Init?relay
       6  ??zclGeneral_KeyEstablish_InitiateKeyEstablishm
       6  ??zclGeneral_KeyEstablish_Send_ConfirmKey?relay
       6  ??zclGeneral_KeyEstablish_Send_ConfirmKeyRsp?re
       6  ??zclGeneral_KeyEstablish_Send_EphemeralDataReq
       6  ??zclGeneral_KeyEstablish_Send_EphemeralDataRsp
       6  ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab
       6  ??zclGeneral_KeyEstablish_Send_InitiateKeyEstab_1
       6  ??zclGeneral_KeyEstablish_Send_TerminateKeyEsta
       6  ??zclGeneral_KeyEstablishment_ECDSASign?relay
       6  ??zclGeneral_KeyEstablishment_ECDSAVerify?relay
       6  ??zclGeneral_KeyEstablishment_GenerateMAC?relay
       6  ??zclGeneral_KeyEstablishment_GetRandom?relay
       6  ??zclGeneral_KeyEstablishment_HashFunc?relay
       6  ??zclGeneral_KeyEstablishment_KeyDeriveFunction
       6  ??zclGeneral_KeyEstablishment_RegYieldCB?relay
       6  ??zclGeneral_ProcessInCmd_ConfirmKey?relay
       6  ??zclGeneral_ProcessInCmd_ConfirmKeyRsp?relay
       6  ??zclGeneral_ProcessInCmd_EphemeralDataReq?rela
       6  ??zclGeneral_ProcessInCmd_EphemeralDataRsp?rela
       6  ??zclGeneral_ProcessInCmd_InitiateKeyEstablish?
       6  ??zclGeneral_ProcessInCmd_InitiateKeyEstablishR
       6  ??zclGeneral_ProcessInCmd_TerminateKeyEstablish
       6  ??zclGeneral_ResetKeyEstablishRec?relay
       6  ??zclKeyEstablish_event_loop?relay
       4  __Constant_11
       4  __Constant_8
       4  __Constant_fffffff0
      78  keyEstablishRec
     459  zclGeneral_AddKeyEstablishRec
     173  zclGeneral_AgeKeyEstablishRec
      66  zclGeneral_GetKeyEstablishRecIndex
      63  zclGeneral_GetKeyEstablishRecIndex_State
      26  zclGeneral_InitKeyEstablishRecTable
    1052  zclGeneral_InitiateKeyEstablish_Cmd_CalculateKey
    1018  zclGeneral_InitiateKeyEstablish_Rsp_CalculateKey
     202  zclGeneral_KeyEstablish_HdlInSpecificCommands
      90  zclGeneral_KeyEstablish_HdlIncoming
      79  zclGeneral_KeyEstablish_Init
     467  zclGeneral_KeyEstablish_InitiateKeyEstablishment
     122  zclGeneral_KeyEstablish_Send_ConfirmKey
     122  zclGeneral_KeyEstablish_Send_ConfirmKeyRsp
     122  zclGeneral_KeyEstablish_Send_EphemeralDataReq
     122  zclGeneral_KeyEstablish_Send_EphemeralDataRsp
     308  zclGeneral_KeyEstablish_Send_InitiateKeyEstablishment
     308  zclGeneral_KeyEstablish_Send_InitiateKeyEstablishmentRsp
     212  zclGeneral_KeyEstablish_Send_TerminateKeyEstablishment
     261  zclGeneral_KeyEstablishment_ECDSASign
     181  zclGeneral_KeyEstablishment_ECDSAVerify
     905  zclGeneral_KeyEstablishment_GenerateMAC
      86  zclGeneral_KeyEstablishment_GetRandom
      81  zclGeneral_KeyEstablishment_HashFunc
     239  zclGeneral_KeyEstablishment_KeyDeriveFunction
      36  zclGeneral_KeyEstablishment_RegYieldCB
     604  zclGeneral_ProcessInCmd_ConfirmKey
     611  zclGeneral_ProcessInCmd_ConfirmKeyRsp
     569  zclGeneral_ProcessInCmd_EphemeralDataReq
     390  zclGeneral_ProcessInCmd_EphemeralDataRsp
    1152  zclGeneral_ProcessInCmd_InitiateKeyEstablish
    1318  zclGeneral_ProcessInCmd_InitiateKeyEstablishRsp
     332  zclGeneral_ProcessInCmd_TerminateKeyEstablish
     428  zclGeneral_ResetKeyEstablishRec
       1  zclKeyEstablishPluginRegisted
       6  zclKeyEstablish_Ep
       2  zclKeyEstablish_InClusterList
       3  zclKeyEstablish_Options
       2  zclKeyEstablish_OutClusterList
      12  zclKeyEstablish_SimpleDesc
       2  zclKeyEstablish_YieldFunc
       1  zclKeyEstablish_YieldLevel
     129  zclKeyEstablish_event_loop
       2  zclSavedPollRate
       1  zcl_KeyEstablishment_TaskID

 
 12 333 bytes in segment BANKED_CODE
    204 bytes in segment BANK_RELAYS
     23 bytes in segment XDATA_I
     23 bytes in segment XDATA_ID
     20 bytes in segment XDATA_ROM_C
     83 bytes in segment XDATA_Z
 
 12 560 bytes of CODE  memory
      8 bytes of CONST memory (+ 12 bytes shared)
    106 bytes of XDATA memory

Errors: none
Warnings: none
